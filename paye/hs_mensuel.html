<!DOCTYPE html>
<html lang="fr">
<head>
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/hs/apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Compteur Heures & Paie">
<meta name="theme-color" content="#4FB3C2">
<meta charset="UTF-8">
<title>Simulateur d'heures mensualis√©</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*,*::before,*::after{box-sizing:border-box}
.kitsune-btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:9px 18px;border-radius:24px;border:none;background:linear-gradient(135deg,#4FB3C2,#2196a6);color:#fff;font-size:14px;font-weight:600;cursor:pointer;width:auto;margin:0;box-shadow:0 2px 8px rgba(79,179,194,0.35);transition:transform .15s,box-shadow .15s;line-height:1}
.kitsune-btn:hover{transform:scale(1.02);box-shadow:0 4px 16px rgba(79,179,194,0.55)}
.kitsune-btn:active{transform:scale(0.97)}
.menu-btn{padding:9px 16px;border-radius:20px;border:none;background:rgba(255,255,255,0.12);color:#e6e6e6;font-size:14px;font-weight:500;cursor:pointer;width:auto;margin:0;line-height:1}
.topbar{position:sticky;top:0;z-index:2000;background:var(--bg);padding:calc(env(safe-area-inset-top) + 8px) 12px 8px;display:flex;gap:8px;align-items:center;justify-content:flex-start;flex-wrap:nowrap;border-bottom:1px solid #1c1f26;min-height:54px}

:root{--bg:#0f1115;--card:#1c1f26;--text:#e6e6e6;--muted:#9aa0a6;--accent:#4FB3C2;--accent2:#2196a6;--danger:#c0392b;--success:#2ecc71}
#versionBadge{position:fixed;bottom:calc(env(safe-area-inset-bottom) + 14px);right:calc(env(safe-area-inset-right) + 14px);font-size:11px;opacity:.55;color:#9aa0a6;z-index:99999;user-select:none;pointer-events:none}
html{background:var(--bg)}body{margin:0;min-height:100vh;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif;overflow-x:hidden}
.main{padding:12px;padding-top:70px;overflow-x:hidden}
h1,h2,h3{text-align:center}
button{width:100%;padding:10px;border-radius:8px;border:none;background:var(--accent);color:white;font-size:15px;margin-top:6px}
button.secondary{background:#2a2f3a}
button.danger{background:var(--danger)}
input,select{width:100%;max-width:100%;padding:8px;margin-top:6px;background:#262a33;color:var(--text);border:1px solid #333;border-radius:6px;display:block}input[type="date"],input[type="month"]{overflow:hidden;min-width:0;-webkit-appearance:none;appearance:none;max-width:100%;width:100%}
.card{background:var(--card);padding:15px;border-radius:12px;margin-top:15px;overflow:hidden}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.weekday{text-align:center;font-weight:bold;font-size:12px}
.day{background:#262a33;border-radius:8px;padding:6px;text-align:center;cursor:pointer;min-height:60px;transition:border .2s ease,opacity .2s ease,transform .1s ease}
.day.today{border:2px solid #4FB3C2 !important;opacity:1 !important;background:#0d2630;box-shadow:0 0 0 2px rgba(79,179,194,0.4);transform:scale(1.03);z-index:2}
.day.locked{opacity:.4;cursor:not-allowed}
.day.after-closing{border:1px dashed #4FB3C2;opacity:0.75}
.day.after-closing.today{opacity:1 !important;border-style:solid}
.closures-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.closure-row{display:flex;flex-direction:column;gap:4px}
.closure-row label{font-size:12px;color:var(--muted)}
.closure-row input{margin-top:0;font-size:13px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:4000;opacity:0;pointer-events:none;transform:translateY(10px);transition:opacity .2s ease,transform .2s ease}
.modal.open{opacity:1;pointer-events:auto;transform:translateY(0)}
.modal-content{background:var(--card);padding:20px;border-radius:16px;width:90%;max-width:480px;max-height:85vh;overflow-y:auto}
.wiz-progress-bar{background:#333;border-radius:4px;height:5px;margin-bottom:16px;overflow:hidden}
.wiz-progress-fill{height:100%;background:linear-gradient(90deg,#4FB3C2,#2196a6);transition:width .3s ease}
.wiz-step{display:none}
.wiz-step.active{display:block}
.wiz-nav{display:flex;gap:10px;margin-top:20px}
.wiz-nav button{flex:1;margin-top:0}
.wiz-choice{display:flex;gap:10px;margin-top:8px}
.wiz-choice button{flex:1;margin-top:0;font-size:13px;padding:10px 8px}
.blur{filter:blur(8px)}
.badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:12px}
.badge.ok{background:#1a3a4a;color:#4FB3C2}
.badge.file{background:#283593}
input[type="month"]{text-align:center;padding-right:0;appearance:none;-webkit-appearance:none}
input[type="number"]{text-align:center;appearance:none;-webkit-appearance:none;-moz-appearance:textfield;padding-left:0;padding-right:0}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div class="topbar">
  <button class="menu-btn" onclick="goMenu()">&#x2B05; Menu</button>
  <button class="kitsune-btn" onclick="window.location.href='../fox/index.html'" title="Ouvrir FOX Engine">&#x1F98A; Kitsune</button>
  <button onclick="openTutorial()" style="margin:0;width:auto;padding:9px 14px;background:#2a2f3a;border-radius:20px;font-size:13px;line-height:1;">&#x2753; Tutoriel</button>
</div>

<!-- MODALES SYST√àME -->
<div class="modal" id="debugGate"><div class="modal-content">
  <h3>&#x1F9EA; Acc√®s debug s√©curis√©</h3>
  <p style="font-size:14px">Avant toute intervention, un <b>test de crash</b> est obligatoire.</p>
  <input type="password" id="debugCode" placeholder="Code requis (1234)">
  <button class="danger" onclick="validateDebugAccess()">&#x1F4A5; Tester le crash maintenant</button>
  <button class="secondary" onclick="closeDebugGate()">Annuler</button>
</div></div>

<div class="modal" id="recoveryModal"><div class="modal-content">
  <h2>&#x1F6E0;&#xFE0F; Mode r√©cup√©ration</h2>
  <h3>&#x1F4F8; Snapshots disponibles</h3>
  <div id="snapshotList"></div>
  <p style="font-size:14px">L'application a d√©tect√© un probl√®me lors du dernier d√©marrage.</p>
  <button onclick="recoverAuto()">&#x1F504; R√©paration automatique</button>
  <button class="secondary" onclick="recoverSoftReset()">&#x267B;&#xFE0F; R√©initialiser l'interface</button>
  <button class="danger" onclick="recoverFactory()">&#x1F9E8; R√©initialisation compl√®te</button>
  <p style="font-size:12px;color:#aaa;margin-top:10px">&#x26A0;&#xFE0F; La r√©initialisation compl√®te supprime les donn√©es locales.</p>
</div></div>

<div class="modal" id="legalModal"><div class="modal-content">
  <h2>&#x26A0;&#xFE0F; Avertissement important</h2>
  <p style="font-size:14px">Cet outil est un <b>simulateur personnel</b>.<br><br>Les calculs sont indicatifs et peuvent diff√©rer de votre bulletin de paie r√©el.<br><br><b>Seuls les documents de l'employeur font foi.</b></p>
  <button onclick="acceptLegal()">J'ai compris</button>
</div></div>

<!-- WIZARD -->
<div class="modal" id="wizardModal"><div class="modal-content">
  <div class="wiz-progress-bar"><div class="wiz-progress-fill" id="wizProgress" style="width:25%"></div></div>
  <div id="wizStepLabel" style="font-size:12px;color:#9aa0a6;text-align:right;margin-bottom:10px;">√âtape 1 / 4</div>

  <div class="wiz-step active" id="wizStep1">
    <h2 style="margin-top:0">&#x1F44B; Bienvenue</h2>
    <p style="font-size:14px;color:var(--muted)">Cet outil te permet de suivre tes heures suppl√©mentaires mois par mois, avec report automatique et estimation ‚Ç¨.<br><br>La configuration prend moins d'une minute.</p>
    <ol style="font-size:14px;line-height:1.9">
      <li>Clique sur un jour pour saisir des heures</li>
      <li>La cl√¥ture mensuelle est le dernier dimanche par d√©faut</li>
      <li>Les reliquats sont report√©s automatiquement</li>
      <li>La zone ‚Ç¨ est prot√©g√©e par un code</li>
    </ol>
    <div class="wiz-nav"><button onclick="wizNext()">Suivant &#x2192;</button></div>
  </div>

  <div class="wiz-step" id="wizStep2">
    <h2 style="margin-top:0">&#x1F4C6; Cl√¥ture mensuelle</h2>
    <p style="font-size:14px;color:var(--muted)">La cl√¥ture d√©finit la fin de ta p√©riode de paie.<br>Par d√©faut : <b>dernier dimanche du mois</b>.<br>Modifiable √† tout moment.</p>
    <div style="background:#262a33;border-radius:10px;padding:14px;margin-top:10px">
      <label style="font-size:13px;color:var(--muted)">Mode de cl√¥ture</label>
      <div class="wiz-choice">
        <button id="wizClosureAuto" onclick="wizSelectClosure('auto')" style="background:#2196a6">&#x1F916; Auto<br><small style="font-weight:400;color:#cde">Dernier dimanche</small></button>
        <button id="wizClosureManual" onclick="wizSelectClosure('manual')" style="background:#2a2f3a">&#x270F;&#xFE0F; Manuel<br><small style="font-weight:400;color:#999">Je choisis</small></button>
      </div>
      <div id="wizManualDateBox" style="display:none;margin-top:10px">
        <label style="font-size:13px;color:var(--muted)">Jour de cl√¥ture (num√©ro du jour)</label>
        <input type="number" id="wizManualDay" min="1" max="28" placeholder="Ex: 25">
        <p style="font-size:11px;color:#9aa0a6;margin-top:4px">Ajust√© au dimanche le plus proche automatiquement.</p>
      </div>
    </div>
    <div class="wiz-nav">
      <button class="secondary" onclick="wizPrev()">&#x2190; Retour</button>
      <button onclick="wizNext()">Suivant &#x2192;</button>
    </div>
  </div>

  <div class="wiz-step" id="wizStep3">
    <h2 style="margin-top:0">&#x1F4B6; Taux horaire</h2>
    <p style="font-size:14px;color:var(--muted)">Ces valeurs pr√©-remplissent la zone ‚Ç¨. Modifiables √† tout moment.</p>
    <div style="background:#262a33;border-radius:10px;padding:14px;margin-top:10px">
      <label style="font-size:13px;color:var(--muted)">Taux horaire de base (‚Ç¨/h)</label>
      <input type="number" id="wizRate" step="0.5" placeholder="Ex: 12.50">
      <label style="font-size:13px;color:var(--muted);margin-top:10px;display:block">Coefficient brut &#x2192; net</label>
      <input type="number" id="wizCoefNet" step="0.01" placeholder="Ex: 0.93">
      <p style="font-size:11px;color:#9aa0a6;margin-top:6px">Laisser vide = valeurs par d√©faut.</p>
    </div>
    <div class="wiz-nav">
      <button class="secondary" onclick="wizPrev()">&#x2190; Retour</button>
      <button onclick="wizNext()">Suivant &#x2192;</button>
    </div>
  </div>

  <div class="wiz-step" id="wizStep4">
    <h2 style="margin-top:0">&#x1F510; Code de s√©curit√©</h2>
    <p style="font-size:14px;color:var(--muted)">La zone ‚Ç¨ est prot√©g√©e par un code. Le code par d√©faut est <b>1234</b> ‚Äî change-le pour s√©curiser tes donn√©es.</p>
    <div style="background:#262a33;border-radius:10px;padding:14px;margin-top:10px">
      <label style="font-size:13px;color:var(--muted)">Nouveau code (laisser vide = garder 1234)</label>
      <input type="password" id="wizNewCode" placeholder="Minimum 4 caract√®res">
      <input type="password" id="wizConfirmCode" placeholder="Confirmer le code" style="margin-top:8px">
    </div>
    <div class="wiz-nav">
      <button class="secondary" onclick="wizPrev()">&#x2190; Retour</button>
      <button onclick="wizFinish()" style="background:linear-gradient(135deg,#4FB3C2,#2196a6)">&#x2705; Terminer &amp; Lancer</button>
    </div>
  </div>
</div></div>

<!-- POPUP HEURES -->
<div class="modal" id="hoursModal"><div class="modal-content">
  <h3>&#x23F1;&#xFE0F; Ajouter des heures</h3>
  <div id="hoursChoices"></div>
  <label>Saisie manuelle</label>
  <input type="number" id="manualHours" step="0.25">
  <button onclick="confirmManual()">Valider</button>
  <button class="danger" onclick="deleteDayHours()">&#x1F5D1;&#xFE0F; Supprimer les heures du jour</button>
  <button class="secondary" onclick="closeHours()">Annuler</button>
</div></div>

<!-- TUTORIEL -->
<div class="modal" id="tutorialModal"><div class="modal-content" style="max-width:700px;max-height:80vh;overflow:auto">
  <h2>&#x1F4D8; Tutoriel</h2>
  <h3>1&#xFE0F;&#x20E3; Principe g√©n√©ral</h3>
  <p>Suivi des heures sup dans le cadre d'une <b>paie mensuelle</b>, avec report automatique des reliquats.</p>
  <h3>2&#xFE0F;&#x20E3; Saisie des heures</h3>
  <ul><li>Clique sur un jour</li><li>Choisis +15 min, +1h‚Ä¶ ou saisis manuellement</li><li>Enregistrement automatique</li></ul>
  <h3>3&#xFE0F;&#x20E3; Cl√¥ture mensuelle</h3>
  <p>D√©finit la fin de la p√©riode de paie. Les heures apr√®s cette date sont report√©es.</p>
  <h3>4&#xFE0F;&#x20E3; Zone ‚Ç¨</h3>
  <p>Flout√©e par d√©faut et prot√©g√©e par code.</p>
  <button class="secondary" onclick="closeTutorial()">Fermer</button>
</div></div>

<!-- MODALE CL√îTURES 12 MOIS -->
<div class="modal" id="closuresModal"><div class="modal-content" style="max-height:85vh;overflow-y:auto">
  <h3 style="margin-top:0">&#x1F4C5; Cl√¥tures des 12 mois</h3>
  <p style="font-size:13px;color:var(--muted);margin-top:0">Chaque mois peut avoir son propre dimanche de cl√¥ture.<br>Laisse vide = dernier dimanche du mois (automatique).</p>
  <div class="closures-grid" id="closuresGrid"></div>
  <button onclick="saveAllClosures()" style="margin-top:16px;background:linear-gradient(135deg,#4FB3C2,#2196a6)">&#x2705; Enregistrer</button>
  <button class="secondary" onclick="closeClosuresModal()" style="margin-top:6px">Annuler</button>
</div></div>

<!-- CONTENU PRINCIPAL -->
<div class="main">
  <h1>&#x23F1;&#xFE0F; Heures suppl√©mentaires</h1>
  <p style="text-align:center;font-size:14px;color:#9aa0a6;margin-top:-10px">
    Suivi pr√©cis bas√© sur la <b>logique r√©elle de paie mensuelle</b> (cl√¥ture + report automatique)
  </p>

  <div class="card">
    <label>Mois suivi</label>
    <input type="month" id="monthPicker">
    <label>Jour de cl√¥ture mensuelle</label>
    <input type="date" id="closingDate">
    <button onclick="openClosuresModal()" style="margin-top:10px;background:#2a2f3a;font-size:13px;">&#x1F4C5; Configurer les cl√¥tures des 12 mois</button>
  </div>

  <div class="calendar card" id="calendar"></div>

  <div class="card">
    <h3>R√©capitulatif</h3>
    <p>Report pr√©c√©dent : <b id="prevCarry">0.00</b> h</p>
    <p>Total p√©riode : <b id="totalMonth">0.00</b> h</p>
    <p>Heures √† 25 % : <b id="hours25">0.00</b> h</p>
    <p>Heures √† 50 % : <b id="hours50">0.00</b> h</p>
    <p style="font-size:12px;color:#aaa;margin-top:8px">&#x2139;&#xFE0F; Calcul standard : 25% jusqu'√† 8h hebdomadaires, puis 50%.</p>
    <p>Heures pay√©es : <input type="number" id="paidHours" step="0.25"></p>
    <p>Reliquat report√© : <b id="carryOver">0.00</b> h</p>
  </div>

  <div class="card">
    <h3>&#x1F4B0; Valeur ‚Ç¨</h3>
    <div id="euroBox" class="blur">
      <label>Taux horaire (‚Ç¨)</label><input type="number" id="rate">
      <label>Coef 25 %</label><input type="number" id="coef25">
      <label>Coef 50 %</label><input type="number" id="coef50">
      <label>Coef brut &#x2192; net</label><input type="number" id="coefNet">
      <p><b id="euroResult">0.00 ‚Ç¨</b></p>
      <p id="euroDetail" style="font-size:12px;color:#aaa;margin-top:8px"></p>
      <p style="font-size:12px;color:#9aa0a6;margin-top:10px;line-height:1.4">
        &#x26A0;&#xFE0F; Taux et coefficients fournis √† titre <b>strictement indicatif</b>. <b>Seul le bulletin de paie fait foi.</b>
      </p>
    </div>
    <input type="password" id="unlockCode" placeholder="Code (1234)">
    <button onclick="unlockEuro()">D√©verrouiller</button>
  </div>

  <button class="secondary" onclick="toggleChangeCode()">&#x1F501; Changer le code</button>
  <div id="changeCodeBox" style="display:none;margin-top:10px">
    <input type="password" id="oldCode" placeholder="Ancien code">
    <input type="password" id="newCode" placeholder="Nouveau code (4 chiffres min)">
    <input type="password" id="confirmCode" placeholder="Confirmer le code">
    <button class="danger" onclick="changeCode()">Valider le nouveau code</button>
  </div>

  <div class="card">
    <span class="badge ok">&#x1F7E2; Sauvegarde locale auto</span>
    <span class="badge file">&#x1F464; Usage personnel ‚Äì outil indicatif</span>
    <span class="badge file">&#x1F4BE; Dernier fichier : <span id="fileDate">‚Äî</span></span>
    <button onclick="exportJSON()">&#x1F4BE; Sauvegarde dans un fichier</button>
    <input type="file" id="importFile" accept=".json" style="display:none">
    <button class="secondary" onclick="document.getElementById('importFile').click()">&#x1F4E5; Importer une sauvegarde</button>
    <button onclick="exportMonthlyPDF()">&#x1F4C4; PDF mensuel d√©taill√©</button>
    <button onclick="exportAnnualPDF()">&#x1F4D5; PDF annuel r√©capitulatif</button>
    <button class="secondary" onclick="restartWizard()" style="margin-top:14px">&#x1F504; Recommencer la configuration</button>
  </div>

  <div class="card" style="font-size:13px;color:#aaa">
    <h3>&#x1F4D8; Notice utilisateur</h3>
    <p>Outil de suivi personnel des heures suppl√©mentaires ‚Äì r√©mun√©ration mensuelle.</p>
    <ul><li>Code du travail</li><li>Convention collective du commerce de gros (IDCC 573)</li></ul>
    <p>&#x26A0;&#xFE0F; En cas de litige, seuls les bulletins de paie et documents officiels font foi.</p>
  </div>

  <div class="card" style="font-size:12px;color:#9aa0a6;line-height:1.5">
    <b>&#x26A0;&#xFE0F; Responsabilit√© et limites</b><br><br>
    Les donn√©es sont renseign√©es <b>sous la seule responsabilit√© de l'utilisateur</b>.<br><br>
    Les r√©sultats sont indicatifs et peuvent ne pas refl√©ter la r√©alit√© en raison d'erreurs de saisie, de diff√©rences li√©es √† la convention collective, aux accords d'entreprise ou de <b>dysfonctionnements techniques</b>.<br><br>
    <b>Seuls les documents √©tablis par l'employeur et le droit applicable font foi.</b>
  </div>

  <footer id="debugTrigger" style="margin-top:30px;text-align:center;font-size:12px;color:#777;cursor:pointer;padding-bottom:40px">
    &#x00A9; C. Anthony<br>Outil indicatif ‚Äì ne constitue pas un bulletin de paie
  </footer>
</div>
<div id="versionBadge"></div>

<script>
const STORAGE_PREFIX="CA_HS_TRACKER_V1",APP_VERSION="1.4.0",SNAP_KEY=`${STORAGE_PREFIX}_SNAPSHOTS`,SNAP_LIMIT=5,DATA_VERSION="1.0";
const RECOVERY_ACTIVE=localStorage.getItem("CA_HS_RECOVERY_MODE")==="1";
function kData(y){return`${STORAGE_PREFIX}_DATA_${y}`}
function kSettings(){return`${STORAGE_PREFIX}_SETTINGS`}
function kCode(){return`${STORAGE_PREFIX}_CODE_HASH`}
function kIndex(){return`${STORAGE_PREFIX}_INDEX`}
function getYearFromMonth(k){return k.split("-")[0]}

let DATA={},SETTINGS=JSON.parse(localStorage.getItem(kSettings())||"{}"),ALL_DATA={};
let currentKey="",currentDay=null,unlocked=false;

/* SCROLL LOCK */
let _scrollY=0;
function lockBodyScroll(){_scrollY=window.scrollY;document.body.style.overflow="hidden";document.body.style.position="fixed";document.body.style.top="-"+_scrollY+"px";document.body.style.width="100%"}
function unlockBodyScroll(){document.body.style.overflow="";document.body.style.position="";document.body.style.top="";document.body.style.width="";window.scrollTo(0,_scrollY)}

/* WIZARD */
let wizStep=1,wizClosureMode="auto";
const WIZ_TOTAL=4;
function openWizard(){wizStep=1;wizClosureMode="auto";document.getElementById("wizardModal").classList.add("open");lockBodyScroll();wizUpdateUI()}
function closeWizard(){document.getElementById("wizardModal").classList.remove("open");unlockBodyScroll()}
function wizUpdateUI(){
  document.querySelectorAll(".wiz-step").forEach((el,i)=>el.classList.toggle("active",i+1===wizStep));
  document.getElementById("wizProgress").style.width=(wizStep/WIZ_TOTAL*100)+"%";
  document.getElementById("wizStepLabel").textContent=`√âtape ${wizStep} / ${WIZ_TOTAL}`;
}
function wizNext(){if(wizStep<WIZ_TOTAL){wizStep++;wizUpdateUI()}}
function wizPrev(){if(wizStep>1){wizStep--;wizUpdateUI()}}
function wizSelectClosure(mode){
  wizClosureMode=mode;
  document.getElementById("wizClosureAuto").style.background=mode==="auto"?"#2196a6":"#2a2f3a";
  document.getElementById("wizClosureManual").style.background=mode==="manual"?"#2196a6":"#2a2f3a";
  document.getElementById("wizManualDateBox").style.display=mode==="manual"?"block":"none";
}
async function wizFinish(){
  const nc=document.getElementById("wizNewCode").value,cc=document.getElementById("wizConfirmCode").value;
  if(nc){if(nc.length<4){alert("‚ö†Ô∏è Code trop court");return}if(nc!==cc){alert("‚ùå Codes diff√©rents");return}localStorage.setItem(kCode(),await sha256(nc))}
  const r=parseFloat(document.getElementById("wizRate").value),cn=parseFloat(document.getElementById("wizCoefNet").value);
  if(!isNaN(r)){SETTINGS["rate"]=r;document.getElementById("rate").value=r}
  if(!isNaN(cn)){SETTINGS["coefNet"]=cn;document.getElementById("coefNet").value=cn}
  localStorage.setItem(kSettings(),JSON.stringify(SETTINGS));
  localStorage.setItem("ONBOARDING_DONE","1");localStorage.setItem("CA_HS_TRACKER_V1_ONBOARDING","1");
  closeWizard();loadMonth();
}

/* INIT */
;(function autoRefreshPWA(){const key="CA_APP_VERSION",last=localStorage.getItem(key);if(last!==APP_VERSION){localStorage.setItem(key,APP_VERSION);if(!sessionStorage.getItem("CA_REFRESHED")){sessionStorage.setItem("CA_REFRESHED","1");location.reload()}}})();
;(function preloadAllYears(){const idx=JSON.parse(localStorage.getItem(kIndex())||"[]");idx.forEach(y=>{try{ALL_DATA[y]=loadYearData(y)}catch(e){ALL_DATA[y]={}}}); })();
;(function migrate(){const s=localStorage.getItem("CA_DATA_VERSION");if(s===DATA_VERSION)return;Object.entries(ALL_DATA).forEach(([y,yd])=>{Object.values(yd).forEach(m=>{if(typeof m.closing!=="number")m.closing=null;if(typeof m.locked!=="boolean")m.locked=false});saveYearData(y,yd)});localStorage.setItem("CA_DATA_VERSION",DATA_VERSION)})();

window.addEventListener("load",()=>{
  const v=document.getElementById("versionBadge");if(v)v.textContent="v"+APP_VERSION;
  if(RECOVERY_ACTIVE){openRecovery();return}
  // Legal d'abord si jamais accept√©
  if(!localStorage.getItem("LEGAL_OK")){document.getElementById("legalModal").classList.add("open");return}
  // Wizard si premi√®re utilisation de CE fichier (cl√© propre)
  if(!localStorage.getItem("CA_HS_TRACKER_V1_ONBOARDING")){openWizard();return}
  loadMonth();
});

function acceptLegal(){localStorage.setItem("LEGAL_OK","1");document.getElementById("legalModal").classList.remove("open");if(!localStorage.getItem("CA_HS_TRACKER_V1_ONBOARDING"))openWizard();else loadMonth()}

/* RECOVERY */
function openRecovery(){document.getElementById("recoveryModal").classList.add("open");renderSnapshots()}
function recoverAuto(){const f=attemptAutoRecovery();localStorage.removeItem("CA_HS_RECOVERY_MODE");alert(f?"‚úÖ R√©paration effectu√©e.":"‚ÑπÔ∏è Aucun probl√®me.");location.reload()}
function recoverSoftReset(){localStorage.removeItem("CA_HS_RECOVERY_MODE");location.reload()}
function recoverFactory(){createSnapshot("factory_reset",true);if(!confirm("‚ö†Ô∏è Supprimer TOUTES les donn√©es ?"))return;Object.keys(localStorage).filter(k=>k.startsWith(STORAGE_PREFIX)).forEach(k=>localStorage.removeItem(k));location.reload()}
function attemptAutoRecovery(){
  let repaired=false;
  try{const idx=JSON.parse(localStorage.getItem(kIndex())||"[]");
    idx.forEach(year=>{let data;try{data=loadYearData(year)}catch(e){localStorage.removeItem(kData(year));repaired=true;return}
      Object.entries(data).forEach(([mk,m])=>{if(!m.days)m.days={};if(typeof m.paid!=="number")m.paid=0;if(typeof m.carry!=="number")m.carry=0;const[y,mo]=mk.split("-").map(Number);const ls=getLastSunday(y,mo-1);if(!m.closing||new Date(y,mo-1,m.closing).getDay()!==0){m.closing=ls;repaired=true}});
      saveYearData(year,data)});
  }catch(e){return false}return repaired;
}

/* SNAPSHOTS */
function createSnapshot(reason="auto",force=false){
  try{if(!force){const last=Number(localStorage.getItem("SNAP_LAST")||0);if(Date.now()-last<60000)return}
    localStorage.setItem("SNAP_LAST",Date.now());const snaps=JSON.parse(localStorage.getItem(SNAP_KEY)||"[]");
    snaps.unshift({date:new Date().toISOString(),reason,currentKey,DATA:JSON.parse(JSON.stringify(ALL_DATA)),SETTINGS});
    snaps.splice(SNAP_LIMIT);localStorage.setItem(SNAP_KEY,JSON.stringify(snaps));
  }catch(e){console.warn("Snapshot √©chou√©",e)}}
function renderSnapshots(){const list=document.getElementById("snapshotList");if(!list)return;const snaps=JSON.parse(localStorage.getItem(SNAP_KEY)||"[]");list.innerHTML=snaps.length?snaps.map((s,i)=>`<button onclick="restoreSnapshot(${i})">üì∏ ${new Date(s.date).toLocaleString()} ‚Äì ${s.reason}</button>`).join(""):"<p style='font-size:12px;color:#aaa'>Aucun snapshot</p>"}
function restoreSnapshot(index){const snaps=JSON.parse(localStorage.getItem(SNAP_KEY)||"[]");if(!snaps[index]){alert("‚ùå Introuvable");return}const snap=snaps[index];if(!confirm(`Restaurer du ${new Date(snap.date).toLocaleString()} ?`))return;ALL_DATA=snap.DATA;SETTINGS=snap.SETTINGS||{};Object.entries(ALL_DATA).forEach(([y,d])=>saveYearData(y,d));localStorage.setItem(kSettings(),JSON.stringify(SETTINGS));localStorage.removeItem("CA_HS_RECOVERY_MODE");location.reload()}

/* CALENDRIER */
const closingDate=document.getElementById("closingDate"),monthPicker=document.getElementById("monthPicker"),paidInput=document.getElementById("paidHours");
monthPicker.value=new Date().toISOString().slice(0,7);
monthPicker.onchange=loadMonth;
paidInput.oninput=()=>{if(!DATA||!DATA[currentKey])return;DATA[currentKey].paid=parseFloat(paidInput.value)||0;save();recalc()};

function getLastSunday(year,monthIndex){const d=new Date(year,monthIndex+1,0);const diff=d.getDay()===0?0:d.getDay();d.setDate(d.getDate()-diff);return d.getDate()}
function getPeriodBounds(monthKey){
  if(!monthKey||typeof monthKey!=="string"){const now=new Date();return{start:new Date(now.getFullYear(),now.getMonth(),1),end:new Date(now.getFullYear(),now.getMonth()+1,0)}}
  const[y,m]=monthKey.split("-").map(Number);if(!y||!m)return{start:new Date(y||1970,(m||1)-1,1),end:new Date(y||1970,m||1,0)};
  const yd=ALL_DATA[String(y)],cm=yd?.[monthKey];if(!cm)return{start:new Date(y,m-1,1),end:new Date(y,m,0)};
  const pmd=new Date(y,m-2,1),pk=pmd.getFullYear()+"-"+String(pmd.getMonth()+1).padStart(2,"0");
  const pyd=ALL_DATA[String(pmd.getFullYear())]||{},pm=pyd[pk];
  let start=pm&&typeof pm.closing==="number"?new Date(pmd.getFullYear(),pmd.getMonth(),pm.closing+1):new Date(y,m-1,1);
  let closing=cm.closing;if(typeof closing!=="number"||new Date(y,m-1,closing).getDay()!==0)closing=getLastSunday(y,m-1);
  return{start,end:new Date(y,m-1,closing)};
}
function goMenu(){localStorage.removeItem("lastApp");window.location.href="../menu.html"}
function loadMonth(){
  currentKey=monthPicker.value;const year=getYearFromMonth(currentKey);registerYear(year);
  if(!ALL_DATA[year])ALL_DATA[year]=loadYearData(year);DATA=ALL_DATA[year];
  const[y,m]=currentKey.split("-").map(Number);let needSave=false;
  if(!DATA[currentKey]){DATA[currentKey]={days:{},paid:0,carry:0,closing:getLastSunday(y,m-1),locked:false};needSave=true}
  {const ld=new Date(y,m,0).getDate(),cl=DATA[currentKey].closing;if(!cl||cl>ld||new Date(y,m-1,cl).getDay()!==0){DATA[currentKey].closing=getLastSunday(y,m-1);needSave=true}}
  paidInput.value=DATA[currentKey].paid||0;setClosingLimits();syncClosingDate();renderCalendar();recalcCascade();recalc();scrollToToday();if(needSave)save();
}
function syncClosingDate(){if(!DATA[currentKey])return;const[y,m]=currentKey.split("-").map(Number),day=DATA[currentKey].closing||31;closingDate.value=`${y}-${String(m).padStart(2,"0")}-${String(day).padStart(2,"0")}`}
function setClosingLimits(){const[y,m]=currentKey.split("-").map(Number),ld=new Date(y,m,0).getDate();closingDate.min=`${y}-${String(m).padStart(2,"0")}-01`;closingDate.max=`${y}-${String(m).padStart(2,"0")}-${ld}`}
closingDate.oninput=()=>{if(!closingDate.value)return;const sel=new Date(closingDate.value),[y,m]=currentKey.split("-").map(Number);if(sel.getFullYear()!==y||sel.getMonth()+1!==m){alert("‚õî La date doit √™tre dans le mois s√©lectionn√©");syncClosingDate();return}if(sel.getDay()!==0){alert("‚õî La cl√¥ture doit √™tre un dimanche");syncClosingDate();return}DATA[currentKey].closing=sel.getDate();save();renderCalendar();recalc()};
closingDate.addEventListener("blur",()=>{const cal=document.getElementById("calendar");if(!cal)return;cal.style.display="none";cal.offsetHeight;cal.style.display="grid"});
function scrollToToday(){const today=new Date().toISOString().slice(0,7);if(currentKey!==today)return;const el=document.getElementById("todayCell");if(el)el.scrollIntoView({behavior:"smooth",block:"center"})}
function renderCalendar(){
  const cal=document.getElementById("calendar");cal.innerHTML="";
  ["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"].forEach(d=>{const w=document.createElement("div");w.className="weekday";w.textContent=d;cal.appendChild(w)});
  const[y,m]=currentKey.split("-").map(Number),today=new Date(),isCurMonth=currentKey===today.toISOString().slice(0,7);
  const firstDay=new Date(y,m-1,1).getDay()||7,dim=new Date(y,m,0).getDate(),{start,end}=getPeriodBounds(currentKey),isLocked=DATA[currentKey].locked;
  for(let i=1;i<firstDay;i++)cal.appendChild(document.createElement("div"));
  for(let d=1;d<=dim;d++){
    const div=document.createElement("div");div.className="day";
    const date=new Date(y,m-1,d);
    if(date>end)div.classList.add("after-closing");
    if(isLocked)div.classList.add("locked");
    if(isCurMonth&&d===today.getDate()){div.classList.add("today");div.id="todayCell"}
    const val=DATA[currentKey].days[d];
    div.innerHTML=`<b>${d}</b><br><span style="color:#fff;font-weight:600">${val?val.toFixed(2)+" h":""}</span>`;
    div.onclick=()=>{if(isLocked){alert("üîí Mois verrouill√©");return}openHours(d)};
    cal.appendChild(div);
  }
}

/* POPUP HEURES */
function openHours(d){currentDay=d;const c=document.getElementById("hoursChoices");c.innerHTML="";[0.25,0.5,0.75,1,1.25,1.5,2].forEach(v=>{const b=document.createElement("button");b.textContent="+"+v+" h";b.onclick=()=>applyHours(v);c.appendChild(b)});document.getElementById("hoursModal").classList.add("open");lockBodyScroll()}
function closeHours(){document.getElementById("hoursModal").classList.remove("open");unlockBodyScroll()}
function applyHours(h){if(h<=0)return;DATA[currentKey].days[currentDay]=(DATA[currentKey].days[currentDay]||0)+h;save();renderCalendar();recalc();closeHours()}
function confirmManual(){const inp=document.getElementById("manualHours"),h=parseFloat(inp.value);if(isNaN(h)||h<=0){alert("‚õî Valeur invalide");return}applyHours(h);inp.value=""}
function deleteDayHours(){if(DATA[currentKey].locked){alert("üîí Mois verrouill√©");return}if(!currentDay||!DATA[currentKey].days[currentDay]){alert("‚ÑπÔ∏è Aucune heure √† supprimer");return}if(!confirm(`Supprimer les heures du ${currentDay} ?`))return;delete DATA[currentKey].days[currentDay];currentDay=null;save();renderCalendar();recalc();closeHours()}

/* TUTORIEL */
function openTutorial(){document.getElementById("tutorialModal").classList.add("open");lockBodyScroll()}
function closeTutorial(){document.getElementById("tutorialModal").classList.remove("open");unlockBodyScroll()}

/* CALCUL */
function getPreviousCarry(mk){const am=[];Object.values(ALL_DATA).forEach(yd=>{if(!yd||typeof yd!=="object")return;Object.keys(yd).forEach(k=>{if(/^\d{4}-\d{2}$/.test(k))am.push({key:k,month:yd[k]})})});am.sort((a,b)=>a.key.localeCompare(b.key));let pc=0;for(const item of am){if(item.key===mk)break;if(item.month.carry!=null)pc=item.month.carry}return pc}
function recalc(){
  const{start,end}=getPeriodBounds(currentKey);const weeks={};
  Object.entries(DATA).forEach(([mk,month])=>{Object.entries(month.days||{}).forEach(([d,h])=>{const date=new Date(mk.split("-")[0],mk.split("-")[1]-1,d);if(date<start||date>end)return;const mon=new Date(date);const day=mon.getDay()||7;mon.setDate(mon.getDate()-day+1);const wk=mon.getFullYear()+"-"+String(mon.getMonth()+1).padStart(2,"0")+"-"+String(mon.getDate()).padStart(2,"0");weeks[wk]=(weeks[wk]||0)+h})});
  let t25=0,t50=0,ph=0;Object.values(weeks).forEach(wh=>{ph+=wh;t25+=Math.min(8,wh);t50+=Math.max(0,wh-8)});
  document.getElementById("hours25").textContent=t25.toFixed(2);document.getElementById("hours50").textContent=t50.toFixed(2);document.getElementById("totalMonth").textContent=ph.toFixed(2);document.getElementById("prevCarry").textContent=getPreviousCarry(currentKey).toFixed(2);document.getElementById("carryOver").textContent=(DATA[currentKey].carry||0).toFixed(2);
  if(unlocked)calcEuro();
}
function calcEuro(){if(!unlocked)return;const rate=Number(document.getElementById("rate").value)||0,c25=Number(document.getElementById("coef25").value)||1.25,c50=Number(document.getElementById("coef50").value)||1.50,cn=Number(document.getElementById("coefNet").value)||1,h25=Number(document.getElementById("hours25").textContent)||0,h50=Number(document.getElementById("hours50").textContent)||0;const w25=h25*c25,w50=h50*c50,wt=w25+w50,brut=wt*rate,net=brut*cn;document.getElementById("euroResult").textContent=net.toFixed(2)+" ‚Ç¨";document.getElementById("euroDetail").innerHTML=`${h25.toFixed(2)} h √ó ${c25} = ${w25.toFixed(2)} h<br>${h50.toFixed(2)} h √ó ${c50} = ${w50.toFixed(2)} h<br><b>Total pond√©r√© : ${wt.toFixed(2)} h</b>`}
function recalcCascade(){
  const am=[];Object.values(ALL_DATA).forEach(yd=>{if(!yd||typeof yd!=="object")return;Object.entries(yd).forEach(([k,m])=>{if(/^\d{4}-\d{2}$/.test(k))am.push({key:k,month:m})})});am.sort((a,b)=>a.key.localeCompare(b.key));
  let rc=0;am.forEach(({key})=>{const{start,end}=getPeriodBounds(key);let ph=0;Object.entries(ALL_DATA).forEach(([,yd])=>{Object.entries(yd||{}).forEach(([mk,m])=>{Object.entries(m.days||{}).forEach(([d,h])=>{const[y,mo]=mk.split("-").map(Number);const date=new Date(y,mo-1,d);if(date>=start&&date<=end)ph+=h})})});const m=ALL_DATA[key.slice(0,4)][key];rc+=ph-(Number(m.paid)||0);if(rc<0)rc=0;m.carry=rc});
}

/* S√âCURIT√â */
async function sha256(str){const buf=new TextEncoder().encode(str);const hash=await crypto.subtle.digest("SHA-256",buf);return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("")}
async function getSecureCode(){let h=localStorage.getItem(kCode());if(!h){h=await sha256("1234");localStorage.setItem(kCode(),h)}return h}
async function unlockEuro(){const inp=document.getElementById("unlockCode").value,ih=await sha256(inp);if(ih===await getSecureCode()){unlocked=true;document.getElementById("euroBox").classList.remove("blur");document.getElementById("unlockCode").value="";recalc();if(inp==="1234")alert("‚ö†Ô∏è Pense √† changer le code par d√©faut")}else alert("‚ùå Code incorrect")}
function toggleChangeCode(){if(!unlocked){alert("üîí D√©verrouille d'abord la zone ‚Ç¨");return}const box=document.getElementById("changeCodeBox");box.style.display=box.style.display==="none"?"block":"none"}
async function changeCode(){const o=document.getElementById("oldCode").value,n=document.getElementById("newCode").value,c=document.getElementById("confirmCode").value;if(!o||!n||!c){alert("‚ö†Ô∏è Remplis tous les champs");return}if(n.length<4){alert("‚ö†Ô∏è Code trop court");return}if(n!==c){alert("‚ùå Codes diff√©rents");return}if(await sha256(o)!==await getSecureCode()){alert("‚ùå Ancien code incorrect");return}localStorage.setItem(kCode(),await sha256(n));document.getElementById("changeCodeBox").style.display="none";["oldCode","newCode","confirmCode"].forEach(id=>document.getElementById(id).value="");alert("‚úÖ Code mis √† jour")}

/* SAUVEGARDE */
function save(){localStorage.setItem(`${STORAGE_PREFIX}_AUTO_SAVE_DATE`,Date.now());recalcCascade();Object.entries(ALL_DATA).forEach(([y,yd])=>saveYearData(y,yd));updateSaveBadge()}
function updateSaveBadge(){const el=document.querySelector(".badge.ok");if(!el)return;const stamp=Number(localStorage.getItem(`${STORAGE_PREFIX}_AUTO_SAVE_DATE`));el.textContent=(!stamp||isNaN(stamp))?"üü¢ Sauvegarde locale auto":"üü¢ Sauvegarde : "+new Date(stamp).toLocaleString()}
function registerYear(y){let idx=JSON.parse(localStorage.getItem(kIndex())||"[]");if(!idx.includes(y)){idx.push(y);idx.sort();localStorage.setItem(kIndex(),JSON.stringify(idx))}}
function loadYearData(y){return JSON.parse(localStorage.getItem(kData(y))||"{}")}
function saveYearData(y,d){localStorage.setItem(kData(y),JSON.stringify(d))}

/* PARAMS ‚Ç¨ */
["rate","coef25","coef50","coefNet"].forEach(id=>{const def={rate:10,coef25:1.25,coef50:1.50,coefNet:0.93}[id],inp=document.getElementById(id);inp.value=SETTINGS[id]??def;inp.oninput=()=>{SETTINGS[id]=parseFloat(inp.value)||0;localStorage.setItem(kSettings(),JSON.stringify(SETTINGS));recalc()}});

/* EXPORT */
function prepareExport(){createSnapshot("before_export",true);recalcCascade();saveYearData(getYearFromMonth(currentKey),ALL_DATA[getYearFromMonth(currentKey)])}
function exportJSON(){prepareExport();const y=getYearFromMonth(currentKey),p={exportedAt:new Date().toISOString(),year:y,appVersion:APP_VERSION,dataVersion:DATA_VERSION,DATA,SETTINGS};const b=new Blob([JSON.stringify(p,null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download="heures_sup_backup_"+Date.now()+".json";a.click();document.getElementById("fileDate").textContent=new Date().toLocaleDateString()}
function exportMonthlyPDF(){prepareExport();const{jsPDF}=window.jspdf,pdf=new jsPDF(),month=DATA[currentKey],{start,end}=getPeriodBounds(currentKey),paid=month.paid||0,pc=getPreviousCarry(currentKey);let y=15;pdf.setFontSize(14);pdf.text("R√©capitulatif mensuel ‚Äì Heures suppl√©mentaires",10,y);y+=8;pdf.setFontSize(11);pdf.text(`P√©riode : ${formatDate(start)} ‚Üí ${formatDate(end)}`,10,y);y+=10;pdf.text(`Report pr√©c√©dent : ${pc.toFixed(2)} h`,10,y);y+=6;pdf.text(`Total p√©riode : ${document.getElementById("totalMonth").textContent} h`,10,y);y+=6;pdf.text(`Heures pay√©es : ${paid.toFixed(2)} h`,10,y);y+=6;pdf.text(`Reliquat : ${month.carry.toFixed(2)} h`,10,y);y+=12;pdf.setFontSize(9);pdf.text("Document personnel ‚Äì valeurs indicatives",10,y);pdf.save(`heures_${currentKey}.pdf`)}
function exportAnnualPDF(){prepareExport();const{jsPDF}=window.jspdf,pdf=new jsPDF(),months=Object.keys(DATA).filter(k=>/^\d{4}-\d{2}$/.test(k)).sort();let y=15;pdf.setFontSize(14);pdf.text("Bilan annuel ‚Äì Heures suppl√©mentaires",10,y);y+=10;pdf.setFontSize(10);pdf.text("Mois",10,y);pdf.text("Carry fin",80,y);y+=6;months.forEach(k=>{const m=DATA[k];pdf.text(k,10,y);pdf.text((m.carry||0).toFixed(2)+" h",80,y);y+=6});pdf.save(`bilan_${months[0]?.slice(0,4)||"hs"}.pdf`)}
function formatDate(d){return d.toLocaleDateString("fr-FR")}
function importJSONFile(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=()=>{createSnapshot("before_import");let payload,dv="1.0";try{payload=JSON.parse(reader.result);dv=payload.dataVersion||"1.0"}catch{alert("‚ùå JSON invalide");return}if(typeof payload!=="object"||typeof payload.DATA!=="object"||!payload.year){alert("‚ùå Structure invalide");return}const year=String(payload.year);if(!/^\d{4}$/.test(year)){alert("‚ùå Ann√©e invalide");return}if(dv==="1.0")Object.values(payload.DATA).forEach(m=>{if(typeof m.closing!=="number")m.closing=null;if(typeof m.locked!=="boolean")m.locked=false});registerYear(year);const existing=loadYearData(year);let imp=0,rep=0;Object.entries(payload.DATA).forEach(([mk,m])=>{if(!/^\d{4}-\d{2}$/.test(mk))return;if(!m.days||typeof m.days!=="object"){m.days={};rep++}if(typeof m.paid!=="number")m.paid=0;if(typeof m.carry!=="number")m.carry=0;if(typeof m.closing!=="number")m.closing=null;if(typeof m.locked!=="boolean")m.locked=false;existing[mk]=m;imp++});saveYearData(year,existing);ALL_DATA[year]=existing;recalcCascade();DATA=ALL_DATA[getYearFromMonth(currentKey)];loadMonth();alert(`‚úÖ Import termin√©\nAnn√©e : ${year}\nMois : ${imp}${rep?"\nR√©par√©s : "+rep:""}`)};reader.readAsText(file);e.target.value=""}
document.getElementById("importFile").addEventListener("change",importJSONFile);

/* ANTI-CRASH */
window.onerror=function(msg,src,l,c,err){handleFatalError({type:"JS_ERROR",message:msg,source:src,lineno:l,colno:c,stack:err?.stack||null});return true};
window.addEventListener("unhandledrejection",ev=>{handleFatalError({type:"PROMISE_REJECTION",message:ev.reason?.message||String(ev.reason),stack:ev.reason?.stack||null})});
function safe(fn){return function(...args){try{return fn.apply(this,args)}catch(e){handleFatalError({type:"SAFE_FN",message:e.message,stack:e.stack})}}}
recalc=safe(recalc);renderCalendar=safe(renderCalendar);loadMonth=safe(loadMonth);save=safe(save);
function handleFatalError(err){console.error("üí•",err);localStorage.setItem("CA_HS_RECOVERY_MODE","1");try{localStorage.setItem("CA_HS_LAST_CRASH",JSON.stringify({date:new Date().toISOString(),error:err,state:{currentKey,unlocked}}))}catch(e){}if(document.getElementById("crashOverlay"))return;const ov=document.createElement("div");ov.id="crashOverlay";ov.style="position:fixed;inset:0;background:#0f1115;color:#fff;z-index:99999;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:20px;text-align:center";ov.innerHTML=`<h2>‚ö†Ô∏è Une erreur est survenue</h2><p style="opacity:.8;font-size:14px;max-width:500px">Aucune donn√©e n'a √©t√© supprim√©e.</p><button onclick="location.reload()" style="margin-top:15px;padding:12px 20px;border-radius:8px;border:none;background:#4FB3C2;color:white;font-size:15px">üîÑ Recharger</button>`;document.body.appendChild(ov)}

/* DEBUG */
const DEBUG_CODE="1234";
window.addEventListener("DOMContentLoaded",()=>{const dbg=document.getElementById("debugTrigger");if(dbg)dbg.addEventListener("click",()=>document.getElementById("debugGate").classList.add("open"))});
function closeDebugGate(){document.getElementById("debugGate").classList.remove("open")}
function validateDebugAccess(){const inp=document.getElementById("debugCode").value;if(inp!==DEBUG_CODE){alert("‚ùå Code incorrect");return}alert("üß™ Test de crash requis.");localStorage.setItem("CA_DEBUG","1");simulateCrash()}
function restartWizard(){
  if(!confirm("Relancer l'assistant de configuration ?\nTes donn√©es ne seront pas effac√©es.")) return;
  localStorage.removeItem("ONBOARDING_DONE");localStorage.removeItem("CA_HS_TRACKER_V1_ONBOARDING");
  openWizard();
}

function simulateCrash(){handleFatalError({type:"SIMULATED_CRASH",message:"Crash simul√©",stack:null})}

/* =======================
   FONCTIONS UTILITAIRES P√âRIODE
======================= */
function getPeriodData(monthKey){
  const{start,end}=getPeriodBounds(monthKey);
  let totalHours=0;
  const rows=[];
  Object.entries(ALL_DATA).forEach(([year,yearData])=>{
    Object.entries(yearData||{}).forEach(([key,month])=>{
      Object.entries(month.days||{}).forEach(([d,h])=>{
        const[y,m]=key.split("-").map(Number);
        const date=new Date(y,m-1,d);
        if(date>=start&&date<=end){totalHours+=h;rows.push({date,h});}
      });
    });
  });
  rows.sort((a,b)=>a.date-b.date);
  return{start,end,rows,totalHours};
}

function getPeriodHoursForMonth(monthKey){
  const{start,end}=getPeriodBounds(monthKey);
  let total=0;
  Object.entries(ALL_DATA).forEach(([year,yearData])=>{
    Object.entries(yearData||{}).forEach(([key,month])=>{
      Object.entries(month.days||{}).forEach(([d,h])=>{
        const[y,m]=key.split("-").map(Number);
        const date=new Date(y,m-1,d);
        if(date>=start&&date<=end)total+=h;
      });
    });
  });
  return total;
}

/* GESTION 12 CL√îTURES */
const MOIS_NOMS=["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];

function openClosuresModal(){
  const grid=document.getElementById("closuresGrid");
  grid.innerHTML="";
  const year=getYearFromMonth(currentKey);
  const y=parseInt(year);

  for(let m=0;m<12;m++){
    const mk=`${y}-${String(m+1).padStart(2,"0")}`;
    // S'assurer que le mois existe dans ALL_DATA
    if(!ALL_DATA[year]) ALL_DATA[year]={};
    if(!ALL_DATA[year][mk]) ALL_DATA[year][mk]={days:{},paid:0,carry:0,closing:getLastSunday(y,m),locked:false};

    const closing=ALL_DATA[year][mk].closing;
    const row=document.createElement("div"); row.className="closure-row";
    const lbl=document.createElement("label"); lbl.textContent=MOIS_NOMS[m]+" "+y;
    const inp=document.createElement("input"); inp.type="date"; inp.id="cls_"+m;
    if(closing){
      inp.value=`${y}-${String(m+1).padStart(2,"0")}-${String(closing).padStart(2,"0")}`;
    }
    // Contraindre au mois concern√©
    inp.min=`${y}-${String(m+1).padStart(2,"0")}-01`;
    const lastDay=new Date(y,m+1,0).getDate();
    inp.max=`${y}-${String(m+1).padStart(2,"0")}-${lastDay}`;

    inp.onchange=()=>{
      if(!inp.value) return;
      const sel=new Date(inp.value);
      if(sel.getDay()!==0){ alert("‚õî La cl√¥ture de "+MOIS_NOMS[m]+" doit √™tre un dimanche"); inp.value=""; return; }
    };

    row.appendChild(lbl); row.appendChild(inp); grid.appendChild(row);
  }

  document.getElementById("closuresModal").classList.add("open");
  lockBodyScroll();
}

function saveAllClosures(){
  const year=getYearFromMonth(currentKey);
  const y=parseInt(year);
  let changed=0;

  for(let m=0;m<12;m++){
    const mk=`${y}-${String(m+1).padStart(2,"0")}`;
    const inp=document.getElementById("cls_"+m);
    if(!inp) continue;

    if(!ALL_DATA[year]) ALL_DATA[year]={};
    if(!ALL_DATA[year][mk]) ALL_DATA[year][mk]={days:{},paid:0,carry:0,closing:getLastSunday(y,m),locked:false};

    if(inp.value){
      const sel=new Date(inp.value);
      if(sel.getDay()===0){
        ALL_DATA[year][mk].closing=sel.getDate();
        changed++;
      }
    } else {
      // Vide = auto : dernier dimanche
      ALL_DATA[year][mk].closing=getLastSunday(y,m);
      changed++;
    }
  }

  save();
  closeClosuresModal();
  // Resync l'input de cl√¥ture du mois courant
  syncClosingDate();
  renderCalendar();
  recalc();
  if(changed) alert("‚úÖ "+changed+" cl√¥ture(s) enregistr√©e(s)");
}

function closeClosuresModal(){
  document.getElementById("closuresModal").classList.remove("open");
  unlockBodyScroll();
}
</script>
</body>
</html>