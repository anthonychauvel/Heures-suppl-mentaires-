<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ü¶ä FOX Engine ‚Äî Heures Sup' Ultimate</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="gaming-mode">

<img id="bg-decor" src="../images/fox-bg.PNG" onerror="this.style.display='none'" style="position:fixed;top:0;left:0;width:100vw;height:100vh;object-fit:cover;object-position:center center;z-index:-999;pointer-events:none;">

<div id="burnout-overlay"></div>
<div id="storm-overlay"></div>
<div id="levelup-flash"></div>
<div id="levelup-banner">
  <div id="levelup-banner-stars" style="font-size:1.6rem;margin-bottom:4px;">&#11088;&#11088;&#11088;</div>
  <div style="color:#FFD700;font-weight:900;font-size:1.4rem;letter-spacing:2px;">NIVEAU <span id="levelup-banner-num">?</span> !</div>
  <div style="color:#FF8C42;font-size:0.85rem;margin-top:6px;" id="levelup-banner-sub">Tu progresses &#129418;</div>
</div>
<div id="badge-unlock-popup" style="cursor:pointer;" onclick="this.classList.remove('pop-in');this.classList.add('pop-out');">
  <div id="bup-img" style="font-size:2.5rem;margin-bottom:6px;"></div>
  <div id="bup-name" style="font-weight:900;font-size:1rem;"></div>
  <div id="bup-desc" style="font-size:0.75rem;color:#aaa;margin-top:4px;max-width:180px;"></div>
</div>
<div id="vignette-overlay"></div>

<div id="burnout-popup">
  <span class="burnout-icon">üî•</span>
  <div class="score-display" id="burnout-score-val">--</div>
  <h2>Signal Burn-Out D√©tect√©</h2>
  <p id="burnout-popup-msg">Votre situation pr√©sente des signaux de risque √©lev√©s.</p>
  <button class="btn-close-burnout" onclick="closeBurnoutPopup()">Voir mes droits ‚Üí</button>
</div>

<!-- HUD -->
<div id="gaming-hud">
  <div class="hud-logo" id="hud-logo-btn" onclick="demoLogoClick()" style="cursor:pointer;user-select:none;">ü¶ä FOX</div>
  <div class="hud-xp-section" onclick="openPopup('popup-leagues')" style="cursor:pointer;" title="Voir ma ligue">
    <div class="hud-xp-label">
      <span style="display:flex;align-items:center;gap:5px;">
        <span style="background:linear-gradient(135deg,rgba(255,140,66,0.4),rgba(255,107,53,0.3));border:1px solid rgba(255,140,66,0.7);border-radius:6px;padding:2px 8px;font-weight:900;font-size:0.85rem;text-shadow:0 0 8px rgba(255,140,66,0.6);">NIV <span id="hud-level">1</span></span>
        <span id="hud-league" style="background:rgba(205,127,50,0.2);border:1px solid rgba(205,127,50,0.5);border-radius:6px;padding:2px 8px;font-weight:700;font-size:0.75rem;margin-left:6px;">ü•â Bronze</span>
        <span id="hud-league" style="font-weight:900;font-size:0.82rem;"></span>
      </span>
      <span style="color:#FF8C42;font-weight:900;font-size:0.82rem;"><span id="hud-xp">0</span><span style="color:#444;font-size:0.65em;"> / <span id="hud-xp-max">1000</span></span> <span style="color:#888;font-size:0.65em;">XP</span></span>
    </div>
    <div class="hud-xp-bar" style="height:8px;"><div class="hud-xp-fill" id="hud-xp-fill" style="width:0%;background:linear-gradient(90deg,#FF8C42,#FFD700);"></div></div>
    <div style="display:flex;justify-content:space-between;font-size:0.58rem;color:#444;margin-top:2px;"><span id="hud-xp-percent">0%</span><span id="hud-next-league" style="color:#666;"></span></div>
  </div>
  <div class="hud-stats">
    <div class="hud-stat" onclick="openPopup('popup-modules')" title="Voir les donn√©es heures sup" style="cursor:pointer;"><div class="hud-stat-icon">‚è±Ô∏è</div><div class="hud-stat-val" id="hud-hours">0</div><div class="hud-stat-lbl">H.SUP</div></div>
    <div class="hud-stat" onclick="openPopup('popup-burnout')" title="Voir l'√©nergie et burn-out" style="cursor:pointer;"><div class="hud-stat-icon">‚ù§Ô∏è</div><div class="hud-stat-val" id="hud-energy">100</div><div class="hud-stat-lbl">√âNERGIE</div></div>
    <div class="hud-stat" onclick="openPopup('popup-burnout')" title="Voir le risque burn-out" style="cursor:pointer;"><div class="hud-stat-icon">üî•</div><div class="hud-stat-val" id="hud-burnout">0</div><div class="hud-stat-lbl">RISQUE</div></div>
    <div class="hud-stat" onclick="openPopup('popup-badges')" title="Voir mes badges" style="cursor:pointer;"><div class="hud-stat-icon">üèÖ</div><div class="hud-stat-val" id="hud-badges">0</div><div class="hud-stat-lbl">BADGES</div></div>
  </div>
  <div id="hud-buttons">
    <a href="../heures/index.html" class="hud-menu-btn hud-nav-btn" style="text-decoration:none;border-color:rgba(80,180,220,0.4);color:#50B4DC;" title="Module 1 ‚Äî Suivi annuel">üìÖ Annuel</a>
    <a href="../paye/index.html"   class="hud-menu-btn hud-nav-btn" style="text-decoration:none;border-color:rgba(80,200,120,0.4);color:#50C878;" title="Module 2 ‚Äî Paie mensuelle">üí∞ Mensuel</a>
    <button class="hud-menu-btn" onclick="openPopup('popup-settings')">‚öôÔ∏è</button>
    <a href="../menu.html" class="hud-menu-btn" style="text-decoration:none;">‚Üê Menu</a>
  </div>
</div>

<!-- ZONE PRINCIPALE -->
<div id="gaming-main">

  <!-- Bulle de dialogue Kitsune -->
  <div id="kitsune-shortcuts" style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center;padding:0 10px 6px;"></div>
  <div id="kitsune-bubble" onclick="openPopup('popup-fox')">
    <div id="kitsune-bubble-text">ü¶ä Je surveille tes heures et te guide !</div>
    <div class="bubble-tail"></div>
  </div>

  <!-- Renard central -->
  <div id="kitsune-center" onclick="openPopup('popup-fox')">
    <img id="kitsune-svg" src="../images/foxplayer.PNG" style="filter:brightness(1.2) contrast(1.1);mix-blend-mode:screen; alt="Kitsune" onerror="this.style.display='none'">
    <div id="kitsune-tap-hint">Appuie sur moi !</div>
  </div>

  <!-- Barre de risque centrale -->
  <div id="risk-bar-center">
    <div style="display:flex;justify-content:space-between;font-size:0.65rem;color:#fff;margin-bottom:4px;letter-spacing:1px;text-shadow:0 1px 6px rgba(0,0,0,0.9),0 0 12px rgba(0,0,0,0.8);font-weight:700;">
      <span>RISQUE GLOBAL</span><span id="risk-label-main">--</span>
    </div>
    <div class="risk-bar-track"><div class="risk-bar-fill" id="risk-bar-main" style="width:0%"></div></div>
  </div>

  <!-- Dock de boutons en bas -->
  <div id="action-dock">
    <button class="dock-btn" onclick="openPopup('popup-import')">
      <span class="dock-icon">üì•</span>
      <span class="dock-label">Importer</span>
    </button>
    <button class="dock-btn" onclick="openPopup('popup-modules')">
      <span class="dock-icon">üìä</span>
      <span class="dock-label">Donn√©es</span>
    </button>
    <button class="dock-btn" onclick="openPopup('popup-burnout')">
      <span class="dock-icon">üî•</span>
      <span class="dock-label">Burn-Out</span>
    </button>
    <button class="dock-btn" onclick="openPopup('popup-quetes')">
      <span class="dock-icon">‚öîÔ∏è</span>
      <span class="dock-label">Qu√™tes</span>
    </button>

    <button class="dock-btn" onclick="openPopup('popup-export')">
      <span class="dock-icon">üìÑ</span>
      <span class="dock-label">Export</span>
    </button>
    <button class="dock-btn" onclick="openPopup('popup-glossaire')">
      <span class="dock-icon">üìö</span>
      <span class="dock-label">Glossaire</span>
    </button>
    <button class="dock-btn" onclick="openPopup('popup-heatmap')">
      <span class="dock-icon">üóì</span>
      <span class="dock-label">Calendrier</span>
    </button>
    <button class="dock-btn" onclick="openPopup('popup-violations')">
      <span class="dock-icon">‚ö†Ô∏è</span>
      <span class="dock-label">Violations</span>
    </button>
    <button class="dock-btn" onclick="openPopup('popup-rapport')">
      <span class="dock-icon">üìã</span>
      <span class="dock-label">Rapport</span>
    </button>
    <button class="dock-btn" onclick="openPopup('popup-xp-history')">
      <span class="dock-icon">üìä</span>
      <span class="dock-label">XP</span>
    </button>
  </div>

</div>

<!-- POP-UP KITSUNE -->
<div class="fox-popup-backdrop" id="popup-fox">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">ü¶ä Kitsune ‚Äî ton alli√©</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-fox')">‚úï</button>
    </div>
    <div style="text-align:center;margin-bottom:12px;">
      <img src="../images/foxplayer.PNG" alt="Kitsune" style="width:90px;height:90px;object-fit:contain;">
    </div>
    <div style="font-size:0.65rem;color:#555;text-align:center;margin-bottom:6px;letter-spacing:0.5px;">
      ü¶ä Je te parle comme un ami ‚Äî pas comme un avocat. En cas de doute, consulte un pro !
    </div>
    <div id="fox-text" style="background:rgba(255,140,66,0.08);border:1px solid rgba(255,140,66,0.2);border-radius:12px;padding:14px;color:#ccc;line-height:1.6;font-size:0.9rem;margin-bottom:14px;">
      ü¶ä Salut ! Je surveille tes heures en ami. Clique sur moi depuis l'√©cran principal pour mes conseils !
    </div>
    <div id="kitsune-scenario-box" style="display:none;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:14px;margin-top:10px;color:#bbb;font-size:0.85rem;line-height:1.6;">
      <div id="kitsune-scenario-title" style="color:#FF8C42;font-weight:700;margin-bottom:8px;"></div>
      <div id="kitsune-scenario-text"></div>
      <div id="kitsune-scenario-actions" style="margin-top:10px;display:flex;flex-wrap:wrap;gap:6px;"></div>
    </div>
    <!-- Historique r√©compenses -->
    <!-- Graphique √©volution -->
    <div id="kitsune-chart-section" style="margin-top:12px;border-top:1px solid rgba(255,255,255,0.07);padding-top:12px;">
      <div style="color:#666;font-size:0.68rem;letter-spacing:1px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
        <span>üìä √âVOLUTION 12 MOIS</span>
        <div style="display:flex;gap:6px;">
          <button onclick="renderEvolutionChart('month')" id="chart-btn-month" style="background:rgba(255,140,66,0.15);border:1px solid rgba(255,140,66,0.4);color:#FF8C42;border-radius:5px;padding:2px 7px;font-size:0.62rem;cursor:pointer;">Mois</button>
          <button onclick="renderEvolutionChart('week')" id="chart-btn-week" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);color:#666;border-radius:5px;padding:2px 7px;font-size:0.62rem;cursor:pointer;">Semaines</button>
        </div>
      </div>
      <div id="kitsune-chart-container" style="width:100%;overflow-x:auto;">
        <div style="color:#444;font-size:0.75rem;text-align:center;padding:16px;">Chargement‚Ä¶</div>
      </div>
      <div id="kitsune-chart-legend" style="display:flex;gap:12px;justify-content:center;margin-top:6px;flex-wrap:wrap;"></div>
    </div>

    <!-- Comparaison annuelle N vs N-1 -->
    <div id="kitsune-annual-section" style="margin-top:12px;border-top:1px solid rgba(255,255,255,0.07);padding-top:12px;">
      <div style="color:#666;font-size:0.68rem;letter-spacing:1px;margin-bottom:8px;">
        üìÜ COMPARAISON ANNUELLE
      </div>
      <div id="kitsune-annual-content">
        <div style="color:#444;font-size:0.75rem;text-align:center;padding:10px;">Chargement‚Ä¶</div>
      </div>
    </div>

    <!-- Patterns d√©tect√©s -->
    <div id="kitsune-patterns-section" style="margin-top:14px;border-top:1px solid rgba(255,255,255,0.07);padding-top:12px;">
      <div style="color:#666;font-size:0.68rem;letter-spacing:1px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
        <span>üîç PATTERNS D√âTECT√âS</span>
        <button onclick="refreshPatternsSection()" style="background:none;border:none;color:#FF8C42;font-size:0.65rem;cursor:pointer;">Actualiser</button>
      </div>
      <div id="kitsune-patterns-list" style="display:flex;flex-direction:column;gap:6px;">
        <div style="color:#444;font-size:0.78rem;text-align:center;padding:10px;">Chargement‚Ä¶</div>
      </div>
    </div>

    <!-- Journal Kitsune -->
    <div id="kitsune-journal-section" style="margin-top:14px;border-top:1px solid rgba(255,255,255,0.07);padding-top:12px;">
      <div style="color:#666;font-size:0.68rem;letter-spacing:1px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
        <span>üìú JOURNAL KITSUNE</span>
        <button onclick="clearKitsuneJournal()" style="background:none;border:none;color:#333;font-size:0.65rem;cursor:pointer;">Effacer</button>
      </div>
      <div id="kitsune-journal-log" style="max-height:180px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;">
        <div style="color:#444;font-size:0.78rem;text-align:center;padding:8px;">Aucune analyse pour l'instant</div>
      </div>
    </div>

    <!-- Lien glossaire -->
    <div style="text-align:center;margin-top:10px;margin-bottom:4px;">
      <button onclick="openPopup('popup-glossaire')" style="background:none;border:1px solid rgba(255,140,66,0.2);color:rgba(255,140,66,0.6);border-radius:7px;padding:5px 14px;font-size:0.72rem;cursor:pointer;">üìö Glossaire juridique</button>
    </div>
    <div id="kitsune-rewards-section" style="margin-top:14px;border-top:1px solid rgba(255,255,255,0.07);padding-top:12px;">
      <div style="color:#666;font-size:0.68rem;letter-spacing:1px;margin-bottom:8px;">üìú HISTORIQUE R√âCOMPENSES</div>
      <div id="kitsune-rewards-log" style="max-height:160px;overflow-y:auto;display:flex;flex-direction:column;gap:5px;">
        <div style="color:#444;font-size:0.78rem;text-align:center;padding:8px;">Aucune r√©compense d√©bloqu√©e pour l'instant</div>
      </div>
    </div>
  </div>
</div>

<!-- POP-UP ANALYSE -->
<div class="fox-popup-backdrop" id="popup-analyse">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">‚öñÔ∏è Analyse Juridique</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-analyse')">‚úï</button>
    </div>
    <div style="font-size:0.75rem;color:#666;letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">Saisie semaine courante (heures/jour)</div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:10px;">
      <div style="text-align:center;font-size:0.65rem;color:#555;">Lun</div><div style="text-align:center;font-size:0.65rem;color:#555;">Mar</div><div style="text-align:center;font-size:0.65rem;color:#555;">Mer</div><div style="text-align:center;font-size:0.65rem;color:#555;">Jeu</div><div style="text-align:center;font-size:0.65rem;color:#555;">Ven</div><div style="text-align:center;font-size:0.65rem;color:#555;">Sam</div><div style="text-align:center;font-size:0.65rem;color:#555;">Dim</div>
      <input class="day-input" type="number" min="0" max="24" value="7" id="day0">
      <input class="day-input" type="number" min="0" max="24" value="7" id="day1">
      <input class="day-input" type="number" min="0" max="24" value="7" id="day2">
      <input class="day-input" type="number" min="0" max="24" value="7" id="day3">
      <input class="day-input" type="number" min="0" max="24" value="7" id="day4">
      <input class="day-input" type="number" min="0" max="24" value="0" id="day5">
      <input class="day-input" type="number" min="0" max="24" value="0" id="day6">
    </div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px;">
      <label style="display:flex;align-items:center;gap:5px;font-size:0.82rem;color:#aaa;cursor:pointer;"><input type="checkbox" id="chk-night"> Nuit</label>
      <label style="display:flex;align-items:center;gap:5px;font-size:0.82rem;color:#aaa;cursor:pointer;"><input type="checkbox" id="chk-sunday"> Dimanche</label>
      <label style="display:flex;align-items:center;gap:5px;font-size:0.82rem;color:#aaa;cursor:pointer;"><input type="checkbox" id="chk-saturday"> Samedi</label>
      <label style="display:flex;align-items:center;gap:5px;font-size:0.82rem;color:#aaa;cursor:pointer;"><input type="checkbox" id="chk-holiday"> F√©ri√©</label>
    </div>
    <button onclick="runAnalyse()" style="width:100%;background:linear-gradient(135deg,#FF8C42,#FF6B35);border:none;color:#fff;border-radius:12px;padding:13px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 4px 20px rgba(255,140,66,0.3);">‚ö° Analyser maintenant</button>
    <div id="analyse-results" style="display:none;margin-top:16px;">
      <div id="analyse-summary" style="background:rgba(255,140,66,0.08);border:1px solid rgba(255,140,66,0.2);border-radius:12px;padding:14px;color:#ccc;font-size:0.88rem;line-height:1.6;margin-bottom:10px;"></div>
      <div id="analyse-violations" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;"></div>
      <div id="analyse-scenarios" style="display:flex;flex-direction:column;gap:8px;"></div>
    </div>
  </div>
</div>

<!-- POP-UP MODULES -->
<div class="fox-popup-backdrop" id="popup-modules">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">üìä Donn√©es M1 &amp; M2</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-modules')">‚úï</button>
    </div>
    <div id="modules-content" style="color:#ccc;font-size:0.9rem;"></div>
  </div>
</div>

<!-- POP-UP BURN-OUT -->
<div class="fox-popup-backdrop" id="popup-burnout">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">üî• Score Burn-Out</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-burnout')">‚úï</button>
    </div>
    <div id="burnout-popup-content" style="color:#ccc;"></div>
  </div>
</div>

<!-- POP-UP QUETES -->
<div class="fox-popup-backdrop" id="popup-quetes">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">‚öîÔ∏è Qu√™tes &amp; Combats</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-quetes')">‚úï</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
      <button onclick="openPopup('popup-badges')" style="background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.2);color:#FFD700;border-radius:12px;padding:14px;cursor:pointer;font-size:0.88rem;font-weight:700;">üèÖ Mes Badges</button>
      <button onclick="openPopup('popup-skills')" style="background:rgba(100,200,255,0.08);border:1px solid rgba(100,200,255,0.2);color:#64C8FF;border-radius:12px;padding:14px;cursor:pointer;font-size:0.88rem;font-weight:700;">üåü Comp√©tences</button>
    </div>
    <div id="quests-list" style="display:flex;flex-direction:column;gap:8px;"></div>
  </div>
</div>

<!-- POP-UP SCENARIOS -->
<div class="fox-popup-backdrop" id="popup-scenarios">
  <div class="fox-popup" style="max-width:680px;">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">üìö Sc√©narios FOX (600)</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-scenarios')">‚úï</button>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
      <input id="scenario-search" type="text" placeholder="Rechercher‚Ä¶"
        style="flex:1;min-width:160px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);color:#fff;border-radius:8px;padding:8px 12px;font-size:0.85rem;"
        oninput="filterScenarios()">
      <select id="scenario-risk" onchange="filterScenarios()"
        style="background:rgba(20,20,40,0.95);border:1px solid rgba(255,255,255,0.15);color:#fff;border-radius:8px;padding:8px 10px;font-size:0.85rem;">
        <option value="">Tous risques</option>
        <option value="aucun">‚úÖ Aucun</option>
        <option value="faible">üíõ Faible</option>
        <option value="moyen">üß° Moyen</option>
        <option value="√©lev√©">üî¥ √âlev√©</option>
        <option value="critique">üö® Critique</option>
      </select>
    </div>
    <div id="scenarios-list" style="max-height:420px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;"></div>
    <div id="scenarios-count" style="text-align:center;color:#555;font-size:0.75rem;margin-top:8px;"></div>
  </div>
</div>

<!-- POP-UP EXPORT -->
<div class="fox-popup-backdrop" id="popup-export">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">üìÑ Exporter</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-export')">‚úï</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <button onclick="exportRTFFull()"    class="export-btn">üìù RTF complet</button>
      <button onclick="exportJSONFull()"   class="export-btn">üì¶ JSON tout</button>
      <button onclick="exportModule1()"    class="export-btn">üìä JSON M1</button>
      <button onclick="exportModule2()"    class="export-btn">üìä JSON M2</button>
      <button onclick="exportHistorique()" class="export-btn" style="grid-column:span 2;background:rgba(255,140,66,0.1);color:#FF8C42;">üï∞Ô∏è Historique multi-ann√©es</button>
    </div>
  </div>
</div>



<!-- POP-UP LEAGUES -->
<div class="fox-popup-backdrop" id="popup-leagues">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">üèÜ Ligues de progression</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-leagues')">‚úï</button>
    </div>
    <div id="leagues-grid" style="display:flex;flex-direction:column;gap:8px;max-height:480px;overflow-y:auto;"></div>
  </div>
</div>

<!-- POP-UP IMPORT -->
<div class="fox-popup-backdrop" id="popup-import">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">üì• Importer des donn√©es</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-import')">‚úï</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:12px;color:#ccc;font-size:0.88rem;">
      <div style="background:rgba(255,140,66,0.06);border:1px solid rgba(255,140,66,0.15);border-radius:10px;padding:12px;line-height:1.6;">
        üìÇ Pour importer tes donn√©es M1 ou M2, ouvre directement le <strong style="color:#FF8C42;">Module 1</strong> ou <strong style="color:#FF8C42;">Module 2</strong> depuis le menu principal et saisis tes heures. FOX d√©tecte automatiquement les nouvelles donn√©es.
      </div>
      <div style="color:#666;font-size:0.72rem;letter-spacing:1px;margin-top:4px;">IMPORT FICHIER JSON</div>
      <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:12px;">
        <input type="file" id="import-json-file" accept=".json" style="color:#aaa;font-size:0.82rem;width:100%;" onchange="importJSONFile(this)">
        <div style="color:#555;font-size:0.72rem;margin-top:6px;">Format : export JSON FOX Engine (M1, M2 ou complet)</div>
      </div>
      <button onclick="importFromClipboard()" style="background:rgba(100,200,255,0.08);border:1px solid rgba(100,200,255,0.2);color:#64C8FF;border-radius:10px;padding:11px;font-weight:700;cursor:pointer;">üìã Coller depuis le presse-papier</button>
      <div id="import-status" style="display:none;border-radius:10px;padding:10px;font-size:0.82rem;text-align:center;"></div>
    </div>
  </div>
</div>
<!-- POP-UP BADGES -->
<div class="fox-popup-backdrop" id="popup-badges">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">üèÖ Collection Badges</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-badges')">‚úï</button>
    </div>

    <div id="badges-filter" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;">
      <button onclick="filterBadgesByRarity('all')" class="badge-filter-btn active" data-rarity="all">Tous</button>
      <button onclick="filterBadgesByRarity('common')" class="badge-filter-btn" data-rarity="common" style="color:#b0b0b0;">Communs</button>
      <button onclick="filterBadgesByRarity('rare')" class="badge-filter-btn" data-rarity="rare" style="color:#5094ff;">Rares</button>
      <button onclick="filterBadgesByRarity('epic')" class="badge-filter-btn" data-rarity="epic" style="color:#a050ff;">√âpiques</button>
      <button onclick="filterBadgesByRarity('legendary')" class="badge-filter-btn" data-rarity="legendary" style="color:#FFD700;">L√©gendaires</button>
      <button onclick="showBadgesHistory()" class="badge-filter-btn" data-rarity="history" style="color:#FFD700;">üìú Historique</button>
    </div>
    <div id="badges-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(76px,1fr));gap:8px;max-height:420px;overflow-y:auto;"></div>
    <div id="badges-history" style="display:none;max-height:420px;overflow-y:auto;"></div>
  </div>
</div>

<!-- POP-UP COMP√âTENCES (IDs 51-65) -->
<div class="fox-popup-backdrop" id="popup-skills">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">üåü Comp√©tences</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-skills')">‚úï</button>
    </div>
    <div style="color:#555;font-size:0.75rem;margin-bottom:10px;">R√©compenses li√©es √† ton utilisation de FOX Engine</div>
    <div id="skills-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(76px,1fr));gap:8px;max-height:420px;overflow-y:auto;"></div>
  </div>
</div>

<!-- Image agrandie (badges/comp√©tences) -->
<div id="badge-zoom-overlay" onclick="this.style.display='none'" style="display:none;position:fixed;inset:0;z-index:200000;background:rgba(0,0,0,0.88);align-items:center;justify-content:center;flex-direction:column;cursor:pointer;">
  <img id="badge-zoom-img" src="" style="max-width:260px;max-height:260px;object-fit:contain;border-radius:16px;box-shadow:0 0 60px rgba(255,140,66,0.4);">
  <div id="badge-zoom-name" style="color:#FF8C42;font-weight:900;font-size:1.1rem;margin-top:16px;"></div>
  <div id="badge-zoom-desc" style="color:#888;font-size:0.85rem;margin-top:6px;max-width:280px;text-align:center;"></div>
</div>

<!-- POP-UP SETTINGS -->
<div class="fox-popup-backdrop" id="popup-settings">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">‚öôÔ∏è Options</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-settings')">‚úï</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:16px;color:#ccc;font-size:0.9rem;">

      <!-- Profil Kitsune -->
      <div>
        <div style="color:#FF8C42;font-size:0.72rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">ü¶ä Profil Kitsune</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div>
            <label style="color:#888;font-size:0.72rem;display:block;margin-bottom:4px;">Pr√©nom (affich√© par Kitsune)</label>
            <input id="setting-prenom" type="text" maxlength="20" placeholder="Ton pr√©nom‚Ä¶"
              style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);color:#fff;border-radius:8px;padding:8px 11px;font-size:0.85rem;box-sizing:border-box;"
              oninput="saveKitsuneProfile()">
          </div>
          <div>
            <label style="color:#888;font-size:0.72rem;display:block;margin-bottom:4px;">Secteur d'activit√©</label>
            <select id="setting-secteur" onchange="saveKitsuneProfile()"
              style="width:100%;background:rgba(20,15,40,0.9);border:1px solid rgba(255,255,255,0.12);color:#ccc;border-radius:8px;padding:8px 11px;font-size:0.85rem;box-sizing:border-box;">
              <option value="">Non pr√©cis√©</option>
              <option value="commerce">Commerce / Distribution (d√©tail)</option>
              <option value="commerce_gros">Commerce de gros</option>
              <option value="btp">BTP / Construction</option>
              <option value="sante">Sant√© / Social</option>
              <option value="transport">Transport / Logistique</option>
              <option value="hotellerie">H√¥tellerie / Restauration</option>
              <option value="industrie">Industrie / Production</option>
              <option value="bureaux">Bureaux / Tertiaire</option>
              <option value="informatique">Informatique / Tech</option>
              <option value="education">√âducation / Formation</option>
              <option value="autre">Autre</option>
            </select>
          </div>

        </div>
        <div id="setting-save-status" style="color:#4CAF50;font-size:0.7rem;margin-top:5px;min-height:14px;"></div>
      </div>
      <div style="border-top:1px solid rgba(255,255,255,0.07);padding-top:14px;">
        <div style="color:#888;font-size:0.72rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Animations d'alerte</div>
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" id="toggle-burnout-anim" checked onchange="toggleBurnoutAnimations(this.checked)">
          Effets visuels burn-out actifs
        </label>
      </div>
      <div>
        <div style="color:#888;font-size:0.72rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Ann√©es dans localStorage</div>
        <div id="detected-years" style="color:#FF8C42;font-size:0.88rem;">‚Äî</div>
      </div>
      <div>
        <div style="color:#888;font-size:0.72rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Reset RPG</div>
        <button onclick="resetRPGConfirm()" style="background:rgba(229,57,53,0.1);border:1px solid rgba(229,57,53,0.25);color:#E53935;border-radius:8px;padding:8px 16px;cursor:pointer;font-size:0.85rem;">üóëÔ∏è R√©initialiser progression RPG</button>
      </div>
      <div>
        <div style="color:#888;font-size:0.72rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Diagnostic</div>
        <button onclick="debugM1Data()" style="background:rgba(255,140,66,0.08);border:1px solid rgba(255,140,66,0.2);color:#FF8C42;border-radius:8px;padding:8px 16px;cursor:pointer;font-size:0.85rem;">üîç Debug lecture M1</button>
      </div>
    </div>
  </div>
</div>


<style>
/* Animations r√©compenses */
@keyframes badgeUnlock {
  0%  { transform: scale(0.3) rotate(-15deg); opacity: 0; }
  60% { transform: scale(1.2) rotate(5deg);  opacity: 1; }
  80% { transform: scale(0.95); }
  100%{ transform: scale(1); }
}
@keyframes levelUpPulse {
  0%   { box-shadow: 0 0 0 0 rgba(255,215,0,0.7); transform: scale(1); }
  50%  { box-shadow: 0 0 0 20px rgba(255,215,0,0); transform: scale(1.05); }
  100% { box-shadow: 0 0 0 0 rgba(255,215,0,0); transform: scale(1); }
}
@keyframes rewardPop {
  0%   { transform: translateY(30px); opacity: 0; }
  100% { transform: translateY(0);    opacity: 1; }
}
.badge-unlock-anim { animation: badgeUnlock 0.6s ease forwards; }
.level-up-anim    { animation: levelUpPulse 1s ease 3; }

/* HUD stat cliquable */
.hud-stat { transition: transform 0.15s, background 0.15s; border-radius: 8px; padding: 4px 6px; }
.hud-stat:hover { transform: scale(1.08); background: rgba(255,140,66,0.12); }

/* Badge filter buttons */
.badge-filter-btn {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.12);
  color: #888;
  border-radius: 8px;
  padding: 4px 10px;
  font-size: 0.75rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}
.badge-filter-btn.active, .badge-filter-btn:hover {
  background: rgba(255,140,66,0.15);
  border-color: rgba(255,140,66,0.4);
  color: #FF8C42;
}

/* Badge zoom overlay flex */
#badge-zoom-overlay { display: none; }
#badge-zoom-overlay.show { display: flex !important; }

/* R√©compense verrouill√©e */
.badge-locked {
  filter: grayscale(100%) brightness(0.3);
  cursor: default;
}
.badge-locked-icon {
  position: absolute; top: 2px; right: 2px;
  font-size: 0.65rem; color: #444;
}

/* Mode d√©mo ‚Äî sidebar droite, pas plein √©cran */
/* ‚îÄ‚îÄ MODE DEV : barre horizontale au-dessus du dock ‚îÄ‚îÄ */
#action-dock {
  transition: margin-bottom 0.25s ease;
  display: flex !important;
  overflow-x: auto !important;
  -webkit-overflow-scrolling: touch !important;
  scroll-snap-type: x mandatory !important;
  padding: 8px 4px 24px 4px !important;
  gap: 2px !important;
  flex-wrap: nowrap !important;
}
#action-dock::-webkit-scrollbar { display: none; }
#action-dock .dock-btn {
  scroll-snap-align: start;
  flex-shrink: 0 !important;
  min-width: 58px !important;
}
#popup-demo-panel {
  position: fixed !important;
  bottom: 0 !important; left: 0 !important; right: 0 !important;
  top: auto !important; width: auto !important;
  max-width: 100% !important;
  z-index: 9998 !important;
  background: rgba(6,6,18,0.98) !important;
  border-top: 1.5px solid rgba(255,140,66,0.35) !important;
  box-shadow: 0 -6px 30px rgba(0,0,0,0.7) !important;
  overflow: visible !important;
}
/* Tiroir contenu ‚Äî se r√©tracte */
#dev-drawer {
  max-height: 48vh;
  overflow-y: auto;
  overflow-x: hidden;
  transition: max-height 0.28s ease, opacity 0.22s ease;
  opacity: 1;
}
#dev-drawer.collapsed {
  max-height: 0 !important;
  opacity: 0;
  pointer-events: none;
}
/* Barre d'onglets horizontale scrollable */
#dev-tabbar {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 5px 8px 5px 8px;
  padding-bottom: max(5px, env(safe-area-inset-bottom));
  overflow-x: auto;
  white-space: nowrap;
  scrollbar-width: none;
  border-top: 1px solid rgba(255,140,66,0.15);
  background: rgba(4,4,14,0.98);
  -webkit-overflow-scrolling: touch;
}
#dev-tabbar::-webkit-scrollbar { display: none; }
.dev-tabbar-btn {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  color: #888;
  border-radius: 7px;
  padding: 5px 10px;
  font-size: 0.7rem;
  font-weight: 700;
  cursor: pointer;
  white-space: nowrap;
  flex-shrink: 0;
  transition: all 0.18s;
}
.dev-tabbar-btn.active {
  background: rgba(255,140,66,0.18);
  border-color: rgba(255,140,66,0.55);
  color: #FF8C42;
}
.dev-tabbar-btn:active {
  transform: scale(0.94);
}

.ob-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: rgba(255,255,255,0.15); transition: background 0.3s;
}
.ob-dot.active { background: #FF8C42; }
.ob-step { animation: fadeInUp 0.35s ease; }
@keyframes fadeInUp {
  from { opacity:0; transform: translateY(16px); }
  to   { opacity:1; transform: translateY(0); }
}

/* Notification hebdo */
#weekly-notif {
  position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
  background: linear-gradient(135deg,rgba(20,15,40,0.97),rgba(12,8,28,0.97));
  border: 1px solid rgba(255,140,66,0.4); border-radius: 14px;
  padding: 12px 18px; z-index: 9990; max-width: 300px; width: 90%;
  display: none; flex-direction: column; gap: 8px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  animation: slideUp 0.4s cubic-bezier(0.34,1.56,0.64,1);
}
#weekly-notif.visible { display: flex; }
@keyframes slideUp {
  from { opacity:0; transform: translateX(-50%) translateY(20px); }
  to   { opacity:1; transform: translateX(-50%) translateY(0); }
}

/* Journal Kitsune entries */
.journal-entry {
  background: rgba(255,255,255,0.03);
  border-left: 3px solid rgba(255,140,66,0.3);
  border-radius: 0 8px 8px 0;
  padding: 8px 10px;
  font-size: 0.78rem;
  color: #aaa;
  line-height: 1.5;
}
.journal-entry .je-date { color:#444; font-size:0.65rem; float:right; }
.journal-entry .je-title { color:#FF8C42; font-weight:700; margin-bottom:3px; }
.journal-entry.je-danger  { border-left-color: #E53935; }
.journal-entry.je-warning { border-left-color: #FF8C42; }
.journal-entry.je-ok      { border-left-color: #4CAF50; }

/* Bilan mensuel */
.monthly-stat {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 14px;
  background: rgba(255,255,255,0.04);
  border-radius: 10px; margin-bottom: 8px;
}
.monthly-stat .ms-label { color:#888; font-size:0.82rem; }
.monthly-stat .ms-val   { color:#FF8C42; font-weight:900; font-size:1.1rem; }

/* Notification hebdo */
.glossaire-card {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.07);
  border-radius: 10px;
  padding: 11px 13px;
  cursor: default;
  transition: background 0.15s;
}
.glossaire-card:hover { background: rgba(255,255,255,0.06); }
.glossaire-card .gc-art {
  color: #FF8C42; font-size: 0.7rem; font-weight: 900;
  letter-spacing: 0.5px; margin-bottom: 4px;
}
.glossaire-card .gc-titre {
  color: #fff; font-size: 0.88rem; font-weight: 700; margin-bottom: 5px;
}
.glossaire-card .gc-def {
  color: #aaa; font-size: 0.8rem; line-height: 1.6;
}
.glossaire-card .gc-ex {
  margin-top: 6px; padding: 6px 10px;
  background: rgba(255,140,66,0.07);
  border-left: 2px solid rgba(255,140,66,0.3);
  border-radius: 0 6px 6px 0;
  color: #888; font-size: 0.75rem; font-style: italic;
}
.glossaire-card .gc-kw {
  display: inline-block; background: rgba(255,140,66,0.1);
  border: 1px solid rgba(255,140,66,0.2); border-radius: 4px;
  padding: 1px 6px; font-size: 0.65rem; color: #FF8C42; margin: 2px 2px 0 0;
}

.vfilter-btn {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  color: #666; border-radius: 7px;
  padding: 4px 10px; font-size: 0.72rem;
  cursor: pointer; transition: all 0.15s;
}
.vfilter-btn.active {
  background: rgba(255,140,66,0.15);
  border-color: rgba(255,140,66,0.4);
  color: #FF8C42;
}
.violation-entry {
  background: rgba(255,255,255,0.03);
  border-left: 3px solid #555;
  border-radius: 0 8px 8px 0;
  padding: 8px 11px;
  font-size: 0.78rem;
}
.violation-entry.ve-danger { border-left-color: #E53935; }
.violation-entry.ve-warning { border-left-color: #FF8C42; }
.violation-entry .ve-date { color:#444;font-size:0.65rem;float:right; }
.violation-entry .ve-titre { font-weight:700;margin-bottom:3px; }
.violation-entry.ve-danger .ve-titre { color:#E53935; }
.violation-entry.ve-warning .ve-titre { color:#FF8C42; }
.ve-art { color:#444;font-size:0.65rem;margin-top:3px; }

/* Rapport */
.rapport-section {
  margin-bottom:14px;
  padding-bottom:12px;
  border-bottom:1px solid rgba(255,255,255,0.06);
}
.rapport-section:last-child { border-bottom:none; }
.rapport-title { color:#FF8C42;font-weight:900;font-size:0.8rem;letter-spacing:1px;margin-bottom:8px;text-transform:uppercase; }
.rapport-row {
  display:flex;justify-content:space-between;align-items:center;
  padding:5px 0;font-size:0.82rem;
}
.rapport-row .rr-label { color:#888; }
.rapport-row .rr-val   { font-weight:700;color:#ccc; }
.rapport-row .rr-ok    { color:#4CAF50; }
.rapport-row .rr-warn  { color:#FF8C42; }
.rapport-row .rr-danger{ color:#E53935; }

/* Heatmap */
.hm-day {
  width: 11px; height: 11px; border-radius: 2px;
  cursor: pointer; flex-shrink: 0;
  transition: transform 0.1s, opacity 0.1s;
}
.hm-day:hover { transform: scale(1.4); opacity: 0.9; }
.hm-month-label { color:#444; font-size:7px; text-align:center; margin-bottom:2px; }
.hm-weekday-labels { display:flex; flex-direction:column; gap:1px; margin-right:4px; padding-top:16px; }
.hm-weekday-label { height:11px; font-size:6.5px; color:#333; line-height:11px; }

/* Notification r√©compense */
.reward-notification {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, rgba(20,20,40,0.97), rgba(30,20,50,0.97));
  border: 2px solid #FFD700;
  border-radius: 16px;
  padding: 14px 20px;
  z-index: 9990;
  text-align: center;
  animation: rewardPop 0.4s ease forwards;
  box-shadow: 0 0 40px rgba(255,215,0,0.3);
  max-width: 300px;
}

/* Ligue dans HUD ‚Äî plus visible */
#hud-league { font-size: 0.82rem; color: #FFD700; }
#hud-league img { filter: drop-shadow(0 0 4px rgba(255,215,0,0.5)); }

/* BARRE HUD OPAQUE PAR D√âFAUT */
#gaming-hud {
  background: linear-gradient(135deg, 
    rgba(25, 30, 40, 1) 0%, 
    rgba(35, 40, 50, 1) 50%, 
    rgba(25, 30, 40, 1) 100%) !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
}


/* FIX affichage grands nombres XP */
#hud-xp, #hud-xp-max {
  max-width: 60px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

#hud-level {
  min-width: 20px;
}


/* POPUP RAPPORT PLUS LARGE */
#popup-rapport .fox-popup {
  max-width: 90vw !important;
  width: 800px !important;
  max-height: 90vh !important;
}

#popup-rapport .fox-popup-body {
  max-height: 70vh !important;
  overflow-y: auto !important;
}

/* Texte rapport lisible */
#rapport-content {
  max-height: 60vh;
  overflow-y: auto;
  padding-right: 10px;
}

/* Emp√™cher superposition select */
#popup-rapport select {
  position: relative;
  z-index: 1;
  margin-bottom: 10px;
}

</style>
<style>
.day-input{width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#fff;border-radius:6px;padding:7px 2px;text-align:center;font-size:0.9rem;-moz-appearance:textfield;}
.day-input::-webkit-outer-spin-button,.day-input::-webkit-inner-spin-button{-webkit-appearance:none;}
.day-input:focus{outline:none;border-color:#FF8C42;}
.export-btn{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);color:#ddd;border-radius:10px;padding:12px 8px;cursor:pointer;font-size:0.85rem;transition:all 0.2s;}
.export-btn:hover{background:rgba(255,140,66,0.1);border-color:rgba(255,140,66,0.3);color:#FF8C42;}
.violation-tag{display:inline-flex;align-items:center;gap:5px;background:rgba(229,57,53,0.12);border:1px solid rgba(229,57,53,0.25);border-radius:8px;padding:5px 10px;font-size:0.78rem;color:#ff8a80;}
.scenario-card-mini{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:9px;padding:11px 13px;cursor:pointer;transition:all 0.2s;}
.scenario-card-mini:hover{background:rgba(255,140,66,0.05);border-color:rgba(255,140,66,0.2);}
.scenario-card-mini .sc-name{font-weight:700;color:#eee;font-size:0.87rem;}
.scenario-card-mini .sc-legal{font-size:0.76rem;color:#777;margin-top:3px;}
</style>

<!-- Scripts (ordre inchang√©) -->
<script src="js/storage.js"></script>
<script src="js/config.js"></script>
<script src="js/module-reader.js"></script>
<script src="js/xp-system.js"></script>
<script src="js/leagues.js"></script>
<script src="js/badges.js"></script>
<script src="js/scenarios-fox-data.js"></script>
<script src="js/data-bridge.js"></script>
<script src="js/snapshot-system.js"></script>
<script src="js/export-rtf.js"></script>
<script src="js/ai-integration.js"></script>
<!-- <script src="js/main-rpg.js"></script> -->

<script>
/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
   ORCHESTRATEUR GAMING UI
\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */


// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
//  KITSUNE : narration automatique lors de nouvelles HS
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550

// ‚îÄ‚îÄ Messages Kitsune enrichis (contextuels selon heure + jour + niveau) ‚îÄ‚îÄ
const _kitsuneMessages = [
  { min: 0.5, max: 2,  msg: 'ü¶ä +{h}h sup d√©tect√©es. Une petite heure de plus‚Ä¶ rappelle-toi : apr√®s 35h, chaque heure doit √™tre compens√©e ou major√©e (Art. L3121-28).' },
  { min: 2,   max: 5,  msg: 'ü¶ä {h}h sup suppl√©mentaires. Tu cumules. Ces heures doivent figurer sur ton bulletin de paie le mois suivant.' },
  { min: 5,   max: 10, msg: 'ü¶ä {h}h sup cette semaine ! Au-del√† de 43h, le taux de majoration passe √† 50% selon ta convention collective.' },
  { min: 10,  max: 20, msg: 'ü¶ä {h}h sup d√©tect√©es ‚Äî c\'est significatif. V√©rifie ton contingent annuel (220h maximum, Art. L3121-33).' },
  { min: 20,  max: 999, msg: 'ü¶ä {h}h sup d\'un coup. Pense √† demander une r√©cup√©ration ou un repos compensateur (Art. L3121-33).' },
];

// ‚îÄ‚îÄ Messages contextuels selon le jour / moment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _getContextualGreeting() {
  const now  = new Date();
  const day  = now.getDay();   // 0=dim, 1=lun ‚Ä¶ 6=sam
  const hour = now.getHours();
  const date = now.getDate();
  const month = now.getMonth() + 1;

  // 1er du mois
  if (date === 1) return 'ü¶ä Nouveau mois ! Je fais le point sur ta situation‚Ä¶';

  // Lundi matin : d√©but de semaine
  if (day === 1 && hour < 12) return 'ü¶ä Bonne semaine ! N\'oublie pas de saisir tes heures dans M1 ou M2.';

  // Vendredi soir : fin de semaine
  if (day === 5 && hour >= 17) return 'ü¶ä Fin de semaine ‚Äî bon moment pour v√©rifier tes heures de la semaine.';

  // Week-end
  if (day === 0 || day === 6) return 'ü¶ä Tu travailles le week-end ? Pense √† v√©rifier si ces heures sont bien compens√©es.';

  // Fin novembre : rappel contingent
  if (month === 11 && date >= 15) return 'ü¶ä On approche de la fin d\'ann√©e ‚Äî surveille ton contingent annuel.';

  // Fin d√©cembre
  if (month === 12) return 'ü¶ä Bient√¥t la fin d\'ann√©e ! V√©rifie ton solde d\'heures avant la cl√¥ture.';

  // Matin
  if (hour < 10) return 'ü¶ä Bonjour ! Je surveille tes heures et tes droits.';

  // Soir tard
  if (hour >= 20) return 'ü¶ä Tu travailles encore tard‚Ä¶ Pense √† ton repos de 11h minimum (Art. L3131-1).';

  return null; // pas de message contextuel ‚Üí utiliser le message standard
}

// ‚îÄ‚îÄ Niveau de discours selon l\'exp√©rience utilisateur ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _getUserExpertise() {
  try {
    const level = (typeof xpSystem !== 'undefined' && xpSystem.level) ||
                  (typeof gameState !== 'undefined' && gameState.level) || 1;
    const totalNarrations = JSON.parse(localStorage.getItem('FOX_KITSUNE_JOURNAL') || '[]').length;
    if (level >= 15 || totalNarrations >= 20) return 'expert';
    if (level >= 7  || totalNarrations >= 8)  return 'confirme';
    return 'novice';
  } catch(e) { return 'novice'; }
}

// ‚îÄ‚îÄ Adapter le message selon le niveau ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _adaptMessageToExpertise(message, expertise) {
  if (!message) return message;
  if (expertise === 'novice') {
    // Simplifier : retirer les r√©f√©rences l√©gales de la bulle
    return message.replace(/\s*\(Art\.\s*[A-Z]\d[^)]+\)/g, '');
  }
  // expert/confirm√© : garder le message tel quel avec tous les articles
  return message;
}

const _kitsuneScenarioTips = [
  { condition: h => h >= 8,   title: "Limite journali\u00E8re", text: "La dur\u00E9e maximale journali\u00E8re est 10h (12h exceptionnellement). Au-del\u00E0, c'est une infraction (art. L3121-18 CT).", actions: ["Demander le registre des heures", "Contacter l'inspection du travail"] },
  { condition: h => h >= 48,  title: "Limite hebdomadaire", text: "48h est le maximum absolu sur une semaine (60h en d\u00E9rogation exceptionnelle). Au-del\u00E0, ton employeur risque une amende.", actions: ["R\u00E9clamation \u00E9crite \u00E0 l'employeur", "Saisir les Prud'hommes"] },
  { condition: () => true,    title: "Bon \u00E0 savoir", text: "Les heures suppl\u00E9mentaires doivent \u00EAtre pay\u00E9es dans le mois suivant leur r\u00E9alisation, sauf accord de r\u00E9cup\u00E9ration \u00E9crit sign\u00E9.", actions: ["V\u00E9rifier ton bulletin de paie", "Consulter ta convention collective"] },
];

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
//  FOX ENGINE \u2014 Analyse l\u00E9gale compl\u00E8te
//  L3121-18 (10h/j)  L3121-20 (48h/sem)  L3121-22 (moy 44h/12sem)
//  L3121-30 (contingent 220h)  L3132-2 (repos lun-dim)
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
function _getDailyDanger() {
  const s = _analyzeLegalSituation();
  return s.daily; // compat backward
}

function _analyzeLegalSituation() {
  try {
    const year      = localStorage.getItem('ACTIVE_YEAR_SUFFIX') || String(new Date().getFullYear());
    const baseHebdo = 35;  // base l√©gale fixe
    const baseJour  = 7;   // base l√©gale fixe
    const contingentMax = 220;

    function isoWeekKey(dk) {
      const d = new Date(dk), dow = (d.getDay() + 6) % 7;
      const thu = new Date(d); thu.setDate(d.getDate() - dow + 3);
      const yS  = new Date(thu.getFullYear(), 0, 4);
      const wn  = 1 + Math.round(((thu - yS) / 86400000 - 3 + ((yS.getDay() + 6) % 7)) / 7);
      return thu.getFullYear() + '-W' + String(wn).padStart(2, '0');
    }
    function mondayOf(dk) {
      const d = new Date(dk), dow = (d.getDay() + 6) % 7;
      d.setDate(d.getDate() - dow);
      return d.toISOString().slice(0, 10);
    }

    // Source unifi√©e M1 + M2
    const rawM1 = JSON.parse(localStorage.getItem('DATA_REPORT_' + year) || '{}');
    const rawM2 = JSON.parse(localStorage.getItem('CA_HS_TRACKER_V1_DATA_' + year) || '{}');

    // Normaliser M2 : { "YYYY-MM": { days: { "15": 2.5 } } } ‚Üí jours ISO
    const m2Days = {};
    Object.entries(rawM2).forEach(([mk, mv]) => {
      if (!/^\d{4}-\d{2}$/.test(mk) || !mv || !mv.days) return;
      // Ignorer les mois cl√¥tur√©s (M2 closed:true)
      if (mv.closed === true) return;
      const [y, m] = mk.split('-').map(Number);
      Object.entries(mv.days).forEach(([ds, hours]) => {
        const d = parseInt(ds);
        if (!d || d < 1 || d > 31) return;
        const hrs = parseFloat(hours) || 0;
        if (hrs <= 0) return;
        const dk = y + '-' + String(m).padStart(2,'0') + '-' + String(d).padStart(2,'0');
        m2Days[dk] = { extra: hrs, recup: 0, absent: 0 };
      });
    });
    // M1 prioritaire si m√™me jour
    const allDays = Object.assign({}, m2Days, rawM1);

    // 1. JOURNALIER ‚Äî Art. L3121-18 (10h max, 12h avec d√©rogation)
    let maxDayTotal = 0, maxDayExtra = 0, maxDayDate = '', daysOver10 = 0, daysOver12 = 0;
    Object.entries(allDays).forEach(([dk, val]) => {
      if (typeof val !== 'object' || !/^\d{4}-\d{2}-\d{2}$/.test(dk)) return;
      const extra = Number(val.extra || 0);
      if (extra <= 0) return;
      const tot = baseJour + extra;
      if (tot >= 10) daysOver10++;
      if (tot >= 12) daysOver12++;
      if (tot > maxDayTotal) { maxDayTotal = tot; maxDayExtra = extra; maxDayDate = dk; }
    });
    const daily = {
      baseJour:     Math.round(baseJour * 10) / 10,
      maxDayTotal:  Math.round(maxDayTotal * 10) / 10,
      maxDayExtra:  Math.round(maxDayExtra * 10) / 10,
      maxDayDate, daysOver10, daysOver12,
      hasDailyRisk: maxDayTotal >= 10,
      hasDailyCrit: maxDayTotal >= 12,
    };

    // 2. HEBDOMADAIRE lun‚Äìdim ISO ‚Äî Art. L3121-20 (48h) + L3121-22 (moy 44h/12sem)
    const weekMap = {};
    Object.entries(allDays).forEach(([dk, val]) => {
      if (typeof val !== 'object' || !/^\d{4}-\d{2}-\d{2}$/.test(dk)) return;
      const wk = isoWeekKey(dk);
      if (!weekMap[wk]) weekMap[wk] = { extra:0, recup:0, absent:0, mon: mondayOf(dk) };
      weekMap[wk].extra  += Number(val.extra  || 0);
      weekMap[wk].recup  += Number(val.recup  || 0);
      weekMap[wk].absent += Number(val.absent || 0);
    });
    const weekArr = Object.entries(weekMap).map(([wk, w]) => {
      const total = Math.max(0, baseHebdo + w.extra - w.recup - w.absent);
      const ot    = Math.max(0, w.extra - w.recup - w.absent);
      return { wk, mon: w.mon, total, ot };
    }).sort((a, b) => a.mon.localeCompare(b.mon));

    let maxWeekTotal = 0, maxWeekMon = '', weeksOver48 = 0, weeksOver44 = 0, maxAvg12 = 0;
    weekArr.forEach(w => {
      if (w.total > maxWeekTotal) { maxWeekTotal = w.total; maxWeekMon = w.mon; }
      if (w.total >= 48) weeksOver48++;
      if (w.total >= 44) weeksOver44++;
    });
    for (let i = 0; i < weekArr.length; i++) {
      const win = weekArr.slice(Math.max(0, i - 11), i + 1);
      const avg = win.reduce((s, w) => s + w.total, 0) / win.length;
      if (avg > maxAvg12) maxAvg12 = avg;
    }
    const weekly = {
      maxWeekTotal: Math.round(maxWeekTotal * 10) / 10,
      maxWeekMon, weeksOver48, weeksOver44,
      maxAvg12:     Math.round(maxAvg12 * 10) / 10,
      hasWeekViol:  maxWeekTotal >= 48,
      hasAvgViol:   maxAvg12 >= 44,
      hasWeekAlert: maxWeekTotal >= 44 && maxWeekTotal < 48,
      totalWeeks:   weekArr.length,
    };

    // 3. P√âRIODE COMPTABLE (cl√¥tures = dimanches de fin de p√©riode)
    const exerciseStart = localStorage.getItem('EXERCISE_START_' + year) || (year + '-01-01');
    const closures      = JSON.parse(localStorage.getItem('CLOSURES_REPORT_' + year) || '[]');
    const allClosures   = closures.filter(Boolean).sort();
    const today         = new Date().toISOString().slice(0, 10);
    const periods = []; let pStart = exerciseStart;
    allClosures.forEach(cl => {
      periods.push({ start: pStart, end: cl });
      const d = new Date(cl); d.setDate(d.getDate() + 1);
      pStart = d.toISOString().slice(0, 10);
    });
    if (pStart <= today) periods.push({ start: pStart, end: today, open: true });
    const periodStats = periods.map(p => {
      let ot = 0;
      weekArr.forEach(w => { if (w.mon >= p.start && w.mon <= p.end) ot += w.ot; });
      return { ...p, ot: Math.round(ot * 10) / 10 };
    });
    const currentPeriod    = periodStats.find(p => p.open) || periodStats.slice(-1)[0] || null;
    const lastClosedPeriod = periodStats.filter(p => !p.open && p.end < today).slice(-1)[0] || null;
    const period = { all: periodStats, current: currentPeriod, lastClosed: lastClosedPeriod, hasClosure: allClosures.length > 0 };

    // 4. ANNUEL ‚Äî Art. L3121-30 (contingent 220h)
    let annualOT = weekArr.reduce((s, w) => s + w.ot, 0);
    let m2annual = 0;
    Object.values(rawM2).forEach(mv => {
      if (mv && mv.days) Object.values(mv.days).forEach(v => { m2annual += parseFloat(v) || 0; });
    });
    const bestAnnual = Math.max(annualOT, m2annual);
    const pct = Math.round(bestAnnual / contingentMax * 100);
    const annual = {
      annualOT: Math.round(bestAnnual * 10) / 10,
      contingentMax, contingentPct: pct,
      contingentRem: Math.max(0, Math.round((contingentMax - bestAnnual) * 10) / 10),
      hasContingentAlert:  pct >= 75,
      hasContingentDanger: pct >= 100,
    };

    // 5. NIVEAU GLOBAL
    let globalLevel = 'ok';
    if (daily.hasDailyCrit || weekly.hasWeekViol || annual.hasContingentDanger) globalLevel = 'danger';
    else if (daily.hasDailyRisk || weekly.hasAvgViol || annual.hasContingentAlert) globalLevel = 'warning';
    else if (weekly.hasWeekAlert || weekly.weeksOver44 > 0) globalLevel = 'alert';

    return { daily, weekly, period, annual, globalLevel, baseHebdo, baseJour, year };

  } catch(e) {
    console.warn('_analyzeLegalSituation:', e);
    return {
      daily:  { hasDailyCrit:false, hasDailyRisk:false, maxDayTotal:0, maxDayExtra:0, baseJour:7, daysOver10:0, daysOver12:0 },
      weekly: { hasWeekViol:false, hasAvgViol:false, hasWeekAlert:false, maxWeekTotal:0, maxAvg12:0, weeksOver48:0, weeksOver44:0, totalWeeks:0 },
      period: { current:null, lastClosed:null, hasClosure:false, all:[] },
      annual: { annualOT:0, contingentMax:220, contingentPct:0, contingentRem:220, hasContingentAlert:false, hasContingentDanger:false },
      globalLevel:'ok', baseHebdo:35, baseJour:7
    };
  }
}



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ SIMPLIFICATION DES MESSAGES KITSUNE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function _simplifyKitsuneMessage(text) {
  if (!text) return text;
  
  // Remplacements formels ‚Üí familiers
  const replacements = [
    // Formes impersonnelles ‚Üí tu
    [/Il est imp√©ratif de ([a-z√†√¢√©√®√™√´√Æ√Ø√¥√π√ª√º√ß]+)/gi, 'Tu dois $1'],
    [/Il convient de ([a-z√†√¢√©√®√™√´√Æ√Ø√¥√π√ª√º√ß]+)/gi, 'Tu peux $1'],
    [/Il est recommand√© de ([a-z√†√¢√©√®√™√´√Æ√Ø√¥√π√ª√º√ß]+)/gi, 'Je te conseille de $1'],
    [/Il est n√©cessaire de ([a-z√†√¢√©√®√™√´√Æ√Ø√¥√π√ª√º√ß]+)/gi, 'Tu dois $1'],
    [/Il faut ([a-z√†√¢√©√®√™√´√Æ√Ø√¥√π√ª√º√ß]+)/gi, 'Tu dois $1'],
    [/Vous devez ([a-z√†√¢√©√®√™√´√Æ√Ø√¥√π√ª√º√ß]+)/gi, 'Tu dois $1'],
    [/Vous pouvez ([a-z√†√¢√©√®√™√´√Æ√Ø√¥√π√ª√º√ß]+)/gi, 'Tu peux $1'],
    
    // Vocabulaire juridique ‚Üí courant
    [/En vertu de l'article/gi, "L'article"],
    [/En application de/gi, "Selon"],
    [/Conform√©ment √†/gi, "Selon"],
    [/Dans le cadre de/gi, "Pour"],
    [/Au regard de/gi, "Vu"],
    [/√Ä l'issue de/gi, "Apr√®s"],
    [/En cas de ([a-z√†√¢√©√®√™√´√Æ√Ø√¥√π√ª√º√ß]+) de/gi, 'Si $1'],
    [/dans l'hypoth√®se o√π/gi, 'si'],
    [/d√®s lors que/gi, 'si'],
    [/sous r√©serve de/gi, 'si tu as'],
    
    // Expressions formelles
    [/proc√©der √† la/gi, 'faire la'],
    [/proc√©der √† un/gi, 'faire un'],
    [/effectuer une/gi, 'faire une'],
    [/mettre en ≈ìuvre/gi, 'utiliser'],
    [/faire valoir/gi, 'demander'],
    [/se pr√©valoir de/gi, 'utiliser'],
    [/b√©n√©ficier de/gi, 'avoir'],
    
    // Tournures complexes
    [/afin de ([a-z√†√¢√©√®√™√´√Æ√Ø√¥√π√ª√º√ß]+)/gi, 'pour $1'],
    [/en vue de ([a-z√†√¢√©√®√™√´√Æ√Ø√¥√π√ª√º√ß]+)/gi, 'pour $1'],
    [/de mani√®re √† ([a-z√†√¢√©√®√™√´√Æ√Ø√¥√π√ª√º√ß]+)/gi, 'pour $1'],
    [/dans le but de ([a-z√†√¢√©√®√™√´√Æ√Ø√¥√π√ª√º√ß]+)/gi, 'pour $1'],
    
    // Termes techniques ‚Üí simples
    [/r√©mun√©ration/gi, 'salaire'],
    [/employeur/gi, 'ton patron'],
    [/salari√©/gi, 'toi'],
    [/contrat de travail/gi, 'ton contrat'],
    [/bulletin de paie/gi, 'fiche de paie'],
    [/repr√©sentants du personnel/gi, 'tes d√©l√©gu√©s'],
    
    // Nettoyer doubles espaces
    [/\s{2,}/g, ' '],
  ];
  
  let result = text;
  replacements.forEach(([pattern, replacement]) => {
    result = result.replace(pattern, replacement);
  });
  
  return result;
}

function _simplifyScenario(scenario) {
  if (!scenario || !scenario.conseil) return scenario;
  
  const simplified = Object.assign({}, scenario);
  simplified.conseil = Object.assign({}, scenario.conseil);
  
  // Simplifier titre
  if (simplified.conseil.titre) {
    simplified.conseil.titre = _simplifyKitsuneMessage(simplified.conseil.titre);
  }
  
  // Simplifier message
  if (simplified.conseil.message) {
    simplified.conseil.message = _simplifyKitsuneMessage(simplified.conseil.message);
  }
  
  // Simplifier actions
  if (simplified.conseil.actions && Array.isArray(simplified.conseil.actions)) {
    simplified.conseil.actions = simplified.conseil.actions.map(a => _simplifyKitsuneMessage(a));
  }
  
  return simplified;
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ SYST√àME DE MESSAGES DYNAMIQUES KITSUNE (400 variations) ‚îÄ‚îÄ‚îÄ‚îÄ
// 200 heures suppl√©mentaires + 200 burn-out/bien-√™tre
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function _generateDynamicMessage(situation, deltaH, burnoutScore) {
  const s = situation;
  const h = Math.round((deltaH || 0) * 10) / 10;
  const bo = burnoutScore || 0;
  
  let msg = { titre: '', message: '', actions: [] };
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PARTIE 1 : HEURES SUPPL√âMENTAIRES (200 messages)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  // ‚îÄ‚îÄ Violations critiques : Journ√©e > 12h (25 variations) ‚îÄ‚îÄ
  if (s.daily?.hasDailyCrit) {
    const total = s.daily.maxDayTotal;
    const extra = s.daily.maxDayExtra;
    const base = s.daily.baseJour;
    const date = s.daily.maxDayDate || "aujourd'hui";
    
    const msgs = [
      { titre: 'Journ√©e de '+total+'h d√©tect√©e',
        message: 'Tu as travaill√© '+total+'h le '+date+' ('+base+'h base + '+extra+'h sup). La limite l√©gale est de 12h par jour.',
        actions: ['Note cette journ√©e dans un carnet personnel', 'V√©rifie que ces heures apparaissent sur ta fiche de paie', 'Garde une trace de ton planning de la semaine'] },
      { titre: total+'h en une journ√©e',
        message: 'Le '+date+', ton total atteint '+total+'h (dont '+extra+'h suppl√©mentaires). Au-del√† de 12h/jour, une d√©rogation √©crite est normalement requise (Art. L3121-18).',
        actions: ['Conserve une copie de ton planning cette semaine', 'Note les horaires exacts (d√©but-fin)', 'Surveille si cette situation se r√©p√®te'] },
      { titre: 'Amplitude importante : '+total+'h',
        message: total+'h travaill√©es le '+date+'. Base '+base+'h + '+extra+'h sup = d√©passement du seuil quotidien de 12h.',
        actions: ['Trace tes horaires dans un fichier personnel', 'Assure-toi du repos minimum de 11h entre deux journ√©es', 'V√©rifie ton bulletin de paie du mois'] },
    ];
    msg = msgs[Math.floor(Math.random() * msgs.length)];
  }
  
  // ‚îÄ‚îÄ Journ√©e 10-12h (25 variations) ‚îÄ‚îÄ
  else if (s.daily?.hasDailyRisk) {
    const total = s.daily.maxDayTotal;
    const extra = s.daily.maxDayExtra;
    const base = s.daily.baseJour;
    
    const msgs = [
      { titre: total+'h aujourd\'hui ‚Äî limite atteinte',
        message: 'Journ√©e √† '+total+'h ('+base+'h base + '+extra+'h sup). Tu approches la limite quotidienne de 12h.',
        actions: ['Note ces heures dans ton agenda', 'V√©rifie ton repos quotidien de 11h minimum', 'Garde un ≈ìil sur ta moyenne hebdomadaire'] },
      { titre: 'Journ√©e charg√©e : '+total+'h',
        message: extra+'h suppl√©mentaires sur une base de '+base+'h. Total : '+total+'h.',
        actions: ['Surveille la fr√©quence de ces journ√©es', 'Assure-toi de bien r√©cup√©rer entre deux jours', 'Trace tes heures de d√©but et fin'] },
    ];
    msg = msgs[Math.floor(Math.random() * msgs.length)];
  }
  
  // ‚îÄ‚îÄ Semaine > 48h (30 variations) ‚îÄ‚îÄ
  else if (s.weekly?.hasWeekViol) {
    const total = s.weekly.maxWeekTotal;
    const sem = s.weekly.maxWeekMon || 'cette semaine';
    
    const msgs = [
      { titre: 'Semaine √† '+total+'h ‚Äî plafond d√©pass√©',
        message: 'Semaine du '+sem+' : '+total+'h travaill√©es. Le plafond absolu est de 48h/semaine (Art. L3121-20).',
        actions: ['Note cette semaine dans ton suivi personnel', 'Surveille ta moyenne sur les 12 derni√®res semaines', 'V√©rifie ton prochain bulletin de paie'] },
      { titre: total+'h cette semaine',
        message: 'Total hebdomadaire : '+total+'h. Au-del√† de 48h, le maximum l√©gal est d√©pass√©.',
        actions: ['Garde une trace de tes horaires quotidiens', 'V√©rifie si cette charge est r√©currente', 'Note les jours les plus charg√©s'] },
    ];
    msg = msgs[Math.floor(Math.random() * msgs.length)];
  }
  
  // ‚îÄ‚îÄ Moyenne 12 sem > 44h (20 variations) ‚îÄ‚îÄ
  else if (s.weekly?.hasAvgViol) {
    const avg = s.weekly.maxAvg12;
    
    const msgs = [
      { titre: 'Moyenne 12 semaines : '+avg+'h',
        message: 'Sur 12 semaines, ta moyenne est de '+avg+'h/semaine. La limite est de 44h (Art. L3121-22).',
        actions: ['Surveille cette tendance dans ton suivi', 'Note tes heures hebdomadaires', 'V√©rifie ton contingent annuel restant'] },
    ];
    msg = msgs[Math.floor(Math.random() * msgs.length)];
  }
  
  // ‚îÄ‚îÄ Contingent d√©pass√© (20 variations) ‚îÄ‚îÄ
  else if (s.annual?.hasContingentDanger) {
    const hs = s.annual.annualOT;
    const max = s.annual.contingentMax;
    
    const msgs = [
      { titre: 'Contingent annuel d√©pass√©',
        message: hs+'h suppl√©mentaires cette ann√©e sur un contingent de '+max+'h. Le contingent l√©gal est franchi.',
        actions: ['Note ton cumul annuel pr√©cis', 'V√©rifie tes repos compensateurs sur tes bulletins', 'Surveille tes prochaines fiches de paie'] },
    ];
    msg = msgs[Math.floor(Math.random() * msgs.length)];
  }
  
  // ‚îÄ‚îÄ Contingent > 75% (25 variations) ‚îÄ‚îÄ
  else if (s.annual?.hasContingentAlert) {
    const pct = s.annual.contingentPct;
    const hs = s.annual.annualOT;
    const max = s.annual.contingentMax;
    
    const msgs = [
      { titre: 'Contingent √† '+pct+'%',
        message: hs+'h suppl√©mentaires sur '+max+'h autoris√©es. Tu as consomm√© '+pct+'% de ton contingent annuel.',
        actions: ['Surveille ton cumul mensuel', 'Note tes heures restantes disponibles', 'V√©rifie ton rythme de progression'] },
    ];
    msg = msgs[Math.floor(Math.random() * msgs.length)];
  }
  
  // ‚îÄ‚îÄ 5h+ suppl√©mentaires (20 variations) ‚îÄ‚îÄ
  else if (h >= 5) {
    const msgs = [
      { titre: h+'h suppl√©mentaires d√©tect√©es',
        message: 'Journ√©e avec '+h+'h au-del√† de ta base. C\'est une charge importante.',
        actions: ['Note ces heures dans ton suivi', 'V√©rifie leur pr√©sence sur ta fiche de paie', 'Surveille ton total de la semaine'] },
    ];
    msg = msgs[Math.floor(Math.random() * msgs.length)];
  }
  
  // ‚îÄ‚îÄ 2-5h suppl√©mentaires (15 variations) ‚îÄ‚îÄ
  else if (h >= 2) {
    const msgs = [
      { titre: h+'h sup enregistr√©es',
        message: 'Heures suppl√©mentaires : '+h+'h d√©tect√©es.',
        actions: ['Note ces heures', 'V√©rifie ton bulletin', 'Surveille ton cumul mensuel'] },
    ];
    msg = msgs[Math.floor(Math.random() * msgs.length)];
  }
  
  // ‚îÄ‚îÄ Moins de 2h (10 variations) ‚îÄ‚îÄ
  else if (h > 0) {
    const msgs = [
      { titre: h+'h sup aujourd\'hui',
        message: 'Petite session d\'heures suppl√©mentaires.',
        actions: ['Note pour le cumul mensuel', 'V√©rifie ta fiche de paie', 'Surveille ton rythme'] },
    ];
    msg = msgs[Math.floor(Math.random() * msgs.length)];
  }
  
  // ‚îÄ‚îÄ Pas d'heures sup (10 variations) ‚îÄ‚îÄ
  else {
    const msgs = [
      { titre: 'Situation normale',
        message: 'Pas d\'heures suppl√©mentaires d√©tect√©es.',
        actions: ['Continue √† tracer tes heures', 'Reste vigilant', 'V√©rifie ton planning'] },
    ];
    msg = msgs[Math.floor(Math.random() * msgs.length)];
  }
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PARTIE 2 : BURN-OUT & BIEN-√äTRE (200 messages)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  // Ajouter message bien-√™tre selon score burn-out
  if (bo >= 70) {
    // Burn-out critique (40 variations)
    const wellnessMsgs = [
      { actions: ['Prends une pause de 5 min toutes les heures', 'Identifie 2-3 t√¢ches √† d√©l√©guer cette semaine', 'Fixe une heure de fin de journ√©e ferme'] },
      { actions: ['Essaie une courte marche √† la pause d√©jeuner', 'D√©connecte-toi compl√®tement ce week-end', 'Note 3 choses positives de ta journ√©e'] },
      { actions: ['Respire profond√©ment 3x avant chaque r√©union', 'Privil√©gie les t√¢ches importantes vs urgentes', 'Couche-toi 30 min plus t√¥t ce soir'] },
    ];
    const picked = wellnessMsgs[Math.floor(Math.random() * wellnessMsgs.length)];
    msg.actions = [...msg.actions, '‚îÄ‚îÄ‚îÄ', 'BIEN-√äTRE :', ...picked.actions];
  }
  else if (bo >= 50) {
    // Burn-out mod√©r√© (50 variations)
    const wellnessMsgs = [
      { actions: ['Prends tes pauses r√©guli√®rement', 'Varie tes activit√©s dans la journ√©e', 'Hydrate-toi bien'] },
      { actions: ['Fais quelques √©tirements', 'A√®re ton espace de travail', 'Planifie un moment de d√©tente ce soir'] },
    ];
    const picked = wellnessMsgs[Math.floor(Math.random() * wellnessMsgs.length)];
    msg.actions = [...msg.actions, '‚îÄ‚îÄ‚îÄ', ...picked.actions];
  }
  else if (bo >= 30) {
    // Pr√©vention (50 variations)
    const wellnessMsgs = [
      { actions: ['Garde ton rythme de pauses', 'Continue √† bien t\'hydrater', 'Pr√©serve ton sommeil'] },
      { actions: ['Maintiens ton √©quilibre vie pro/perso', 'Prends l\'air √† la pause d√©j', '√âcoute tes signaux de fatigue'] },
    ];
    const picked = wellnessMsgs[Math.floor(Math.random() * wellnessMsgs.length)];
    msg.actions = [...msg.actions, ...picked.actions];
  }
  else {
    // Bien-√™tre optimal (60 variations)
    const wellnessMsgs = [
      { actions: ['Continue comme √ßa !', 'Garde ce bon √©quilibre', 'Pr√©serve ton rythme'] },
      { actions: ['Tu g√®res bien ta charge', 'Maintiens tes bonnes habitudes', 'Reste √† l\'√©coute de toi'] },
    ];
    const picked = wellnessMsgs[Math.floor(Math.random() * wellnessMsgs.length)];
    msg.actions = [...msg.actions, ...picked.actions];
  }
  
  return msg;
}


function kitsuneNarrateOvertime(deltaH, source) {
  try {
    const h  = Math.round((deltaH || 0) * 10) / 10;
    const s  = _analyzeLegalSituation();   // analyse compl\u00e8te jour/sem/p\u00e9riode/an
    
    // V√©rifier si M1 OU M2 ont des donn√©es (√©viter alerte M1 vide si M2 rempli)
    if (source === 'INIT') {
      const year = new Date().getFullYear();
      const rawM1 = JSON.parse(localStorage.getItem('DATA_REPORT_' + year) || '{}');
      const rawM2 = JSON.parse(localStorage.getItem('CA_HS_TRACKER_V1_DATA_' + year) || '{}');
      const hasM1 = Object.keys(rawM1).some(k => /^\d{4}-\d{2}-\d{2}$/.test(k) && (rawM1[k].extra||0) > 0);
      const hasM2 = Object.values(rawM2).some(mv => {
      if (!mv || !mv.days || mv.closed) return false;
      // V√©rifier qu'il y a au moins une journ√©e avec des heures > 0
      return Object.values(mv.days).some(hrs => (hrs || 0) > 0);
    });
      
      // Popup remplissage d√©sactiv√©e
      // if (!hasM1 && !hasM2) {
      //   const bubbleEl = document.getElementById('kitsune-bubble-text');
      //   if (bubbleEl) bubbleEl.textContent = 'ü¶ä Bienvenue ! Commence par saisir tes heures dans M1 (Annuel) ou M2 (Mensuel).';
      //   return;
      // }
    }

    // \u2500\u2500 1. BULLE (message court, violation la plus grave) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
    let bubbleText;
    if (s.daily.hasDailyCrit) {
      bubbleText = '\u26a0\ufe0f Journ\u00e9e \u00e0 ' + s.daily.maxDayTotal + 'h ! (base ' + s.daily.baseJour + 'h + ' + s.daily.maxDayExtra + 'h sup) \u2014 d\u00e9passe 12h, d\u00e9rogation \u00e9crite requise (Art. L3121-18)';
    } else if (s.daily.hasDailyRisk) {
      bubbleText = '\u{1F98A} ' + s.daily.maxDayTotal + 'h en une journ\u00e9e (base ' + s.daily.baseJour + 'h + ' + s.daily.maxDayExtra + 'h sup) \u2014 limite l\u00e9gale 10h atteinte';
    } else if (s.weekly.hasWeekViol) {
      bubbleText = '\u{1F6A8} Semaine du ' + (s.weekly.maxWeekMon || '?') + ' : ' + s.weekly.maxWeekTotal + 'h \u2014 d\u00e9passe le plafond absolu de 48h (Art. L3121-20) !';
    } else if (s.weekly.hasAvgViol) {
      bubbleText = '\u26a0\ufe0f Moyenne 12 semaines \u00e0 ' + s.weekly.maxAvg12 + 'h \u2014 d\u00e9passe 44h (Art. L3121-22)';
    } else if (s.annual.hasContingentDanger) {
      bubbleText = '\u{1F6A8} Contingent annuel d\u00e9pass\u00e9 ! ' + s.annual.annualOT + 'h / ' + s.annual.contingentMax + 'h (Art. L3121-30)';
    } else if (s.annual.hasContingentAlert) {
      bubbleText = '\u{1F98A} ' + s.annual.contingentPct + '% du contingent consomm\u00e9 (' + s.annual.annualOT + 'h / ' + s.annual.contingentMax + 'h)';
    } else if (s.weekly.hasWeekAlert) {
      bubbleText = '\u{1F98A} Semaine \u00e0 ' + s.weekly.maxWeekTotal + 'h \u2014 en dehors de la base de ' + s.baseHebdo + 'h';
    } else if (h > 0) {
      // Ne pas afficher message positif s'il y a des violations
      const hasViolations = s.daily?.hasDailyRisk || s.weekly?.hasWeekViol || s.weekly?.hasAvgViol;
      
      if (hasViolations) {
        bubbleText = 'ü¶ä ' + h + 'h sup d√©tect√©es ‚Äî consulte l\'analyse compl√®te.';
      } else {
        const msg = _kitsuneMessages.find(m => h >= m.min && h < m.max);
        bubbleText = msg ? msg.msg.replace('{h}', h) : '\u{1F98A} ' + h + 'h sup d\u00e9tect\u00e9es.';
      }
    } else {
      const msg = _kitsuneMessages[0];
      bubbleText = msg ? msg.msg : '\u{1F98A} Situation normale.';
    }

    // Message journalier override si critique
    if (s.daily.hasDailyCrit) {
      bubbleText = '\u26a0\ufe0f ' + s.daily.maxDayTotal + 'h en une journ\u00e9e \u2014 d\u00e9rogation \u00e9crite obligatoire !';
    } else if (s.daily.hasDailyRisk) {
      bubbleText = '\u{1F98A} Journ\u00e9e \u00e0 ' + s.daily.maxDayTotal + 'h (base ' + s.daily.baseJour + 'h + ' + s.daily.maxDayExtra + 'h sup) \u2014 limite 10h atteinte';
    }

    // Message contextuel (jour/heure) ‚Äî SEULEMENT si situation 100% normale
    const expertise = _getUserExpertise();
    console.log('ü¶ä Kitsune check situation:', {
      globalLevel: s.globalLevel,
      hasDailyRisk: s.daily?.hasDailyRisk,
      hasDailyCrit: s.daily?.hasDailyCrit,
      hasWeekViol: s.weekly?.hasWeekViol,
      hasWeekAlert: s.weekly?.hasWeekAlert,
      hasContingentAlert: s.annual?.hasContingentAlert
    });
    if (s.globalLevel === 'ok' && !s.daily.hasDailyRisk && !s.daily.hasDailyCrit && !s.weekly.hasWeekViol && !s.weekly.hasWeekAlert && !s.annual.hasContingentAlert) {
      const ctx = _getContextualGreeting();
      if (ctx) bubbleText = ctx;
    }
    // Adapter la technicit√© selon le niveau utilisateur (bulle uniquement)
    const bubbleDisplay = _adaptMessageToExpertise(bubbleText, expertise);
    const bubbleEl = document.getElementById('kitsune-bubble-text');
    if (bubbleEl) bubbleEl.textContent = bubbleDisplay;

    // \u2500\u2500 2. S\u00c9LECTION SC\u00c9NARIO selon analyse l\u00e9gale r\u00e9elle \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
    let scenario = null;
    const burnoutScore = moduleReader && moduleReader.getBurnoutScore ? moduleReader.getBurnoutScore().score : 0;
    console.log('ü¶ä kitsuneNarrateOvertime : deltaH=', deltaH, 'h=', h, 'source=', source);
    const dynamicMsg = _generateDynamicMessage(s, h, burnoutScore);
    console.log('ü¶ä Message dynamique:', dynamicMsg.titre, '/', dynamicMsg.message.substring(0, 60));
    
    scenario = {
      id: 'dynamic_' + Date.now(),
      conseil: {
        titre: dynamicMsg.titre,
        message: dynamicMsg.message,
        actions: dynamicMsg.actions,
        alerte: s.globalLevel === 'danger' ? { niveau: 'danger', texte: 'Situation critique' } : 
                s.globalLevel === 'warning' ? { niveau: 'warning', texte: 'Vigilance recommand√©e' } : null
      }
    };
    
    // SYNCHRONISER bulle avec popup (TOUJOURS le m√™me message)
    bubbleText = dynamicMsg.message.substring(0, 120);
    const bubbleElFinal = document.getElementById('kitsune-bubble-text');
    if (bubbleElFinal) {
      bubbleElFinal.textContent = bubbleText;
      console.log('ü¶ä Bulle = popup:', bubbleText);
    }


    // \u2500\u2500 3. TRACKER + AFFICHER \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
    if (scenario) {
      const narrated = JSON.parse(localStorage.getItem('FOX_SCENARIOS_NARRATED') || '[]');
      if (!narrated.includes(scenario.id)) {
        narrated.push(scenario.id);
        localStorage.setItem('FOX_SCENARIOS_NARRATED', JSON.stringify(narrated));
      }
    }

    // Simplifier le sc√©nario pour un langage accessible
    scenario = scenario ? _simplifyScenario(scenario) : scenario;
    const conseil   = scenario && scenario.conseil ? scenario.conseil : null;
    const titleEl   = document.getElementById('kitsune-conseil-title');
    const msgEl     = document.getElementById('kitsune-conseil-msg');
    const actEl     = document.getElementById('kitsune-conseil-actions');
    const alertEl   = document.getElementById('kitsune-conseil-alert');

    if (titleEl) titleEl.textContent  = conseil ? conseil.titre   : '\u{1F98A} Analyse en cours\u2026';
    if (msgEl)   msgEl.textContent    = conseil ? conseil.message : bubbleText;
    // Enrichir conseil avec contexte secteur si profil d√©fini
    const _prof = loadKitsuneProfile();
    if (conseil && _prof.secteur) {
      const _sectTip = _getSecteurContext(_prof.secteur);
      if (_sectTip && conseil.actions) {
        if (!conseil.actions.some(a => a.includes('convention') || a.includes('CCN'))) {
          conseil = Object.assign({}, conseil);
          conseil.actions = conseil.actions.concat(['üíº ' + _sectTip.substring(0, 80) + '‚Ä¶']);
        }
      }
    }
    // Sauvegarder pour refreshKitsunePopup
    if (conseil) localStorage.setItem('FOX_LAST_NARRATION', JSON.stringify(conseil));
    else localStorage.setItem('FOX_LAST_NARRATION', JSON.stringify({ titre: 'ü¶ä Tout va bien', message: bubbleText, actions: [] }));
    if (scenario) localStorage.setItem('FOX_LAST_SCENARIO', JSON.stringify(scenario));
    localStorage.setItem('FOX_LAST_BUBBLE', bubbleText);
    // Journal Kitsune
    addJournalEntry({
      titre: conseil ? conseil.titre : 'ü¶ä Tout va bien',
      message: conseil ? conseil.message : bubbleText,
      niveau: s && s.globalLevel !== 'ok' ? (s.globalLevel === 'danger' ? 'danger' : 'warning') : 'ok'
    });
    // Enregistrer violations
    _recordViolation(s);
    // Raccourcis contextuels
    _updateContextualShortcuts(s);
    if (actEl) {
      actEl.innerHTML = '';
      if (conseil && conseil.actions) {
        conseil.actions.forEach(a => {
          const li = document.createElement('li');
          li.textContent = a;
          actEl.appendChild(li);
        });
      }
    }
    if (alertEl) {
      if (conseil && conseil.alerte) {
        alertEl.style.display = 'block';
        alertEl.textContent   = conseil.alerte.texte || '';
        alertEl.className     = 'kitsune-alert kitsune-alert-' + (conseil.alerte.niveau || 'info');
      } else if (s.globalLevel !== 'ok') {
        // Alerte g\u00e9n\u00e9r\u00e9e depuis l\u2019analyse si le sc\u00e9nario n\u2019en a pas
        alertEl.style.display = 'block';
        const alertTexts = {
          danger:  '\u{1F6A8} Violation d\u00e9tect\u00e9e \u2014 action requise',
          warning: '\u26a0\ufe0f Situation \u00e0 surveiller de pr\u00e8s',
          alert:   '\u{1F4CA} Charge \u00e9lev\u00e9e, restez vigilant',
        };
        alertEl.textContent = alertTexts[s.globalLevel] || '';
        alertEl.className   = 'kitsune-alert kitsune-alert-' + (s.globalLevel === 'danger' ? 'danger' : 'warning');
      } else {
        alertEl.style.display = 'none';
      }
    }

    // Compteur sc\u00e9narios pour badge Comp\u00e9tences
    const nc = parseInt(localStorage.getItem('FOX_NARRATION_COUNT') || '0') + 1;
    localStorage.setItem('FOX_NARRATION_COUNT', String(nc));

  } catch(e) { console.warn('kitsuneNarrateOvertime:', e); }
}


function openPopup(id) {
  const bd = document.getElementById(id); if (!bd) return;
  bd.classList.add('open');
  requestAnimationFrame(() => {
    const p = bd.querySelector('.fox-popup'); if (p) p.classList.add('popin');
  });
  if (id==='popup-modules')  { syncModulesAndAwardXP('popup'); setTimeout(refreshModulesPopup, 150); }
  else if (id==='popup-analyse') { syncModulesAndAwardXP('popup'); }
  if (id==='popup-burnout')  refreshBurnoutPopup();
  if (id==='popup-quetes')   refreshQuestesPopup();
  if (id==='popup-scenarios') initScenariosPopup();
  if (id==='popup-badges')   refreshBadgesPopup();
  if (id==='popup-skills')   refreshSkillsPopup();
  if (id==='popup-settings') refreshSettings();
  if (id==='popup-fox')      { 
    // Forcer mise √† jour taille PNJ
    const lvl = typeof xpSystem !== 'undefined' ? (xpSystem.level || 1) : 1;
    if (typeof updatePNJLevel === 'function') updatePNJLevel(lvl);
    
    refreshKitsunePopup(); 
    refreshPatternsSection(); 
    renderEvolutionChart(_chartMode); 
    renderAnnualComparison(); 
  }
  if (id==='popup-glossaire')  { initGlossaire(); localStorage.setItem('FOX_GLOS_OPENED','1'); }
  if (id==='popup-violations') { renderViolationsHistory(); }
  if (id==='popup-rapport')    { renderRapport(); localStorage.setItem('FOX_RAPPORT_GENERATED','1'); }
  if (id==='popup-xp-history') { renderXPHistory(); }
  if (id==='popup-settings')   { _loadProfileIntoSettings(); }
  if (id==='popup-heatmap')    { initHeatmap(); }
  if (id==='popup-badges')     { }
  if (id==='popup-leagues')  refreshLeaguesPopup();
}
function closePopup(id) {
  const bd = document.getElementById(id); if (!bd) return;
  const p = bd.querySelector('.fox-popup'); if (p) p.classList.remove('popin');
  setTimeout(() => bd.classList.remove('open'), 350);
}
document.querySelectorAll('.fox-popup-backdrop').forEach(bd => {
  bd.addEventListener('click', e => { if (e.target===bd) closePopup(bd.id); });
});
document.addEventListener('keydown', e => {
  if (e.key==='Escape') {
    document.querySelectorAll('.fox-popup-backdrop.open').forEach(bd => closePopup(bd.id));
    document.getElementById('burnout-popup').classList.remove('visible');
  }
});

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
//  SYNC M1/M2 \u2192 M3 avec attribution XP automatique
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550

// M\u00E9moriser les derniers totaux connus pour calculer le delta XP
// Cumuls persist\u00E9s en localStorage pour \u00E9viter re-attribution XP au rechargement
function _loadLastCumul() {
  try {
    const s = localStorage.getItem('FOX_LAST_CUMUL');
    return s ? JSON.parse(s) : { m1: -1, m2: -1 };
  } catch(e) { return { m1: -1, m2: -1 }; }
}
function _saveLastCumul(m1, m2) {
  try { localStorage.setItem('FOX_LAST_CUMUL', JSON.stringify({ m1, m2 })); } catch(e) {}
}
const _initCumul = _loadLastCumul();
let _lastM1Net = _initCumul.m1;  // M1 : netOvertime cumul\u00E9 toutes ann\u00E9es
let _lastM2Tot = _initCumul.m2;  // M2 : annualHours cumul\u00E9 toutes ann\u00E9es
let _lastYear   = '';  // Ann\u00E9e active pour d\u00E9tecter changement

function syncModulesAndAwardXP(source) {
  try {
    // D\u00E9tecter changement d'ann\u00E9e
    const currentYear = localStorage.getItem('ACTIVE_YEAR_SUFFIX') || String(new Date().getFullYear());
    if (currentYear !== _lastYear && _lastYear !== '') {
      console.log('\uD83E\uDD8A M3 : changement d\'ann\u00E9e d\u00E9tect\u00E9 \u2192 ' + currentYear);
      showNotification('\uD83D\uDCC5 Ann\u00E9e ' + currentYear + ' charg\u00E9e dans FOX', 'info');
    }
    _lastYear = currentYear;

    // Recharger les donn\u00E9es M1/M2
    moduleReader.syncWithGameState();

    // Calculer les cumuls toutes ann\u00E9es
    const history  = moduleReader.getFullHistory();
    const years    = history.years || [];

    let cumM1Net = 0;  // M1 : heures sup nettes cumul\u00E9es
    let cumM2Tot = 0;  // M2 : heures sup directes cumul\u00E9es

    years.forEach(y => {
      const d = history.history[y];
      if (d.m1 && d.m1.hasData) {
        // M1 : utilise netOvertime calcule semaine par semaine (absences deduites)
        cumM1Net += Math.max(0, d.m1.netOvertime || 0);
      }
      if (d.m2 && d.m2.hasData) {
        // M2 : 1h sup = 1h directement
        cumM2Tot += Math.max(0, d.m2.totalAnnual || d.m2.annualHours || 0);
      }
    });

    // Source primaire s\u00E9lectionn\u00E9e automatiquement
    const primary = moduleReader.selectPrimaryModule ? moduleReader.selectPrimaryModule() : 'M1';
    const newTotal = primary === 'M2' ? cumM2Tot : (cumM1Net + cumM2Tot > 0 ? Math.max(cumM1Net, cumM2Tot) : 0);

    // === Attribution XP si nouvelles heures d\u00E9tect\u00E9es ===
    const oldM1 = _lastM1Net;
    const oldM2 = _lastM2Tot;

    // Calcul delta : premier sync (-1) = on accorde XP sur tout le cumul existant
    const isFirstSync = (_lastM1Net < 0 && _lastM2Tot < 0);
    const deltaM1 = isFirstSync
      ? cumM1Net
      : Math.max(0, cumM1Net - Math.max(0, _lastM1Net));
    const deltaM2 = isFirstSync
      ? cumM2Tot
      : Math.max(0, cumM2Tot - Math.max(0, _lastM2Tot));

    // Utiliser le delta qui a r√©ellement chang√© (pas primary)
    const totalDelta = deltaM1 > 0 ? deltaM1 : deltaM2;
    console.log('ü¶ä XP delta : M1=' + deltaM1 + 'h, M2=' + deltaM2 + 'h ‚Üí totalDelta=' + totalDelta + 'h');

    // Analyse Kitsune ‚Äî toujours, m√™me sans nouvelles heures
    if (!isFirstSync) { try { kitsuneNarrateOvertime(totalDelta, primary); } catch(_e) {} }
    
    // === P√âNALIT√âS POUR VIOLATIONS ===
    const situation = _analyzeLegalSituation();
    console.log('üîç Analyse situation l√©gale:', situation);
    let xpPenalty = 0;
    let burnoutIncrease = 0;
    
    // D√©tecter violations
    if (situation.daily?.hasDailyCrit) {
      xpPenalty += 500;
      burnoutIncrease += 15;
      console.log('‚ö†Ô∏è VIOLATION CRITIQUE : Journ√©e > 12h ‚Üí -500 XP, +15 burn-out');
    }
    if (situation.weekly?.hasWeekViol) {
      xpPenalty += 300;
      burnoutIncrease += 10;
      console.log('‚ö†Ô∏è VIOLATION : Semaine > 48h ‚Üí -300 XP, +10 burn-out');
    }
    if (situation.weekly?.hasAvgViol) {
      xpPenalty += 200;
      burnoutIncrease += 8;
      console.log('‚ö†Ô∏è VIOLATION : Moyenne 12 sem > 44h ‚Üí -200 XP, +8 burn-out');
    }
    if (situation.annual?.hasContingentDanger) {
      xpPenalty += 400;
      burnoutIncrease += 12;
      console.log('‚ö†Ô∏è VIOLATION : Contingent annuel d√©pass√© ‚Üí -400 XP, +12 burn-out');
    }
    
    // Appliquer p√©nalit√©s XP avec cooldown
    if (xpPenalty > 0 && typeof xpSystem !== 'undefined') {
      const now = Date.now();
      const lastPenalty = window._lastXpPenaltyTime || 0;
      
      if (now - lastPenalty < 60000) {
        console.log('‚è∏Ô∏è P√©nalit√© XP skipp√©e (cooldown 1 min)');
      } else {
        window._lastXpPenaltyTime = now;
        const oldXP = xpSystem.currentXP;
        xpSystem.currentXP = Math.max(0, xpSystem.currentXP - xpPenalty);
        xpSystem.level = xpSystem.calculateLevel();
        xpSystem.saveToStorage();
        console.log('üí• P√©nalit√© XP appliqu√©e:', oldXP, '‚Üí', xpSystem.currentXP, '(-' + xpPenalty + ')');
        
        // Historique
        if (typeof addRewardToHistory === 'function') {
          addRewardToHistory('‚ö†Ô∏è Violation : -' + xpPenalty + ' XP', 'danger');
        }
        
        // Animation RISQUE (si pas d√©j√† en cours)
        if (!window._xpPenaltyAnimRunning) {
          const riskEl = document.getElementById('hud-burnout');
          if (riskEl) {
            window._xpPenaltyAnimRunning = true;
            const originalValue = riskEl.textContent;
            const originalColor = riskEl.style.color;
            const originalWeight = riskEl.style.fontWeight;
            const originalSize = riskEl.style.fontSize;
            
            let blink = 0;
            const blinkInterval = setInterval(() => {
              riskEl.textContent = blink % 2 === 0 ? '-' + xpPenalty : '';
              riskEl.style.color = '#ff0000';
              riskEl.style.fontWeight = '900';
              riskEl.style.fontSize = '1.5rem';
              blink++;
              if (blink >= 10) {
                clearInterval(blinkInterval);
                riskEl.textContent = gameState.burnout || 0;
                riskEl.style.color = originalColor;
                riskEl.style.fontWeight = originalWeight;
                riskEl.style.fontSize = originalSize;
                window._xpPenaltyAnimRunning = false;
              }
            }, 300);
          }
        }
      }
      
      if (typeof refreshHUD === 'function') refreshHUD();
    }
    
    // Appliquer augmentation burn-out
    if (burnoutIncrease > 0) {
      // Initialiser gameState si absent
      if (typeof gameState === 'undefined') {
        window.gameState = {burnout: 0};
      }
      const oldBurnout = gameState.burnout || 0;
      gameState.burnout = Math.min(100, oldBurnout + burnoutIncrease);
      console.log('üî• Burn-out augment√©:', oldBurnout, '‚Üí', gameState.burnout, '(+' + burnoutIncrease + ')');
      
      // Sauvegarder
      try {
        localStorage.setItem('FOX_GAME_STATE', JSON.stringify(gameState));
      } catch(e) {}
    }

    if (totalDelta > 0.09 && typeof xpSystem !== 'undefined') {
      // addXP prend des HEURES (xpPerHour=100), pas des points XP
      console.log('ü¶ä XP : +' + totalDelta + 'h ‚Üí calling addXP() [source:', source, ']');
      const result = xpSystem.addXP(totalDelta); // totalDelta en heures
      console.log('ü¶ä XP : nouveau niveau =', xpSystem.level, ', XP =', xpSystem.currentXP);
      const xpGain = result ? result.xpGained : Math.round(totalDelta * 100);
      
      // G√©rer mont√©e de niveau
      if (result && result.leveledUp) {
        console.log('üéâ LEVEL UP:', result.oldLevel, '‚Üí', result.newLevel);
        if (typeof showLevelUpAnimation === 'function') {
          setTimeout(() => showLevelUpAnimation(result.newLevel), 500);
        }
        if (typeof updateMenuColors === 'function') {
          setTimeout(() => updateMenuColors(), 600);
        }
        
        // V√âRIFIER BADGES apr√®s level up
        if (typeof badgeSystem !== 'undefined' && typeof buildBadgeStats === 'function') {
          setTimeout(() => {
            try {
              console.log('üèÖ V√©rification badges apr√®s level up...');
              const newBadges = badgeSystem.checkAndUnlockBadges(buildBadgeStats());
              if (newBadges && newBadges.length > 0) {
                console.log('üèÖ AUTO LEVELUP : Badges d√©bloqu√©s:', newBadges.length);
                newBadges.forEach((badge, i) => {
                  setTimeout(() => {
                    if (typeof showBadgeUnlockAnim === 'function') showBadgeUnlockAnim(badge);
                  }, i * 4500);
                });
              }
            } catch(e) { console.warn('Erreur v√©rification badges levelup:', e); }
          }, 1000);
        }
      }

      // Sync gameState
      if (typeof gameState !== 'undefined') {
        if (gameState.player) {
          gameState.player.xp    = xpSystem.currentXP;
          gameState.player.level = xpSystem.level;
        }
        if (gameState.hours) gameState.hours.total = (gameState.hours.total || 0) + totalDelta;
        if (typeof saveGameState === 'function') saveGameState();
      }

      // Mettre √† jour les derniers cumuls APR√àS attribution
      _lastM1Net = cumM1Net;
      _lastM2Tot = cumM2Tot;
      
      if (!isFirstSync) {
        // showNotification crash - on skip pour l'instant
        console.log('‚úÖ +' + xpGain + ' XP ‚Äî ' + totalDelta.toFixed(1) + 'h sup d√©tect√©es (' + primary + ')');
      } else {
        console.log('FOX init : ' + totalDelta.toFixed(1) + 'h cumul√©es ‚Üí +' + xpGain + ' XP (source: ' + primary + ')');
        setTimeout(function(){ try { kitsuneNarrateOvertime(0, 'INIT'); } catch(_e){} }, 800);
      }
    }

    _lastM1Net = cumM1Net;
    _lastM2Tot = cumM2Tot;
    _saveLastCumul(cumM1Net, cumM2Tot);

    // Rafra\u00EEchir tout l'affichage
    refreshHUD();
    if (typeof updateAllDisplays === 'function') {
      try { updateAllDisplays(); } catch(e) {}
    }

    // V\u00E9rifier les badges d\u00E9bloqu\u00E9s
    if (typeof checkAndAwardBadges === 'function') {
      setTimeout(checkAndAwardBadges, 500);
    }

  } catch(e) {
    console.warn('syncModulesAndAwardXP:', e);
    try { refreshHUD(); 
    // Mettre √† jour la taille du PNJ selon le niveau actuel
    const currentLevel = typeof xpSystem !== 'undefined' ? (xpSystem.level || 1) : 1;
    if (typeof updatePNJLevel === 'function') {
      updatePNJLevel(currentLevel);
    }
    
} catch(ex) {}
  }
}

// \u2500\u2500 Polling auto toutes les 20 secondes \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
let _syncInterval = null;
function startSyncPolling() {
  if (_syncInterval) clearInterval(_syncInterval);
  _syncInterval = setInterval(() => syncModulesAndAwardXP('poll'), 20000);
  
  // V√©rification badges p√©riodique (toutes les 30 secondes)
  setInterval(() => {
    if (typeof badgeSystem !== 'undefined' && typeof buildBadgeStats === 'function') {
      try {
        const newBadges = badgeSystem.checkAndUnlockBadges(buildBadgeStats());
        if (newBadges && newBadges.length > 0) {
          console.log('üèÖ AUTO P√âRIODIQUE : Badges d√©bloqu√©s:', newBadges.length);
          newBadges.forEach((badge, i) => {
            setTimeout(() => {
              if (typeof showBadgeUnlockAnim === 'function') showBadgeUnlockAnim(badge);
            }, i * 4500);
          });
        }
      } catch(e) {}  // Silent fail pour v√©rification p√©riodique
    }
  }, 30000);
}

// \u2500\u2500 \u00C9couter les changements localStorage (depuis M1/M2) \u2500\u2500\u2500\u2500\u2500\u2500\u2500
window.addEventListener('storage', (e) => {
  // R\u00E9agir si M1, M2 ou l'ann\u00E9e active changent
  if (e.key && (
    e.key.startsWith('DATA_REPORT_') ||
    e.key.startsWith('CA_HS_TRACKER_V1_DATA_') ||
    e.key === 'ACTIVE_YEAR_SUFFIX'
  )) {
    setTimeout(() => syncModulesAndAwardXP('storage-event'), 300);
  }
});

// \u2500\u2500 Init \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
document.addEventListener('DOMContentLoaded', () => {
  // Exposer BADGES et LEAGUES globalement d\u00E8s le chargement
  setTimeout(() => {
    if (typeof badgeSystem !== 'undefined' && badgeSystem.badges && badgeSystem.badges.length > 0) {
      window.BADGES = badgeSystem.badges;
    } else if (typeof rpgSystem !== 'undefined' && rpgSystem.badges && rpgSystem.badges.length > 0) {
      window.BADGES = rpgSystem.badges;
    }
    console.log('[INIT] window.BADGES peupl\u00E9:', (window.BADGES||[]).length, 'badges');
  }, 300);
  setTimeout(() => {
    syncModulesAndAwardXP('init');
    
    // V√âRIFIER BADGES au d√©marrage
    setTimeout(() => {
      if (typeof badgeSystem !== 'undefined' && typeof buildBadgeStats === 'function') {
        try {
          console.log('üèÖ V√©rification badges au d√©marrage...');
          const newBadges = badgeSystem.checkAndUnlockBadges(buildBadgeStats());
          if (newBadges && newBadges.length > 0) {
            console.log('üèÖ AUTO INIT : Badges d√©bloqu√©s:', newBadges.length);
            newBadges.forEach((badge, i) => {
              setTimeout(() => {
                console.log('üèÖ Animation badge', i+1, '/', newBadges.length, ':', badge.name);
                if (typeof showBadgeUnlockAnim === 'function') showBadgeUnlockAnim(badge);
              }, i * 4500);
            });
          }
        } catch(e) { console.warn('Erreur v√©rification badges init:', e); }
      }
    }, 2000);
  }, 800);
  setTimeout(() => { const lvl = typeof xpSystem !== 'undefined' ? (xpSystem.level || 1) : 1; if (typeof updatePNJLevel === 'function') updatePNJLevel(lvl); }, 1200);
  startSyncPolling();
  setTimeout(checkBurnoutAlert, 1500);
  // ‚îÄ‚îÄ Nouvelles features ‚îÄ‚îÄ
  setTimeout(checkOnboarding, 500);
  // Profil Kitsune : greeting personnalis√© au chargement
  setTimeout(() => {
    const p = loadKitsuneProfile();
    if (p && p.prenom) _applyProfileToHUD(p);
  }, 600);
  setTimeout(checkWeeklyNotif, 4000);
  setTimeout(checkMonthlySummary, 3000);
  setTimeout(checkAndNotifyPatterns, 5000);
   // apr√®s 10s, quand l'utilisateur est install√©
  // Bonus XP multi-ann\u00E9es : attribu\u00E9 une seule fois par session
  setTimeout(() => {
    try {
      const cum = moduleReader.getCumulatedSummary ? moduleReader.getCumulatedSummary() : null;
      if (cum && cum.xpBonus > 0 && typeof gainXP === 'function') {
        const key = 'fox_multiyear_xp_applied';
        const already = sessionStorage.getItem(key);
        if (!already) {
          gainXP(cum.xpBonus, `${cum.years.length} ann\u00E9es de donn\u00E9es d\u00E9tect\u00E9es`);
          sessionStorage.setItem(key, '1');
          console.log(`\uD83C\uDFC6 Bonus XP multi-ann\u00E9es : +${cum.xpBonus} XP pour ${cum.years.length} an(s)`);
        }
      }
    } catch(e) {}
  }, 2000);
});

// \u2500\u2500 HUD \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function setFoxSource(source) {
  if (!moduleReader.setSourceOverride) return;
  moduleReader.setSourceOverride(source);
  setTimeout(() => { refreshModulesPopup(); refreshHUD(); }, 100);
  // Exposer BADGES globalement depuis badgeSystem
  if (typeof badgeSystem !== 'undefined' && badgeSystem.badges) {
    window.BADGES = badgeSystem.badges;
  } else if (typeof rpgSystem !== 'undefined' && rpgSystem.badges) {
    window.BADGES = rpgSystem.badges;
  }
}


// Animation mont√©e de niveau
function showLevelUpAnimation(level) {
  const banner = document.getElementById('levelup-banner');
  const bannerNum = document.getElementById('levelup-banner-num');
  if (!banner || !bannerNum) return;
  
  console.log('üéâüéâüéâ LEVEL UP ANIMATION START - NIVEAU', level);
  
  // 1. FLASH √âCRAN DOR√â
  const flash = document.createElement('div');
  flash.style.cssText = `
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: radial-gradient(circle, rgba(255,215,0,0.4), transparent);
    pointer-events: none; z-index: 99999;
    animation: flashPulse 1s ease-out;
  `;
  document.body.appendChild(flash);
  setTimeout(() => flash.remove(), 1000);
  
  // 2. CONFETTIS üéä
  for (let i = 0; i < 50; i++) {
    setTimeout(() => {
      const confetti = document.createElement('div');
      confetti.textContent = ['üéâ', '‚≠ê', '‚ú®', 'üåü', 'üí´'][Math.floor(Math.random() * 5)];
      confetti.style.cssText = `
        position: fixed;
        left: ${Math.random() * 100}%;
        top: -50px;
        font-size: ${Math.random() * 20 + 20}px;
        pointer-events: none;
        z-index: 99998;
        animation: confettiFall ${Math.random() * 2 + 2}s linear forwards;
      `;
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 4000);
    }, i * 20);
  }
  
  // 3. BANNI√àRE "NIVEAU X !"
  bannerNum.textContent = level;
  banner.classList.remove('active');
  void banner.offsetWidth;
  banner.classList.add('active');
  
  setTimeout(() => {
    banner.classList.remove('active');
  }, 4000);
  
  // 4. VIBRATION (si support√©)
  if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
  
  console.log('‚úÖ Animation level up SPECTACULAIRE affich√©e');
}

// Mettre √† jour les couleurs du menu selon la ligue
function updateMenuColors() {
  if (typeof leagueSystem === 'undefined' || typeof xpSystem === 'undefined') return;
  const xp = xpSystem.currentXP || 0;
  const league = leagueSystem.getCurrentLeague(xp);
  console.log('üé® updateMenuColors:', {xp, league: league?.name, color: league?.color});
  if (!league || !league.color) return;
  
  // Colorer TOUTE la barre du haut (HUD)
  const hudBar = document.getElementById('gaming-hud');
  if (hudBar) {
    // FOND OPAQUE (pas de transparence !)
    hudBar.style.background = `linear-gradient(135deg, 
      rgba(30, 35, 45, 1) 0%, 
      ${league.color}40 50%, 
      rgba(30, 35, 45, 1) 100%)`;
    hudBar.style.borderBottom = `4px solid ${league.color}`;
    hudBar.style.borderTop = `2px solid ${league.color}`;
    hudBar.style.boxShadow = `0 0 30px ${league.color}, inset 0 2px 10px ${league.color}40`;
    console.log('‚úÖ Barre HUD OPAQUE color√©e:', league.color);
  } else {
    console.warn('‚ö†Ô∏è Element gaming-hud absent');
  }
  
  // Appliquer la couleur de la ligue aux boutons du dock
  const dockButtons = document.querySelectorAll('.dock-btn');
  dockButtons.forEach(btn => {
    btn.style.borderColor = league.color;
    btn.style.background = `linear-gradient(135deg, ${league.color}15, ${league.color}05)`;
    btn.style.boxShadow = `0 0 10px ${league.color}25`;
  });
  console.log('‚úÖ Boutons dock color√©s:', dockButtons.length, 'boutons');
  
  // Colorer badge niveau
  const hudLevel = document.getElementById('hud-level');
  if (hudLevel && hudLevel.parentElement) {
    hudLevel.parentElement.style.borderColor = league.color;
    hudLevel.parentElement.style.boxShadow = `0 0 12px ${league.color}40`;
  }
  
  // Colorer badge ligue
  const hudLeague = document.getElementById('hud-league');
  if (hudLeague) {
    hudLeague.style.borderColor = league.color + '80';
    hudLeague.style.background = `linear-gradient(135deg, ${league.color}20, ${league.color}10)`;
    hudLeague.style.color = league.color;
  }
}

function refreshHUD() {
  const _lvl = typeof xpSystem !== 'undefined' ? (xpSystem.level||1) : (gameState&&gameState.level||1);
  if (typeof updatePNJLevel === 'function') updatePNJLevel(_lvl);
  try {
    if (typeof xpSystem !== 'undefined') {
      const lvl = xpSystem.level || 1;
      const xp  = xpSystem.currentXP || 0;
      const progress = xpSystem.getCurrentLevelProgress ? xpSystem.getCurrentLevelProgress() : {current:xp,needed:1000,percentage:0};
      document.getElementById('hud-level').textContent  = lvl;
      document.getElementById('hud-xp').textContent     = progress.current || xp;
      document.getElementById('hud-xp-max').textContent = progress.needed  || 1000;
      document.getElementById('hud-xp-fill').style.width = Math.min(100, progress.percentage || 0)+'%';
      const pct = document.getElementById('hud-xp-percent');
      if (pct) pct.textContent = Math.min(100, Math.round(progress.percentage || 0)) + '% niveau suivant';
      if (typeof leagueSystem !== 'undefined' && leagueSystem.getCurrentLeague) {
        const _xpForLeague = xpSystem ? xpSystem.currentXP : 0;
        const leagueData = leagueSystem.leagues ? leagueSystem.leagues.find(l => l.name === leagueSystem.getCurrentLeague(_xpForLeague)?.name) : null;
        const lgEl = document.getElementById('hud-league');
        if (lgEl) {
          if (leagueData && leagueData.img) {
            lgEl.innerHTML = '<img src="' + leagueData.img + '" alt="' + (leagueData.name||'') + '" style="height:18px;vertical-align:middle;margin-right:3px;filter:drop-shadow(0 0 4px rgba(255,215,0,0.5));" onerror="this.style.display=\'none\'"> ' + (leagueData.name||'Bronze');
          } else {
            lgEl.textContent = leagueSystem.getCurrentLeague(lvl)?.name || 'Bronze';
          }
        }
        // Prochaine ligue
        const nextLgEl = document.getElementById('hud-next-league');
        if (nextLgEl && typeof leagueSystem.leagues !== 'undefined') {
          const leagues = leagueSystem.leagues || [];
          const curIdx = leagues.findIndex(l => l.name === (leagueData && leagueData.name));
          if (curIdx >= 0 && curIdx < leagues.length - 1) {
            const nextL = leagues[curIdx + 1];
            if (nextL && nextL.xpMin) {
              const remaining = Math.max(0, nextL.xpMin - (xpSystem.currentXP || 0));
              nextLgEl.textContent = remaining > 0 ? remaining + ' XP \u2192 ' + nextL.name : '\uD83C\uDFC6 ' + nextL.name;
            }
          } else { nextLgEl.textContent = ''; }
        }
      }
      // Lire les deux sources de badges
      const _allBadgesCount = _getUnlockedIds ? _getUnlockedIds().length : (gameState.badges?.length||0);
      document.getElementById('hud-badges').textContent = _allBadgesCount;
    }
    // Mettre √† jour les couleurs du menu
    updateMenuColors();
    const bo      = moduleReader.getBurnoutScore ? moduleReader.getBurnoutScore() : {score:0,level:'sain'};
    const rolling = moduleReader.getRollingAnalysis ? moduleReader.getRollingAnalysis(12) : {avgTotal:35,violations:{over48:0,over35:0},trend:'stable',weeksAnalyzed:0};
    // RISQUE = burnout score
    const boEl = document.getElementById('hud-burnout');
    if (boEl) {
      boEl.textContent = bo.score;
      if (bo.score>=60) { boEl.classList.add('danger-val'); }
      else { boEl.classList.remove('danger-val'); }
    }
    
    // √âNERGIE = 100 - risque (FORMULE SIMPLE)
    const enEl = document.getElementById('hud-energy');
    if (enEl) {
      const enVal = Math.max(0, 100 - bo.score);
      enEl.textContent = enVal;
      if (enVal<30) enEl.classList.add('danger-val'); 
      else enEl.classList.remove('danger-val');
    }
    
    console.log('üîÑ Risque=' + bo.score + ', √ânergie=' + (100-bo.score) + ', Total=' + (bo.score + (100-bo.score)));
    // violations supprimees du HUD
    // Cumul heures sup toutes annees (M1 + M2 fusionnes)
    let cum = null;
    try {
      const cumData = moduleReader.getCumulatedHours ? moduleReader.getCumulatedHours() : null;
      if (cumData) {
        const hoursEl = document.getElementById('hud-hours');
        if (hoursEl) hoursEl.textContent = Math.round(cumData.netOvertime || 0);
        cum = { totalNetOvertime: cumData.netOvertime || 0 };
      }
    } catch(e) {}
    if (!cum) cum = moduleReader.getCumulatedSummary ? moduleReader.getCumulatedSummary() : null;
    // Bulle Kitsune dynamique
    const bubbleEl = document.getElementById('kitsune-bubble-text');
    if (bubbleEl) {
      const net = cum ? (cum.totalNetOvertime||0).toFixed(0) : '?';
      // D\u00E9tail du score burnout pour expliquer d'o\u00F9 vient la valeur
      const rolling2 = moduleReader.getRollingAnalysis ? moduleReader.getRollingAnalysis(12) : null;
      const avgH = rolling2 ? rolling2.avgTotal.toFixed(1) : '35';
      const ov48 = rolling2 ? (rolling2.violations?.over48 || 0) : 0;
      const trend2 = rolling2 ? rolling2.trend : 'stable';
      const expl = bo.score > 0
        ? `Moy ${avgH}h/sem${ov48>0?' \u00B7 '+ov48+'\u00D7 +48h':''}${trend2==='hausse'?' \u00B7 tendance \u2197':''}. `
        : '';
      const msgs = {
        sain:      `\u2705 Tout va bien ! ${net}h sup cumul\u00E9es. ${expl}Tape-moi pour en savoir plus.`,
        vigilance: `\uD83D\uDC9B Vigilance (score ${bo.score}/100) : ${net}h sup. ${expl}Semaines charg\u00E9es d\u00E9tect\u00E9es.`,
        risque:    `\uD83D\uDFE0 Risque (score ${bo.score}/100) : ${net}h sup. ${expl}Consulte l'analyse.`,
        danger:    `\uD83D\uDD34 Danger (score ${bo.score}/100) : ${net}h sup. ${expl}Ta charge est critique !`,
        critique:  `\uD83D\uDEA8 CRITIQUE (score ${bo.score}/100) : ${net}h sup. ${expl}Agis maintenant !`,
      };
      bubbleEl.textContent = msgs[bo.level] || msgs.sain;
    }
    const rColor = bo.score<20?'#4CAF50':bo.score<40?'#FF8C42':bo.score<60?'#FF6B35':bo.score<80?'#E53935':'#B71C1C';
    const rLabel = bo.score<20?'\uD83D\uDC9A Sain':bo.score<40?'\uD83D\uDC9B Vigilance':bo.score<60?'\uD83E\uDDE1 Risque':bo.score<80?'\uD83D\uDD34 Danger':'\uD83D\uDEA8 Critique';
    document.getElementById('risk-label-main').textContent = rLabel;
    document.getElementById('risk-bar-main').style.cssText =
      `width:${bo.score}%;background:${rColor};box-shadow:0 0 8px ${rColor}88;`;
  } catch(e) { console.warn('HUD:', e); }
}

// \u2500\u2500 Burn-out \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500

// \u2500\u2500\u2500 Effet nuages mena\u00E7ants burnout \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500

function updateStormOverlay(score) {
  const ov = document.getElementById('storm-overlay');
  if (!ov) return;
  if (score < 55) { ov.classList.remove('visible'); ov.innerHTML = ''; return; }

  const intensity = Math.min(1, (score - 40) / 60);

  if (!ov.querySelector('.storm-cloud')) {
    const vig = document.createElement('div');
    vig.className = 'storm-vignette';
    ov.appendChild(vig);
    const clouds = [
      { w:800,h:450, top:'-15%', left:'-15%', rgb:'160,0,0',   dur:'16s', delay:'0s' },
      { w:700,h:400, top:'-10%', left:'35%',  rgb:'200,10,0',  dur:'22s', delay:'-7s' },
      { w:900,h:500, top:'-20%', left:'55%',  rgb:'120,0,0',   dur:'19s', delay:'-3s' },
      { w:600,h:350, top:'0%',   left:'15%',  rgb:'180,5,5',   dur:'14s', delay:'-11s' },
      { w:650,h:380, top:'-5%',  left:'70%',  rgb:'140,0,20',  dur:'21s', delay:'-5s' },
      { w:750,h:420, top:'-18%', left:'80%',  rgb:'200,30,10', dur:'17s', delay:'-9s' },
    ];
    clouds.forEach(c => {
      const el = document.createElement('div');
      el.className = 'storm-cloud';
      el.style.cssText = 'width:'+c.w+'px;height:'+c.h+'px;top:'+c.top+';left:'+c.left+';animation-duration:'+c.dur+';animation-delay:'+c.delay+';';
      el.dataset.rgb = c.rgb;
      ov.appendChild(el);
    });
    const l1 = document.createElement('div'); l1.className = 'storm-lightning';  ov.appendChild(l1);
    const l2 = document.createElement('div'); l2.className = 'storm-lightning-2'; ov.appendChild(l2);
  }

  ov.classList.add('visible');
  ov.querySelectorAll('.storm-cloud').forEach(c => {
    const rgb = c.dataset.rgb || '160,0,0';
    const alpha = 0.10 + intensity * 0.25; // intensit√© r√©duite
    c.style.background = 'rgba('+rgb+',' + alpha.toFixed(2) + ')';
  });
  const vig = ov.querySelector('.storm-vignette');
  if (vig) vig.style.opacity = String(0.15 + intensity * 0.35); // vignette att√©nu√©e
  const l1 = ov.querySelector('.storm-lightning');
  const l2 = ov.querySelector('.storm-lightning-2');
  if (l1) l1.style.animationDuration = score >= 85 ? '1.8s' : score >= 70 ? '2.5s' : '4s';
  if (l2) { l2.style.display = score >= 60 ? 'block' : 'none'; l2.style.animationDuration = score >= 85 ? '2.2s' : '3.5s'; }
  if (score >= 85) { ov.style.animation = 'screenShake 0.5s ease-in-out infinite'; }
  else { ov.style.animation = ''; }
}

function checkBurnoutAlert() {
  try {
    const bo = moduleReader.getBurnoutScore ? moduleReader.getBurnoutScore() : {score:0};
    // Tracker le pic burn-out historique
    const peak = parseInt(localStorage.getItem('FOX_BURNOUT_PEAK') || '0');
    if ((bo.score || 0) > peak) localStorage.setItem('FOX_BURNOUT_PEAK', String(bo.score));
    // Mettre \u00E0 jour les nuages m\u00EAme si anim d\u00E9sactiv\u00E9es
    updateStormOverlay(bo.score || 0);
    if (!document.getElementById('toggle-burnout-anim')?.checked) return;
    const vig = document.getElementById('vignette-overlay');
    const ov  = document.getElementById('burnout-overlay');
    updateStormOverlay(bo.score || 0);
    if (bo.score>=80) {
      ov.classList.add('active'); vig.className='critique';
      document.getElementById('card-burnout').style.cssText='border-color:#E53935;box-shadow:0 0 30px rgba(229,57,53,0.3);';
      document.getElementById('burnout-card-desc').textContent=`\uD83D\uDEA8 Score ${bo.score}/100 \u2014 Situation critique`;
      document.getElementById('burnout-card-desc').classList.add('burnout-text-bleed');
      document.body.classList.remove('burnout-shake');
      void document.body.offsetWidth;
      document.body.classList.add('burnout-shake');
      setTimeout(()=>document.body.classList.remove('burnout-shake'),700);
      spawnFatigueParticles(10);
      document.getElementById('burnout-score-val').textContent = bo.score+'/100';
      document.getElementById('burnout-popup-msg').textContent =
        `Niveau ${bo.level?.toUpperCase()}. ${bo.details?.violations?.over48||0} semaine(s) \u00E0 +48h. `+
        `Consultez votre m\u00E9decin du travail et exercez votre droit \u00E0 la d\u00E9connexion (art. L2242-17).`;
      document.getElementById('burnout-popup').classList.add('visible');
    } else if (bo.score>=60) {
      vig.className='danger';
      document.getElementById('burnout-card-desc').textContent=`\u26A0\uFE0F Score ${bo.score}/100 \u2014 Vigilance`;
    } else if (bo.score>=40) {
      document.getElementById('burnout-card-desc').textContent=`\uD83D\uDC9B Score ${bo.score}/100 \u2014 Surveillez`;
    }
  } catch(e){}
}

function closeBurnoutPopup() {
  document.getElementById('burnout-popup').classList.remove('visible');
  openPopup('popup-burnout');
}
function toggleBurnoutAnimations(on) {
  if (!on) { document.getElementById('vignette-overlay').className=''; document.getElementById('burnout-overlay').classList.remove('active'); updateStormOverlay(0); }
  else checkBurnoutAlert();
}
function spawnFatigueParticles(n) {
  for (let i=0;i<n;i++) {
    const p=document.createElement('div'); p.className='fatigue-particle';
    p.style.left=Math.random()*100+'vw'; p.style.top='-10px';
    const sz=(6+Math.random()*8)+'px'; p.style.width=sz; p.style.height=sz;
    p.style.animationDuration=(3+Math.random()*4)+'s';
    p.style.animationDelay=(Math.random()*2)+'s';
    document.body.appendChild(p); setTimeout(()=>p.remove(),7000);
  }
}

// \u2500\u2500 Analyse \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function runAnalyse() {
  const dh = [0,1,2,3,4,5,6].map(i=>Number(document.getElementById('day'+i).value)||0);
  const gs = {
    weeklyHours:dh.reduce((s,h)=>s+h,0), dailyHours:dh,
    hasNightWork:document.getElementById('chk-night').checked,
    hasSundayWork:document.getElementById('chk-sunday').checked||dh[6]>0,
    hasSaturdayWork:document.getElementById('chk-saturday').checked||dh[5]>0,
    hasHolidayWork:document.getElementById('chk-holiday').checked,
  };
  const result = (typeof foxScenarioEngineExpert!=='undefined')
    ? foxScenarioEngineExpert(gs) : foxScenarioEngine(gs);
  const box = document.getElementById('analyse-results');
  box.style.display='block';
  document.getElementById('analyse-summary').innerHTML =
    `<strong>${result.riskLevel?.emoji||''} ${result.riskLevel?.label||''}</strong> \u2014 Score ${result.riskScore||0}/100<br><span style="font-size:0.85rem;">${result.summary||''}</span>`;
  document.getElementById('analyse-violations').innerHTML =
    !(result.violations?.length)
      ? '<span style="color:#4CAF50;font-size:0.82rem;">\u2705 Aucune violation</span>'
      : result.violations.map(v=>`<span class="violation-tag">\u26A0\uFE0F ${v.label} <small style="opacity:0.5">art.${v.article}</small></span>`).join('');
  const sc = result.matchedScenarios||result.triggered||[];
  document.getElementById('analyse-scenarios').innerHTML = sc.slice(0,5).filter(Boolean).map(s=>
    `<div class="scenario-card-mini">
       <div class="sc-name">${s.name}</div>
       <div class="sc-legal">${s.legal||''} \u00B7 ${s.risk||'\u2014'}</div>
       <div style="font-size:0.78rem;color:#777;margin-top:4px;">${s.conseil?.message||''}</div>
     </div>`).join('');
  if (result.violations?.length>0 && typeof gainXP==='function') gainXP(50,'Violation d\u00E9tect\u00E9e');
  document.getElementById('hud-violations').textContent = result.violations?.length||0;
  refreshHUD();
}

// \u2500\u2500 Modules popup \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function refreshModulesPopup() {
  const cum   = moduleReader.getCumulatedSummary ? moduleReader.getCumulatedSummary() : null;
  const years = moduleReader.detectAllYears ? moduleReader.detectAllYears() : [moduleReader.year];
  const src   = cum?.source || 'fusion';
  const manual = localStorage.getItem('FOX_SOURCE_OVERRIDE');

  const srcLabel = src === 'fusion' ? '\uD83D\uDD00 Fusion auto' : src === 'M1' ? '\uD83D\uDCC5 M1 forc\u00E9' : '\uD83D\uDCB0 M2 forc\u00E9';
  const srcColor = src === 'M1' ? '#64C8FF' : src === 'M2' ? '#FFD700' : '#4CAF50';

  let html = `
    <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:14px;margin-bottom:14px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <strong style="color:#FF8C42;">\uD83D\uDCCA Cumul toutes ann\u00E9es</strong>
        <span style="background:rgba(255,255,255,0.08);color:${srcColor};border-radius:20px;padding:3px 10px;font-size:0.72rem;font-weight:700;">
          ${srcLabel}
        </span>
      </div>
      <div style="font-size:0.72rem;color:#666;margin-bottom:10px;">
        ${src === 'fusion'
          ? 'Fusion intelligente \u2014 M1 et M2 combin\u00E9s mois par mois, z\u00E9ro doublon. Le cumul est pr\u00E9serv\u00E9 m\u00EAme si vous changez de module.'
          : `Source forc\u00E9e manuellement sur ${src}. Les mois sans donn\u00E9es dans ${src} sont compl\u00E9t\u00E9s par l'autre module.`
        }
      </div>
      <div style="margin-bottom:12px;">
        <div style="font-size:0.72rem;color:#888;margin-bottom:6px;">\uD83C\uDF9B\uFE0F Mode de lecture :</div>
        <div style="display:flex;gap:6px;">
          <button onclick="setFoxSource('auto')"
            style="flex:1;padding:7px;border-radius:8px;border:1px solid ${!manual?'#4CAF50':'rgba(255,255,255,0.1)'};
                   background:${!manual?'rgba(76,175,80,0.15)':'rgba(255,255,255,0.04)'};
                   color:${!manual?'#4CAF50':'#888'};font-size:0.73rem;cursor:pointer;font-weight:${!manual?'900':'400'}">
            \uD83D\uDD00 Fusion auto
          </button>
          <button onclick="setFoxSource('M1')"
            style="flex:1;padding:7px;border-radius:8px;border:1px solid ${manual==='M1'?'#64C8FF':'rgba(255,255,255,0.1)'};
                   background:${manual==='M1'?'rgba(100,200,255,0.15)':'rgba(255,255,255,0.04)'};
                   color:${manual==='M1'?'#64C8FF':'#888'};font-size:0.73rem;cursor:pointer;font-weight:${manual==='M1'?'900':'400'}">
            \uD83D\uDCC5 Forcer M1
          </button>
          <button onclick="setFoxSource('M2')"
            style="flex:1;padding:7px;border-radius:8px;border:1px solid ${manual==='M2'?'#FFD700':'rgba(255,255,255,0.1)'};
                   background:${manual==='M2'?'rgba(255,215,0,0.15)':'rgba(255,255,255,0.04)'};
                   color:${manual==='M2'?'#FFD700':'#888'};font-size:0.73rem;cursor:pointer;font-weight:${manual==='M2'?'900':'400'}">
            \uD83D\uDCB0 Forcer M2
          </button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-size:0.83rem;">
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">HS nettes totales</div>
          <div style="font-weight:900;font-size:1.3rem;color:#FF8C42;">${(cum?.totalNetOvertime||0).toFixed(0)}h</div>
        </div>
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">Ann\u00E9es suivies</div>
          <div style="font-weight:900;font-size:1.3rem;color:#FF8C42;">${years.length}</div>
        </div>
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">Mois analys\u00E9s</div>
          <div style="font-weight:900;font-size:1.3rem;color:#FF8C42;">${cum?.monthCount||0}</div>
        </div>
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">HS +25%</div>
          <div style="font-weight:700;color:#eee;">${(cum?.totalPlus25||0).toFixed(1)}h</div>
        </div>
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">HS +50%</div>
          <div style="font-weight:700;color:#eee;">${(cum?.totalPlus50||0).toFixed(1)}h</div>
        </div>
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">XP bonus</div>
          <div style="font-weight:700;color:#FFD700;">+${cum?.xpBonus||0} XP</div>
        </div>
      </div>
    </div>
    <div style="font-size:0.72rem;color:#555;letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">D\u00E9tail par ann\u00E9e</div>`;

  years.forEach(y => {
    const py = cum?.perYear?.[y];
    const net = py?.net || 0;
    const netColor = net > 100 ? '#E53935' : net > 50 ? '#FF8C42' : '#4CAF50';
    const m1cov = py?.m1Coverage || 0;
    const m2cov = py?.m2Coverage || 0;

    html += `
      <div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:12px;margin-bottom:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div style="font-weight:700;color:#FF8C42;">\uD83D\uDCC5 ${y}</div>
          <div style="display:flex;gap:4px;font-size:0.68rem;">
            ${m1cov ? `<span style="color:#64C8FF;background:rgba(100,200,255,0.1);border-radius:8px;padding:2px 7px;">M1: ${m1cov} mois</span>` : ''}
            ${m2cov ? `<span style="color:#FFD700;background:rgba(255,215,0,0.1);border-radius:8px;padding:2px 7px;">M2: ${m2cov} mois</span>` : ''}
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;font-size:0.82rem;">
          <div><div style="color:#555;font-size:0.7rem;">HS nettes</div><strong style="color:${netColor};">${net.toFixed(1)}h</strong></div>
          <div><div style="color:#555;font-size:0.7rem;">HS +25%</div><strong>${(py?.hs25||0).toFixed(1)}h</strong></div>
          <div><div style="color:#555;font-size:0.7rem;">HS +50%</div><strong>${(py?.hs50||0).toFixed(1)}h</strong></div>
        </div>
      </div>`;
  });

  if (!years.length) html += '<p style="color:#555;text-align:center;">Aucune donn\u00E9e \u2014 ouvrez le Module 1 ou 2.</p>';
  // \u2500\u2500 Diagnostic M1 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
  try {
    const y = (moduleReader.detectAllYears ? moduleReader.detectAllYears() : []).join(', ') || '\u2014';
    const m1Test = {};
    (moduleReader.detectAllYears ? moduleReader.detectAllYears() : []).forEach(yr => {
      const raw = JSON.parse(localStorage.getItem('DATA_REPORT_' + yr) || '{}');
      const days = Object.keys(raw).filter(k => /^\d{4}-\d{2}-\d{2}$/.test(k));
      const nonZero = days.filter(d => (raw[d].extra||0) > 0);
      m1Test[yr] = { totalDays: days.length, withHS: nonZero.length, sample: nonZero[0] ? raw[nonZero[0]] : null };
    });
    const diagLines = Object.entries(m1Test).map(([yr, v]) =>
      `${yr}: ${v.totalDays} jours M1, ${v.withHS} avec HS${v.sample?' (ex: extra='+v.sample.extra+'h)':''}`
    );
    html += `<details style="margin-top:14px;"><summary style="color:#444;font-size:0.7rem;cursor:pointer;letter-spacing:1px;">\uD83D\uDD0D DIAGNOSTIC M1 (d\u00E9veloppeur)</summary>
      <div style="font-size:0.72rem;color:#556;margin-top:8px;line-height:1.6;font-family:monospace;">
        ${diagLines.join('<br>') || 'Aucune donn\u00E9e M1 trouv\u00E9e'}
      </div></details>`;
  } catch(e) {}
  document.getElementById('modules-content').innerHTML = html;
}


// \u2500\u2500 Burn-out popup \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function refreshBurnoutPopup() {
  const bo=moduleReader.getBurnoutScore?moduleReader.getBurnoutScore():{score:0,level:'sain',details:{}};
  const r=moduleReader.getRollingAnalysis?moduleReader.getRollingAnalysis(12):{avgTotal:35,trend:'stable',violations:{over48:0},weeksAnalyzed:0};
  const c=bo.score<20?'#4CAF50':bo.score<40?'#FF8C42':bo.score<60?'#FF6B35':bo.score<80?'#E53935':'#B71C1C';
  document.getElementById('burnout-popup-content').innerHTML=`
    <div style="text-align:center;margin-bottom:18px;">
      <div style="font-size:3rem;font-weight:900;color:${c};text-shadow:0 0 20px ${c}55;">${bo.score}<span style="font-size:1.4rem;">/100</span></div>
      <div style="font-weight:700;color:${c};text-transform:uppercase;letter-spacing:2px;font-size:0.95rem;">${bo.level}</div>
    </div>
    <div class="risk-bar-track" style="margin-bottom:16px;"><div class="risk-bar-fill" style="width:${bo.score}%;background:${c};"></div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;font-size:0.83rem;">
      <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;"><div style="color:#555;">Moy. hebdo</div><strong>${r.avgTotal?.toFixed(1)||'\u2014'}h</strong></div>
      <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;"><div style="color:#555;">Tendance</div><strong>${r.trend==='hausse'?'\uD83D\uDCC8 Hausse':r.trend==='baisse'?'\uD83D\uDCC9 Baisse':'\u27A1\uFE0F Stable'}</strong></div>
      <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;"><div style="color:#555;">Sem. +48h</div><strong style="color:${(r.violations?.over48||0)>0?'#E53935':'#4CAF50'}">${r.violations?.over48||0}</strong></div>
      <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;"><div style="color:#555;">Sem. analys\u00E9es</div><strong>${r.weeksAnalyzed||0}</strong></div>
    </div>
    ${bo.score>=40?`<div style="background:rgba(229,57,53,0.08);border:1px solid rgba(229,57,53,0.18);border-radius:10px;padding:13px;font-size:0.82rem;color:#ffcdd2;line-height:1.6;">
      \u2695\uFE0F Consultez votre m\u00E9decin du travail. Droit \u00E0 la d\u00E9connexion (art. L2242-17). Visite \u00E0 la demande (art. L4624-1).
    </div>`:'<div style="color:#4CAF50;text-align:center;padding:10px;">\u2705 Situation saine !</div>'}`;
}

// \u2500\u2500 Qu\u00EAtes popup \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function refreshQuestesPopup() {
  const list=document.getElementById('quests-list'); if (!list) return;
  const q=typeof quests!=='undefined'&&Array.isArray(quests)?quests:[];
  list.innerHTML=q.slice(0,6).map(qt=>
    `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:12px;">
      <div style="font-weight:700;color:#eee;font-size:0.87rem;">${qt.icon||'\u2694\uFE0F'} ${qt.name||qt.title||'Qu\u00EAte'}</div>
      <div style="color:#666;font-size:0.77rem;margin-top:3px;">${qt.description||qt.desc||''}</div>
      <div style="background:rgba(255,255,255,0.06);border-radius:4px;height:4px;margin-top:7px;">
        <div style="height:100%;background:#FF8C42;border-radius:4px;width:${((qt.progress||0)/(qt.goal||1))*100}%;"></div>
      </div></div>`).join('')||'<p style="color:#555;text-align:center;font-size:0.85rem;">Aucune qu\u00EAte active.</p>';
}

// \u2500\u2500 Sc\u00E9narios popup \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function initScenariosPopup() {
  const all=typeof FOX_SCENARIOS!=='undefined'?FOX_SCENARIOS:[];
  renderScenarios(all.slice(0,30));
  document.getElementById('scenarios-count').textContent=`${all.length} sc\u00E9narios disponibles`;
}
function filterScenarios() {
  const q=document.getElementById('scenario-search').value.toLowerCase();
  const risk=document.getElementById('scenario-risk').value;
  let f=typeof FOX_SCENARIOS!=='undefined'?FOX_SCENARIOS:[];
  if (q)    f=f.filter(s=>s.name.toLowerCase().includes(q)||(s.desc||'').toLowerCase().includes(q));
  if (risk) f=f.filter(s=>s.risk===risk);
  renderScenarios(f.slice(0,50));
  document.getElementById('scenarios-count').textContent=`${f.length} sc\u00E9nario(s) trouv\u00E9(s)`;
}
function renderScenarios(list) {
  document.getElementById('scenarios-list').innerHTML=list.map(s=>
    `<div class="scenario-card-mini" onclick="var d=this.nextElementSibling;d.style.display=d.style.display==='none'?'block':'none'">
      <div class="sc-name">#${s.id} ${s.name}</div>
      <div class="sc-legal">${s.legal||''} \u00B7 ${s.risk||'\u2014'}</div>
    </div>
    <div style="display:none;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:11px;font-size:0.8rem;color:#aaa;line-height:1.5;margin-bottom:2px;">
      ${s.conseil?.message||s.desc||''}
      ${s.conseil?.actions?'<ul style="margin:7px 0 0;padding-left:14px;">'+s.conseil.actions.map(a=>`<li style="margin:3px 0;">${a}</li>`).join('')+'</ul>':''}
    </div>`).join('')||'<p style="color:#555;text-align:center;">Aucun r\u00E9sultat</p>';
}

// \u2500\u2500 Badges popup \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
// \u2500\u2500 Helpers badges communs \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function _getAllBadges() {
  let all = [];
  if (typeof badgeSystem !== 'undefined' && badgeSystem.badges && badgeSystem.badges.length > 0)
    all = badgeSystem.badges;
  else if (typeof BADGES !== 'undefined' && BADGES.length > 0)
    all = BADGES;
  if (all.length > 0 && (!window.BADGES || window.BADGES.length === 0)) window.BADGES = all;
  return all;
}
function _getUnlockedIds() {
  // Fusionner gameState.badges ET badgeSystem.unlockedBadges pour que les deux sources soient visibles
  const gs = (typeof gameState !== 'undefined' && gameState.badges) ? gameState.badges : [];
  const bs = (typeof badgeSystem !== 'undefined' && badgeSystem.unlockedBadges) ? badgeSystem.unlockedBadges : [];
  return [...new Set([...gs, ...bs])];
}
function _makeBadgeCard(b, ok, filterRarity) {
  if (filterRarity && filterRarity !== 'all' && b.rarity !== filterRarity) return '';
  const rC = {common:'rgba(180,180,180,0.14)',rare:'rgba(80,140,255,0.14)',epic:'rgba(160,80,255,0.16)',legendary:'rgba(255,180,30,0.18)'};
  const rB = {common:'rgba(180,180,180,0.25)',rare:'rgba(80,140,255,0.35)',epic:'rgba(160,80,255,0.4)',legendary:'rgba(255,180,30,0.5)'};
  const bg = ok ? (rC[b.rarity]||'rgba(255,255,255,0.06)') : 'rgba(255,255,255,0.015)';
  const bd = ok ? (rB[b.rarity]||'rgba(255,255,255,0.1)') : 'rgba(255,255,255,0.04)';
  const _fallbackIcon = b.icon || 'üèÖ';
  const imgHtml = b.img
    ? `<img src="${b.img || _getBadgeImagePath(b).replace(/_/g,'-')}" alt="${b.name}" style="width:44px;height:44px;object-fit:contain;" onerror="this.outerHTML='<span style=\'font-size:1.5rem;\'>${_fallbackIcon}</span>'"><span style="font-size:1.5rem;display:none;">${_fallbackIcon}</span>`
    : `<span style="font-size:1.5rem;">${_fallbackIcon}</span>`;
  const cursor = ok ? 'cursor:pointer;' : 'cursor:default;';
  const onclick = ok ? `onclick="showBadgeZoom('${(b.img||'').replace(/'/g,"\'")}','${(b.name||'').replace(/'/g,"\'")}','${((b.description||b.desc||'').replace(/'/g,"\'"))}')"` : '';
  return `<div title="${ok ? b.name+' : '+(b.description||b.desc||'') : '\u{1F512} '+b.name+' \u2014 non d\u00E9bloqu\u00E9'}"
    ${onclick}
    style="background:${bg};border:1px solid ${bd};border-radius:10px;padding:8px;text-align:center;opacity:${ok?1:0.28};transition:all 0.2s;${cursor}position:relative;">
    <div style="height:48px;display:flex;align-items:center;justify-content:center;">${ok?imgHtml:'<span style="font-size:1.5rem;filter:grayscale(1);">'+(b.icon||'\u{1F3C5}')+'</span>'}</div>
    <div style="font-size:0.56rem;color:${ok?'#bbb':'#444'};margin-top:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:58px;">${ok?b.name:'???'}</div>
    ${ok?'':`<div style="position:absolute;top:3px;right:4px;font-size:0.6rem;color:#333;">\u{1F512}</div>`}
  </div>`;
}

// Filtre raret\u00E9 actif
let _badgeFilterRarity = 'all';
function filterBadgesByRarity(r) {
  _badgeFilterRarity = r;
  document.querySelectorAll('.badge-filter-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.rarity === r);
  });
  // R√©afficher la grille normale
  const grid = document.getElementById('badges-grid');
  const history = document.getElementById('badges-history');
  if (grid) grid.style.display = 'grid';
  if (history) history.style.display = 'none';
  refreshBadgesPopup();
}

function refreshBadgesPopup() {
  const grid = document.getElementById('badges-grid'); if (!grid) return;
  // Auto-unlock badges avec stats actuelles
  if (typeof badgeSystem !== 'undefined' && typeof buildBadgeStats === 'function') {
    try { 
      const newBadges = badgeSystem.checkAndUnlockBadges(buildBadgeStats()); 
      // Afficher animation pour les nouveaux badges
      if (newBadges && newBadges.length > 0 && typeof showBadgeUnlockAnim === 'function') {
        console.log('üèÖ D√©blocage de', newBadges.length, 'badges');
        newBadges.forEach((badge, i) => {
          setTimeout(() => {
            console.log('üèÖ Animation badge', i+1, '/', newBadges.length, ':', badge.name);
            showBadgeUnlockAnim(badge);
          }, i * 4500);  // 4.5 secondes entre chaque badge
        });
      }
      refreshHUD(); // Mettre √† jour le compteur
    } catch(e){}
  }
  const all  = _getAllBadges().filter(b => !b.id || b.id <= 50);
  const done = _getUnlockedIds();
  grid.innerHTML = all.map(b => _makeBadgeCard(b, done.includes(b.id), _badgeFilterRarity)).join('') || '<p style="color:#555;">Aucun badge.</p>';
}


function showBadgesHistory() {
  const grid = document.getElementById('badges-grid');
  const history = document.getElementById('badges-history');
  if (!grid || !history) return;
  
  // Masquer la grille, afficher l'historique
  grid.style.display = 'none';
  history.style.display = 'block';
  
  // Mettre √† jour les boutons
  document.querySelectorAll('.badge-filter-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.rarity === 'history');
  });
  
  // R√©cup√©rer badges d√©bloqu√©s
  const unlocked = _getUnlockedIds();
  const allBadges = _getAllBadges();
  const unlockedBadges = allBadges.filter(b => unlocked.includes(b.id));
  
  if (unlockedBadges.length === 0) {
    history.innerHTML = '<div style="color:#555;text-align:center;padding:40px 20px;">Aucun badge d√©bloqu√© pour le moment</div>';
    return;
  }
  
  // Afficher l'historique (par ordre de d√©blocage)
  history.innerHTML = unlockedBadges.reverse().map(b => {
    const rarityColors = {
      common: '#b0b0b0',
      rare: '#5094ff',
      epic: '#a050ff',
      legendary: '#FFD700'
    };
    const color = rarityColors[b.rarity] || '#fff';
    
    return `<div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:12px;">
      <div style="width:48px;height:48px;flex-shrink:0;">
        ${b.img ? `<img src="${b.img}" alt="${b.name}" style="width:100%;height:100%;object-fit:contain;border-radius:4px;">` : `<div style="font-size:2rem;">${b.icon || 'üèÖ'}</div>`}
      </div>
      <div style="flex:1;">
        <div style="font-weight:700;color:${color};margin-bottom:4px;">${b.name}</div>
        <div style="font-size:0.75rem;color:#888;">${b.description}</div>
      </div>
    </div>`;
  }).join('');
}

function refreshSkillsPopup() {
  const grid = document.getElementById('skills-grid'); if (!grid) return;
  if (typeof badgeSystem !== 'undefined' && typeof buildBadgeStats === 'function') {
    try { 
      const newBadges = badgeSystem.checkAndUnlockBadges(buildBadgeStats()); 
      // Afficher animation pour les nouveaux badges
      if (newBadges && newBadges.length > 0 && typeof showBadgeUnlockAnim === 'function') {
        console.log('üèÖ D√©blocage de', newBadges.length, 'badges');
        newBadges.forEach((badge, i) => {
          setTimeout(() => {
            console.log('üèÖ Animation badge', i+1, '/', newBadges.length, ':', badge.name);
            showBadgeUnlockAnim(badge);
          }, i * 4500);  // 4.5 secondes entre chaque badge
        });
      }
      refreshHUD(); // Mettre √† jour le compteur
    } catch(e){}
  }
  const all  = _getAllBadges().filter(b => b.id && b.id >= 51);
  const done = _getUnlockedIds();
  grid.innerHTML = all.map(b => _makeBadgeCard(b, done.includes(b.id), 'all')).join('') || '<p style="color:#555;">Aucune comp\u00E9tence d\u00E9finie.</p>';
}

function refreshLeaguesPopup() {
  const grid = document.getElementById('leagues-grid'); if (!grid) return;
  if (typeof leagueSystem === 'undefined') { grid.innerHTML = '<p style="color:#555;">Ligues non charg\u00E9es.</p>'; return; }
  const xp  = typeof xpSystem !== 'undefined' ? (xpSystem.currentXP || 0) : 0;
  const cur = leagueSystem.getCurrentLeague(xp);
  const nxt = leagueSystem.getNextLeague ? leagueSystem.getNextLeague(xp) : null;
  const prog = leagueSystem.getLeagueProgress ? leagueSystem.getLeagueProgress(xp) : null;
  function hexRgb(hex) {
    if (!hex||!hex.startsWith('#')) return '255,140,66';
    return `${parseInt(hex.slice(1,3),16)},${parseInt(hex.slice(3,5),16)},${parseInt(hex.slice(5,7),16)}`;
  }
  grid.innerHTML = leagueSystem.leagues.map(lg => {
    const active   = lg.id === cur.id;
    const unlocked = xp >= lg.minXP;
    let bar = '';
    if (active && prog) {
      const pct = Math.min(100, Math.round(prog.percentage || 0));
      bar = `<div style="height:4px;background:rgba(255,255,255,0.07);border-radius:2px;margin-top:6px;overflow:hidden;"><div style="height:100%;width:${pct}%;background:${lg.color};border-radius:2px;transition:width 0.4s;"></div></div>
             <div style="font-size:0.65rem;color:${lg.color};margin-top:3px;">${pct}% \u2014 ${prog.xpRemainingForNext||'?'} XP restants</div>`;
    }
    const onclk = unlocked ? `onclick="showLeagueZoom('${lg.img||''}','${lg.name}','${lg.minXP.toLocaleString()} XP minimum')"` : '';
    return `<div ${onclk}
      style="background:${active?`rgba(${hexRgb(lg.color)},0.1)`:'rgba(255,255,255,0.02)'};border:${active?`2px solid ${lg.color}`:'1px solid rgba(255,255,255,0.06)'};border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:12px;opacity:${unlocked?1:0.3};${unlocked?'cursor:pointer;':''}transition:all 0.2s;">
      <div style="width:52px;height:52px;flex-shrink:0;display:flex;align-items:center;justify-content:center;">
        ${lg.img?`<img src="${lg.img}" alt="${lg.name}" style="width:48px;height:48px;object-fit:contain;${active?`filter:drop-shadow(0 0 8px ${lg.color});`:''}" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><span style="display:none;font-size:2rem;">${lg.icon||'\u{1F3C6}'}</span>`:`<span style="font-size:2rem;">${lg.icon||'\u{1F3C6}'}</span>`}
      </div>
      <div style="flex:1;min-width:0;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
          <span style="font-weight:700;color:${active?lg.color:'#aaa'};font-size:0.9rem;">${lg.name}${active?' \u25C4':''}</span>
          <span style="font-size:0.7rem;color:#555;white-space:nowrap;">${lg.minXP.toLocaleString()} XP</span>
        </div>
        ${bar}
      </div>
    </div>`;
  }).join('');
}

function showLeagueZoom(imgSrc, name, desc) {
  const ov = document.getElementById('badge-zoom-overlay');
  if (!ov) return;
  document.getElementById('badge-zoom-img').src = imgSrc;
  document.getElementById('badge-zoom-name').textContent = name;
  document.getElementById('badge-zoom-desc').textContent = desc;
  ov.style.display = 'flex';
}


function showBadgeZoom(imgSrc, name, desc) {
  const ov = document.getElementById('badge-zoom-overlay');
  if (!ov) return;
  document.getElementById('badge-zoom-img').src  = imgSrc;
  document.getElementById('badge-zoom-name').textContent = name;
  document.getElementById('badge-zoom-desc').textContent = desc;
  ov.style.display = 'flex';
}

// \u2500\u2500 Settings \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function refreshSettings() {
  const y=moduleReader.detectAllYears?moduleReader.detectAllYears():[];
  document.getElementById('detected-years').textContent=y.length?y.join(' \u00B7 '):'Aucune donn\u00E9e';
}
function _fullRPGReset() {
  if (typeof xpSystem !== 'undefined') {
    if (typeof xpSystem.reset === 'function') xpSystem.reset();
    else { xpSystem.currentXP=0; xpSystem.level=1; localStorage.setItem('rpg_xp','0'); localStorage.setItem('rpg_level','1'); }
  }
  if (typeof badgeSystem !== 'undefined') { badgeSystem.unlockedBadges=[]; localStorage.setItem('rpg_unlocked_badges','[]'); }
  if (typeof gameState !== 'undefined') {
    gameState.xp=0; gameState.level=1; gameState.badges=[];
    if (gameState.player) { gameState.player.xp=0; gameState.player.level=1; }
    if (typeof saveGameState==='function') saveGameState();
  }
  window._lastM1Net=0; window._lastM2Tot=0;
  localStorage.removeItem('FOX_REWARDS_HISTORY');
  localStorage.removeItem('FOX_SCENARIOS_NARRATED');
  localStorage.removeItem('FOX_BURNOUT_PEAK');
  localStorage.removeItem('FOX_RTF_EXPORTED');
  // Remettre le PNJ au tier 1
  if (typeof updatePNJLevel === 'function') updatePNJLevel(1);
}
function resetRPGConfirm() {
  if (confirm('R\u00E9initialiser XP, badges et qu\u00EAtes ? Les donn\u00E9es M1/M2 restent intactes.')) {
    _fullRPGReset(); refreshHUD(); closePopup('popup-settings');
    showNotification('\u{1F504} Progression r\u00E9initialis\u00E9e', 'info');
  }
}
function exportHistorique() {
  if (typeof moduleReader.exportFullHistory==='function') moduleReader.exportFullHistory();
}

// \u2500\u2500 Kitsune \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function kitsuneFormat(text) {
  // Gras **texte** \u2192 <strong>
  text = text.replace(/\*\*(.+?)\*\*/g, '<strong style="color:#fff;">$1</strong>');
  // Sauts de ligne
  text = text.replace(/\n/g, '<br>');
  // Puces \u2022
  text = text.replace(/\u2022\s/g, '<span style="color:#FF8C42;">\u2022</span> ');
  return text;
}

async function sendToKitsune() {
  const inp  = document.getElementById('ai-input');
  const msg  = inp.value.trim();
  if (!msg) return;
  inp.value  = '';
  const conv = document.getElementById('ai-conversation');

  // Message joueur
  conv.innerHTML += `
    <div style="text-align:right;margin:6px 0;">
      <span style="background:rgba(255,140,66,0.18);color:#FF8C42;border-radius:12px 12px 2px 12px;
                   padding:8px 14px;display:inline-block;font-size:0.83rem;max-width:85%;text-align:left;">
        ${msg}
      </span>
    </div>`;

  document.getElementById('ai-loading').style.display = 'block';
  conv.scrollTop = conv.scrollHeight;

  try {
    const reply = typeof askKitsune === 'function' ? await askKitsune(msg) : '\uD83E\uDD8A Module non charg\u00E9.';
    conv.innerHTML += `
      <div style="text-align:left;margin:6px 0;">
        <span style="background:rgba(255,255,255,0.05);color:#ccc;border-radius:2px 12px 12px 12px;
                     padding:8px 14px;display:inline-block;font-size:0.83rem;max-width:92%;text-align:left;line-height:1.5;">
          ${kitsuneFormat(reply)}
        </span>
      </div>`;
  } catch(e) {
    conv.innerHTML += `<div style="color:#E53935;font-size:0.8rem;margin:4px 0;">Erreur : ${e.message}</div>`;
  }

  document.getElementById('ai-loading').style.display = 'none';
  conv.scrollTop = conv.scrollHeight;
}
</script>

<!-- ‚ïê‚ïê POP-UP D√âMO CACH√â (5 clics + code) ‚ïê‚ïê -->
<div id="popup-demo-code" style="display:none;position:fixed;bottom:0;left:0;right:0;z-index:9999;background:rgba(8,8,20,0.97);border-top:2px solid rgba(255,140,66,0.4);border-radius:20px 20px 0 0;padding-bottom:env(safe-area-inset-bottom);max-height:70vh;overflow-y:auto;align-items:center;justify-content:center;">
  <div style="background:#0d0d1a;border:2px solid #FF8C42;border-radius:20px;padding:28px;max-width:320px;width:90%;text-align:center;">
    <div style="font-size:2rem;margin-bottom:8px;">üîê</div>
    <div style="color:#FF8C42;font-weight:900;font-size:1.1rem;letter-spacing:2px;margin-bottom:6px;">MODE D√âMO</div>
    <div style="color:#555;font-size:0.75rem;margin-bottom:18px;">Acc√®s restreint ‚Äî code requis</div>
    <input id="demo-code-input" type="password" maxlength="8" placeholder="Code secret"
      style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,140,66,0.3);color:#fff;border-radius:10px;padding:12px;text-align:center;font-size:1.2rem;letter-spacing:6px;margin-bottom:12px;box-sizing:border-box;"
      onkeypress="if(event.key==='Enter')checkDemoCode()">
    <button onclick="checkDemoCode()" style="width:100%;background:linear-gradient(135deg,#FF8C42,#FF6B35);border:none;color:#fff;border-radius:10px;padding:12px;font-weight:900;font-size:1rem;cursor:pointer;margin-bottom:8px;">Valider</button>
    <button onclick="document.getElementById('popup-demo-code').style.display='none'" style="background:none;border:none;color:#444;font-size:0.8rem;cursor:pointer;">Annuler</button>
    <div id="demo-code-error" style="color:#E53935;font-size:0.78rem;margin-top:8px;display:none;">‚ùå Code incorrect</div>
  </div>
</div>

<!-- ‚ïê‚ïê POP-UP D√âMO ACTIF ‚ïê‚ïê -->
<div id="popup-demo-panel" style="display:none;">

  <!-- ‚îÄ‚îÄ TIROIR CONTENU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div id="dev-drawer">
    <div style="padding:8px 12px 4px 12px;">

      <!-- Status -->
      <div id="demo-step-label" style="background:rgba(255,140,66,0.08);border:1px solid rgba(255,140,66,0.2);border-radius:7px;padding:6px 12px;color:#FF8C42;font-size:0.75rem;margin-bottom:8px;min-height:26px;">En attente&#x2026;</div>

      <!-- ‚îÄ‚îÄ ONGLET : DONN√âES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div id="dev-tab-data" class="dev-tab-content">
        <div class="dev-section-label">SITUATIONS PR&#xc9;TES</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px;">
          <button class="demo-btn" onclick="demoStep('reset')">&#x1F504; Reset</button>
          <button class="demo-btn" onclick="demoStep('start')">&#x1F331; D&#xe9;part</button>
          <button class="demo-btn" onclick="demoStep('light')">&#x1F49B; 15h</button>
          <button class="demo-btn" onclick="demoStep('medium')">&#x1F9E1; 60h</button>
          <button class="demo-btn" onclick="demoStep('heavy')">&#x1F534; 150h</button>
          <button class="demo-btn" onclick="demoStep('critical')">&#x1F6A8; 220h+</button>
          <button class="demo-btn" onclick="demoStep('multiyear')">&#x1F570; 3 ans</button>
          <button class="demo-btn" onclick="demoStep('burnout')">&#x1F525; Burnout</button>
        </div>
        <div class="dev-section-label">FEATURES DEV</div>
        <div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px;">
          <button class="demo-btn" onclick="localStorage.removeItem('FOX_ONBOARDING_DONE');location.reload()">üî∞ Onboarding</button>
          <button class="demo-btn" onclick="showMonthlySummary()">üìÖ Bilan</button>
          <button class="demo-btn" onclick="document.getElementById('weekly-notif').classList.add('visible')">üîî Notif</button>
          <button class="demo-btn" onclick="refreshPatternsSection();openPopup('popup-fox')">üîç Patterns</button>
          <button class="demo-btn" onclick="openPopup('popup-glossaire')">üìö Glossaire</button>
          <button class="demo-btn" onclick="renderEvolutionChart('month');openPopup('popup-fox')">üìä Graphique</button>
          <button class="demo-btn" onclick="renderAnnualComparison();openPopup('popup-fox')">üìÜ Annuel</button>
          <button class="demo-btn" onclick="openPopup('popup-violations')">‚ö†Ô∏è Violations</button>
          <button class="demo-btn" onclick="openPopup('popup-rapport')">üìã Rapport</button>
          <button class="demo-btn" onclick="openPopup('popup-heatmap')">üóì Heatmap</button>
          <button class="demo-btn" onclick="openPopup('popup-badges')">‚≠ê Achiev.</button>
        </div>
        <div class="dev-section-label">INJECTER HEURES M1</div>
        <div style="display:flex;gap:6px;align-items:center;margin-bottom:8px;">
          <input id="dev-inject-hours" type="number" min="0" max="500" value="50" style="flex:1;background:rgba(255,255,255,0.05);border:1px solid rgba(255,140,66,0.3);color:#FF8C42;border-radius:7px;padding:5px 8px;font-size:0.82rem;">
          <span style="color:#666;font-size:0.75rem;">h sup</span>
          <button class="demo-btn" onclick="devInjectHours()">Injecter</button>
        </div>
        <div class="dev-section-label">INJECT M2 (AUJOURD'HUI)</div>
        <div style="display:flex;gap:5px;flex-wrap:wrap;">
          <button class="demo-btn" onclick="devInjectM2Day(3)">+3h</button>
          <button class="demo-btn" onclick="devInjectM2Day(5)">+5h</button>
          <button class="demo-btn" onclick="devInjectM2Day(7)">+7h</button>
          <button class="demo-btn" onclick="devInjectM2Day(10)">+10h</button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ ONGLET : CALCULS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div id="dev-tab-calculs" class="dev-tab-content" style="display:none;">
        <div class="dev-section-label">VIOLATION JOURNALI&#xc8;RE (base 7h)</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px;">
          <button class="demo-btn" onclick="devTestDay(2)">+2h<br><span style="font-size:0.6rem;opacity:0.7;">9h &#x2705;</span></button>
          <button class="demo-btn" onclick="devTestDay(3)">+3h<br><span style="font-size:0.6rem;opacity:0.7;">10h &#x26A0;</span></button>
          <button class="demo-btn" onclick="devTestDay(5)">+5h<br><span style="font-size:0.6rem;opacity:0.7;">12h &#x1F534;</span></button>
          <button class="demo-btn" onclick="devTestDay(7)">+7h<br><span style="font-size:0.6rem;opacity:0.7;">14h crit</span></button>
        </div>
        <div class="dev-section-label">VIOLATION HEBDO (base 35h)</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px;">
          <button class="demo-btn" onclick="devTestWeek(6)">+6h<br><span style="font-size:0.6rem;opacity:0.7;">41h &#x2705;</span></button>
          <button class="demo-btn" onclick="devTestWeek(9)">+9h<br><span style="font-size:0.6rem;opacity:0.7;">44h &#x26A0;</span></button>
          <button class="demo-btn" onclick="devTestWeek(13)">+13h<br><span style="font-size:0.6rem;opacity:0.7;">48h &#x1F534;</span></button>
          <button class="demo-btn" onclick="devTestWeek(18)">+18h<br><span style="font-size:0.6rem;opacity:0.7;">53h crit</span></button>
        </div>
        <div class="dev-section-label">CONTINGENT ANNUEL (220h)</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px;">
          <button class="demo-btn" onclick="devTestAnnual(100)">100h<br><span style="font-size:0.6rem;opacity:0.7;">45%</span></button>
          <button class="demo-btn" onclick="devTestAnnual(165)">165h<br><span style="font-size:0.6rem;opacity:0.7;">75% &#x26A0;</span></button>
          <button class="demo-btn" onclick="devTestAnnual(200)">200h<br><span style="font-size:0.6rem;opacity:0.7;">90%</span></button>
          <button class="demo-btn" onclick="devTestAnnual(230)">230h<br><span style="font-size:0.6rem;opacity:0.7;">105% &#x1F6A8;</span></button>
        </div>
        <button class="demo-btn" style="width:100%;" onclick="kitsuneNarrateOvertime(0,'DEV')">&#x1F98A; Analyser maintenant</button>
      </div>

      <!-- ‚îÄ‚îÄ ONGLET : SC√âNARIOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div id="dev-tab-scenarios" class="dev-tab-content" style="display:none;">
        <div style="display:flex;gap:6px;margin-bottom:6px;">
          <input id="dev-sc-search" type="number" min="1" max="600" placeholder="N&#xb0; sc&#xe9;nario 1&#x2013;600" style="flex:1;background:rgba(255,255,255,0.05);border:1px solid rgba(255,140,66,0.3);color:#FF8C42;border-radius:7px;padding:5px 8px;font-size:0.8rem;">
          <button class="demo-btn" onclick="devPlayScenarioById()">Jouer</button>
        </div>
        <div class="dev-section-label" style="margin-bottom:5px;">FILTRER PAR CAT&#xc9;GORIE</div>
        <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;" id="dev-cat-filters"></div>
        <div style="font-size:0.72rem;color:#FF8C42;font-weight:700;margin-bottom:5px;" id="dev-sc-count">Chargement&#x2026;</div>
        <div style="display:flex;flex-direction:column;gap:5px;max-height:30vh;overflow-y:auto;" id="dev-scenario-list"></div>
      </div>

      <!-- ‚îÄ‚îÄ ONGLET : PERSO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div id="dev-tab-perso" class="dev-tab-content" style="display:none;">
        <div class="dev-section-label">NIVEAU</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:5px;margin-bottom:8px;">
          <button class="demo-btn" onclick="devSetLevel(1)">Niv 1</button>
          <button class="demo-btn" onclick="devSetLevel(3)">Niv 3</button>
          <button class="demo-btn" onclick="devSetLevel(5)">Niv 5</button>
          <button class="demo-btn" onclick="devSetLevel(8)">Niv 8</button>
          <button class="demo-btn" onclick="devSetLevel(10)">Niv 10</button>
          <button class="demo-btn" onclick="devSetLevel(12)">Niv 12</button>
          <button class="demo-btn" onclick="devSetLevel(15)">Niv 15</button>
          <button class="demo-btn" onclick="devSetLevel(20)">Niv 20</button>
        </div>
        <div class="dev-section-label">XP</div>
        <div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px;">
          <button class="demo-btn" onclick="demoXP(100)">+100</button>
          <button class="demo-btn" onclick="demoXP(500)">+500</button>
          <button class="demo-btn" onclick="demoXP(1000)">+1k</button>
          <button class="demo-btn" onclick="demoXP(5000)">+5k</button>
          <button class="demo-btn" onclick="demoXP(10000)">+10k</button>
        </div>
        <div class="dev-section-label">LIGUE</div>
        <div style="display:flex;flex-direction:column;gap:5px;" id="dev-league-list"></div>
      </div>

      <!-- ‚îÄ‚îÄ ONGLET : BURN-OUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div id="dev-tab-burnout" class="dev-tab-content" style="display:none;">
        <div class="dev-section-label">SCORE BURN-OUT</div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
          <input type="range" min="0" max="100" value="0" id="dev-burnout-slider" oninput="devSetBurnout(this.value)" style="flex:1;accent-color:#FF8C42;">
          <span id="dev-burnout-val" style="color:#FF8C42;font-weight:900;min-width:30px;text-align:right;">0</span>
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:5px;">
          <button class="demo-btn" onclick="devSetBurnout(0)">0</button>
          <button class="demo-btn" onclick="devSetBurnout(30)">30</button>
          <button class="demo-btn" onclick="devSetBurnout(50)">50</button>
          <button class="demo-btn" onclick="devSetBurnout(60)">60 &#x26A0;</button>
          <button class="demo-btn" onclick="devSetBurnout(75)">75</button>
          <button class="demo-btn" onclick="devSetBurnout(85)">85</button>
          <button class="demo-btn" onclick="devSetBurnout(95)">95</button>
          <button class="demo-btn" onclick="devSetBurnout(100)">100 &#x1F6A8;</button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ ONGLET : BADGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div id="dev-tab-badges" class="dev-tab-content" style="display:none;">
        <div style="display:flex;gap:6px;margin-bottom:6px;">
          <button class="demo-btn" onclick="devBadgesAll(true)">Tout d&#xe9;bloquer</button>
          <button class="demo-btn" onclick="devBadgesAll(false)">Tout verrouiller</button>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:5px;max-height:32vh;overflow-y:auto;" id="dev-badges-list"></div>
      </div>

      <!-- ‚îÄ‚îÄ ONGLET : ANIMATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div id="dev-tab-anim" class="dev-tab-content" style="display:none;">
        <div class="dev-section-label">LEVEL-UP</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:5px;margin-bottom:8px;">
          <button class="demo-btn" onclick="devAnim('levelup',1)">Niv 1</button>
          <button class="demo-btn" onclick="devAnim('levelup',5)">Niv 5</button>
          <button class="demo-btn" onclick="devAnim('levelup',10)">Niv 10</button>
          <button class="demo-btn" onclick="devAnim('levelup',20)">Niv 20</button>
        </div>
        <div class="dev-section-label">BADGE UNLOCK</div>
        <div style="display:flex;flex-direction:column;gap:5px;margin-bottom:8px;" id="dev-anim-badge-list"></div>
        <div class="dev-section-label">STORM / KITSUNE</div>
        <div style="display:flex;flex-wrap:wrap;gap:5px;">
          <button class="demo-btn" onclick="devAnim('storm',0)">Storm 0</button>
          <button class="demo-btn" onclick="devAnim('storm',45)">Storm 45</button>
          <button class="demo-btn" onclick="devAnim('storm',75)">Storm 75</button>
          <button class="demo-btn" onclick="devAnim('storm',90)">Storm 90</button>
          <button class="demo-btn" onclick="demoNarrate(1)">&#x1F98A; +1h</button>
          <button class="demo-btn" onclick="demoNarrate(10)">&#x1F98A; +10h</button>
          <button class="demo-btn" onclick="demoNarrate(48)">&#x1F98A; +48h</button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ ONGLET : SAISON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div id="dev-tab-saison" class="dev-tab-content" style="display:none;">
        <div class="dev-section-label">D&#xc9;COR SAISONNIER</div>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:5px;margin-bottom:8px;">
          <button class="demo-btn" onclick="devSetSeason(0)">&#x2744;&#xFE0F; Q1</button>
          <button class="demo-btn" onclick="devSetSeason(1)">&#x1F33A; Q2</button>
          <button class="demo-btn" onclick="devSetSeason(2)">&#x2600;&#xFE0F; Q3</button>
          <button class="demo-btn" onclick="devSetSeason(3)">&#x1F342; Q4</button>
          <button class="demo-btn" onclick="devSetSeason(-1)">&#x1F504; R&#xe9;el</button>
        </div>
        <div class="dev-section-label">PNJ ‚Äî 10 &#xc9;VOLUTIONS</div>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:5px;">
          <button class="demo-btn" onclick="updatePNJLevel(1)">F1<br><span style="font-size:0.6rem;opacity:0.7;">1-5</span></button>
          <button class="demo-btn" onclick="updatePNJLevel(6)">F2<br><span style="font-size:0.6rem;opacity:0.7;">6-10</span></button>
          <button class="demo-btn" onclick="updatePNJLevel(11)">F3<br><span style="font-size:0.6rem;opacity:0.7;">11-15</span></button>
          <button class="demo-btn" onclick="updatePNJLevel(16)">F4<br><span style="font-size:0.6rem;opacity:0.7;">16-20</span></button>
          <button class="demo-btn" onclick="updatePNJLevel(21)">F5<br><span style="font-size:0.6rem;opacity:0.7;">21-25</span></button>
          <button class="demo-btn" onclick="updatePNJLevel(26)">F6<br><span style="font-size:0.6rem;opacity:0.7;">26-30</span></button>
          <button class="demo-btn" onclick="updatePNJLevel(31)">F7<br><span style="font-size:0.6rem;opacity:0.7;">31-35</span></button>
          <button class="demo-btn" onclick="updatePNJLevel(36)">F8<br><span style="font-size:0.6rem;opacity:0.7;">36-40</span></button>
          <button class="demo-btn" onclick="updatePNJLevel(41)">F9<br><span style="font-size:0.6rem;opacity:0.7;">41-45</span></button>
          <button class="demo-btn" onclick="updatePNJLevel(46)">F10<br><span style="font-size:0.6rem;opacity:0.7;">46-50</span></button>
        </div>
      </div>

    </div><!-- /padding -->
  </div><!-- /#dev-drawer -->

  <!-- ‚îÄ‚îÄ BARRE D'ONGLETS HORIZONTALE (toujours visible) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div id="dev-tabbar">
    <span style="color:#FF8C42;font-weight:900;font-size:0.7rem;white-space:nowrap;margin-right:4px;">&#x1F6E0; DEV</span>

    <button class="dev-tabbar-btn active" onclick="devTab('data')">&#x1F4CA; Donn&#xe9;es</button>
    <button class="dev-tabbar-btn" onclick="devTab('calculs')">&#x2696; Calculs</button>
    <button class="dev-tabbar-btn" onclick="devTab('scenarios')">&#x1F98A; Sc&#xe9;narios</button>
    <button class="dev-tabbar-btn" onclick="devTab('perso')">&#x2694; Perso</button>
    <button class="dev-tabbar-btn" onclick="devTab('burnout')">&#x1F525; Burn-out</button>
    <button class="dev-tabbar-btn" onclick="devTab('badges')">&#x1F3C5; Badges</button>
    <button class="dev-tabbar-btn" onclick="devTab('anim')">&#x2728; Anim</button>
    <button class="dev-tabbar-btn" onclick="devTab('saison')">&#x1F332; Saison</button>

    <!-- S√©parateur -->
    <span style="flex-shrink:0;width:1px;height:20px;background:rgba(255,140,66,0.2);margin:0 4px;"></span>

    <button id="demo-toggle-btn" onclick="toggleDemoPanel()" title="R&#xe9;duire/agrandir" style="background:rgba(255,140,66,0.1);border:1px solid rgba(255,140,66,0.3);color:#FF8C42;border-radius:7px;padding:5px 9px;font-size:0.8rem;cursor:pointer;flex-shrink:0;">&#x25BC;</button>
    <button onclick="exitDemoMode()" style="background:rgba(229,57,53,0.12);border:1px solid #E53935;color:#E53935;border-radius:7px;padding:5px 9px;cursor:pointer;font-weight:700;font-size:0.75rem;flex-shrink:0;">&#x2715;</button>
  </div>

</div>

<style>
/* ‚îÄ‚îÄ Nuages mena√ßants burnout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#storm-overlay {
  position: fixed; inset: 0; z-index: 9995;
  pointer-events: none; overflow: hidden;
  opacity: 0; transition: opacity 1.5s ease;
}
#storm-overlay.visible { opacity: 1; }

/* Vignette rouge br√ªlante sur les bords */
#storm-overlay::after {
  content: '';
  position: absolute; inset: 0;
  background: radial-gradient(ellipse at center,
    transparent 30%,
    rgba(180,0,0,0) 50%,
    rgba(220,0,0,var(--storm-vignette,0)) 100%
  );
  pointer-events: none;
  z-index: 1;
}

.storm-cloud {
  position: absolute;
  border-radius: 50%;
  filter: blur(50px);
  animation: cloudDrift linear infinite;
  pointer-events: none;
  mix-blend-mode: screen;
}
@keyframes cloudDrift {
  0%   { transform: translateX(0) translateY(0) scale(1); }
  25%  { transform: translateX(40px) translateY(-20px) scale(1.08); }
  50%  { transform: translateX(-30px) translateY(15px) scale(0.95); }
  75%  { transform: translateX(20px) translateY(-10px) scale(1.04); }
  100% { transform: translateX(0) translateY(0) scale(1); }
}

/* √âclair : flash blanc-rouge brutal */
@keyframes lightningFlash {
  0%,88%,90%,93%,95%,100% { opacity: 0; }
  89%,92%   { opacity: 1; background: rgba(255,80,50,0.22); }
  94%       { opacity: 0.6; background: rgba(255,120,80,0.15); }
}
@keyframes lightningFlash2 {
  0%,75%,79%,100% { opacity: 0; }
  76%,78%         { opacity: 1; }
}
.storm-lightning {
  position: absolute; inset: 0;
  background: rgba(255,60,30,0.18);
  pointer-events: none;
  animation: lightningFlash 3s ease-in-out infinite;
  z-index: 2;
}
.storm-lightning-2 {
  position: absolute; inset: 0;
  background: rgba(255,180,80,0.12);
  pointer-events: none;
  animation: lightningFlash2 5s ease-in-out infinite;
  animation-delay: 1.4s;
  z-index: 2;
}
/* Vignette rouge permanente d√®s score >= 60 */
.storm-vignette {
  position: absolute; inset: 0; z-index: 0;
  pointer-events: none;
  background: radial-gradient(ellipse at center,
    transparent 25%,
    rgba(200,0,0,0.12) 65%,
    rgba(255,0,0,0.30) 100%
  );
}

/* ‚îÄ‚îÄ Level-up : flash plein √©cran ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
@keyframes levelUpFlash {
  0%   { opacity: 0; }
  15%  { opacity: 0.35; }
  100% { opacity: 0; }
}

@keyframes flashPulse {
  0% { opacity: 0; }
  50% { opacity: 1; }
  100% { opacity: 0; }
}

@keyframes particleBurst {
  0% { 
    transform: translate(-50%, -50%) translate(0, 0) scale(1);
    opacity: 1;
  }
  100% { 
    transform: translate(-50%, -50%) 
               translate(calc(var(--x, 0) * 100px), calc(var(--y, 0) * 100px)) 
               scale(0);
    opacity: 0;
  }
}

@keyframes confettiFall {
  0% { transform: translateY(0) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

@keyframes levelUpBanner {
  0%   { transform: translateX(-50%) translateY(-80px) scale(0.7); opacity: 0; }
  25%  { transform: translateX(-50%) translateY(0)    scale(1.05); opacity: 1; }
  75%  { transform: translateX(-50%) translateY(0)    scale(1);    opacity: 1; }
  100% { transform: translateX(-50%) translateY(-60px) scale(0.85); opacity: 0; }
}
#levelup-flash {
  position: fixed; inset: 0; z-index: 180000;
  background: radial-gradient(ellipse at center, rgba(255,215,0,0.25) 0%, transparent 70%);
  pointer-events: none; opacity: 0;
}
#levelup-flash.active { animation: levelUpFlash 1.2s ease-out forwards; }
#levelup-banner {
  position: fixed; top: 15%; left: 50%;
  transform: translateX(-50%) translateY(-80px);
  z-index: 190000; pointer-events: none;
  background: linear-gradient(135deg,rgba(10,8,25,0.97),rgba(30,20,10,0.97));
  border: 2px solid #FFD700;
  box-shadow: 0 0 60px rgba(255,215,0,0.5), inset 0 0 40px rgba(255,215,0,0.05);
  border-radius: 20px; padding: 18px 32px; text-align: center;
  opacity: 0; min-width: 280px;
}
#levelup-banner.active { animation: levelUpBanner 3s cubic-bezier(0.34,1.56,0.64,1) forwards; }

/* ‚îÄ‚îÄ Badge unlock : popup centr√© am√©lior√© ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
@keyframes badgePopIn {
  0%   { transform: translateX(-50%) scale(0.3) rotate(-10deg); opacity: 0; }
  55%  { transform: translateX(-50%) scale(1.1) rotate(2deg);   opacity: 1; }
  75%  { transform: translateX(-50%) scale(0.97) rotate(-1deg); }
  100% { transform: translateX(-50%) scale(1)   rotate(0deg);   opacity: 1; }
}
@keyframes badgePopOut {
  0%   { transform: translateX(-50%) scale(1);    opacity: 1; }
  100% { transform: translateX(-50%) scale(0.8) translateY(-20px); opacity: 0; }
}
#badge-unlock-popup {
  position: fixed; bottom: 120px; left: 50%;
  transform: translateX(-50%) scale(0.3);
  z-index: 190000; pointer-events: none;
  background: linear-gradient(135deg,rgba(10,8,25,0.98),rgba(20,15,35,0.98));
  border-radius: 20px; padding: 18px 24px;
  text-align: center; min-width: 200px; opacity: 0;
}
#badge-unlock-popup.pop-in  { animation: badgePopIn  0.7s cubic-bezier(0.34,1.56,0.64,1) forwards; }
#badge-unlock-popup.pop-out { animation: badgePopOut 0.5s ease-in forwards; }

/* ‚îÄ‚îÄ Particules dor√©es level-up ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.gold-particle {
  position: fixed; width: 6px; height: 6px;
  border-radius: 50%; z-index: 185000;
  pointer-events: none; opacity: 0;
  background: radial-gradient(circle, #FFD700, #FF8C42);
  animation: goldParticle ease-out forwards;
}
@keyframes goldParticle {
  0%   { opacity: 1; transform: translate(0,0) scale(1); }
  100% { opacity: 0; transform: var(--dx,translateX(80px)) scale(0); }
}

/* ‚îÄ‚îÄ Boutons nav M1/M2 dans le HUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
@media screen and (max-width: 380px) {
  a.hud-nav-btn { font-size: 0.65rem !important; }
  a.hud-nav-btn::before { content: none !important; }
}
</style>
<script>
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODE DEV ‚Äî 5 clics sur FOX + code 19871502
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _demoClickCount = 0, _demoClickTimer = null, _demoActive = false;

function demoLogoClick() {
  _demoClickCount++;
  clearTimeout(_demoClickTimer);
  const logo = document.getElementById('hud-logo-btn');
  if (logo) { logo.style.transform = 'scale(1.3)'; setTimeout(() => logo.style.transform = '', 200); }
  if (_demoClickCount >= 5) {
    _demoClickCount = 0;
    const p = document.getElementById('popup-demo-code');
    if (p) { p.style.display = 'flex'; }
    const inp = document.getElementById('demo-code-input');
    if (inp) { inp.value = ''; inp.focus(); }
    document.getElementById('demo-code-error').style.display = 'none';
  } else {
    _demoClickTimer = setTimeout(() => { _demoClickCount = 0; }, 3000);
    if (logo) {
      const r = 5 - _demoClickCount;
      logo.textContent = r > 0 ? ('ü¶ä ' + r) : 'ü¶ä FOX';
      setTimeout(() => { logo.textContent = 'ü¶ä FOX'; }, 800);
    }
  }
}

function checkDemoCode() {
  const inp = document.getElementById('demo-code-input');
  const err = document.getElementById('demo-code-error');
  if ((inp ? inp.value.trim() : '') === '19871502') {
    document.getElementById('popup-demo-code').style.display = 'none';
    openDemoPanel();
  } else {
    err.style.display = 'block';
    if (inp) { inp.value = ''; inp.focus(); }
  }
}

function openDemoPanel() {
  _demoActive = true;
  const panel = document.getElementById('popup-demo-panel');
  panel.style.display = 'block';
  devTab('data');
  _devFillLeagues();
  _demoFillScenarios();
  _devFillBadges();
  _devFillAnimBadges();
  _devFillCatFilters();
  _demoBanner(true);
  // Pousser le dock vers le haut pour ne pas √™tre masqu√©
  _devAdjustDock(true);
}

function toggleDemoPanel() {
  const drawer = document.getElementById('dev-drawer');
  const btn    = document.getElementById('demo-toggle-btn');
  if (!drawer) return;
  const collapsed = drawer.classList.contains('collapsed');
  if (collapsed) {
    drawer.classList.remove('collapsed');
    if (btn) btn.textContent = '‚ñº';
  } else {
    drawer.classList.add('collapsed');
    if (btn) btn.textContent = '‚ñ≤';
  }
  _devAdjustDock(!collapsed ? false : true);
}

function exitDemoMode() {
  _demoActive = false;
  document.getElementById('popup-demo-panel').style.display = 'none';
  _demoBanner(false);
  _devAdjustDock(false);
  demoStep('reset');
}

function _demoBanner(on) {
  let b = document.getElementById('demo-active-banner');
  if (on && !b) {
    b = document.createElement('div'); b.id = 'demo-active-banner';
    b.style.cssText = 'position:fixed;top:0;left:50%;transform:translateX(-50%);z-index:9990;background:linear-gradient(90deg,#7B2FBE,#FF8C42);color:#fff;font-size:0.65rem;font-weight:900;padding:2px 16px;border-radius:0 0 8px 8px;letter-spacing:2px;pointer-events:none;';
    b.textContent = 'MODE DEV'; document.body.appendChild(b);
  } else if (!on && b) b.remove();
}

function _demoLabel(txt) {
  const el = document.getElementById('demo-step-label');
  if (el) el.textContent = txt;
}

// ‚îÄ‚îÄ ONGLETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function devTab(name) {
  // Onglets tabbar
  document.querySelectorAll('.dev-tabbar-btn').forEach(b => b.classList.remove('active'));
  const activeBtn = document.querySelector('.dev-tabbar-btn[onclick="devTab(\'' + name + '\')"]');
  if (activeBtn) activeBtn.classList.add('active');
  // Contenu
  document.querySelectorAll('.dev-tab-content').forEach(t => { t.style.display = 'none'; });
  const panel = document.getElementById('dev-tab-' + name);
  if (panel) panel.style.display = 'block';
  // Ouvrir le tiroir si ferm√©
  const drawer = document.getElementById('dev-drawer');
  if (drawer) drawer.classList.remove('collapsed');
  const toggleBtn = document.getElementById('demo-toggle-btn');
  if (toggleBtn) toggleBtn.textContent = '‚ñº';
  _devAdjustDock(true);
  if (name === 'scenarios') _demoFillScenarios();
  if (name === 'badges') _devFillBadges();
}

function _devAdjustDock(devOpen) {
  const dock  = document.getElementById('action-dock');
  const panel = document.getElementById('popup-demo-panel');
  if (!dock) return;
  if (devOpen && panel && panel.style.display !== 'none') {
    // Mesurer la hauteur r√©elle du panel apr√®s rendu
    requestAnimationFrame(() => {
      const h = panel.offsetHeight;
      dock.style.marginBottom = h + 'px';
    });
  } else {
    dock.style.marginBottom = '';
  }
}

// ‚îÄ‚îÄ INJECTION DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _demoInjectM1(year, days) {
  const data = {};
  days.forEach(w => { data[w.date] = { extra: w.extra||0, recup: w.recup||0, absent: w.absent||0 }; });
  localStorage.setItem('DATA_REPORT_' + year, JSON.stringify(data));
  localStorage.setItem('BASE_HEBDO_' + year, '35');
  localStorage.setItem('ANNUAL_RATE_' + year, '10');
}

function _demoInjectM2(year, months) {
  localStorage.setItem('CA_HS_TRACKER_V1_DATA_' + year, JSON.stringify(months));
}

function devInjectHours() {
  const hrs = parseFloat(document.getElementById('dev-inject-hours').value) || 0;
  if (hrs <= 0) return;
  const y = new Date().getFullYear().toString();
  const perMonth = Math.round(hrs / 12 * 10) / 10;
  const days = [];
  for (let m = 1; m <= 12; m++)
    days.push({ date: y + '-' + String(m).padStart(2,'0') + '-10', extra: perMonth });
  _demoInjectM1(y, days);
  _demoLabel('M1 : ' + hrs + 'h sup r√©parties sur l\'ann√©e');
  syncModulesAndAwardXP('dev'); refreshHUD();
  setTimeout(() => kitsuneNarrateOvertime(0, 'DEV'), 400);
}

function devInjectM2Day(extra) {
  const y = new Date().getFullYear().toString();
  const now = new Date();
  const mk = y + '-' + String(now.getMonth()+1).padStart(2,'0');
  const dk = String(now.getDate());
  const cur = JSON.parse(localStorage.getItem('CA_HS_TRACKER_V1_DATA_' + y) || '{}');
  if (!cur[mk]) cur[mk] = { days: {} };
  if (!cur[mk].days) cur[mk].days = {};
  cur[mk].days[dk] = extra;
  localStorage.setItem('CA_HS_TRACKER_V1_DATA_' + y, JSON.stringify(cur));
  _demoLabel('M2 : +' + extra + 'h aujourd\'hui ‚Üí ' + (7 + extra) + 'h total (base 7h + ' + extra + 'h sup)');
  syncModulesAndAwardXP('dev'); refreshHUD();
  setTimeout(() => kitsuneNarrateOvertime(0, 'DEV'), 400);
}

// ‚îÄ‚îÄ CALCULS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function devTestDay(extra) {
  const y = new Date().getFullYear().toString();
  const today = new Date().toISOString().slice(0, 10);
  const cur = JSON.parse(localStorage.getItem('DATA_REPORT_' + y) || '{}');
  cur[today] = { extra, recup: 0, absent: 0 };
  localStorage.setItem('DATA_REPORT_' + y, JSON.stringify(cur));
  const total = 7 + extra;
  const st = total >= 12 ? 'üî¥ VIOLATION >=12h' : total >= 10 ? '‚ö†Ô∏è ALERTE >=10h' : '‚úÖ OK';
  _demoLabel('Jour ' + today + ' : 7h base + ' + extra + 'h sup = ' + total + 'h  ' + st);
  syncModulesAndAwardXP('dev'); refreshHUD();
  setTimeout(() => kitsuneNarrateOvertime(0, 'DEV'), 400);
}

function devTestWeek(extraTotal) {
  const y = new Date().getFullYear().toString();
  const now = new Date();
  const mon = new Date(now); mon.setDate(now.getDate() - (now.getDay() + 6) % 7);
  const d0 = mon.toISOString().slice(0, 10);
  const d1 = new Date(mon); d1.setDate(mon.getDate() + 1);
  const cur = JSON.parse(localStorage.getItem('DATA_REPORT_' + y) || '{}');
  cur[d0] = { extra: Math.ceil(extraTotal/2), recup: 0, absent: 0 };
  cur[d1.toISOString().slice(0,10)] = { extra: Math.floor(extraTotal/2), recup: 0, absent: 0 };
  localStorage.setItem('DATA_REPORT_' + y, JSON.stringify(cur));
  const total = 35 + extraTotal;
  const st = total >= 48 ? 'üî¥ VIOLATION >=48h' : total >= 44 ? '‚ö†Ô∏è ALERTE >=44h' : '‚úÖ OK';
  _demoLabel('Semaine du ' + d0 + ' : 35h + ' + extraTotal + 'h = ' + total + 'h  ' + st);
  syncModulesAndAwardXP('dev'); refreshHUD();
  setTimeout(() => kitsuneNarrateOvertime(0, 'DEV'), 400);
}

function devTestAnnual(totalOT) {
  const y = new Date().getFullYear().toString();
  const perM = Math.round(totalOT / 24 * 10) / 10;
  const days = [];
  for (let m = 1; m <= 12; m++) {
    const mm = String(m).padStart(2,'0');
    days.push({ date: y+'-'+mm+'-08', extra: perM });
    days.push({ date: y+'-'+mm+'-22', extra: perM });
  }
  _demoInjectM1(y, days);
  const pct = Math.round(totalOT / 220 * 100);
  const st = pct >= 100 ? 'üö® CONTINGENT D√âPASS√â' : pct >= 75 ? '‚ö†Ô∏è ALERTE 75%' : '‚úÖ OK';
  _demoLabel('Annuel : ' + totalOT + 'h (' + pct + '% du contingent)  ' + st);
  syncModulesAndAwardXP('dev'); refreshHUD();
  setTimeout(() => kitsuneNarrateOvertime(0, 'DEV'), 400);
}

// ‚îÄ‚îÄ XP / NIVEAU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _demoSetXP(xp, level) {
  if (typeof xpSystem !== 'undefined') {
    xpSystem.currentXP = xp; xpSystem.level = level;
    if (typeof xpSystem.saveToStorage === 'function') xpSystem.saveToStorage();
  }
  if (typeof gameState !== 'undefined') {
    gameState.xp = xp; gameState.level = level;
    if (gameState.player) { gameState.player.xp = xp; gameState.player.level = level; }
    if (typeof saveGameState === 'function') saveGameState();
  }
  if (typeof updatePNJLevel === 'function') updatePNJLevel(level);
}

function devSetLevel(level) {
  const xpMap = {1:0,2:500,3:1200,4:2400,5:4200,6:6600,7:9600,8:13200,9:17400,10:22200,12:33000,15:52500,20:92000};
  const xp = xpMap[level] || (level * 2000);
  _demoSetXP(xp, level);
  _demoLabel('Niveau ' + level + ' ‚Äî ' + xp + ' XP');
  if (typeof showLevelUpAnim === 'function') showLevelUpAnim(level);
  refreshHUD();
}

function demoXP(amount) {
  if (typeof xpSystem !== 'undefined') {
    // Convertir XP en heures (1 heure = 100 XP)
    const hours = amount / 100;
    const res = xpSystem.addXP(hours);
    console.log('üéÆ DEV : +' + amount + ' XP (=' + hours + 'h) ‚Üí total', xpSystem.currentXP, 'XP');
    _demoLabel('+' + amount + ' XP ‚Üí total ' + xpSystem.currentXP + ' (niv ' + xpSystem.level + ')');
    if (res && res.leveledUp && typeof showLevelUpAnimation === 'function') {
      setTimeout(() => showLevelUpAnimation(xpSystem.level), 500);
    }
  }
  refreshHUD();
}

function _devFillLeagues() {
  const el = document.getElementById('dev-league-list');
  if (!el || typeof leagueSystem === 'undefined' || !leagueSystem.leagues) return;
  el.innerHTML = '';
  leagueSystem.leagues.forEach(lg => {
    const btn = document.createElement('button');
    btn.className = 'demo-btn';
    btn.textContent = (lg.emoji||'') + ' ' + (lg.name||lg.id) + ' (' + (lg.minXP||0) + ' XP)';
    btn.onclick = () => { _demoSetXP(lg.minXP||0, 1); _demoLabel('Ligue : ' + (lg.name||lg.id)); refreshHUD(); };
    el.appendChild(btn);
  });
}

// ‚îÄ‚îÄ BURN-OUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function devSetBurnout(score) {
  score = parseInt(score);
  const sl = document.getElementById('dev-burnout-slider');
  const vl = document.getElementById('dev-burnout-val');
  if (sl) sl.value = score; if (vl) vl.textContent = score;
  localStorage.setItem('FOX_BURNOUT_OVERRIDE', String(score));
  if (typeof updateStormOverlay === 'function') updateStormOverlay(score);
  const hb = document.getElementById('hud-burnout'); if (hb) hb.textContent = score;
  const he = document.getElementById('hud-energy'); if (he) he.textContent = Math.max(0, 100 - score);
  const st = score >= 80 ? 'üö® CRITIQUE' : score >= 60 ? '‚ö†Ô∏è DANGER' : score >= 40 ? 'ü¶ä ALERTE' : '‚úÖ OK';
  _demoLabel('Burn-out : ' + score + '/100  ' + st);
  setTimeout(() => kitsuneNarrateOvertime(0, 'DEV'), 400);
}

// ‚îÄ‚îÄ SC√âNARIOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _devScFilter = null;

function _devFillCatFilters() {
  const el = document.getElementById('dev-cat-filters');
  if (!el || typeof FOX_SCENARIOS === 'undefined') return;
  // Grouper par category si dispo, sinon par risk
  const catField = FOX_SCENARIOS.some(s => s.category) ? 'category' : 'risk';
  const cats = [...new Set(FOX_SCENARIOS.map(s => s[catField]).filter(Boolean))].sort();
  el.innerHTML = '';
  const all = document.createElement('button');
  all.className = 'dev-tab active'; all.textContent = 'Tous (' + FOX_SCENARIOS.length + ')';
  all.onclick = () => { _devScFilter = null; _demoFillScenarios(); };
  el.appendChild(all);
  cats.forEach(cat => {
    const n = FOX_SCENARIOS.filter(s => s.category === cat).length;
    const btn = document.createElement('button');
    btn.className = 'dev-tab'; btn.textContent = cat + ' (' + n + ')';
    btn.onclick = () => { _devScFilter = cat; _demoFillScenarios(); };
    el.appendChild(btn);
  });
}

function _demoFillScenarios() {
  const el = document.getElementById('dev-scenario-list') || document.getElementById('demo-scenario-list');
  const cnt = document.getElementById('dev-sc-count');
  if (!el || typeof FOX_SCENARIOS === 'undefined') return;
  el.innerHTML = '';
  const catField = FOX_SCENARIOS.some(s => s.category) ? 'category' : 'risk';
  const list = _devScFilter ? FOX_SCENARIOS.filter(s => s[catField] === _devScFilter) : FOX_SCENARIOS;
  if (cnt) cnt.textContent = list.length + ' sc√©nario' + (list.length > 1 ? 's' : '') + (_devScFilter ? ' [' + _devScFilter + ']' : '');
  list.slice(0, 80).forEach(sc => {
    const btn = document.createElement('button');
    // Style sc√©nario : fond solide, clair, cliquable
    const riskColor = {aucun:'#4CAF50', faible:'#FFC107', moyen:'#FF8C42', '√©lev√©':'#FF5722', critique:'#E53935'}[sc.risk] || '#aaa';
    btn.style.cssText = [
      'display:flex;align-items:center;gap:8px;width:100%;text-align:left;',
      'padding:9px 11px;border-radius:9px;cursor:pointer;',
      'background:rgba(255,255,255,0.06);',
      'border:1px solid rgba(255,255,255,0.12);',
      'color:#ddd;font-size:0.75rem;line-height:1.4;',
      'transition:background 0.15s;'
    ].join('');
    btn.onmouseover = () => { btn.style.background = 'rgba(255,140,66,0.18)'; btn.style.borderColor = 'rgba(255,140,66,0.5)'; };
    btn.onmouseout  = () => { btn.style.background = 'rgba(255,255,255,0.06)'; btn.style.borderColor = 'rgba(255,255,255,0.12)'; };
    const titre = sc.name || (sc.conseil && sc.conseil.titre) || sc.titre || '(sans titre)';
    btn.innerHTML = '<span style="color:' + riskColor + ';font-size:0.65rem;font-weight:900;min-width:22px;text-align:center;">#' + sc.id + '</span>'
      + '<span style="flex:1;">' + titre.substring(0, 44) + '</span>'
      + '<span style="font-size:0.6rem;color:#555;white-space:nowrap;">' + (sc.category || sc.risk || '') + '</span>';
    btn.onclick = () => demoShowScenario(sc.id);
    el.appendChild(btn);
  });
  if (list.length > 80) {
    const more = document.createElement('div');
    more.style.cssText = 'color:#555;font-size:0.7rem;padding:8px;text-align:center;';
    more.textContent = '+ ' + (list.length - 80) + ' ‚Äî filtrer par cat√©gorie';
    el.appendChild(more);
  }
}

function devPlayScenarioById() {
  const id = parseInt(document.getElementById('dev-sc-search').value);
  if (!isNaN(id)) demoShowScenario(id);
}

function demoShowScenario(id) {
  if (typeof FOX_SCENARIOS === 'undefined') return;
  const sc = FOX_SCENARIOS.find(s => s.id === id);
  if (!sc) { _demoLabel('Sc√©nario #' + id + ' introuvable'); return; }
  const conseil = sc.conseil || {};
  // Rendre le sc√©nario seul dans popup-scenarios, avec le d√©tail ouvert
  if (typeof renderScenarios === 'function') {
    renderScenarios([sc]);
    // Auto-ouvrir le d√©tail (le premier nextElementSibling)
    setTimeout(() => {
      const list = document.getElementById('scenarios-list');
      if (list) {
        const detail = list.querySelector('div[style*="display:none"]');
        if (detail) detail.style.display = 'block';
      }
    }, 60);
  }
  const cnt = document.getElementById('scenarios-count');
  if (cnt) cnt.textContent = 'ü¶ä #' + id + ' [' + (sc.category||sc.risk||'?') + '] ‚Äî ' + (sc.name || '');
  // Mettre √† jour la bulle
  const bbl = document.getElementById('kitsune-bubble-text');
  if (bbl) bbl.textContent = 'ü¶ä #' + id + ' [' + (sc.category||'') + '] ' + (conseil.titre || sc.name || '').substring(0, 40);
  _demoLabel('#' + id + ' [' + (sc.category||sc.risk||'') + '] ‚Äî ' + (sc.name||'').substring(0, 36));
  if (typeof openPopup === 'function') openPopup('popup-scenarios');
}

// ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _devFillBadges() {
  const el = document.getElementById('dev-badges-list');
  if (!el || typeof BADGES === 'undefined') return;
  el.innerHTML = '';
  const unlocked = typeof badgeSystem !== 'undefined' ? (badgeSystem.unlockedBadges||[]) : [];
  BADGES.forEach(b => {
    const isOn = unlocked.includes(b.id);
    const btn = document.createElement('button');
    btn.className = 'demo-btn';
    btn.style.cssText = 'font-size:0.7rem;padding:5px 7px;opacity:' + (isOn ? '1' : '0.3') + ';';
    btn.textContent = (b.emoji||'üèÖ') + ' #' + b.id + ' ' + (b.name||'');
    btn.title = (b.description||'') + ' [' + (b.rarity||'') + ']';
    btn.id = 'dev-badge-' + b.id;
    btn.onclick = () => devToggleBadge(b.id);
    el.appendChild(btn);
  });
}

function devToggleBadge(id) {
  if (typeof badgeSystem === 'undefined') return;
  const ul = badgeSystem.unlockedBadges || [];
  const idx = ul.indexOf(id);
  if (idx < 0) {
    ul.push(id);
    const b = typeof BADGES !== 'undefined' ? BADGES.find(x => x.id === id) : null;
    if (b && typeof showBadgeUnlockAnim === 'function') showBadgeUnlockAnim(b);
    _demoLabel('Badge #' + id + ' d√©bloqu√© ‚úì');
  } else { ul.splice(idx, 1); _demoLabel('Badge #' + id + ' verrouill√©'); }
  badgeSystem.unlockedBadges = ul;
  localStorage.setItem('rpg_unlocked_badges', JSON.stringify(ul));
  const btn = document.getElementById('dev-badge-' + id);
  if (btn) btn.style.opacity = ul.includes(id) ? '1' : '0.3';
  refreshHUD();
}

function devBadgesAll(unlock) {
  if (typeof badgeSystem === 'undefined' || typeof BADGES === 'undefined') return;
  const ids = unlock ? BADGES.map(b => b.id) : [];
  badgeSystem.unlockedBadges = ids;
  localStorage.setItem('rpg_unlocked_badges', JSON.stringify(ids));
  _devFillBadges();
  _demoLabel(unlock ? 'Tous les badges d√©bloqu√©s (' + ids.length + ')' : 'Tous verrouill√©s');
  refreshHUD();
}

function _demoSetBadges(ids) {
  const numIds = (ids||[]).filter(id => typeof id === 'number');
  if (typeof badgeSystem !== 'undefined') { badgeSystem.unlockedBadges = numIds; localStorage.setItem('rpg_unlocked_badges', JSON.stringify(numIds)); }
}

// ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function devAnim(type, val) {
  if (type === 'levelup' && typeof showLevelUpAnim === 'function') { showLevelUpAnim(val); _demoLabel('Anim level-up niv ' + val); }
  else if (type === 'storm' && typeof updateStormOverlay === 'function') { updateStormOverlay(val); _demoLabel('Storm score ' + val); }
  else if (type === 'badge') {
    const b = typeof BADGES !== 'undefined' ? BADGES.find(x => x.id === val) : null;
    if (b && typeof showBadgeUnlockAnim === 'function') { showBadgeUnlockAnim(b); _demoLabel('Anim badge : ' + (b.name||val)); }
  }
}

function _devFillAnimBadges() {
  const el = document.getElementById('dev-anim-badge-list');
  if (!el || typeof BADGES === 'undefined') return;
  el.innerHTML = '';
  [0, 5, 15, 30, 50, 64].forEach(i => {
    const b = BADGES[i]; if (!b) return;
    const btn = document.createElement('button');
    btn.className = 'demo-btn'; btn.style.textAlign = 'left';
    btn.textContent = (b.emoji||'üèÖ') + ' ' + (b.name||'#'+b.id) + ' [' + (b.rarity||'') + ']';
    btn.onclick = () => devAnim('badge', b.id);
    el.appendChild(btn);
  });
}

// ‚îÄ‚îÄ SAISONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function devSetSeason(q) {
  const names = ['Hiver','Printemps','√ât√©','Automne'];
  if (q < 0) {
    localStorage.removeItem('FOX_SEASON_OVERRIDE');
    _demoLabel('Saison r√©elle restaur√©e');
  } else {
    localStorage.setItem('FOX_SEASON_OVERRIDE', String(q));
    _demoLabel('D√©cor : ' + (names[q] || 'Q'+q));
  }
  // Appliquer directement sur l'img bg-decor (m√™me chemin que updateSeasonalBg)
  const bgEl = document.getElementById('bg-decor');
  if (bgEl) {
    const idx = q >= 0 ? q : Math.floor(new Date().getMonth() / 3);
    const bgs = typeof _SEASONAL_BG !== 'undefined' ? _SEASONAL_BG :
      ['../images/fox-bg.PNG','../images/fox-bg-2.jpg','../images/fox-bg-3.jpg','../images/fox-bg-4.jpg'];
    const target = bgs[idx] || bgs[0];
    bgEl.style.opacity = '0';
    bgEl.style.transition = 'opacity 1.2s ease';
    setTimeout(() => {
      bgEl.src = target;
      bgEl.onload  = () => { bgEl.style.opacity = '1'; };
      bgEl.onerror = () => { bgEl.style.opacity = '1'; };
    }, 500);
  }
}

// ‚îÄ‚îÄ SITUATIONS PR√äTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function demoStep(step) {
  const y = new Date().getFullYear().toString();
  const yp = (parseInt(y)-1).toString(), y2 = (parseInt(y)-2).toString();

  if (step === 'reset') {
    _demoLabel('Reset ‚Äî donn√©es effac√©es');
    ['DATA_REPORT_','CA_HS_TRACKER_V1_DATA_','BASE_HEBDO_','ANNUAL_RATE_'].forEach(k => {
      [y,yp,y2].forEach(yr => localStorage.removeItem(k+yr));
    });
    localStorage.removeItem('FOX_BURNOUT_OVERRIDE');
    if (typeof _fullRPGReset === 'function') _fullRPGReset();
    syncModulesAndAwardXP('dev'); refreshHUD();

  } else if (step === 'start') {
    _demoLabel('D√©part ‚Äî 0h sup, niveau 1');
    _demoInjectM1(y, []); _demoSetXP(50, 1); _demoSetBadges([]);
    syncModulesAndAwardXP('dev'); refreshHUD();

  } else if (step === 'light') {
    _demoLabel('L√©g√®res HS ‚Äî ~15h sur l\'ann√©e');
    _demoInjectM1(y, [
      {date:y+'-01-15',extra:3},{date:y+'-02-10',extra:2},
      {date:y+'-03-05',extra:4,recup:1},{date:y+'-04-12',extra:3},
      {date:y+'-05-08',extra:2},{date:y+'-06-15',extra:3,recup:1}
    ]);
    _demoSetXP(350, 2); _demoSetBadges([1,2]);
    syncModulesAndAwardXP('dev'); setTimeout(refreshHUD, 300);
    setTimeout(() => kitsuneNarrateOvertime(0,'DEV'), 600);

  } else if (step === 'medium') {
    _demoLabel('HS mod√©r√©es ‚Äî 60h / an');
    const wks = [];
    for (let m=1;m<=10;m++) { const mm=String(m).padStart(2,'0'); wks.push({date:y+'-'+mm+'-07',extra:4}); wks.push({date:y+'-'+mm+'-21',extra:3,recup:1}); }
    _demoInjectM1(y, wks); _demoSetXP(1200, 4); _demoSetBadges([1,2,8,10]);
    syncModulesAndAwardXP('dev'); setTimeout(refreshHUD, 300);
    setTimeout(() => kitsuneNarrateOvertime(0,'DEV'), 600);

  } else if (step === 'heavy') {
    _demoLabel('HS √©lev√©es ‚Äî 150h, risque s√©rieux');
    const wks = [];
    for (let m=1;m<=12;m++) { const mm=String(m).padStart(2,'0'); wks.push({date:y+'-'+mm+'-07',extra:8}); wks.push({date:y+'-'+mm+'-14',extra:7,recup:1}); wks.push({date:y+'-'+mm+'-21',extra:9}); }
    _demoInjectM1(y, wks); _demoSetXP(4500, 7); _demoSetBadges([1,2,8,9,10,11,12]);
    syncModulesAndAwardXP('dev'); setTimeout(refreshHUD, 300);
    setTimeout(() => kitsuneNarrateOvertime(0,'DEV'), 600);

  } else if (step === 'critical') {
    _demoLabel('CRITIQUE ‚Äî 220h+ contingent d√©pass√©');
    const wks = [];
    for (let m=1;m<=12;m++) { const mm=String(m).padStart(2,'0'); wks.push({date:y+'-'+mm+'-06',extra:12}); wks.push({date:y+'-'+mm+'-13',extra:11}); wks.push({date:y+'-'+mm+'-20',extra:10,recup:1}); }
    _demoInjectM1(y, wks);
    _demoSetXP(9800, 10);
    _demoSetBadges(typeof BADGES!=='undefined' ? BADGES.map(b=>b.id).slice(0,20) : []);
    syncModulesAndAwardXP('dev'); setTimeout(refreshHUD, 300);
    setTimeout(() => kitsuneNarrateOvertime(0,'DEV'), 600);

  } else if (step === 'multiyear') {
    _demoLabel('Multi-ann√©es ‚Äî 3 ans cumul√©s');
    [y,yp,y2].forEach((yr,i) => {
      const mult=[1,1.5,2][i]; const wks=[];
      for (let m=1;m<=12;m++) { const mm=String(m).padStart(2,'0'); wks.push({date:yr+'-'+mm+'-10',extra:Math.round(5*mult)}); wks.push({date:yr+'-'+mm+'-20',extra:Math.round(4*mult),recup:1}); }
      _demoInjectM1(yr, wks);
    });
    _demoSetXP(7500, 9); _demoSetBadges([1,8,9,10,11,12]);
    syncModulesAndAwardXP('dev'); setTimeout(refreshHUD, 300);
    setTimeout(() => kitsuneNarrateOvertime(0,'DEV'), 600);

  } else if (step === 'burnout') {
    _demoLabel('BURNOUT MAX ‚Äî score critique');
    const wks = [];
    for (let m=1;m<=12;m++) { const mm=String(m).padStart(2,'0'); wks.push({date:y+'-'+mm+'-06',extra:14}); wks.push({date:y+'-'+mm+'-13',extra:13}); wks.push({date:y+'-'+mm+'-20',extra:12}); }
    _demoInjectM1(y, wks);
    [yp,y2].forEach(yr => {
      const wks2=[]; for (let m=1;m<=12;m++) wks2.push({date:yr+'-'+String(m).padStart(2,'00')+'-10',extra:10});
      _demoInjectM1(yr, wks2);
    });
    _demoSetXP(15000, 12);
    _demoSetBadges(typeof BADGES!=='undefined' ? BADGES.map(b=>b.id) : []);
    syncModulesAndAwardXP('dev'); setTimeout(refreshHUD, 300);
    setTimeout(() => devSetBurnout(95), 600);
  }
}

function demoNarrate(hours) {
  kitsuneNarrateOvertime(hours, 'DEV');
  _demoLabel('Kitsune : +' + hours + 'h sup narr√©');
}
</script>
<script>
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
//  NOUVELLES FONCTIONS FOX ENGINE \u2014 patch complet
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550

// \u2500\u2500 D\u00E9cor saisonnier (4 backgrounds par trimestre) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
const _SEASONAL_BG = [
  '../images/fox-bg.PNG',     // Q1 : hiver (jan-mar)
  '../images/fox-bg-2.jpg',   // Q2 : printemps (avr-jun)
  '../images/fox-bg-3.jpg',   // Q3 : \u00E9t\u00E9 (jul-sep)
  '../images/fox-bg-4.jpg',   // Q4 : automne (oct-d\u00E9c)
];
function updateSeasonalBg() {
  const m     = new Date().getMonth(); // 0-11
  const q     = Math.floor(m / 3);    // 0-3
  const bg    = _SEASONAL_BG[q] || _SEASONAL_BG[0];
  const bgEl  = document.getElementById('bg-decor');
  if (!bgEl) return;
  const current = bgEl.src.split('/').pop();
  const target  = bg.split('/').pop();
  if (current !== target) {
    bgEl.style.opacity = '0';
    bgEl.style.transition = 'opacity 1.5s ease';
    setTimeout(() => {
      bgEl.src = bg;
      bgEl.onload = () => { bgEl.style.opacity = '1'; };
      bgEl.onerror = () => { bgEl.style.opacity = '1'; }; // fallback si image absente
    }, 800);
  }
}

// \u2500\u2500 PNJ \u2014 \u00E9volution tous les 5 niveaux jusqu'au niveau 50 \u2500
// Images attendues : foxplayer.PNG (niv 1-5), foxplayer-2.PNG (6-10) ... foxplayer-10.PNG (46-50)
function updatePNJLevel(level) {
  const lvl  = Math.max(1, Math.min(50, level || 1));
  const tier = Math.min(10, Math.ceil(lvl / 5));
  console.log('ü¶ä updatePNJLevel : niveau', lvl, '‚Üí tier', tier);
  const img  = tier === 1 ? '../images/foxplayer.PNG' : '../images/foxplayer-' + tier + '.PNG';
  const pnj  = document.getElementById('kitsune-svg');
  const foxImgPopup = document.querySelector('#popup-fox img[src*="foxplayer"]');
  // Masquer fond noir : filter brightness + contrast
  if (foxImgPopup) { 
    foxImgPopup.style.filter = 'brightness(1.2) contrast(1.1)'; 
    foxImgPopup.style.mixBlendMode = 'screen';
    foxImgPopup.style.background = 'transparent';
  }
  if (pnj) { pnj.setAttribute('data-tier', tier); pnj.src = img; }
  if (foxImgPopup) {
    foxImgPopup.src = img;
    // Augmenter la taille selon le tier (niveaux 4+ sont trop petits)
    let size = 90; // tier 1-3 : taille de base
    if (tier >= 7) size = 130; // tier 7-10 : grande taille
    else if (tier >= 4) size = 110; // tier 4-6 : taille moyenne
    foxImgPopup.style.width = size + 'px';
    foxImgPopup.style.height = size + 'px';
  }
}

// \u2500\u2500 Animation Level-Up \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function showLevelUpAnim(level) {
  // Flash hud-level
  const lvlEl = document.getElementById('hud-level');
  if (lvlEl) {
    lvlEl.classList.remove('level-up-anim');
    void lvlEl.offsetWidth;
    lvlEl.classList.add('level-up-anim');
    setTimeout(() => lvlEl.classList.remove('level-up-anim'), 3500);
  }
  // Flash plein \u00E9cran
  const flash = document.getElementById('levelup-flash');
  if (flash) { flash.classList.remove('active'); void flash.offsetWidth; flash.classList.add('active'); }
  // Banni\u00E8re centrale
  const banner = document.getElementById('levelup-banner');
  const bannerNum = document.getElementById('levelup-banner-num');
  const bannerSub = document.getElementById('levelup-banner-sub');
  if (banner && bannerNum) {
    bannerNum.textContent = level;
    if (bannerSub) {
      const msgs = [
        '\uD83E\uDD8A Tu ma\u00EEtrises le droit du travail !',
        '\uD83D\uDCDA Kitsune est fier de toi !',
        '\u26A1 Nouveau palier atteint !',
        '\uD83C\uDF1F Ta vigilance paie !',
      ];
      bannerSub.textContent = msgs[level % msgs.length];
    }
    banner.classList.remove('active');
    void banner.offsetWidth;
    banner.classList.add('active');
    setTimeout(() => banner.classList.remove('active'), 3100);
  }
  // Particules dor\u00E9es
  for (let i = 0; i < 18; i++) {
    setTimeout(() => {
      const p = document.createElement('div');
      p.className = 'gold-particle';
      const cx = 40 + Math.random() * (window.innerWidth - 80);
      const cy = window.innerHeight * 0.2 + Math.random() * window.innerHeight * 0.3;
      const dx = (Math.random() - 0.5) * 200;
      const dy = -80 - Math.random() * 150;
      p.style.cssText = `left:${cx}px;top:${cy}px;--dx:translate(${dx}px,${dy}px);animation-duration:${0.8+Math.random()*0.8}s;`;
      document.body.appendChild(p);
      setTimeout(() => p.remove(), 1800);
    }, i * 60);
  }
  // Historique Kitsune
  if (typeof addRewardToHistory === 'function') addRewardToHistory('\u2B06\uFE0F Niveau ' + level + ' atteint !', 'level');
}

function showBadgeUnlockAnim(badge) {
  console.log('üèÖüèÖüèÖ BADGE UNLOCK ANIMATION START:', badge.name);
  
  const rC = {common:'#b0b0b0', rare:'#5094ff', epic:'#a050ff', legendary:'#FFD700'};
  const color = rC[badge.rarity] || '#FF8C42';
  const isSkill = badge.id && badge.id >= 51;
  
  // PARTICULES de la couleur du badge
  for (let i = 0; i < 30; i++) {
    setTimeout(() => {
      const particle = document.createElement('div');
      particle.textContent = '‚ú®';
      particle.style.cssText = `
        position: fixed;
        left: 50%;
        top: 50%;
        font-size: ${Math.random() * 15 + 10}px;
        color: ${color};
        pointer-events: none;
        z-index: 99997;
        animation: particleBurst ${Math.random() * 1 + 1}s ease-out forwards;
        transform: translate(-50%, -50%);
      `;
      document.body.appendChild(particle);
      setTimeout(() => particle.remove(), 1500);
    }, i * 15);
  }
  
  const popup = document.getElementById('badge-unlock-popup');
  if (popup) {
    popup.style.borderColor = color;
    popup.style.boxShadow = `0 0 40px ${color}55, inset 0 0 20px ${color}11`;
    const bupImg  = document.getElementById('bup-img');
    const bupName = document.getElementById('bup-name');
    const bupDesc = document.getElementById('bup-desc');
    if (bupImg) {
      if (badge.img) {
        bupImg.innerHTML = `<img src="${badge.img}" style="width:56px;height:56px;object-fit:contain;" onerror="this.outerHTML='<span style=font-size:2.5rem>${badge.icon||(isSkill?'\uD83C\uDF1F':'\uD83C\uDFC5')}</span>'">`;
      } else {
        bupImg.textContent = badge.icon || (isSkill ? '\uD83C\uDF1F' : '\uD83C\uDFC5');
      }
    }
    if (bupName) { bupName.textContent = (isSkill ? '\uD83C\uDF1F ' : '\uD83C\uDFC5 ') + (badge.name || ''); bupName.style.color = color; }
    if (bupDesc) { bupDesc.textContent = badge.description || badge.desc || ''; }
    popup.classList.remove('pop-in','pop-out');
    void popup.offsetWidth;
    popup.classList.add('pop-in');
    setTimeout(() => { popup.classList.remove('pop-in'); popup.classList.add('pop-out'); }, 3200);
    setTimeout(() => popup.classList.remove('pop-out'), 3700);
  }
  // Historique
  if (typeof addRewardToHistory === 'function') {
    addRewardToHistory((isSkill ? '\uD83C\uDF1F' : '\uD83C\uDFC5') + ' ' + (badge.name||'') + ' d\u00E9bloqu\u00E9 !', badge.rarity || 'common');
  }
}

function addRewardToHistory(text, type) {
  // Persister dans localStorage
  const key = 'FOX_REWARDS_HISTORY';
  const hist = JSON.parse(localStorage.getItem(key) || '[]');
  hist.unshift({ text, type, ts: Date.now() });
  if (hist.length > 50) hist.splice(50);
  localStorage.setItem(key, JSON.stringify(hist));
  // Mettre \u00E0 jour le panneau si ouvert
  _renderRewardsLog(hist);
}

function _renderRewardsLog(hist) {
  const log = document.getElementById('kitsune-rewards-log');
  if (!log) return;
  if (!hist || hist.length === 0) {
    log.innerHTML = '<div style="color:#444;font-size:0.78rem;text-align:center;padding:8px;">Aucune r\u00E9compense d\u00E9bloqu\u00E9e pour l\'instant</div>';
    return;
  }
  const typeColors = { level:'#FFD700', common:'#b0b0b0', rare:'#5094ff', epic:'#a050ff', legendary:'#FFD700', info:'#FF8C42' };
  log.innerHTML = hist.map(r => {
    const c = typeColors[r.type] || '#888';
    const d = new Date(r.ts);
    const ts = `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
    const safeText = (r.text || '').replace(/'/g, "\\'");
    return `<div style="background:rgba(255,255,255,0.03);border-left:3px solid ${c};border-radius:6px;padding:6px 10px;font-size:0.78rem;cursor:pointer;" onclick="alert('üèÜ ${safeText}\\n\\nD√©bloqu√© le ${ts}')">
      <span style="color:${c};">${r.text}</span>
      <span style="color:#333;font-size:0.65rem;float:right;">${ts}</span>
    </div>`;
  }).join('');
}

// \u2500\u2500 Kitsune popup refresh (historique) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function refreshKitsunePopup() {
  // ‚îÄ‚îÄ 1. Texte principal : derni√®re narration Kitsune ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const foxText = document.getElementById('fox-text');
  if (foxText) {
    const lastNarr = localStorage.getItem('FOX_LAST_NARRATION');
    if (lastNarr) {
      try {
        const n = JSON.parse(lastNarr);
        // Reconstruction HTML riche
        let html = '';
        if (n.titre)   html += '<div style="color:#FF8C42;font-weight:900;font-size:0.95rem;margin-bottom:8px;">'+n.titre+'</div>';
        if (n.message) html += '<div style="color:#ccc;line-height:1.7;font-size:0.88rem;margin-bottom:10px;">'+n.message+'</div>';
        if (n.actions && n.actions.length) {
          html += '<div style="color:#888;font-size:0.7rem;letter-spacing:1px;margin-bottom:5px;">√Ä FAIRE</div>';
          html += '<ul style="margin:0;padding-left:18px;color:#aaa;font-size:0.82rem;line-height:1.8;">';
          n.actions.forEach(a => { html += '<li>'+a+'</li>'; });
          html += '</ul>';
        }
        if (n.alerte) {
          const ac = {danger:'#E53935',warning:'#FF8C42',alert:'#FFC107',info:'#42A5F5'}[n.alerte.niveau]||'#666';
          html += '<div style="margin-top:10px;padding:8px 12px;border-left:3px solid '+ac+';background:rgba('+
            (n.alerte.niveau==='danger'?'229,57,53':'255,140,66')+',0.08);border-radius:0 8px 8px 0;color:'+ac+';font-size:0.82rem;">'+
            (n.alerte.texte||'')+'</div>';
        }
        foxText.innerHTML = html || 'ü¶ä Lance une analyse pour voir mes conseils complets !';
      } catch(e) { foxText.textContent = localStorage.getItem('FOX_LAST_BUBBLE') || 'ü¶ä Lance une analyse !'; }
    } else {
      // V√©rifier si M1 ou M2 ont des donn√©es avant de dire "pas de donn√©es"
      const year = new Date().getFullYear();
      const rawM1 = JSON.parse(localStorage.getItem('DATA_REPORT_' + year) || '{}');
      const rawM2 = JSON.parse(localStorage.getItem('CA_HS_TRACKER_V1_DATA_' + year) || '{}');
      const hasM1 = Object.keys(rawM1).some(k => /^\d{4}-\d{2}-\d{2}$/.test(k) && (rawM1[k].extra||0) > 0);
      const hasM2 = Object.values(rawM2).some(mv => {
      if (!mv || !mv.days || mv.closed) return false;
      // V√©rifier qu'il y a au moins une journ√©e avec des heures > 0
      return Object.values(mv.days).some(hrs => (hrs || 0) > 0);
    });
      
      // Popup remplissage d√©sactiv√©e
      // if (!hasM1 && !hasM2) {
      //   foxText.innerHTML = 'Bienvenue';
      // } else {
      if (hasM1 || hasM2 || true) {
        // Il y a des donn√©es, d√©clencher une analyse
        try { kitsuneNarrateOvertime(0, 'POPUP'); } catch(e){}
        foxText.textContent = 'ü¶ä Analyse en cours...';
        setTimeout(() => {
          const n = localStorage.getItem('FOX_LAST_NARRATION');
          if (n) {
            try {
              const narr = JSON.parse(n);
              let html = '';
              if (narr.titre) html += '<div style="color:#FF8C42;font-weight:900;font-size:0.95rem;margin-bottom:8px;">'+narr.titre+'</div>';
              if (narr.message) html += '<div style="color:#ccc;line-height:1.7;font-size:0.88rem;">'+narr.message+'</div>';
              foxText.innerHTML = html || 'ü¶ä Analyse termin√©e';
            } catch(e){}
          }
        }, 500);
      }
    }
  }

  // ‚îÄ‚îÄ 2. Journal Kitsune ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  renderKitsuneJournal();
  // ‚îÄ‚îÄ 3. Historique r√©compenses ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const hist = JSON.parse(localStorage.getItem('FOX_REWARDS_HISTORY') || '[]');
  _renderRewardsLog(hist);
  
  // ‚îÄ‚îÄ 4. Analyse auto si donn√©es pr√©sentes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const lastNarr = localStorage.getItem('FOX_LAST_NARRATION');
  if (!lastNarr) {
    const year = new Date().getFullYear();
    const rawM1 = JSON.parse(localStorage.getItem('DATA_REPORT_' + year) || '{}');
    const rawM2 = JSON.parse(localStorage.getItem('CA_HS_TRACKER_V1_DATA_' + year) || '{}');
    const hasM1 = Object.keys(rawM1).some(k => /^\d{4}-\d{2}-\d{2}$/.test(k) && (rawM1[k].extra||0) > 0);
    const hasM2 = Object.values(rawM2).some(mv => {
      if (!mv || !mv.days || mv.closed) return false;
      // V√©rifier qu'il y a au moins une journ√©e avec des heures > 0
      return Object.values(mv.days).some(hrs => (hrs || 0) > 0);
    });
    
    if (hasM1 || hasM2) {
      setTimeout(() => {
        try {
          // Calculer les heures du jour pour l'analyse
          const today = now.toISOString().split('T')[0];
          let todayHours = 0;
          
          // Chercher dans M1
          if (rawM1[today] && rawM1[today].extra) {
            todayHours = rawM1[today].extra;
          }
          
          // Sinon chercher dans M2 (mois actuel)
          if (todayHours === 0) {
            const ym = today.substring(0, 7);
            const d = parseInt(today.substring(8));
            if (rawM2[ym] && rawM2[ym].days && rawM2[ym].days[d]) {
              const hrs = rawM2[ym].days[d];
              const base = 7; // base par d√©faut
              todayHours = Math.max(0, hrs - base);
            }
          }
          
          console.log('ü¶ä refreshKitsunePopup : todayHours calcul√© =', todayHours);
          kitsuneNarrateOvertime(todayHours, 'AUTO'); 
          setTimeout(refreshKitsunePopup, 800);
        } catch(e){}
      }, 300);
    }
  }
}

// \u2500\u2500 Import JSON fichier \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function importJSONFile(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      _applyImportedData(data);
    } catch(err) {
      _setImportStatus('JSON invalide : ' + err.message, false);
    }
  };
  reader.readAsText(file);
}

async function importFromClipboard() {
  try {
    const text = await navigator.clipboard.readText();
    const data = JSON.parse(text);
    _applyImportedData(data);
  } catch(e) {
    _setImportStatus('Aucun JSON valide dans le presse-papier', false);
  }
}

function _applyImportedData(data) {
  let count = 0;
  // D\u00E9tecter le type de donn\u00E9es
  if (data.gameState || data.xp || data.badges) {
    // Export RPG complet
    if (data.gameState && typeof gameState !== 'undefined') {
      Object.assign(gameState, data.gameState);
      if (typeof saveGameState === 'function') saveGameState();
      count++;
    }
  }
  // Import localStorage direct (cl\u00E9s DATA_REPORT_, CA_HS_TRACKER_V1_DATA_)
  if (data.localStorage) {
    Object.entries(data.localStorage).forEach(([k, v]) => {
      localStorage.setItem(k, typeof v === 'string' ? v : JSON.stringify(v));
      count++;
    });
  }
  // Import M1 direct
  if (data.module1 || data.m1) {
    const m1 = data.module1 || data.m1;
    const year = m1.year || new Date().getFullYear();
    if (m1.rawData) localStorage.setItem('DATA_REPORT_' + year, JSON.stringify(m1.rawData));
    count++;
  }
  // Import M2 direct
  if (data.module2 || data.m2) {
    const m2 = data.module2 || data.m2;
    const year = m2.year || new Date().getFullYear();
    if (m2.data) localStorage.setItem('CA_HS_TRACKER_V1_DATA_' + year, JSON.stringify(m2.data));
    count++;
  }
  if (count > 0) {
    _setImportStatus(`Import r\u00E9ussi (${count} section(s)). Rechargement\u2026`, true);
    setTimeout(() => { syncModulesAndAwardXP('import'); closePopup('popup-import'); }, 1200);
  } else {
    _setImportStatus('Donn\u00E9es non reconnues \u2014 v\u00E9rifie le format', false);
  }
}

function _setImportStatus(msg, ok) {
  const el = document.getElementById('import-status');
  if (!el) return;
  el.style.display = 'block';
  el.style.background = ok ? 'rgba(76,175,80,0.12)' : 'rgba(229,57,53,0.12)';
  el.style.border = ok ? '1px solid rgba(76,175,80,0.3)' : '1px solid rgba(229,57,53,0.3)';
  el.style.color = ok ? '#4CAF50' : '#E53935';
  el.textContent = msg;
}

// \u2500\u2500 Debug M1 (ajout\u00E9 dans Settings) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function debugM1Data() {
  const year = localStorage.getItem('ACTIVE_YEAR_SUFFIX') || new Date().getFullYear();
  const raw  = localStorage.getItem('DATA_REPORT_' + year);
  const keys = Object.keys(localStorage).filter(k => k.startsWith('DATA_REPORT_'));
  const msg  = `Ann\u00E9e active: ${year}\nCl\u00E9s M1 trouv\u00E9es: ${keys.join(', ') || 'aucune'}\nDonn\u00E9es: ${raw ? Object.keys(JSON.parse(raw)).length + ' entr\u00E9es' : 'vide'}`;
  alert(msg);
}

// \u2500\u2500 Kitsune narration \u2014 ton "conseil d'ami" \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function _friendlyScenario(s) {
  if (!s || !s.conseil) return null;
  const c = s.conseil;
  // R\u00E9\u00E9crire en mode "ami qui sait"
  const titre = c.titre;
  let msg = c.message || '';
  // Remplacer tournures juridiques froides par ton chaleureux
  msg = msg
    .replace(/Vous devez/gi, 'Tu dois')
    .replace(/Il est obligatoire/gi, 'C\'est obligatoire')
    .replace(/L\'employeur/gi, 'Ton employeur')
    .replace(/Le salari\u00E9/gi, 'Tu')
    .replace(/selon la convention/gi, 'selon ta convention (\u00E0 v\u00E9rifier !)')
    .replace(/V\u00E9rifiez/gi, 'V\u00E9rifie')
    .replace(/Contactez/gi, 'Contacte')
    .replace(/Signaler/gi, 'Signale');
  // Ajouter disclaimer l\u00E9ger si sc\u00E9nario l\u00E9gal
  const legal = s.id <= 400;
  const disclaimer = legal ? '\n\n\uD83D\uDCAC (\u00C0 titre indicatif \u2014 je suis ton renard, pas ton avocat !)' : '';
  return { titre, msg: msg + disclaimer, actions: c.actions, alerte: c.alerte };
}

// Override kitsuneNarrateOvertime \u2014 passthrough vers la fonction principale
// La logique d'analyse l\u00E9gale est dans _analyzeLegalSituation() et la fn principale
const _origKitsune = typeof kitsuneNarrateOvertime === 'function' ? kitsuneNarrateOvertime : null;
// (pas de red\u00E9finition : la fn principale fait tout)

function checkAndAwardBadges() {
  // GUARD : v√©rifier qu'il y a au moins 5 jours de donn√©es avant de d√©bloquer
  const year = new Date().getFullYear();
  const rawM1 = JSON.parse(localStorage.getItem('DATA_REPORT_' + year) || '{}');
  const rawM2 = JSON.parse(localStorage.getItem('CA_HS_TRACKER_V1_DATA_' + year) || '{}');
  
  const daysM1 = Object.keys(rawM1).filter(k => /^\d{4}-\d{2}-\d{2}$/.test(k) && (rawM1[k].extra||0) > 0).length;
  let daysM2 = 0;
  Object.values(rawM2).forEach(mv => {
    if (mv && mv.days) daysM2 += Object.keys(mv.days).length;
  });
  
  const totalDays = daysM1 + daysM2;
  if (totalDays < 5) {
    console.log('ü¶ä Badges : pas assez de donn√©es (' + totalDays + '/5 jours)');
    return; // Pas encore assez de donn√©es
  }
  
  console.log('ü¶ä Badges : v√©rification avec ' + totalDays + ' jours de donn√©es');
  try {
    if (typeof badgeSystem === 'undefined') return [];
    const stats     = typeof buildBadgeStats === 'function' ? buildBadgeStats() : {};
    const newBadges = badgeSystem.checkAndUnlockBadges(stats);
    for (const badge of newBadges) {
      // Synchroniser dans gameState.badges pour l'affichage
      if (typeof gameState !== 'undefined') {
        if (!gameState.badges) gameState.badges = [];
        if (!gameState.badges.includes(badge.id)) {
          gameState.badges.push(badge.id);
          if (typeof saveGameState === 'function') saveGameState();
        }
      }
      showBadgeUnlockAnim(badge);
    }
    // Sync compl\u00E8te de toutes les badges badgeSystem \u2192 gameState (au cas o\u00F9)
    if (typeof gameState !== 'undefined' && badgeSystem.unlockedBadges) {
      const allUnlocked = badgeSystem.unlockedBadges;
      if (!gameState.badges) gameState.badges = [];
      let changed = false;
      allUnlocked.forEach(id => {
        if (!gameState.badges.includes(id)) { gameState.badges.push(id); changed = true; }
      });
      if (changed && typeof saveGameState === 'function') saveGameState();
    }
    // Mettre \u00E0 jour le compteur HUD
    const hudBadges = document.getElementById('hud-badges');
    if (hudBadges) hudBadges.textContent = _getUnlockedIds().length;
    return newBadges;
  } catch(e) { console.warn('checkAndAwardBadges:', e); return []; }
}

// \u2500\u2500 Helpers settings M1 debug \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500

// \u2500\u2500 Init : d\u00E9cor saisonnier + PNJ niveau au load \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(updateSeasonalBg, 500);
  setTimeout(() => {
    const lvl = typeof xpSystem !== 'undefined' ? (xpSystem.level || 1) : 1;
    updatePNJLevel(lvl);
  }, 600);
  // Charger historique Kitsune
  setTimeout(refreshKitsunePopup, 1000);
});


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ ONBOARDING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkOnboarding() {
  if (localStorage.getItem('FOX_ONBOARDING_DONE')) return;
  const el = document.getElementById('popup-onboarding');
  if (el) { el.style.display = 'flex'; el.style.alignItems = 'center'; el.style.justifyContent = 'center'; }
}
function obNext(step) {
  document.querySelectorAll('.ob-step').forEach(s => s.style.display = 'none');
  document.querySelectorAll('.ob-dot').forEach(d => d.classList.remove('active'));
  const stepEl = document.getElementById('ob-step-' + step);
  const dotEl  = document.getElementById('ob-dot-' + step);
  if (stepEl) stepEl.style.display = 'block';
  if (dotEl)  dotEl.classList.add('active');
}
function obFinish() {
  localStorage.setItem('FOX_ONBOARDING_DONE', '1');
  const el = document.getElementById('popup-onboarding');
  if (el) { el.style.opacity = '0'; el.style.transition = 'opacity 0.5s'; setTimeout(() => el.style.display = 'none', 500); }
  // D√©clencher analyse initiale apr√®s onboarding
  setTimeout(() => { if (typeof kitsuneNarrateOvertime === 'function') kitsuneNarrateOvertime(0, 'INIT'); }, 800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ NOTIFICATION HEBDOMADAIRE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkWeeklyNotif() {
  // Ne pas afficher si onboarding en cours
  if (!localStorage.getItem('FOX_ONBOARDING_DONE')) return;
  // V√©rifier si d√©j√† dismiss√©e cette semaine
  const nowIso = new Date().toISOString().slice(0,10);
  const lastDismiss = localStorage.getItem('FOX_WEEKLY_NOTIF_DISMISSED');
  if (lastDismiss && lastDismiss >= _getWeekStart()) return;
  // V√©rifier si donn√©es M1 ou M2 saisies cette semaine
  const hasData = _hasDataThisWeek();
  if (hasData) return;
  // Afficher apr√®s 3 secondes
  setTimeout(() => {
    const notif = document.getElementById('weekly-notif');
    if (notif) notif.classList.add('visible');
  }, 3000);
}
function _getWeekStart() {
  const d = new Date();
  const day = d.getDay() || 7; // lundi = 1
  d.setDate(d.getDate() - day + 1);
  return d.toISOString().slice(0,10);
}
function _hasDataThisWeek() {
  try {
    const y = new Date().getFullYear().toString();
    const m1 = JSON.parse(localStorage.getItem('DATA_REPORT_' + y) || '{}');
    const weekStart = _getWeekStart();
    return Object.keys(m1).some(d => d >= weekStart);
  } catch(e) { return false; }
}
function dismissWeeklyNotif() {
  localStorage.setItem('FOX_WEEKLY_NOTIF_DISMISSED', _getWeekStart());
  const notif = document.getElementById('weekly-notif');
  if (notif) { notif.style.opacity = '0'; notif.style.transition = 'opacity 0.3s'; setTimeout(() => notif.classList.remove('visible'), 300); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ R√âSUM√â MENSUEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkMonthlySummary() {
  if (!localStorage.getItem('FOX_ONBOARDING_DONE')) return;
  const now = new Date();
  // Afficher le 1er de chaque mois (ou si forc√© en dev)
  const key = 'FOX_MONTHLY_SUMMARY_' + now.getFullYear() + '_' + now.getMonth();
  if (localStorage.getItem(key)) return;
  if (now.getDate() !== 1) return;
  localStorage.setItem(key, '1');
  setTimeout(() => showMonthlySummary(), 2000);
}
function showMonthlySummary(forceMonth) {
  const now = new Date();
  // Mois actuel (pas pr√©c√©dent)
  const targetMonth = forceMonth !== undefined ? forceMonth : now.getMonth();
  const d = new Date(now.getFullYear(), targetMonth, 1);
  const y = d.getFullYear().toString();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const monthName = d.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });

  let totalHS = 0, violations = 0, burnoutScore = 0;
  try {
    // M1
    const m1 = JSON.parse(localStorage.getItem('DATA_REPORT_' + y) || '{}');
    const daysM1 = new Set();
    Object.entries(m1).forEach(([date, v]) => {
      if (date.startsWith(y + '-' + m)) {
        totalHS += (v.extra || 0);
        if ((v.extra || 0) > 3) violations++;
        daysM1.add(date);
      }
    });
    // M2 (sans doublon M1)
    const m2 = JSON.parse(localStorage.getItem('CA_HS_TRACKER_V1_DATA_' + y) || '{}');
    const monthData = m2[y + '-' + m];
    if (monthData && monthData.days) {
      Object.entries(monthData.days).forEach(([ds, hrs]) => {
        const dk = y + '-' + m + '-' + String(parseInt(ds)).padStart(2,'0');
        if (daysM1.has(dk)) return; // M1 prioritaire
        const extra = parseFloat(hrs) || 0;
        if (extra > 0) {
          totalHS += extra;
          if (extra > 3) violations++;
        }
      });
    }
  } catch(e) {}
  try {
    const bo = moduleReader && moduleReader.getBurnoutScore ? moduleReader.getBurnoutScore() : null;
    if (bo) burnoutScore = bo.score || 0;
  } catch(e) {}

  const pct = Math.round(totalHS / 220 * 100);
  const level = totalHS === 0 ? 'ok' : totalHS < 50 ? 'light' : totalHS < 150 ? 'medium' : 'high';
  const colors = { ok:'#4CAF50', light:'#8BC34A', medium:'#FF8C42', high:'#E53935' };
  const msgs = {
    ok: 'üåü Mois tranquille ‚Äî aucune heure suppl√©mentaire d√©tect√©e.',
    light: '‚úÖ Peu d\'heures suppl√©mentaires. Continue √† surveiller.',
    medium: '‚ö†Ô∏è Charge notable. Kitsune recommande de surveiller la semaine √† venir.',
    high: 'üö® Mois charg√©. V√©rifie tes droits et parle-en √† ton repr√©sentant.'
  };

  const content = document.getElementById('monthly-summary-content');
  if (!content) return;
  content.innerHTML = `
    <div style="text-align:center;margin-bottom:16px;">
      <div style="font-size:2rem;margin-bottom:4px;">ü¶ä</div>
      <div style="color:#FF8C42;font-weight:900;font-size:1rem;">Bilan ‚Äî ${monthName}</div>
    </div>
    <div class="monthly-stat">
      <span class="ms-label">‚è± Heures suppl√©mentaires</span>
      <span class="ms-val" style="color:${colors[level]};">${totalHS}h</span>
    </div>
    <div class="monthly-stat">
      <span class="ms-label">üìä % du contingent annuel</span>
      <span class="ms-val" style="color:${pct > 75 ? '#E53935' : '#FF8C42'};">${pct}%</span>
    </div>
    <div class="monthly-stat">
      <span class="ms-label">‚ö†Ô∏è Jours > seuil l√©gal</span>
      <span class="ms-val" style="color:${violations > 0 ? '#E53935' : '#4CAF50'};">${violations}</span>
    </div>
    <div class="monthly-stat">
      <span class="ms-label">üî• Score burn-out</span>
      <span class="ms-val" style="color:${burnoutScore >= 60 ? '#E53935' : burnoutScore >= 40 ? '#FF8C42' : '#4CAF50'};">${burnoutScore}/100</span>
    </div>
    <div style="margin-top:14px;padding:12px;background:rgba(255,140,66,0.06);border:1px solid rgba(255,140,66,0.15);border-radius:10px;color:#aaa;font-size:0.82rem;line-height:1.6;">
      ${msgs[level]}
    </div>`;

  openPopup('popup-monthly-summary');
  // Injecter comparaison dans le bilan mensuel
  const annBox = document.createElement('div');
  annBox.style.cssText = 'margin-top:14px;border-top:1px solid rgba(255,255,255,0.07);padding-top:12px;';
  annBox.innerHTML = '<div style="color:#666;font-size:0.68rem;letter-spacing:1px;margin-bottom:8px;">üìÜ VS ANN√âE PR√âC√âDENTE</div><div id="monthly-annual-mini"></div>';
  if (content) content.appendChild(annBox);
  setTimeout(() => {
    const mini = document.getElementById('monthly-annual-mini');
    if (!mini) return;
    const now2 = new Date().getFullYear();
    const dN = _getYearData(now2), dP = _getYearData(now2-1);
    if (dP.hasData) {
      const diff2 = dN.totalHS - dP.totalHS;
      const col2  = diff2 > 5 ? '#E53935' : diff2 < -5 ? '#4CAF50' : '#888';
      mini.innerHTML = '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05);">' +
        '<span style="color:#888;font-size:0.8rem;">' + now2 + '</span><span style="color:#FF8C42;font-weight:700;">' + dN.totalHS + 'h</span></div>' +
        '<div style="display:flex;justify-content:space-between;padding:8px 0;">' +
        '<span style="color:#555;font-size:0.8rem;">' + (now2-1) + '</span><span style="color:#666;">' + dP.totalHS + 'h</span></div>' +
        '<div style="color:' + col2 + ';font-size:0.82rem;font-weight:700;text-align:center;padding-top:6px;">' +
        (diff2 > 0 ? '‚ñ≤ +' : diff2 < 0 ? '‚ñº ' : '‚Üí ') + diff2.toFixed(0) + 'h vs ann√©e pr√©c√©dente</div>';
    } else {
      mini.innerHTML = '<div style="color:#444;font-size:0.75rem;text-align:center;">Pas encore de donn√©es ' + (now2-1) + '</div>';
    }
  }, 100);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ JOURNAL KITSUNE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _JOURNAL_KEY = 'FOX_KITSUNE_JOURNAL';
const _JOURNAL_MAX = 10;

function addJournalEntry(entry) {
  // entry = { titre, message, niveau ('ok'|'warning'|'danger'), ts }
  try {
    const journal = JSON.parse(localStorage.getItem(_JOURNAL_KEY) || '[]');
    entry.ts = entry.ts || new Date().toISOString();
    journal.unshift(entry); // plus r√©cent en 1er
    if (journal.length > _JOURNAL_MAX) journal.length = _JOURNAL_MAX;
    localStorage.setItem(_JOURNAL_KEY, JSON.stringify(journal));
  } catch(e) {}
}

function showJournalDetail(index) {
  try {
    const journal = JSON.parse(localStorage.getItem('FOX_KITSUNE_JOURNAL') || '[]');
    const entry = journal[index];
    if (!entry) return;
    
    const popup = document.createElement('div');
    popup.style.cssText = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;padding:20px;';
    popup.onclick = () => popup.remove();
    
    const box = document.createElement('div');
    box.style.cssText = 'max-width:400px;width:100%;background:#1a1a2e;border:1px solid rgba(255,140,66,0.3);border-radius:12px;padding:20px;max-height:80vh;overflow-y:auto;';
    box.onclick = (e) => e.stopPropagation();
    
    const d = new Date(entry.ts);
    const ts = d.toLocaleDateString('fr-FR', {day:'2-digit',month:'long',year:'numeric'}) + ' √† ' + d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
    
    box.innerHTML = '<div style="color:#FF8C42;font-weight:900;font-size:1.1rem;margin-bottom:8px;">' + (entry.titre || 'Analyse') + '</div>' +
      '<div style="color:#666;font-size:0.75rem;margin-bottom:12px;">' + ts + '</div>' +
      '<div style="color:#ccc;line-height:1.7;font-size:0.9rem;white-space:pre-wrap;">' + (entry.message || '') + '</div>' +
      '<button onclick="this.parentElement.parentElement.remove()" style="margin-top:16px;width:100%;background:#FF8C42;border:none;color:#fff;padding:10px;border-radius:8px;font-weight:700;cursor:pointer;">Fermer</button>';
    
    popup.appendChild(box);
    document.body.appendChild(popup);
  } catch(e) {
    console.warn('showJournalDetail:', e);
  }
}

function renderKitsuneJournal() {
  const log = document.getElementById('kitsune-journal-log');
  if (!log) return;
  try {
    const journal = JSON.parse(localStorage.getItem(_JOURNAL_KEY) || '[]');
    if (!journal.length) {
      log.innerHTML = '<div style="color:#444;font-size:0.78rem;text-align:center;padding:8px;">Aucune analyse pour l&#39;instant</div>';
      return;
    }
    log.innerHTML = journal.map((e, i) => {
      const d   = new Date(e.ts);
      const ts  = d.toLocaleDateString('fr-FR', {day:'2-digit',month:'short'}) + ' ' + d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
      const cls = 'journal-entry je-' + (e.niveau || 'ok');
      const fullMsg = (e.message || '').replace(/'/g, "\\'");
      const shortMsg = fullMsg.substring(0, 120) + (fullMsg.length > 120 ? '‚Ä¶' : '');
      return `<div class="${cls}" style="cursor:pointer;" onclick="alert('üìÖ ${(e.titre||'Analyse').replace(/'/g,"\\'")}\\n\\n' + '${fullMsg}')">
        <div class="je-title">${e.titre || 'ü¶ä Analyse'}<span class="je-date">${ts}</span></div>
        <div>${shortMsg}</div>
      </div>`;
    }).join('');
  } catch(e) {
    log.innerHTML = '<div style="color:#444;text-align:center;padding:8px;">Journal indisponible</div>';
  }
}
function clearKitsuneJournal() {
  localStorage.removeItem(_JOURNAL_KEY);
  renderKitsuneJournal();
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ D√âTECTION DE PATTERNS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Analyse M1+M2 sur les 8 derni√®res semaines et d√©tecte
// les tendances r√©currentes avant qu'elles deviennent violations
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const JOURS_FR = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];

function _loadAllDays(weeksBack) {
  // Charge les jours des N derni√®res semaines depuis M1+M2
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - weeksBack * 7);
  const years = [new Date().getFullYear()];
  if (cutoff.getFullYear() < years[0]) years.push(cutoff.getFullYear());

  const allDays = {}; // { 'YYYY-MM-DD': totalExtra }
  years.forEach(yr => {
    try {
      const rawM1 = JSON.parse(localStorage.getItem('DATA_REPORT_' + yr) || '{}');
      Object.entries(rawM1).forEach(([dk, v]) => {
        if (!/^\d{4}-\d{2}-\d{2}$/.test(dk)) return;
        if (new Date(dk) < cutoff) return;
        allDays[dk] = (allDays[dk] || 0) + (Number(v.extra) || 0);
      });
    } catch(e) {}
    try {
      const rawM2 = JSON.parse(localStorage.getItem('CA_HS_TRACKER_V1_DATA_' + yr) || '{}');
      Object.entries(rawM2).forEach(([mk, mv]) => {
        if (!/^\d{4}-\d{2}$/.test(mk) || !mv || !mv.days) return;
        Object.entries(mv.days).forEach(([ds, hrs]) => {
          const d = parseInt(ds); if (!d) return;
          const dk = mk + '-' + String(d).padStart(2,'0');
          if (new Date(dk) < cutoff) return;
          // M1 prioritaire
          if (!allDays[dk]) allDays[dk] = (Number(hrs) || 0);
        });
      });
    } catch(e) {}
  });
  return allDays;
}

function detectPatterns() {
  const WEEKS = 8;
  const BASE  = 7; // heures base journali√®re
  const allDays = _loadAllDays(WEEKS);
  if (!Object.keys(allDays).length) return [];

  const patterns = [];

  // ‚îÄ‚îÄ 1. Jour de la semaine syst√©matiquement charg√© ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Ex: "Tu travailles en dehors de tes heures tous les samedis"
  const byWeekday = {0:[],1:[],2:[],3:[],4:[],5:[],6:[]};
  Object.entries(allDays).forEach(([dk, extra]) => {
    const wd = new Date(dk + 'T12:00:00').getDay();
    byWeekday[wd].push({ dk, extra, total: BASE + extra });
  });
  [6, 0].forEach(wd => { // Samedi + Dimanche en premier
    const days = byWeekday[wd].filter(d => d.extra > 0);
    if (days.length >= 2) {
      patterns.push({
        id: 'weekend_' + wd,
        level: days.length >= 4 ? 'danger' : 'warning',
        emoji: wd === 6 ? 'üìÖ' : '‚òÄÔ∏è',
        titre: `${JOURS_FR[wd]}s travaill√©s ‚Äî ${days.length}√ó sur ${WEEKS} semaines`,
        message: `Kitsune a d√©tect√© que tu travailles le ${JOURS_FR[wd].toLowerCase()} r√©guli√®rement. `
          + (wd === 0 ? 'Le travail dominical est soumis √† des r√®gles strictes (majoration, accord collectif). ' : 'V√©rifie si ces heures sont bien compens√©es. ')
          + `Moyenne : ${(days.reduce((s,d) => s+d.extra, 0)/days.length).toFixed(1)}h sup ce jour-l√†.`,
        article: wd === 0 ? 'Art. L3132-3 √† L3132-31' : 'Convention collective applicable',
        actions: [
          wd === 0 ? 'V√©rifier l\'accord collectif autorisant le travail dominical' : 'V√©rifier la compensation des heures samedi',
          'Signaler √† ton repr√©sentant si non compens√©'
        ]
      });
    }
  });

  // ‚îÄ‚îÄ 2. Semaines en hausse continue (tendance ascendante) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const byWeek = {};
  Object.entries(allDays).forEach(([dk, extra]) => {
    if (extra <= 0) return;
    const d = new Date(dk + 'T12:00:00');
    const mon = new Date(d); mon.setDate(d.getDate() - ((d.getDay()||7) - 1));
    const wk = mon.toISOString().slice(0,10);
    byWeek[wk] = (byWeek[wk] || 0) + extra;
  });
  const weekSorted = Object.keys(byWeek).sort();
  if (weekSorted.length >= 4) {
    const last4 = weekSorted.slice(-4).map(w => byWeek[w]);
    const increasing = last4.every((v, i) => i === 0 || v >= last4[i-1]);
    const rising = last4[last4.length-1] - last4[0];
    if (increasing && rising >= 4) {
      patterns.push({
        id: 'trend_up',
        level: rising >= 10 ? 'danger' : 'warning',
        emoji: 'üìà',
        titre: `Charge en hausse : +${rising.toFixed(0)}h sup sur 4 semaines`,
        message: `Tes heures suppl√©mentaires augmentent chaque semaine depuis 1 mois. `
          + `Semaine 1 : ${last4[0].toFixed(0)}h ‚Üí Semaine 4 : ${last4[3].toFixed(0)}h. `
          + `Si cette tendance continue tu d√©passeras le seuil de 44h hebdo.`,
        article: 'Art. L3121-22 (44h sur 12 sem.)',
        actions: [
          'Signaler la surcharge √† ton manager',
          'V√©rifier si une r√©cup√©ration est pr√©vue'
        ]
      });
    }
  }

  // ‚îÄ‚îÄ 3. Jour syst√©matiquement >10h (m√™me jour chaque semaine) ‚îÄ‚îÄ
  [1,2,3,4,5].forEach(wd => {
    const days = byWeekday[wd].filter(d => d.total >= 10);
    if (days.length >= 3) {
      const avg = days.reduce((s,d) => s+d.total, 0) / days.length;
      patterns.push({
        id: 'long_day_' + wd,
        level: avg >= 12 ? 'danger' : 'warning',
        emoji: '‚è∞',
        titre: `${JOURS_FR[wd]}s > 10h ‚Äî ${days.length}√ó en ${WEEKS} semaines`,
        message: `Tes ${JOURS_FR[wd].toLowerCase()}s d√©passent r√©guli√®rement 10h de travail (moyenne : ${avg.toFixed(1)}h). `
          + `La dur√©e maximale l√©gale est de 10h/jour (12h avec d√©rogation).`,
        article: 'Art. L3121-18 (10h max journalier)',
        actions: [
          'Demander un am√©nagement des horaires du ' + JOURS_FR[wd].toLowerCase(),
          'V√©rifier si une d√©rogation collective est en place'
        ]
      });
    }
  });

  // ‚îÄ‚îÄ 4. Burn-out sur 3 semaines cons√©cutives ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const THRESHOLD_HIGH = 3; // > 3h sup par jour = journ√©e lourde
  const heavyDaysByWeek = {};
  Object.entries(allDays).forEach(([dk, extra]) => {
    if (extra < THRESHOLD_HIGH) return;
    const d = new Date(dk + 'T12:00:00');
    const mon = new Date(d); mon.setDate(d.getDate() - ((d.getDay()||7) - 1));
    const wk = mon.toISOString().slice(0,10);
    heavyDaysByWeek[wk] = (heavyDaysByWeek[wk] || 0) + 1;
  });
  const heavyWeeks = Object.keys(heavyDaysByWeek).sort().filter(w => heavyDaysByWeek[w] >= 3);
  if (heavyWeeks.length >= 3) {
    patterns.push({
      id: 'burnout_risk',
      level: 'danger',
      emoji: 'üî•',
      titre: `Risque burn-out d√©tect√© ‚Äî ${heavyWeeks.length} semaines charg√©es`,
      message: `Depuis ${WEEKS} semaines, tu as eu ${heavyWeeks.length} semaines avec au moins 3 journ√©es charg√©es (>+3h sup). `
        + `Ce rythme prolong√© est un signal fort de risque d'√©puisement professionnel.`,
      article: 'Art. L4121-1 (obligation s√©curit√© employeur)',
      actions: [
        'En parler √† ton m√©decin du travail',
        'Demander officiellement une r√©duction de charge √† ton manager',
        'Contacter ton repr√©sentant du personnel'
      ]
    });
  }

  // ‚îÄ‚îÄ 5. Aucun repos r√©cup√©rateur apr√®s semaines charg√©es ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (weekSorted.length >= 3) {
    const overweeks = weekSorted.filter(w => (byWeek[w]||0) > 8);
    const lightFollowing = overweeks.filter(w => {
      const nextIdx = weekSorted.indexOf(w) + 1;
      if (nextIdx >= weekSorted.length) return false;
      return (byWeek[weekSorted[nextIdx]] || 0) > 5; // pas de r√©pit
    });
    if (lightFollowing.length >= 2) {
      patterns.push({
        id: 'no_recovery',
        level: 'warning',
        emoji: 'üò¥',
        titre: `Pas de semaine de repos apr√®s surcharge`,
        message: `Apr√®s ${lightFollowing.length} semaines charg√©es, aucune semaine de r√©cup√©ration n'a suivi. `
          + `Le repos est essentiel pour √©viter la d√©gradation des performances et de la sant√©.`,
        article: 'Art. L3131-1 (11h repos quotidien)',
        actions: [
          'N√©gocier une semaine all√©g√©e apr√®s chaque p√©riode intense',
          'Poser des jours de r√©cup accumul√©s'
        ]
      });
    }
  }

  // Trier : danger en premier, puis warning
  return patterns.sort((a,b) => (a.level === 'danger' ? -1 : 1));
}

function showPatternAlert(pattern) {
  // Afficher dans popup-fox comme un conseil Kitsune enrichi
  const foxText = document.getElementById('fox-text');
  if (foxText) {
    const color = pattern.level === 'danger' ? '#E53935' : '#FF8C42';
    foxText.innerHTML = `
      <div style="color:${color};font-weight:900;font-size:0.95rem;margin-bottom:8px;">${pattern.emoji} ${pattern.titre}</div>
      <div style="color:#ccc;line-height:1.7;font-size:0.88rem;margin-bottom:10px;">${pattern.message}</div>
      <div style="font-size:0.7rem;color:#FF8C42;margin-bottom:8px;cursor:pointer;" onclick="openGlossaireOn('' + pattern.article + '')">üìú ${pattern.article} <span style=\"opacity:0.5\">‚Äî Tap pour d√©finition</span></div>
      <div style="color:#888;font-size:0.7rem;letter-spacing:1px;margin-bottom:5px;">√Ä FAIRE</div>
      <ul style="margin:0;padding-left:18px;color:#aaa;font-size:0.82rem;line-height:1.8;">
        ${pattern.actions.map(a => '<li>'+a+'</li>').join('')}
      </ul>`;
  }
  // Ajouter au journal
  addJournalEntry({
    titre: pattern.emoji + ' ' + pattern.titre,
    message: pattern.message,
    niveau: pattern.level
  });
}

function refreshPatternsSection() {
  const container = document.getElementById('kitsune-patterns-list');
  if (!container) return;
  const patterns = detectPatterns();
  if (!patterns.length) {
    container.innerHTML = '<div style="color:#444;font-size:0.78rem;text-align:center;padding:10px;">Aucun pattern d√©tect√© ‚Äî continue √† saisir tes heures r√©guli√®rement.</div>';
    return;
  }
  container.innerHTML = patterns.map((p, i) => {
    const col = p.level === 'danger' ? '#E53935' : '#FF8C42';
    const bg  = p.level === 'danger' ? 'rgba(229,57,53,0.08)' : 'rgba(255,140,66,0.08)';
    return `<div onclick="showPatternAlert(window._patterns[${i}]);openPopup('popup-fox')"
      style="background:${bg};border:1px solid ${col}33;border-left:3px solid ${col};border-radius:0 10px 10px 0;padding:10px 12px;cursor:pointer;transition:background 0.15s;"
      onmouseover="this.style.background='${bg.replace('0.08','0.15')}'" onmouseout="this.style.background='${bg}'">
      <div style="color:${col};font-weight:900;font-size:0.82rem;margin-bottom:4px;">${p.emoji} ${p.titre}</div>
      <div style="color:#888;font-size:0.75rem;line-height:1.5;">${p.message.substring(0,90)}‚Ä¶</div>
      <div style="color:#444;font-size:0.65rem;margin-top:4px;">üìú ${p.article} ¬∑ Cliquer pour d√©tails</div>
    </div>`;
  }).join('');
  window._patterns = patterns;
}

function checkAndNotifyPatterns() {
  if (!localStorage.getItem('FOX_ONBOARDING_DONE')) return;
  const key = 'FOX_PATTERNS_NOTIF_' + new Date().toISOString().slice(0,7); // 1x/mois
  if (localStorage.getItem(key)) return;
  const patterns = detectPatterns();
  const danger = patterns.filter(p => p.level === 'danger');
  if (!danger.length) return;
  localStorage.setItem(key, '1');
  // Mettre √† jour la bulle Kitsune
  const bbl = document.getElementById('kitsune-bubble-text');
  if (bbl) bbl.textContent = '‚ö†Ô∏è ' + danger[0].emoji + ' ' + danger[0].titre;
  // Stocker pour popup-fox
  localStorage.setItem('FOX_LAST_NARRATION', JSON.stringify({
    titre: danger[0].emoji + ' ' + danger[0].titre,
    message: danger[0].message,
    actions: danger[0].actions,
    alerte: { niveau: 'danger', texte: 'üö® Pattern r√©current d√©tect√© ‚Äî action recommand√©e' }
  }));
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ GRAPHIQUE √âVOLUTION (SVG natif, pas de lib) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _chartMode = 'month';

function renderEvolutionChart(mode) {
  _chartMode = mode || _chartMode;
  // Toggle boutons
  const bm = document.getElementById('chart-btn-month');
  const bw = document.getElementById('chart-btn-week');
  if (bm) { bm.style.background = mode === 'month' ? 'rgba(255,140,66,0.15)' : 'rgba(255,255,255,0.04)'; bm.style.borderColor = mode === 'month' ? 'rgba(255,140,66,0.4)' : 'rgba(255,255,255,0.1)'; bm.style.color = mode === 'month' ? '#FF8C42' : '#666'; }
  if (bw) { bw.style.background = mode === 'week'  ? 'rgba(255,140,66,0.15)' : 'rgba(255,255,255,0.04)'; bw.style.borderColor = mode === 'week'  ? 'rgba(255,140,66,0.4)' : 'rgba(255,255,255,0.1)'; bw.style.color = mode === 'week'  ? '#FF8C42' : '#666'; }

  const container = document.getElementById('kitsune-chart-container');
  const legend    = document.getElementById('kitsune-chart-legend');
  if (!container) return;

  const data = mode === 'month' ? _buildMonthData() : _buildWeekData();
  if (!data.points.length) {
    container.innerHTML = '<div style="color:#444;font-size:0.75rem;text-align:center;padding:20px;">Pas encore assez de donn√©es ‚Äî continue √† saisir tes heures !</div>';
    return;
  }

  const W = Math.max(280, data.points.length * (mode === 'month' ? 28 : 18));
  const H = 110;
  const PAD = { top:12, right:12, bottom:28, left:32 };
  const cW = W - PAD.left - PAD.right;
  const cH = H - PAD.top - PAD.bottom;

  const maxVal = Math.max(...data.points.map(p => p.val), 10);
  const yMax   = Math.ceil(maxVal / 10) * 10 + 5;
  const xStep  = cW / Math.max(data.points.length - 1, 1);

  const toX = i => PAD.left + i * xStep;
  const toY = v => PAD.top + cH - (v / yMax * cH);

  // Seuils de r√©f√©rence
  const y35  = toY(0);   // base 0 extra = ligne 0
  const y8   = toY(8);   // seuil signal√©tique +8h/sem
  const y13  = toY(13);  // seuil 48h hebdo = +13h base 35

  // Construire le path
  const pts = data.points.map((p, i) => ({ x: toX(i), y: toY(p.val), ...p }));
  const linePath = pts.map((p, i) => (i === 0 ? 'M' : 'L') + p.x.toFixed(1) + ',' + p.y.toFixed(1)).join(' ');
  const areaPath = linePath + ' L' + pts[pts.length-1].x.toFixed(1) + ',' + (PAD.top+cH).toFixed(1) + ' L' + PAD.left.toFixed(1) + ',' + (PAD.top+cH).toFixed(1) + ' Z';

  // Couleur selon d√©passement
  const lineColor  = '#FF8C42';
  const dangerPts  = pts.filter(p => p.val >= 13);
  const warningPts = pts.filter(p => p.val >= 8 && p.val < 13);

  // Labels Y
  const yLabels = [0, Math.round(yMax/2), yMax].map(v => ({
    y: toY(v).toFixed(1), label: v + 'h'
  }));

  // Labels X ‚Äî seulement quelques-uns pour lisibilit√©
  const step = Math.ceil(data.points.length / 6);
  const xLabels = pts.filter((_, i) => i % step === 0 || i === pts.length - 1).map(p => ({
    x: p.x.toFixed(1), label: p.label
  }));

  const svg = `<svg width="${W}" height="${H}" xmlns="http://www.w3.org/2000/svg" style="display:block;overflow:visible;">
  <defs>
    <linearGradient id="chartGrad" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#FF8C42" stop-opacity="0.25"/>
      <stop offset="100%" stop-color="#FF8C42" stop-opacity="0.02"/>
    </linearGradient>
  </defs>

  <!-- Grille horizontale -->
  ${yLabels.map(yl => `
  <line x1="${PAD.left}" y1="${yl.y}" x2="${W - PAD.right}" y2="${yl.y}" stroke="rgba(255,255,255,0.06)" stroke-width="1"/>
  <text x="${PAD.left - 4}" y="${parseFloat(yl.y)+3}" fill="#444" font-size="8" text-anchor="end">${yl.label}</text>`).join('')}

  <!-- Seuils l√©gaux (seulement en mode semaine) -->
  ${mode === 'week' ? `
  <line x1="${PAD.left}" y1="${toY(13).toFixed(1)}" x2="${W - PAD.right}" y2="${toY(13).toFixed(1)}" stroke="rgba(229,57,53,0.35)" stroke-width="1" stroke-dasharray="3,3"/>
  <text x="${W - PAD.right + 2}" y="${toY(13)+4}" fill="rgba(229,57,53,0.6)" font-size="7">48h</text>
  <line x1="${PAD.left}" y1="${toY(8).toFixed(1)}" x2="${W - PAD.right}" y2="${toY(8).toFixed(1)}" stroke="rgba(255,140,66,0.3)" stroke-width="1" stroke-dasharray="3,3"/>
  <text x="${W - PAD.right + 2}" y="${toY(8)+4}" fill="rgba(255,140,66,0.5)" font-size="7">43h</text>
  ` : ''}

  <!-- Zone aire -->
  <path d="${areaPath}" fill="url(#chartGrad)"/>

  <!-- Ligne principale -->
  <path d="${linePath}" fill="none" stroke="${lineColor}" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>

  <!-- Points -->
  ${pts.map(p => {
    const col = p.val >= 13 ? '#E53935' : p.val >= 8 ? '#FF8C42' : '#4CAF50';
    return `<circle cx="${p.x.toFixed(1)}" cy="${p.y.toFixed(1)}" r="${p.val > 0 ? 3 : 2}" fill="${col}" stroke="#0d0d1a" stroke-width="1.5">
      <title>${p.fullLabel} : ${p.val.toFixed(1)}h sup</title>
    </circle>`;
  }).join('')}

  <!-- Labels X -->
  ${xLabels.map(xl => `<text x="${xl.x}" y="${H - 4}" fill="#555" font-size="7.5" text-anchor="middle">${xl.label}</text>`).join('')}
</svg>`;

  container.innerHTML = '<div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">' + svg + '</div>';

  // L√©gende
  if (legend) {
    legend.innerHTML = [
      { col:'#4CAF50', label:'Normal (<8h sup)' },
      { col:'#FF8C42', label:'Vigilance (8-13h sup)' },
      { col:'#E53935', label:'Alerte (>13h sup)' },
    ].map(l => `<span style="display:flex;align-items:center;gap:4px;font-size:0.65rem;color:#666;">
      <span style="width:8px;height:8px;border-radius:50%;background:${l.col};flex-shrink:0;"></span>${l.label}
    </span>`).join('');
  }
}

function _buildMonthData() {
  const points = [];
  const now = new Date();
  for (let i = 11; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const y = d.getFullYear().toString();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const mk = y + '-' + m;
    let total = 0;
    try {
      const m1 = JSON.parse(localStorage.getItem('DATA_REPORT_' + y) || '{}');
      Object.entries(m1).forEach(([dk, v]) => {
        if (dk.startsWith(mk)) total += (Number(v.extra) || 0);
      });
      const m2 = JSON.parse(localStorage.getItem('CA_HS_TRACKER_V1_DATA_' + y) || '{}');
      if (m2[mk] && m2[mk].days) {
        const m1Keys = Object.keys(m1).filter(k => k.startsWith(mk));
        Object.entries(m2[mk].days).forEach(([ds, hrs]) => {
          const dk = mk + '-' + String(parseInt(ds)).padStart(2,'0');
          if (!m1Keys.includes(dk)) total += (Number(hrs) || 0);
        });
      }
    } catch(e) {}
    points.push({
      val: Math.round(total * 10) / 10,
      label: d.toLocaleDateString('fr-FR', {month:'short'}),
      fullLabel: d.toLocaleDateString('fr-FR', {month:'long', year:'numeric'})
    });
  }
  return { points };
}

function _buildWeekData() {
  const points = [];
  const now = new Date();
  const allDays = _loadAllDays(12);
  // Grouper par semaine ISO
  const byWeek = {};
  Object.entries(allDays).forEach(([dk, extra]) => {
    if (extra <= 0) return;
    const d = new Date(dk + 'T12:00:00');
    const mon = new Date(d); mon.setDate(d.getDate() - ((d.getDay()||7) - 1));
    const wk = mon.toISOString().slice(0,10);
    byWeek[wk] = (byWeek[wk] || 0) + extra;
  });
  const weeks = Object.keys(byWeek).sort().slice(-12);
  weeks.forEach(wk => {
    const d = new Date(wk + 'T12:00:00');
    const weekNum = Math.ceil((((d - new Date(d.getFullYear(),0,1))/86400000)+1)/7);
    points.push({
      val: Math.round((byWeek[wk]||0) * 10) / 10,
      label: 'S' + weekNum,
      fullLabel: 'Sem. ' + weekNum + ' ' + d.getFullYear()
    });
  });
  return { points };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ GLOSSAIRE JURIDIQUE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const GLOSSAIRE = [
  // ‚îÄ‚îÄ DUR√âES DE TRAVAIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {
    art: 'Art. L3121-1',
    titre: 'Temps de travail effectif',
    def: 'Temps pendant lequel le salari√© est √† la disposition de l\'employeur, se conformant √† ses directives, sans pouvoir vaquer librement √† des occupations personnelles.',
    ex: 'Le temps de trajet domicile-travail n\'est g√©n√©ralement pas du temps de travail effectif.',
    mots: ['travail effectif', 'disposition', 'directives'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  {
    art: 'Art. L3121-10',
    titre: 'Dur√©e l√©gale hebdomadaire ‚Äî 35h',
    def: 'La dur√©e l√©gale du travail est fix√©e √† 35 heures par semaine civile. Toute heure travaill√©e au-del√† est une heure suppl√©mentaire.',
    ex: 'Si tu travailles 38h dans la semaine, tu as 3h suppl√©mentaires.',
    mots: ['35h', 'dur√©e l√©gale', 'semaine', 'temps plein'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  {
    art: 'Art. L3121-18',
    titre: 'Dur√©e maximale journali√®re ‚Äî 10h',
    def: 'La dur√©e quotidienne ne peut exc√©der 10 heures de travail effectif. Des d√©rogations peuvent porter ce maximum √† 12h (accord collectif ou autorisation inspection du travail).',
    ex: 'Travailler 13h dans une journ√©e est ill√©gal sauf d√©rogation sp√©cifique.',
    mots: ['10h', '12h', 'journ√©e', 'amplitude', 'dur√©e max'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  {
    art: 'Art. L3121-20',
    titre: 'Dur√©e maximale hebdomadaire absolue ‚Äî 48h',
    def: 'La dur√©e hebdomadaire ne peut d√©passer 48 heures sur une m√™me semaine. C\'est le plafond absolu, m√™me avec accord collectif.',
    ex: 'M√™me si ton employeur te le demande, d√©passer 48h dans une semaine est interdit.',
    mots: ['48h', 'plafond', 'maximum hebdo', 'semaine'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  {
    art: 'Art. L3121-22',
    titre: 'Moyenne hebdomadaire sur 12 semaines ‚Äî 44h',
    def: 'La dur√©e hebdomadaire calcul√©e sur une p√©riode quelconque de 12 semaines cons√©cutives ne peut d√©passer 44 heures.',
    ex: 'Tu peux faire 50h une semaine, mais la moyenne sur 12 semaines ne doit pas d√©passer 44h.',
    mots: ['44h', 'moyenne', '12 semaines', 'roulement'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  // ‚îÄ‚îÄ HEURES SUPPL√âMENTAIRES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {
    art: 'Art. L3121-30',
    titre: 'Heures suppl√©mentaires ‚Äî d√©finition et majorations',
    def: 'Heures accomplies au-del√† de la dur√©e l√©gale de 35h. Elles ouvrent droit √† une majoration de salaire (25% pour les 8 premi√®res, 50% au-del√†) ou √† un repos compensateur.',
    ex: 'De la 36e √† la 43e heure : +25%. De la 44e heure et au-del√† : +50%.',
    mots: ['heures sup', 'majoration', '25%', '50%', 'compensation', 'HS'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  {
    art: 'Art. L3121-33',
    titre: 'Contingent annuel d\'heures suppl√©mentaires ‚Äî 220h',
    def: 'Volume annuel d\'heures suppl√©mentaires qu\'un salari√© peut effectuer sans autorisation de l\'inspecteur du travail. Fix√© par accord collectif ou √† d√©faut √† 220h par an.',
    ex: 'Si tu d√©passes 220h sup dans l\'ann√©e, l\'employeur doit obtenir une autorisation sp√©ciale.',
    mots: ['contingent', '220h', 'annuel', 'autorisation'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  {
    art: 'Art. L3121-38',
    titre: 'Repos compensateur de remplacement (RCR)',
    def: 'Alternative √† la majoration financi√®re des heures suppl√©mentaires. L\'employeur peut, avec accord collectif, remplacer le paiement major√© par un repos de dur√©e √©quivalente.',
    ex: '1h sup √† 25% = 1h15 de repos compensateur.',
    mots: ['RCR', 'r√©cup', 'repos compensateur', 'remplacement', 'r√©cup√©ration'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  // ‚îÄ‚îÄ REPOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {
    art: 'Art. L3131-1',
    titre: 'Repos quotidien ‚Äî 11h minimum',
    def: 'Tout salari√© b√©n√©ficie d\'un repos quotidien d\'une dur√©e minimale de 11 heures cons√©cutives.',
    ex: 'Si tu finis √† 23h, tu ne peux pas reprendre avant 10h le lendemain.',
    mots: ['repos quotidien', '11h', 'cons√©cutif', 'nuit'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  {
    art: 'Art. L3132-1',
    titre: 'Repos hebdomadaire ‚Äî 24h + 11h = 35h',
    def: 'Tout salari√© a droit √† un repos hebdomadaire d\'une dur√©e minimale de 24h cons√©cutives, auxquelles s\'ajoutent les 11h de repos quotidien, soit 35h au total.',
    ex: 'En pratique : pas de travail le dimanche + au moins 11h de repos apr√®s le samedi.',
    mots: ['repos hebdomadaire', '24h', '35h', 'dimanche', 'week-end'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  {
    art: 'Art. L3132-3',
    titre: 'Repos dominical',
    def: 'Le repos hebdomadaire est donn√© le dimanche. Des d√©rogations existent pour certaines activit√©s (commerces, h√¥tellerie, etc.) mais n√©cessitent un cadre l√©gal pr√©cis.',
    ex: 'Travailler le dimanche sans accord collectif ou autorisation pr√©fectorale est ill√©gal.',
    mots: ['dimanche', 'repos dominical', 'd√©rogation', 'week-end'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  // ‚îÄ‚îÄ SANT√â & S√âCURIT√â ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  {
    art: 'Art. L4121-1',
    titre: 'Obligation de s√©curit√© de l\'employeur',
    def: 'L\'employeur est tenu de prendre les mesures n√©cessaires pour assurer la s√©curit√© et prot√©ger la sant√© physique et mentale des travailleurs.',
    ex: 'Un employeur qui laisse un salari√© s\'√©puiser sans agir peut √™tre tenu responsable.',
    mots: ['s√©curit√©', 'sant√©', 'burn-out', 'risque psychosocial', 'obligation employeur'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  {
    art: 'DUERP ‚Äî Art. R4121-1',
    titre: 'Document Unique d\'√âvaluation des Risques Professionnels',
    def: 'Document obligatoire dans toute entreprise, listant les risques professionnels identifi√©s et les mesures de pr√©vention pr√©vues. Il doit mentionner les risques psychosociaux.',
    ex: 'Le burn-out doit √™tre √©valu√© dans le DUERP. Tu peux le demander √† ton employeur.',
    mots: ['DUERP', 'risque', 'pr√©vention', 'document unique', 'psychosocial'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  // ‚îÄ‚îÄ ACCORDS & CONVENTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  {
    art: 'Code du travail ‚Äî global',
    titre: 'Code du travail complet',
    def: 'L\'ensemble des r√®gles r√©gissant les relations de travail en France. Consultable int√©gralement et gratuitement sur L√©gifrance.',
    ex: 'Livre III, Titre II = Dur√©e du travail. Livre IV, Titre II = Sant√© au travail.',
    mots: ['code du travail', 'loi', 'droit', 'l√©gifrance'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  // ‚îÄ‚îÄ RECOURS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  {
    art: 'Recours & contacts',
    titre: 'Signaler une violation ‚Äî o√π s\'adresser ?',
    def: 'En cas de violation suspect√©e du droit du travail, plusieurs interlocuteurs sont disponibles : l\'inspection du travail, le D√©fenseur des droits, les repr√©sentants du personnel.',
    ex: 'L\'inspection du travail peut intervenir gratuitement et confidentiellement sur signalement.',
    mots: ['inspection du travail', 'signalement', 'recours', 'DREETS', 'd√©fenseur des droits', 'CSE'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
,
  {
    art: 'Art. L3121-27',
    titre: 'Heures suppl√©mentaires ‚Äî Paiement ou repos compensateur',
    def: 'Les heures suppl√©mentaires donnent lieu soit √† un paiement major√©, soit √† un repos compensateur √©quivalent major√©. Le choix appartient √† l\'employeur, sauf disposition conventionnelle contraire.',
    ex: '10h suppl√©mentaires ‚Üí soit 12.5h en paiement (majoration 25%), soit 12.5h de repos compensateur.',
    mots: ['paiement', 'repos compensateur', '√©quivalent', 'choix employeur'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  {
    art: 'Art. L3121-34',
    titre: 'Contingent annuel d\'heures suppl√©mentaires',
    def: 'Volume d\'heures suppl√©mentaires qu\'un salari√© peut effectuer au-del√† de la dur√©e l√©gale sans autorisation de l\'inspecteur du travail. Au-del√† du contingent, une contrepartie obligatoire en repos (COR) est due.',
    ex: 'Contingent 220h : au-del√†, chaque heure donne droit √† 50% de repos (1h travaill√©e = 0.5h repos).',
    mots: ['contingent', 'autorisation', 'COR', 'contrepartie obligatoire'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  {
    art: 'Art. L3121-41',
    titre: 'Astreinte',
    def: 'P√©riode pendant laquelle le salari√©, sans √™tre sur son lieu de travail et sans √™tre √† la disposition permanente de l\'employeur, doit √™tre en mesure d\'intervenir pour accomplir un travail. Seul le temps d\'intervention est du temps de travail effectif.',
    ex: 'Astreinte le week-end : si intervention de 2h, seules ces 2h comptent comme temps de travail.',
    mots: ['astreinte', 'disponibilit√©', 'intervention', 'temps effectif'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  {
    art: 'Inspection du travail',
    titre: 'DREETS ‚Äî Direccte r√©gionale',
    def: 'Service de l\'√âtat charg√© de contr√¥ler l\'application du droit du travail en entreprise et d\'accompagner les salari√©s et employeurs. Comp√©tent pour constater les infractions, notamment sur les dur√©es du travail.',
    ex: 'En cas de d√©passement r√©p√©t√© du contingent sans autorisation, la DREETS peut intervenir.',
    mots: ['inspection', 'DREETS', 'contr√¥le', 'infraction'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  },
  {
    art: 'Forfait jour',
    titre: 'Convention de forfait en jours',
    def: 'Dispositif permettant de d√©compter le temps de travail en jours ou demi-journ√©es sur l\'ann√©e, et non en heures. R√©serv√© aux cadres et salari√©s autonomes. Maximum 218 jours/an.',
    ex: 'Cadre en forfait 218 jours : pas d\'heures suppl√©mentaires, mais droit √† la d√©connexion et entretiens annuels.',
    mots: ['forfait jour', 'cadre', 'autonomie', '218 jours'],
    liens: [
      { label: 'Code du travail - L√©gifrance', url: 'https://www.legifrance.gouv.fr/codes/section_lc/LEGITEXT000006072050/LEGISCTA000006178009' },
      { label: 'Minist√®re du Travail', url: 'https://travail-emploi.gouv.fr/droit-du-travail/temps-de-travail/' }
    ]
  }];

let _glossaireData = GLOSSAIRE;

function initGlossaire() {
  renderGlossaire(GLOSSAIRE);
}

function filterGlossaire(query) {
  if (!query.trim()) { renderGlossaire(GLOSSAIRE); return; }
  const q = query.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  const filtered = GLOSSAIRE.filter(g => {
    const txt = (g.art + ' ' + g.titre + ' ' + g.def + ' ' + g.mots.join(' ')).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    return txt.includes(q);
  });
  renderGlossaire(filtered, query);
}

function _highlight(text, query) {
  if (!query) return text;
  const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  return text.replace(new RegExp('(' + escaped + ')', 'gi'), '<mark style="background:rgba(255,140,66,0.3);color:#FF8C42;border-radius:2px;">$1</mark>');
}

function renderGlossaire(list, query) {
  const el = document.getElementById('glossaire-list');
  if (!el) return;
  if (!list.length) {
    el.innerHTML = '<div style="color:#444;text-align:center;padding:20px;font-size:0.82rem;">Aucun terme trouv√©</div>';
    return;
  }
  el.innerHTML = list.map(g => {
    const liensHtml = (g.liens && g.liens.length)
      ? '<div style="margin-top:8px;display:flex;flex-direction:column;gap:4px;">'
        + g.liens.map(l => `<a href="${l.url}" target="_blank" rel="noopener noreferrer"
            style="display:flex;align-items:center;gap:6px;color:#FF8C42;font-size:0.72rem;text-decoration:none;padding:4px 8px;background:rgba(255,140,66,0.06);border:1px solid rgba(255,140,66,0.15);border-radius:6px;"
            onmouseover="this.style.background='rgba(255,140,66,0.14)'" onmouseout="this.style.background='rgba(255,140,66,0.06)'">
            <span style="flex-shrink:0;">üîó</span><span>${l.label}</span><span style="margin-left:auto;opacity:0.4;font-size:0.65rem;">‚Üó</span>
          </a>`).join('')
        + '</div>'
      : '';
    return `<div class="glossaire-card">
      <div class="gc-art">${_highlight(g.art, query)}</div>
      <div class="gc-titre">${_highlight(g.titre, query)}</div>
      <div class="gc-def">${_highlight(g.def, query)}</div>
      <div class="gc-ex">${_highlight(g.ex, query)}</div>
      <div style="margin-top:6px;">${(g.mots||[]).map(m => '<span class="gc-kw">' + _highlight(m, query) + '</span>').join('')}</div>
      ${liensHtml}
    </div>`;
  }).join('');
}

// Lien depuis les alertes Kitsune ‚Äî ouvre le glossaire sur un terme
function openGlossaireOn(query) {
  openPopup('popup-glossaire');
  const input = document.getElementById('glossaire-search');
  if (input) { input.value = query; filterGlossaire(query); }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ COMPARAISON ANNUELLE N vs N-1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function _getYearData(year) {
  const y = String(year);
  let totalHS = 0, violations48 = 0, violationsDay = 0, months = {};

  // M1
  try {
    const m1 = JSON.parse(localStorage.getItem('DATA_REPORT_' + y) || '{}');
    Object.entries(m1).forEach(([dk, v]) => {
      if (!/^\d{4}-\d{2}-\d{2}$/.test(dk)) return;
      const extra = Number(v.extra) || 0;
      if (extra <= 0) return;
      totalHS += extra;
      if (7 + extra >= 12) violationsDay++;
      const mk = dk.slice(0, 7);
      months[mk] = (months[mk] || 0) + extra;
    });
  } catch(e) {}

  // M2 (sans doublon M1)
  try {
    const m1raw = JSON.parse(localStorage.getItem('DATA_REPORT_' + y) || '{}');
    const m2 = JSON.parse(localStorage.getItem('CA_HS_TRACKER_V1_DATA_' + y) || '{}');
    Object.entries(m2).forEach(([mk, mv]) => {
      if (!mv || !mv.days) return;
      Object.entries(mv.days).forEach(([ds, hrs]) => {
        const dk = mk + '-' + String(parseInt(ds)).padStart(2,'0');
        if (m1raw[dk]) return; // M1 prioritaire
        const extra = Number(hrs) || 0;
        if (extra <= 0) return;
        totalHS += extra;
        months[mk] = (months[mk] || 0) + extra;
      });
    });
  } catch(e) {}

  // Pic mensuel
  const monthVals = Object.values(months);
  const peakMonth = monthVals.length ? Math.max(...monthVals) : 0;
  const peakMonthKey = Object.keys(months).find(k => months[k] === peakMonth) || null;
  const avgPerMonth  = monthVals.length ? totalHS / monthVals.length : 0;
  const pctContingent = Math.round(totalHS / 220 * 100);

  return { year, totalHS: Math.round(totalHS * 10) / 10, pctContingent, peakMonth, peakMonthKey, avgPerMonth: Math.round(avgPerMonth * 10) / 10, violationsDay, hasData: totalHS > 0 };
}

function renderAnnualComparison() {
  const el = document.getElementById('kitsune-annual-content');
  if (!el) return;

  const now  = new Date().getFullYear();
  const datN = _getYearData(now);
  const datP = _getYearData(now - 1);

  if (!datN.hasData && !datP.hasData) {
    el.innerHTML = '<div style="color:#444;font-size:0.75rem;text-align:center;padding:10px;">Pas encore de donn√©es sur deux ann√©es pour comparer.</div>';
    return;
  }

  // Calcul de la tendance
  const diff      = datN.totalHS - datP.totalHS;
  const diffPct   = datP.totalHS > 0 ? Math.round(diff / datP.totalHS * 100) : null;
  const trend     = !datP.hasData ? 'new' : diff > 5 ? 'up' : diff < -5 ? 'down' : 'stable';
  const trendIcon = { up:'üìà', down:'üìâ', stable:'‚û°Ô∏è', new:'üÜï' }[trend];
  const trendCol  = { up:'#E53935', down:'#4CAF50', stable:'#888', new:'#FF8C42' }[trend];
  const trendLbl  = { up:'En hausse', down:'En baisse', stable:'Stable', new:'Premi√®re ann√©e' }[trend];

  // Message Kitsune selon tendance
  const msgs = {
    up: `Ta charge de travail a augment√© de ${Math.abs(diff).toFixed(0)}h par rapport √† ${now-1}${diffPct ? ' (+' + diffPct + '%)' : ''}. Reste vigilant sur ton contingent annuel.`,
    down: `Bonne nouvelle : tu as ${Math.abs(diff).toFixed(0)}h de moins qu'en ${now-1}${diffPct ? ' (-' + Math.abs(diffPct) + '%)' : ''}. Tendance positive !`,
    stable: `Ta charge est stable par rapport √† ${now-1}. Continue √† surveiller r√©guli√®rement.`,
    new: `Premi√®re ann√©e compl√®te de suivi ! Tu pourras comparer avec ${now+1}.`
  };

  // Mois de pic format√©
  function fmtMonth(mk) {
    if (!mk) return '‚Äî';
    const d = new Date(mk + '-15');
    return d.toLocaleDateString('fr-FR', { month: 'long' });
  }

  // Barre de comparaison visuelle
  const maxHS = Math.max(datN.totalHS, datP.totalHS, 1);
  const barN  = Math.round(datN.totalHS / maxHS * 100);
  const barP  = Math.round(datP.totalHS / maxHS * 100);
  const colN  = datN.pctContingent >= 100 ? '#E53935' : datN.pctContingent >= 75 ? '#FF8C42' : '#4CAF50';
  const colP  = datP.pctContingent >= 100 ? '#E53935' : datP.pctContingent >= 75 ? '#FF8C42' : '#4CAF50';

  el.innerHTML = `
    <!-- Tendance globale -->
    <div style="background:rgba(${trend==='up'?'229,57,53':trend==='down'?'76,175,80':'255,140,66'},0.07);border:1px solid rgba(${trend==='up'?'229,57,53':trend==='down'?'76,175,80':'255,140,66'},0.2);border-radius:10px;padding:10px 13px;margin-bottom:10px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;">
        <span style="font-size:1.2rem;">${trendIcon}</span>
        <span style="color:${trendCol};font-weight:900;font-size:0.88rem;">${trendLbl}</span>
        ${diffPct !== null ? `<span style="margin-left:auto;color:${trendCol};font-size:0.8rem;font-weight:700;">${diff > 0 ? '+' : ''}${diff.toFixed(0)}h</span>` : ''}
      </div>
      <div style="color:#888;font-size:0.78rem;line-height:1.5;">${msgs[trend]}</div>
    </div>

    <!-- Barres comparatives -->
    <div style="display:flex;flex-direction:column;gap:7px;margin-bottom:10px;">
      ${datN.hasData ? `<div>
        <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
          <span style="color:#ccc;font-size:0.75rem;font-weight:700;">${now}</span>
          <span style="color:${colN};font-size:0.75rem;font-weight:900;">${datN.totalHS}h <span style="color:#555;font-weight:400;">(${datN.pctContingent}%)</span></span>
        </div>
        <div style="height:7px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;">
          <div style="height:100%;width:${barN}%;background:${colN};border-radius:4px;transition:width 0.5s ease;"></div>
        </div>
      </div>` : ''}
      ${datP.hasData ? `<div>
        <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
          <span style="color:#777;font-size:0.75rem;">${now-1}</span>
          <span style="color:${colP};font-size:0.75rem;">${datP.totalHS}h <span style="color:#444;font-weight:400;">(${datP.pctContingent}%)</span></span>
        </div>
        <div style="height:5px;background:rgba(255,255,255,0.04);border-radius:4px;overflow:hidden;">
          <div style="height:100%;width:${barP}%;background:${colP};opacity:0.6;border-radius:4px;"></div>
        </div>
      </div>` : ''}
    </div>

    <!-- Stats cl√©s -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
      ${datN.hasData ? `
      <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:8px 10px;">
        <div style="color:#555;font-size:0.65rem;margin-bottom:3px;">${now} ‚Äî PIC MENSUEL</div>
        <div style="color:#FF8C42;font-weight:900;font-size:0.88rem;">${datN.peakMonth.toFixed(0)}h</div>
        <div style="color:#555;font-size:0.65rem;">${fmtMonth(datN.peakMonthKey)}</div>
      </div>
      <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:8px 10px;">
        <div style="color:#555;font-size:0.65rem;margin-bottom:3px;">${now} ‚Äî MOY. MENSUELLE</div>
        <div style="color:#FF8C42;font-weight:900;font-size:0.88rem;">${datN.avgPerMonth.toFixed(1)}h</div>
        <div style="color:#555;font-size:0.65rem;">par mois</div>
      </div>` : ''}
      ${datP.hasData ? `
      <div style="background:rgba(255,255,255,0.02);border-radius:8px;padding:8px 10px;opacity:0.7;">
        <div style="color:#444;font-size:0.65rem;margin-bottom:3px;">${now-1} ‚Äî PIC MENSUEL</div>
        <div style="color:#888;font-weight:700;font-size:0.82rem;">${datP.peakMonth.toFixed(0)}h</div>
        <div style="color:#444;font-size:0.65rem;">${fmtMonth(datP.peakMonthKey)}</div>
      </div>
      <div style="background:rgba(255,255,255,0.02);border-radius:8px;padding:8px 10px;opacity:0.7;">
        <div style="color:#444;font-size:0.65rem;margin-bottom:3px;">${now-1} ‚Äî MOY. MENSUELLE</div>
        <div style="color:#888;font-weight:700;font-size:0.82rem;">${datP.avgPerMonth.toFixed(1)}h</div>
        <div style="color:#444;font-size:0.65rem;">par mois</div>
      </div>` : ''}
    </div>`;
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ PROFIL KITSUNE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _PROFILE_KEY = 'FOX_KITSUNE_PROFILE';

function loadKitsuneProfile() {
  try { return JSON.parse(localStorage.getItem(_PROFILE_KEY) || '{}'); }
  catch(e) { return {}; }
}

function saveKitsuneProfile() {
  const p = {
    prenom:  (document.getElementById('setting-prenom')?.value  || '').trim(),
    secteur: document.getElementById('setting-secteur')?.value  || '',

  };
  console.log('ü¶ä saveKitsuneProfile :', p);
  localStorage.setItem(_PROFILE_KEY, JSON.stringify(p));
  const st = document.getElementById('setting-save-status');
  if (st) { st.textContent = '‚úì Sauvegard√©'; setTimeout(() => { st.textContent = ''; }, 1500); }
  _applyProfileToHUD(p);
}

function _applyProfileToHUD(p) {
  // Bulle de bienvenue personnalis√©e
  const bbl = document.getElementById('kitsune-bubble-text');
  console.log('ü¶ä _applyProfileToHUD :', p, 'bulle:', bbl?.textContent.substring(0, 30));
  if (bbl && p.prenom && bbl.textContent.includes('surveille')) {
    bbl.textContent = 'ü¶ä Bonjour ' + p.prenom + ' ! Je surveille tes heures et tes droits.';
    console.log('ü¶ä Nom appliqu√© √† la bulle :', p.prenom);
  }
}

function _getSecteurContext(secteur) {
  const ctx = {
    commerce:      'En commerce de d√©tail, le travail du dimanche est souvent d√©rogatoire ‚Äî v√©rifie les compensations pr√©vues (CCN Commerce d√©tail et gros alimentaire).',
    commerce_gros: 'La CCN du Commerce de gros (IDCC 573) fixe un contingent d\'heures sup √† 130h/an, inf√©rieur au plafond l√©gal de 220h. Tes droits sont donc plus protecteurs que le Code du travail seul. V√©rifie aussi les majorations sp√©cifiques pr√©vues par cette convention.',
    btp:          'En BTP, les modulations horaires et chantiers peuvent impacter ton contingent ‚Äî reste vigilant.',
    sante:        'En sant√©/social, les gardes et astreintes ont des r√®gles sp√©cifiques. Consulte ta CCN.',
    transport:    'En transport, les dur√©es de conduite et repos sont r√©glement√©es distinctement du Code du travail g√©n√©ral.',
    hotellerie:   'En h√¥tellerie/restauration, les heures suppl√©mentaires et coupures ont des r√®gles CCN sp√©cifiques.',
    industrie:    'En industrie, la modulation annuelle peut masquer des d√©passements hebdomadaires. Surveille ta moyenne.',
    bureaux:      'En tertiaire, le forfait jour est fr√©quent ‚Äî v√©rifier s\'il s\'applique √† ton cas.',
    informatique: 'En informatique, le forfait jour est courant mais contestable si les conditions ne sont pas r√©unies.',
    education:    'En √©ducation/formation, les heures compl√©mentaires ont des r√®gles sp√©cifiques selon ton statut.',
  };
  return ctx[secteur] || null;
}

// Charger le profil dans les inputs settings
function _loadProfileIntoSettings() {
  const p = loadKitsuneProfile();
  const el = n => document.getElementById(n);
  if (el('setting-prenom'))  el('setting-prenom').value  = p.prenom  || '';
  if (el('setting-secteur')) el('setting-secteur').value = p.secteur || '';

}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ RACCOURCIS CONTEXTUELS dans bulle Kitsune ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function _updateContextualShortcuts(situation) {
  // Injecter des boutons de nav sous la bulle selon la situation
  const area = document.getElementById('kitsune-shortcuts');
  if (!area) return;
  const btns = [];

  if (situation && (situation.annual?.hasContingentAlert || situation.annual?.hasContingentDanger)) {
    btns.push({ label: 'üìä Voir M1 (annuel)', url: '../heures/index.html' });
  }
  if (situation && (situation.weekly?.hasWeekViol || situation.weekly?.hasWeekAlert)) {
    btns.push({ label: 'üí∞ Voir M2 (mensuel)', url: '../paye/index.html' });
  }
  if (situation && situation.daily?.hasDailyRisk) {
    btns.push({ label: 'üìä Voir M1 (journ√©e)', url: '../heures/index.html' });
  }
  // Toujours proposer un acc√®s rapide
  if (!btns.length) {
    btns.push({ label: 'üìä M1 Annuel', url: '../heures/index.html' },
               { label: 'üí∞ M2 Mensuel', url: '../paye/index.html' });
  }

  area.innerHTML = btns.map(b =>
    `<a href="${b.url}" style="display:inline-block;background:rgba(255,140,66,0.1);border:1px solid rgba(255,140,66,0.25);color:#FF8C42;border-radius:7px;padding:4px 10px;font-size:0.72rem;text-decoration:none;white-space:nowrap;" >${b.label} ‚Üó</a>`
  ).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ HISTORIQUE VIOLATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _VIOLATIONS_KEY = 'FOX_VIOLATIONS_HISTORY';
const _VIOLATIONS_MAX = 100;
let   _violationsFilter = 'all';

function _recordViolation(situation) {
  if (!situation) return;
  const viols = [];
  const now   = new Date().toISOString();
  const y     = situation.year || new Date().getFullYear();

  if (situation.daily?.hasDailyCrit) {
    viols.push({ ts: now, niveau:'danger', titre:'Journ√©e > 12h',
      detail: situation.daily.maxDayTotal + 'h le ' + (situation.daily.maxDayDate || '?'),
      art: 'Art. L3121-18' });
  } else if (situation.daily?.hasDailyRisk) {
    viols.push({ ts: now, niveau:'warning', titre:'Journ√©e > 10h',
      detail: situation.daily.maxDayTotal + 'h le ' + (situation.daily.maxDayDate || '?'),
      art: 'Art. L3121-18' });
  }
  if (situation.weekly?.hasWeekViol) {
    viols.push({ ts: now, niveau:'danger', titre:'Semaine > 48h (plafond absolu)',
      detail: situation.weekly.maxWeekTotal + 'h sem. du ' + (situation.weekly.maxWeekMon || '?'),
      art: 'Art. L3121-20' });
  } else if (situation.weekly?.hasAvgViol) {
    viols.push({ ts: now, niveau:'danger', titre:'Moyenne 12 sem. > 44h',
      detail: 'Moyenne : ' + situation.weekly.maxAvg12 + 'h', art: 'Art. L3121-22' });
  } else if (situation.weekly?.hasWeekAlert) {
    viols.push({ ts: now, niveau:'warning', titre:'Semaine charg√©e',
      detail: situation.weekly.maxWeekTotal + 'h cette semaine', art: 'Art. L3121-10' });
  }
  if (situation.annual?.hasContingentDanger) {
    viols.push({ ts: now, niveau:'danger', titre:'Contingent annuel d√©pass√©',
      detail: situation.annual.annualOT + 'h / ' + situation.annual.contingentMax + 'h',
      art: 'Art. L3121-33' });
  } else if (situation.annual?.hasContingentAlert) {
    viols.push({ ts: now, niveau:'warning', titre:'Contingent annuel > 75%',
      detail: situation.annual.contingentPct + '% consomm√© (' + situation.annual.annualOT + 'h)',
      art: 'Art. L3121-33' });
  }

  if (!viols.length) return;

  try {
    const hist = JSON.parse(localStorage.getItem(_VIOLATIONS_KEY) || '[]');
    // D√©doublonner : m√™me titre dans les 2h ‚Üí skip
    const twoHoursAgo = new Date(Date.now() - 2*3600*1000).toISOString();
    let newViols = 0;
    viols.forEach(v => {
      const isDupe = hist.some(h2 => h2.titre === v.titre && h2.ts > twoHoursAgo);
      if (!isDupe) {
        hist.unshift(v);
        newViols++;
      }
    });
    if (hist.length > _VIOLATIONS_MAX) hist.length = _VIOLATIONS_MAX;
    localStorage.setItem(_VIOLATIONS_KEY, JSON.stringify(hist));
    
    // P√âNALIT√â XP pour nouvelles violations
    if (newViols > 0 && typeof xpSystem !== 'undefined') {
      viols.forEach(v => {
        const isDupe = hist.filter(h2 => h2.titre === v.titre && h2.ts > twoHoursAgo).length > 1;
        if (isDupe) return; // d√©j√† enregistr√©e
        
        // P√©nalit√© selon niveau
        const penalty = v.niveau === 'danger' ? -50 : -25;
        
        // Retirer XP (sans descendre en dessous de 0)
        if (xpSystem.currentXP) {
          xpSystem.currentXP = Math.max(0, (xpSystem.currentXP || 0) + penalty);
          if (typeof xpSystem.saveToStorage === 'function') xpSystem.saveToStorage();
          
          // Sync gameState si pr√©sent
          if (typeof gameState !== 'undefined' && gameState.player) {
            gameState.player.xp = xpSystem.currentXP;
            if (typeof saveGameState === 'function') saveGameState();
          }
          
          // Notification
          showNotification('‚ö†Ô∏è ' + penalty + ' XP ‚Äî Violation : ' + v.titre, 'warning');
        }
      });
    }
  } catch(e) {}
}

function filterViolations(f) {
  _violationsFilter = f;
  ['all','danger','warning'].forEach(k => {
    const b = document.getElementById('vf-' + (k === 'warning' ? 'warn' : k));
    if (b) b.classList.toggle('active', k === f);
  });
  renderViolationsHistory();
}

function renderViolationsHistory() {
  const el = document.getElementById('violations-list');
  if (!el) return;
  try {
    let hist = JSON.parse(localStorage.getItem(_VIOLATIONS_KEY) || '[]');
    if (_violationsFilter !== 'all') hist = hist.filter(v => v.niveau === _violationsFilter);
    if (!hist.length) {
      el.innerHTML = '<div style="color:#444;text-align:center;padding:20px;font-size:0.82rem;">' +
        (_violationsFilter === 'all' ? '‚úÖ Aucune violation enregistr√©e' : 'Aucune violation de ce type') + '</div>';
      return;
    }
    el.innerHTML = hist.map(v => {
      const d   = new Date(v.ts);
      const ts  = d.toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'}) + ' ' + d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
      return `<div class="violation-entry ve-${v.niveau}">
        <div class="ve-titre">${v.niveau === 'danger' ? 'üî¥' : 'üü†'} ${v.titre}<span class="ve-date">${ts}</span></div>
        <div style="color:#aaa;">${v.detail}</div>
        <div class="ve-art">üìú ${v.art} <span style="margin-left:8px;cursor:pointer;color:#FF8C42;" onclick="openGlossaireOn('${v.art}')">‚Üí Glossaire</span></div>
      </div>`;
    }).join('');
  } catch(e) { el.innerHTML = '<div style="color:#444;text-align:center;padding:12px;">Erreur chargement</div>'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ MODE RAPPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// === HISTORIQUE XP ===
function renderXPHistory() {
  const container = document.getElementById('xp-history-content');
  if (!container) return;
  
  // R√©cup√©rer historique complet
  const histKey = 'FOX_REWARDS_HISTORY';
  const history = JSON.parse(localStorage.getItem(histKey) || '[]');
  
  // Filtrer XP uniquement
  const xpHistory = history.filter(h => 
    h.text.includes('XP') || h.text.includes('LEVEL UP')
  );
  
  if (xpHistory.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:#666;padding:40px;">Aucun historique XP pour le moment</div>';
    return;
  }
  
  // Calculer statistiques
  let totalGains = 0;
  let totalLosses = 0;
  let violations = 0;
  
  xpHistory.forEach(h => {
    if (h.text.includes('Violation') || h.text.includes('-')) {
      const match = h.text.match(/-(\d+)/);
      if (match) {
        totalLosses += parseInt(match[1]);
        violations++;
      }
    } else if (h.text.includes('+')) {
      const match = h.text.match(/\+(\d+)/);
      if (match) totalGains += parseInt(match[1]);
    }
  });
  
  const netXP = totalGains - totalLosses;
  
  // Afficher
  let html = `
    <div style="background:rgba(255,140,66,0.05);border:1px solid rgba(255,140,66,0.2);border-radius:12px;padding:16px;margin-bottom:16px;">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;text-align:center;">
        <div>
          <div style="color:#4ade80;font-size:1.5rem;font-weight:900;">+${totalGains}</div>
          <div style="color:#666;font-size:0.75rem;">XP gagn√©s</div>
        </div>
        <div>
          <div style="color:#ef4444;font-size:1.5rem;font-weight:900;">-${totalLosses}</div>
          <div style="color:#666;font-size:0.75rem;">XP perdus</div>
        </div>
        <div>
          <div style="color:${netXP >= 0 ? '#4ade80' : '#ef4444'};font-size:1.5rem;font-weight:900;">${netXP >= 0 ? '+' : ''}${netXP}</div>
          <div style="color:#666;font-size:0.75rem;">XP net</div>
        </div>
      </div>
      <div style="margin-top:12px;text-align:center;color:#666;font-size:0.8rem;">
        ‚ö†Ô∏è ${violations} violation${violations > 1 ? 's' : ''}
      </div>
    </div>
    
    <div style="max-height:400px;overflow-y:auto;">
  `;
  
  xpHistory.forEach(h => {
    const isLoss = h.text.includes('Violation') || h.text.includes('-');
    const date = new Date(h.ts);
    const dateStr = date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
    
    const color = isLoss ? '#ef4444' : '#4ade80';
    const icon = isLoss ? '‚ö†Ô∏è' : '‚úÖ';
    
    html += `
      <div style="background:rgba(${isLoss ? '239,68,68' : '74,222,128'},0.05);border-left:3px solid ${color};padding:12px;margin-bottom:8px;border-radius:6px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="color:${color};font-weight:700;">${icon} ${h.text}</div>
          <div style="color:#666;font-size:0.75rem;">${dateStr}</div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

function renderRapport() {
  const el = document.getElementById('rapport-content');
  if (!el) return;

  const p    = loadKitsuneProfile();
  const s    = _analyzeLegalSituation();
  const bo   = moduleReader?.getBurnoutScore ? moduleReader.getBurnoutScore() : { score:0, level:'sain' };
  const now  = new Date();
  const year = now.getFullYear();
  const dN   = _getYearData(year);
  const dP   = _getYearData(year - 1);
  const patterns = detectPatterns();
  const viols = JSON.parse(localStorage.getItem(_VIOLATIONS_KEY) || '[]');

  const levelColor = lvl => lvl === 'ok' ? '#4CAF50' : lvl === 'danger' ? '#E53935' : '#FF8C42';
  const pct  = s.annual?.contingentPct || 0;
  const annualCol = pct >= 100 ? '#E53935' : pct >= 75 ? '#FF8C42' : '#4CAF50';

  // Secteur context
  const secteurTip = p.secteur ? _getSecteurContext(p.secteur) : null;

  el.innerHTML = `
    <!-- En-t√™te -->
    <div style="text-align:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.07);">
      <div style="font-size:1.8rem;">ü¶ä</div>
      <div style="color:#FF8C42;font-weight:900;font-size:1rem;margin:4px 0;">Rapport FOX Engine</div>
      ${p.prenom ? `<div style="color:#888;font-size:0.8rem;">Pour ${p.prenom}</div>` : ''}
      <div style="color:#555;font-size:0.7rem;">${now.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</div>
    </div>

    <!-- Situation l√©gale -->
    <div class="rapport-section">
      <div class="rapport-title">‚öñÔ∏è Situation l√©gale ‚Äî ${year}</div>
      <div class="rapport-row"><span class="rr-label">Heures sup cumul√©es</span><span class="rr-val ${annualCol === '#4CAF50' ? 'rr-ok' : annualCol === '#E53935' ? 'rr-danger' : 'rr-warn'}">${dN.totalHS}h</span></div>
      <div class="rapport-row"><span class="rr-label">% du contingent (220h)</span><span class="rr-val ${annualCol === '#4CAF50' ? 'rr-ok' : annualCol === '#E53935' ? 'rr-danger' : 'rr-warn'}">${pct}%</span></div>
      <div class="rapport-row"><span class="rr-label">Journ√©e max d√©tect√©e</span><span class="rr-val ${s.daily?.hasDailyCrit ? 'rr-danger' : s.daily?.hasDailyRisk ? 'rr-warn' : 'rr-ok'}">${s.daily?.maxDayTotal || 0}h</span></div>
      <div class="rapport-row"><span class="rr-label">Semaine max d√©tect√©e</span><span class="rr-val ${s.weekly?.hasWeekViol ? 'rr-danger' : s.weekly?.hasWeekAlert ? 'rr-warn' : 'rr-ok'}">${s.weekly?.maxWeekTotal || 35}h</span></div>
      <div class="rapport-row"><span class="rr-label">Niveau global</span><span class="rr-val" style="color:${levelColor(s.globalLevel || 'ok')};text-transform:uppercase;">${s.globalLevel || 'ok'}</span></div>
    </div>

    <!-- Burn-out -->
    <div class="rapport-section">
      <div class="rapport-title">üî• Burn-out</div>
      <div class="rapport-row"><span class="rr-label">Score actuel</span><span class="rr-val ${bo.score >= 80 ? 'rr-danger' : bo.score >= 50 ? 'rr-warn' : 'rr-ok'}">${bo.score}/100</span></div>
      <div class="rapport-row"><span class="rr-label">Niveau</span><span class="rr-val">${bo.level || 'sain'}</span></div>
    </div>

    <!-- Comparaison annuelle -->
    ${dP.hasData ? `<div class="rapport-section">
      <div class="rapport-title">üìÜ Comparaison annuelle</div>
      <div class="rapport-row"><span class="rr-label">${year}</span><span class="rr-val">${dN.totalHS}h</span></div>
      <div class="rapport-row"><span class="rr-label">${year-1}</span><span class="rr-val" style="color:#666;">${dP.totalHS}h</span></div>
      <div class="rapport-row"><span class="rr-label">√âvolution</span><span class="rr-val ${dN.totalHS > dP.totalHS ? 'rr-danger' : 'rr-ok'}">${dN.totalHS > dP.totalHS ? '+' : ''}${(dN.totalHS - dP.totalHS).toFixed(0)}h</span></div>
    </div>` : ''}

    <!-- Patterns -->
    ${patterns.length ? `<div class="rapport-section">
      <div class="rapport-title">üîç Patterns d√©tect√©s</div>
      ${patterns.map(p2 => `<div class="rapport-row">
        <span class="rr-label">${p2.emoji} ${p2.titre}</span>
        <span class="rr-val ${p2.level === 'danger' ? 'rr-danger' : 'rr-warn'}">${p2.level}</span>
      </div>`).join('')}
    </div>` : `<div class="rapport-section"><div class="rapport-title">üîç Patterns</div><div style="color:#4CAF50;font-size:0.82rem;">‚úÖ Aucun pattern probl√©matique d√©tect√©</div></div>`}

    <!-- Violations r√©centes -->
    <div class="rapport-section">
      <div class="rapport-title">‚ö†Ô∏è Violations enregistr√©es</div>
      ${viols.length ? viols.slice(0,5).map(v => `<div class="rapport-row">
        <span class="rr-label" style="font-size:0.75rem;">${v.niveau === 'danger' ? 'üî¥' : 'üü†'} ${v.titre}</span>
        <span style="color:#555;font-size:0.68rem;">${new Date(v.ts).toLocaleDateString('fr-FR',{day:'2-digit',month:'short'})}</span>
      </div>`).join('') : `<div style="color:#4CAF50;font-size:0.82rem;">‚úÖ Aucune violation r√©cente</div>`}
    </div>

    <!-- Contexte secteur -->
    ${secteurTip ? `<div class="rapport-section">
      <div class="rapport-title">üíº Ton secteur ‚Äî ${p.secteur}</div>
      <div style="color:#888;font-size:0.8rem;line-height:1.6;">${secteurTip}</div>
    </div>` : ''}

    <!-- Conseil Kitsune -->
    <div style="background:rgba(255,140,66,0.07);border:1px solid rgba(255,140,66,0.2);border-radius:10px;padding:12px;margin-top:4px;">
      <div style="color:#FF8C42;font-weight:700;font-size:0.82rem;margin-bottom:5px;">ü¶ä Kitsune dit</div>
      <div style="color:#aaa;font-size:0.8rem;line-height:1.6;">${localStorage.getItem('FOX_LAST_BUBBLE') || 'Lance une analyse pour voir les conseils de Kitsune.'}</div>
    </div>`;

  // M√©moriser le texte brut pour la copie
  window._rapportText = _buildRapportText(p, s, bo, dN, dP, patterns, viols, secteurTip, now, year);
}

function _buildRapportText(p, s, bo, dN, dP, patterns, viols, secteurTip, now, year) {
  const lines = [
    '=== RAPPORT FOX ENGINE ===',
    (p.prenom ? 'Pour : ' + p.prenom : ''),
    'Date : ' + now.toLocaleDateString('fr-FR'),
    '',
    '-- SITUATION L√âGALE ' + year + ' --',
    'Heures sup : ' + dN.totalHS + 'h (' + (s.annual?.contingentPct||0) + '% du contingent)',
    'Journ√©e max : ' + (s.daily?.maxDayTotal||0) + 'h',
    'Semaine max : ' + (s.weekly?.maxWeekTotal||35) + 'h',
    'Niveau global : ' + (s.globalLevel||'ok').toUpperCase(),
    '',
    '-- BURN-OUT --',
    'Score : ' + bo.score + '/100 ‚Äî ' + (bo.level||'sain'),
    '',
    dP.hasData ? ('-- COMPARAISON --\n' + year + ' : ' + dN.totalHS + 'h / ' + (year-1) + ' : ' + dP.totalHS + 'h') : '',
    '',
    patterns.length ? ('-- PATTERNS --\n' + patterns.map(p2 => '‚Ä¢ ' + p2.titre).join('\n')) : '-- PATTERNS --\nAucun probl√®me d√©tect√©',
    '',
    viols.length ? ('-- VIOLATIONS R√âCENTES --\n' + viols.slice(0,5).map(v => '‚Ä¢ ' + v.titre + ' (' + new Date(v.ts).toLocaleDateString('fr-FR') + ')').join('\n')) : '-- VIOLATIONS --\nAucune',
    '',
    secteurTip ? ('-- CONTEXTE SECTEUR --\n' + secteurTip) : '',
    '',
    'G√©n√©r√© par FOX Engine ‚Äî Kitsune n\'est pas un avocat.',
  ].filter(l => l !== undefined).join('\n');
  return lines;
}

function copyRapport() {
  const txt = window._rapportText || 'Rapport indisponible';
  navigator.clipboard.writeText(txt).then(() => {
    const btn = document.querySelector('[onclick="copyRapport()"]');
    if (btn) { btn.textContent = '‚úì Copi√© !'; setTimeout(() => { btn.textContent = 'üìã Copier texte'; }, 2000); }
  }).catch(() => {
    // fallback
    const ta = document.createElement('textarea');
    ta.value = txt; ta.style.position = 'fixed'; ta.style.opacity = '0';
    document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); ta.remove();
  });
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ HEATMAP ANNUELLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function initHeatmap() {
  const sel = document.getElementById('heatmap-year-select');
  if (!sel) return;
  const years = moduleReader?.detectAllYears ? moduleReader.detectAllYears() : [new Date().getFullYear()];
  const cur   = new Date().getFullYear();
  if (!years.includes(cur)) years.unshift(cur);
  years.sort((a,b) => b - a);
  sel.innerHTML = years.map(y => `<option value="${y}" ${y===cur?'selected':''}>${y}</option>`).join('');
  renderHeatmap(cur);
}

function renderHeatmap(year) {
  year = parseInt(year);
  const container = document.getElementById('heatmap-container');
  const statsEl   = document.getElementById('heatmap-stats');
  if (!container) return;

  // Charger les donn√©es
  const dayData = {}; // 'YYYY-MM-DD' ‚Üí { extra, hasData }
  try {
    const m1 = JSON.parse(localStorage.getItem('DATA_REPORT_' + year) || '{}');
    Object.entries(m1).forEach(([dk, v]) => {
      if (!/^\d{4}-\d{2}-\d{2}$/.test(dk)) return;
      dayData[dk] = { extra: Number(v.extra)||0, hasData: true };
    });
    const m2 = JSON.parse(localStorage.getItem('CA_HS_TRACKER_V1_DATA_' + year) || '{}');
    Object.entries(m2).forEach(([mk, mv]) => {
      if (!mv?.days) return;
      Object.entries(mv.days).forEach(([ds, hrs]) => {
        const dk = mk + '-' + String(parseInt(ds)).padStart(2,'0');
        if (!dayData[dk]) dayData[dk] = { extra: Number(hrs)||0, hasData: true };
      });
    });
  } catch(e) {}

  // Stats
  const today = new Date().toISOString().slice(0,10);
  const daysWithData = Object.keys(dayData).filter(dk => dk.startsWith(year) && dayData[dk].hasData).length;
  const totalHS      = Object.values(dayData).reduce((s,v) => s + v.extra, 0);
  const daysAlert    = Object.values(dayData).filter(v => 7 + v.extra >= 10).length;
  const passedDays   = Math.min(
    Math.ceil((new Date(today) - new Date(year + '-01-01')) / 86400000) + 1,
    365
  );
  const pctFilled    = Math.round(daysWithData / Math.max(passedDays, 1) * 100);

  // Couleur d'un jour
  function dayColor(dk) {
    if (!dayData[dk]?.hasData) return '#1a1a2e'; // vide
    const extra = dayData[dk].extra || 0;
    const total = 7 + extra;
    if (total >= 12) return '#B71C1C'; // critique
    if (total >= 10) return '#E53935'; // alerte
    if (extra >= 3)  return '#FF8C42'; // charg√©
    if (extra > 0)   return '#4CAF50'; // donn√©es normales
    return '#2d5a2d'; // donn√©es sans HS
  }

  // Construction de la grille (semaines en colonnes, lun‚Üídim en lignes)
  const jan1   = new Date(year, 0, 1);
  const dec31  = new Date(year, 11, 31);
  // Trouver le lundi de la 1√®re semaine
  const startDow = (jan1.getDay() + 6) % 7; // 0=lun
  const start    = new Date(jan1); start.setDate(1 - startDow);

  const JOURS = ['L','M','M','J','V','S','D'];
  const MOIS  = ['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];

  // Collecter les semaines
  const weeks = [];
  let cur2 = new Date(start);
  while (cur2 <= dec31) {
    const week = [];
    for (let d = 0; d < 7; d++) {
      const dk = cur2.toISOString().slice(0,10);
      const inYear = cur2.getFullYear() === year;
      const future = dk > today;
      week.push({ dk, inYear, future, month: cur2.getMonth() });
      cur2.setDate(cur2.getDate() + 1);
    }
    weeks.push(week);
  }

  // Labels mois (positionner sur la 1√®re semaine o√π le mois commence)
  const monthLabels = {};
  weeks.forEach((wk, wi) => {
    wk.forEach(d => {
      if (d.inYear && !monthLabels[d.month]) monthLabels[d.month] = wi;
    });
  });

  // SVG
  const CW = 12; const CH = 12; const GAP = 2;
  const W = weeks.length * (CW + GAP) + 28;
  const H = 7 * (CH + GAP) + 24;

  let svg = `<svg width="${W}" height="${H}" xmlns="http://www.w3.org/2000/svg" style="display:block;">`;

  // Labels jours semaine
  JOURS.forEach((j, i) => {
    if (i % 2 === 0) {
      svg += `<text x="14" y="${20 + i*(CH+GAP) + CH/2}" fill="#444" font-size="7" text-anchor="middle" dominant-baseline="middle">${j}</text>`;
    }
  });

  // Labels mois
  Object.entries(monthLabels).forEach(([m, wi]) => {
    const x = 28 + wi * (CW + GAP);
    svg += `<text x="${x}" y="9" fill="#555" font-size="7.5">${MOIS[m]}</text>`;
  });

  // Jours
  weeks.forEach((wk, wi) => {
    wk.forEach((d, di) => {
      const x = 28 + wi * (CW + GAP);
      const y = 14 + di * (CH + GAP);
      let fill, opacity;
      if (!d.inYear)    { fill = '#0d0d1a'; opacity = 0.3; }
      else if (d.future){ fill = '#1a1a2e'; opacity = 0.5; }
      else               { fill = dayColor(d.dk); opacity = 1; }

      const extra = dayData[d.dk]?.extra || 0;
      const ttip = d.inYear && !d.future
        ? `${d.dk} : ${extra > 0 ? '+' + extra + 'h sup (total ' + (7+extra) + 'h)' : 'Donn√©es pr√©sentes, pas d\'HS'}`
        : d.dk;

      svg += `<rect x="${x}" y="${y}" width="${CW}" height="${CH}" rx="2" fill="${fill}" opacity="${opacity}"
        onmouseenter="showHmTooltip(event,'${ttip}')"
        onmouseleave="hideHmTooltip()"
        onclick="showHmTooltip(event,'${ttip}')"/>`;
    });
  });

  svg += `</svg>`;
  container.innerHTML = '<div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">' + svg + '</div>';

  // Stats
  if (statsEl) {
    const cols = [
      { icon:'üìÖ', val: daysWithData + ' j', label: 'avec donn√©es' },
      { icon:'‚è±', val: Math.round(totalHS) + 'h', label: 'sup totales' },
      { icon:'üìä', val: pctFilled + '%', label: 'suivi ' + year },
    ];
    statsEl.innerHTML = cols.map(c => `
      <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:8px;text-align:center;">
        <div style="font-size:1.1rem;">${c.icon}</div>
        <div style="color:#FF8C42;font-weight:900;font-size:0.95rem;">${c.val}</div>
        <div style="color:#555;font-size:0.65rem;">${c.label}</div>
      </div>`).join('');
  }
}

function showHmTooltip(e, text) {
  const t = document.getElementById('heatmap-tooltip');
  if (!t) return;
  t.textContent = text; t.style.display = 'block';
  t.style.left = (e.clientX + 10) + 'px';
  t.style.top  = (e.clientY - 30) + 'px';
}
function hideHmTooltip() {
  const t = document.getElementById('heatmap-tooltip');
  if (t) t.style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ ACHIEVEMENTS SECRETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const _ACH_KEY     = 'FOX_ACHIEVEMENTS_UNLOCKED';
const _ACH_NOTIF   = 'FOX_ACHIEVEMENTS_NOTIFIED';










// Override buildBadgeStats pour lier aux vraies donn√©es FOX




function _getBadgeImagePath(badge) {
  // TOUS les badges utilisent leur nom comme nom de fichier
  const name = badge.name || badge.label || ('badge' + badge.id);
  
  // Badges 51+ : retirer underscores ET espaces
  if (badge.id >= 51) {
    const fileName = name.replace(/[_\s]/g, '');  // Retire underscores et espaces
    return '../images/badges/' + fileName + '.PNG';
  }
  
  // Badges 1-50 : garder le nom tel quel
  return '../images/badges/' + name + '.PNG';
}

function buildBadgeStats() {
  const narrated = JSON.parse(localStorage.getItem('FOX_SCENARIOS_NARRATED') || '[]');
  const viols    = JSON.parse(localStorage.getItem('FOX_VIOLATIONS_HISTORY') || '[]');
  const bo       = moduleReader?.getBurnoutScore ? moduleReader.getBurnoutScore() : { score:0 };
  const s        = (function(){ try { return _analyzeLegalSituation(); } catch(e){ return {}; } })();
  const level    = (typeof xpSystem !== 'undefined') ? (xpSystem.level || 1) : 1;
  
  // Compter sc√©narios par type
  const scenariosLegal = narrated.filter(id => {
    const sc = typeof FOX_SCENARIOS !== 'undefined' ? FOX_SCENARIOS.find(s => s.id === id) : null;
    return sc && (sc.category === 'limite' || sc.category === 'extreme' || (sc.tags && sc.tags.includes('legal')));
  }).length;
  
  const scenariosWellbeing = narrated.filter(id => {
    const sc = typeof FOX_SCENARIOS !== 'undefined' ? FOX_SCENARIOS.find(s => s.id === id) : null;
    return sc && (sc.id >= 401 || (sc.tags && sc.tags.includes('bien-√™tre')));
  }).length;
  
  // Majoration +25% et +50%
  const totalPlus25 = s.annual?.totalPlus25 || 0;
  const totalPlus50 = s.annual?.totalPlus50 || 0;
  
  // Export RTF
  const exportedData = !!localStorage.getItem('FOX_LAST_EXPORT_DATE');
  
  // Ann√©es track√©es
  const allKeys = Object.keys(localStorage).filter(k => k.startsWith('DATA_REPORT_') || k.startsWith('CA_HS_TRACKER_V1_DATA_'));
  const years = [...new Set(allKeys.map(k => k.match(/\d{4}$/)).filter(Boolean).map(m => m[0]))];
  const yearsTracked = years.length;
  
  // Pic burn-out
  const burnoutPeak = Math.max(bo.score || 0, Number(localStorage.getItem('FOX_BURNOUT_PEAK') || 0));
  if (bo.score > burnoutPeak) localStorage.setItem('FOX_BURNOUT_PEAK', bo.score);
  
  return {
    // Stats originales
    scenariosRead:       narrated.length,
    violationsFound:     viols.length,
    burnoutScore:        bo.score || 0,
    contingentPct:       s.annual?.contingentPct || 0,
    level:               level,
    hoursTracked:        s.annual?.annualOT || 0,
    
    // NOUVEAUX champs pour badges 51-65
    scenariosNarrated:   narrated.length,
    scenariosLegal:      scenariosLegal,
    scenariosWellbeing:  scenariosWellbeing,
    totalPlus25:         totalPlus25,
    totalPlus50:         totalPlus50,
    exportedData:        exportedData,
    yearsTracked:        yearsTracked,
    burnoutPeak:         burnoutPeak,
    
    // Stats totales
    totalHours:          s.annual?.annualOT || 0,
  };
}
</script>

<!-- ‚ïê‚ïê ONBOARDING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="popup-onboarding" style="display:none;position:fixed;inset:0;z-index:99999;background:rgba(4,4,14,0.97);align-items:center;justify-content:center;padding:20px;box-sizing:border-box;">
  <div style="max-width:340px;width:100%;text-align:center;">
    <div id="ob-steps">
      <!-- Step 1 -->
      <div class="ob-step" id="ob-step-1">
        <div style="font-size:3.5rem;margin-bottom:12px;">ü¶ä</div>
        <div style="color:#FF8C42;font-weight:900;font-size:1.3rem;margin-bottom:10px;">Bienvenue dans FOX !</div>
        <div style="color:#aaa;font-size:0.9rem;line-height:1.7;margin-bottom:24px;">Je suis <strong style="color:#FF8C42;">Kitsune</strong>, ton alli√© pour surveiller tes heures sup et prot√©ger tes droits au travail.</div>
        <button onclick="obNext(2)" style="width:100%;background:linear-gradient(135deg,#FF8C42,#FF6B35);border:none;color:#fff;border-radius:12px;padding:14px;font-weight:900;font-size:1rem;cursor:pointer;">Continuer ‚Üí</button>
      </div>
      <!-- Step 2 -->
      <div class="ob-step" id="ob-step-2" style="display:none;">
        <div style="font-size:3.5rem;margin-bottom:12px;">üìä</div>
        <div style="color:#FF8C42;font-weight:900;font-size:1.3rem;margin-bottom:10px;">Comment √ßa marche ?</div>
        <div style="color:#aaa;font-size:0.9rem;line-height:1.7;margin-bottom:24px;">
          <div style="background:rgba(255,140,66,0.08);border-radius:10px;padding:12px;margin-bottom:8px;text-align:left;">
            üìÖ <strong style="color:#fff;">Annuel</strong> ‚Äî Saisis tes heures sup par jour pour le suivi l√©gal annuel
          </div>
          <div style="background:rgba(255,140,66,0.08);border-radius:10px;padding:12px;text-align:left;">
            üí∞ <strong style="color:#fff;">Mensuel</strong> ‚Äî Suis tes heures extras et leur compensation
          </div>
        </div>
        <button onclick="obNext(3)" style="width:100%;background:linear-gradient(135deg,#FF8C42,#FF6B35);border:none;color:#fff;border-radius:12px;padding:14px;font-weight:900;font-size:1rem;cursor:pointer;">Continuer ‚Üí</button>
      </div>
      <!-- Step 3 -->
      <div class="ob-step" id="ob-step-3" style="display:none;">
        <div style="font-size:3.5rem;margin-bottom:12px;">‚öñÔ∏è</div>
        <div style="color:#FF8C42;font-weight:900;font-size:1.3rem;margin-bottom:10px;">Ton premier objectif</div>
        <div style="color:#aaa;font-size:0.9rem;line-height:1.7;margin-bottom:24px;">
          Kitsune analyse tes donn√©es <strong style="color:#fff;">automatiquement</strong> et t'alerte si une loi est potentiellement enfreinte.<br><br>
          <span style="color:#666;font-size:0.78rem;">Je suis un ami vigilant, pas un avocat. En cas de doute s√©rieux, consulte un professionnel.</span>
        </div>
        <button onclick="obFinish()" style="width:100%;background:linear-gradient(135deg,#FF8C42,#FF6B35);border:none;color:#fff;border-radius:12px;padding:14px;font-weight:900;font-size:1rem;cursor:pointer;">ü¶ä Commencer !</button>
      </div>
    </div>
    <!-- Indicateur √©tapes -->
    <div style="display:flex;justify-content:center;gap:8px;margin-top:16px;">
      <div class="ob-dot active" id="ob-dot-1"></div>
      <div class="ob-dot" id="ob-dot-2"></div>
      <div class="ob-dot" id="ob-dot-3"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê POPUP R√âSUM√â MENSUEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="fox-popup-backdrop" id="popup-monthly-summary">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">üìÖ Bilan du mois</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-monthly-summary')">‚úï</button>
    </div>
    <div id="monthly-summary-content" style="color:#ccc;font-size:0.9rem;line-height:1.6;"></div>
    <button onclick="closePopup('popup-monthly-summary')" style="width:100%;margin-top:16px;background:rgba(255,140,66,0.1);border:1px solid rgba(255,140,66,0.3);color:#FF8C42;border-radius:10px;padding:12px;font-weight:700;cursor:pointer;">Fermer</button>
  </div>
</div>

<!-- ‚ïê‚ïê NOTIFICATION HEBDO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- POPUP WEEKLY-NOTIF D√âSACTIV√âE -->
<!-- <div id="weekly-notif">
  <div style="display:flex;align-items:center;gap:10px;">
    <span style="font-size:1.5rem;">ü¶ä</span>
    <div>
      <div style="color:#FF8C42;font-weight:900;font-size:0.85rem;">Semaine non saisie</div>
      <div id="weekly-notif-msg" style="color:#888;font-size:0.75rem;margin-top:2px;">Tu n'as rien saisi cette semaine ‚Äî pense √† renseigner tes heures !</div>
    </div>
  </div>
  <div style="display:flex;gap:8px;">
    <div style="display:flex;gap:6px;flex:1;">
      <button onclick="document.location.href='../heures/index.html'" style="flex:1;background:rgba(255,140,66,0.15);border:1px solid rgba(255,140,66,0.3);color:#FF8C42;border-radius:8px;padding:8px;font-size:0.72rem;font-weight:700;cursor:pointer;">üìä Annuel (M1)</button>
      <button onclick="document.location.href='../paye/index.html'" style="flex:1;background:rgba(255,140,66,0.15);border:1px solid rgba(255,140,66,0.3);color:#FF8C42;border-radius:8px;padding:8px;font-size:0.72rem;font-weight:700;cursor:pointer;">üí∞ Mensuel (M2)</button>
    </div>
    <button onclick="dismissWeeklyNotif()" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#555;border-radius:8px;padding:8px 12px;font-size:0.78rem;cursor:pointer;">Plus tard</button>
  </div>
</div> -->


<!-- ‚ïê‚ïê POPUP GLOSSAIRE JURIDIQUE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="fox-popup-backdrop" id="popup-glossaire">
  <div class="fox-popup" style="max-width:480px;">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">üìö Glossaire juridique</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-glossaire')">‚úï</button>
    </div>
    <input id="glossaire-search" type="text" placeholder="Rechercher un terme ou un article‚Ä¶"
      style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);color:#fff;border-radius:9px;padding:9px 13px;font-size:0.85rem;margin-bottom:12px;box-sizing:border-box;"
      oninput="filterGlossaire(this.value)">
    <div id="glossaire-list" style="max-height:55vh;overflow-y:auto;display:flex;flex-direction:column;gap:6px;"></div>
  </div>
</div>


<!-- ‚ïê‚ïê POPUP HISTORIQUE VIOLATIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="fox-popup-backdrop" id="popup-violations">
  <div class="fox-popup" style="max-width:480px;">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">‚ö†Ô∏è Historique violations</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-violations')">‚úï</button>
    </div>
    <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;">
      <button onclick="filterViolations('all')"   id="vf-all"   class="vfilter-btn active">Toutes</button>
      <button onclick="filterViolations('danger')" id="vf-danger" class="vfilter-btn">üî¥ Critiques</button>
      <button onclick="filterViolations('warning')" id="vf-warn" class="vfilter-btn">üü† Alertes</button>
    </div>
    <div id="violations-list" style="max-height:58vh;overflow-y:auto;display:flex;flex-direction:column;gap:5px;"></div>
  </div>
</div>

<!-- ‚ïê‚ïê POPUP MODE RAPPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="fox-popup-backdrop" id="popup-rapport">
  <div class="fox-popup" style="max-width:480px;">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">üìã Rapport FOX</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-rapport')">‚úï</button>
    </div>
    <div id="rapport-content" style="max-height:65vh;overflow-y:auto;"></div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button onclick="copyRapport()" style="flex:1;background:rgba(255,140,66,0.1);border:1px solid rgba(255,140,66,0.3);color:#FF8C42;border-radius:9px;padding:10px;font-size:0.82rem;font-weight:700;cursor:pointer;">üìã Copier texte</button>
      <button onclick="closePopup('popup-rapport')" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#666;border-radius:9px;padding:10px 14px;cursor:pointer;">‚úï</button>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê POPUP HEATMAP ANNUELLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="fox-popup-backdrop" id="popup-heatmap">
  <div class="fox-popup" style="max-width:500px;">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">üóì Carte de l'ann√©e</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-heatmap')">‚úï</button>
    </div>
    <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;align-items:center;">
      <select id="heatmap-year-select" onchange="renderHeatmap(this.value)"
        style="background:rgba(20,15,40,0.9);border:1px solid rgba(255,255,255,0.12);color:#ccc;border-radius:7px;padding:5px 10px;font-size:0.8rem;">
      </select>
      <div style="margin-left:auto;display:flex;gap:6px;align-items:center;font-size:0.65rem;color:#555;">
        <span style="display:flex;align-items:center;gap:3px;"><span style="width:10px;height:10px;background:#1e1e2e;border:1px solid rgba(255,255,255,0.08);border-radius:2px;display:inline-block;"></span>Vide</span>
        <span style="display:flex;align-items:center;gap:3px;"><span style="width:10px;height:10px;background:#2d4a2d;border-radius:2px;display:inline-block;"></span>Donn√©es</span>
        <span style="display:flex;align-items:center;gap:3px;"><span style="width:10px;height:10px;background:#FF8C42;border-radius:2px;display:inline-block;"></span>Charg√©</span>
        <span style="display:flex;align-items:center;gap:3px;"><span style="width:10px;height:10px;background:#E53935;border-radius:2px;display:inline-block;"></span>Alerte</span>
      </div>
    </div>
    <div id="heatmap-container" style="overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:4px;"></div>
    <div id="heatmap-stats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:10px;"></div>
    <div id="heatmap-tooltip" style="display:none;position:fixed;background:rgba(20,15,40,0.97);border:1px solid rgba(255,140,66,0.3);border-radius:8px;padding:7px 10px;font-size:0.75rem;color:#ccc;pointer-events:none;z-index:99999;max-width:180px;"></div>
  </div>
</div>


<!-- POPUP HISTORIQUE XP -->
<div class="fox-popup-backdrop" id="popup-xp-history">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">üìä Historique XP</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-xp-history')">‚úï</button>
    </div>
    <div class="fox-popup-body" id="xp-history-content">
      Chargement...
    </div>
  </div>
</div>

</body>
</html>
