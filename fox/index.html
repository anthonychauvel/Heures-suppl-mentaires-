<!DOCTYPE html>

<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¦Š FOX Engine â€” Heures Sup' Ultimate</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="gaming-mode">

<div id="burnout-overlay"></div>
<div id="vignette-overlay"></div>

<div id="burnout-popup">
  <span class="burnout-icon">ğŸ”¥</span>
  <div class="score-display" id="burnout-score-val">--</div>
  <h2>Signal Burn-Out DÃ©tectÃ©</h2>
  <p id="burnout-popup-msg">Votre situation prÃ©sente des signaux de risque Ã©levÃ©s.</p>
  <button class="btn-close-burnout" onclick="closeBurnoutPopup()">Voir mes droits â†’</button>
</div>

<!-- HUD -->

<div id="gaming-hud">
  <div class="hud-logo">ğŸ¦Š FOX</div>
  <div class="hud-xp-section">
    <div class="hud-xp-label">
      <span>NIV <span id="hud-level">1</span> â€” <span id="hud-league">Bronze</span></span>
      <span><span id="hud-xp">0</span> / <span id="hud-xp-max">1000</span> XP</span>
    </div>
    <div class="hud-xp-bar"><div class="hud-xp-fill" id="hud-xp-fill" style="width:0%"></div></div>
  </div>
  <div class="hud-stats">
    <div class="hud-stat"><div class="hud-stat-val" id="hud-energy">100</div><div class="hud-stat-lbl">â¤ï¸ Ã‰nergie</div></div>
    <div class="hud-stat"><div class="hud-stat-val" id="hud-burnout">0</div><div class="hud-stat-lbl">ğŸ”¥ Risque</div></div>
    <div class="hud-stat"><div class="hud-stat-val" id="hud-badges">0</div><div class="hud-stat-lbl">ğŸ… Badges</div></div>
    <div class="hud-stat"><div class="hud-stat-val" id="hud-violations">0</div><div class="hud-stat-lbl">âš ï¸ Violations</div></div>
  </div>
  <div style="display:flex;gap:6px;flex-shrink:0;">
    <button class="hud-menu-btn" onclick="openPopup('popup-fox')">ğŸ¦Š Kitsune</button>
    <button class="hud-menu-btn" onclick="openPopup('popup-settings')">âš™ï¸</button>
    <a href="../menu.html" class="hud-menu-btn" style="text-decoration:none;">â† Menu</a>
  </div>
</div>

<!-- ZONE PRINCIPALE -->

<div id="gaming-main">

  <!-- Bulle de dialogue Kitsune -->

  <div id="kitsune-bubble" onclick="openPopup('popup-fox')">
    <div id="kitsune-bubble-text">Bonjour ! Tape ici pour me parler ğŸ¦Š</div>
    <div class="bubble-tail"></div>
  </div>

  <!-- Renard central -->

  <div id="kitsune-center" onclick="openPopup('popup-fox')">
    <img id="kitsune-svg" src="../../images/foxplayer.PNG" alt="Kitsune">
    <div id="kitsune-tap-hint">Appuie sur moi !</div>
  </div>

  <!-- Barre de risque centrale -->

  <div id="risk-bar-center">
    <div style="display:flex;justify-content:space-between;font-size:0.65rem;color:rgba(255,255,255,0.7);margin-bottom:4px;letter-spacing:1px;">
      <span>RISQUE GLOBAL</span><span id="risk-label-main">--</span>
    </div>
    <div class="risk-bar-track"><div class="risk-bar-fill" id="risk-bar-main" style="width:0%"></div></div>
  </div>

  <!-- Dock de boutons en bas -->

  <div id="action-dock">
    <button class="dock-btn" onclick="openPopup('popup-analyse')">
      <span class="dock-icon">âš–ï¸</span>
      <span class="dock-label">Analyse</span>
      <span class="dock-badge live-badge">LIVE</span>
    </button>
    <button class="dock-btn" onclick="openPopup('popup-modules')">
      <span class="dock-icon">ğŸ“Š</span>
      <span class="dock-label">DonnÃ©es</span>
    </button>
    <button class="dock-btn" onclick="openPopup('popup-burnout')">
      <span class="dock-icon">ğŸ”¥</span>
      <span class="dock-label">Burn-Out</span>
    </button>
    <button class="dock-btn" onclick="openPopup('popup-quetes')">
      <span class="dock-icon">âš”ï¸</span>
      <span class="dock-label">QuÃªtes</span>
    </button>
    <button class="dock-btn" onclick="openPopup('popup-scenarios')">
      <span class="dock-icon">ğŸ“š</span>
      <span class="dock-label">600 ScÃ©n.</span>
    </button>
    <button class="dock-btn" onclick="openPopup('popup-export')">
      <span class="dock-icon">ğŸ“„</span>
      <span class="dock-label">Export</span>
    </button>
  </div>

</div>

<!-- POP-UP KITSUNE -->

<div class="fox-popup-backdrop" id="popup-fox">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">ğŸ¦Š Kitsune â€” Guide Juridique</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-fox')">âœ•</button>
    </div>
    <div style="text-align:center;margin-bottom:12px;">
      <img src="../../images/foxplayer.PNG" alt="Kitsune" style="width:90px;height:90px;object-fit:contain;">
    </div>
    <div id="fox-text" style="background:rgba(255,140,66,0.08);border:1px solid rgba(255,140,66,0.2);border-radius:12px;padding:14px;color:#ccc;line-height:1.6;font-size:0.9rem;margin-bottom:14px;">
      Bonjour ! Je suis Kitsune. Pose-moi une question sur tes heures sup, tes droits ou ta situation.
    </div>
    <div style="display:flex;gap:8px;">
      <input id="ai-input" type="text" placeholder="Ta questionâ€¦"
        style="flex:1;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);color:#fff;border-radius:10px;padding:10px 14px;font-size:0.88rem;"
        onkeypress="if(event.key==='Enter')sendToKitsune()">
      <button onclick="sendToKitsune()" style="background:linear-gradient(135deg,#FF8C42,#FF6B35);border:none;color:#fff;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer;">â†‘</button>
    </div>
    <div id="ai-loading" style="display:none;text-align:center;margin-top:10px;color:#666;font-size:0.85rem;">ğŸ¦Š Kitsune rÃ©flÃ©chitâ€¦</div>
    <div id="ai-conversation" style="margin-top:10px;max-height:200px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;"></div>
  </div>
</div>

<!-- POP-UP ANALYSE -->

<div class="fox-popup-backdrop" id="popup-analyse">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">âš–ï¸ Analyse Juridique</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-analyse')">âœ•</button>
    </div>
    <div style="font-size:0.75rem;color:#666;letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">Saisie semaine courante (heures/jour)</div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:10px;">
      <div style="text-align:center;font-size:0.65rem;color:#555;">Lun</div><div style="text-align:center;font-size:0.65rem;color:#555;">Mar</div><div style="text-align:center;font-size:0.65rem;color:#555;">Mer</div><div style="text-align:center;font-size:0.65rem;color:#555;">Jeu</div><div style="text-align:center;font-size:0.65rem;color:#555;">Ven</div><div style="text-align:center;font-size:0.65rem;color:#555;">Sam</div><div style="text-align:center;font-size:0.65rem;color:#555;">Dim</div>
      <input class="day-input" type="number" min="0" max="24" value="7" id="day0">
      <input class="day-input" type="number" min="0" max="24" value="7" id="day1">
      <input class="day-input" type="number" min="0" max="24" value="7" id="day2">
      <input class="day-input" type="number" min="0" max="24" value="7" id="day3">
      <input class="day-input" type="number" min="0" max="24" value="7" id="day4">
      <input class="day-input" type="number" min="0" max="24" value="0" id="day5">
      <input class="day-input" type="number" min="0" max="24" value="0" id="day6">
    </div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px;">
      <label style="display:flex;align-items:center;gap:5px;font-size:0.82rem;color:#aaa;cursor:pointer;"><input type="checkbox" id="chk-night"> Nuit</label>
      <label style="display:flex;align-items:center;gap:5px;font-size:0.82rem;color:#aaa;cursor:pointer;"><input type="checkbox" id="chk-sunday"> Dimanche</label>
      <label style="display:flex;align-items:center;gap:5px;font-size:0.82rem;color:#aaa;cursor:pointer;"><input type="checkbox" id="chk-saturday"> Samedi</label>
      <label style="display:flex;align-items:center;gap:5px;font-size:0.82rem;color:#aaa;cursor:pointer;"><input type="checkbox" id="chk-holiday"> FÃ©riÃ©</label>
    </div>
    <button onclick="runAnalyse()" style="width:100%;background:linear-gradient(135deg,#FF8C42,#FF6B35);border:none;color:#fff;border-radius:12px;padding:13px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 4px 20px rgba(255,140,66,0.3);">âš¡ Analyser maintenant</button>
    <div id="analyse-results" style="display:none;margin-top:16px;">
      <div id="analyse-summary" style="background:rgba(255,140,66,0.08);border:1px solid rgba(255,140,66,0.2);border-radius:12px;padding:14px;color:#ccc;font-size:0.88rem;line-height:1.6;margin-bottom:10px;"></div>
      <div id="analyse-violations" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;"></div>
      <div id="analyse-scenarios" style="display:flex;flex-direction:column;gap:8px;"></div>
    </div>
  </div>
</div>

<!-- POP-UP MODULES -->

<div class="fox-popup-backdrop" id="popup-modules">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">ğŸ“Š DonnÃ©es M1 &amp; M2</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-modules')">âœ•</button>
    </div>
    <div id="modules-content" style="color:#ccc;font-size:0.9rem;"></div>
  </div>
</div>

<!-- POP-UP BURN-OUT -->

<div class="fox-popup-backdrop" id="popup-burnout">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">ğŸ”¥ Score Burn-Out</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-burnout')">âœ•</button>
    </div>
    <div id="burnout-popup-content" style="color:#ccc;"></div>
  </div>
</div>

<!-- POP-UP QUETES -->

<div class="fox-popup-backdrop" id="popup-quetes">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">âš”ï¸ QuÃªtes &amp; Combats</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-quetes')">âœ•</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
      <button onclick="openPopup('popup-badges')" style="background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.2);color:#FFD700;border-radius:12px;padding:14px;cursor:pointer;font-size:0.88rem;font-weight:700;">ğŸ… Mes Badges</button>
      <button onclick="openPopup('popup-skills')" style="background:rgba(100,200,255,0.08);border:1px solid rgba(100,200,255,0.2);color:#64C8FF;border-radius:12px;padding:14px;cursor:pointer;font-size:0.88rem;font-weight:700;">ğŸŒŸ CompÃ©tences</button>
    </div>
    <div id="quests-list" style="display:flex;flex-direction:column;gap:8px;"></div>
  </div>
</div>

<!-- POP-UP SCENARIOS -->

<div class="fox-popup-backdrop" id="popup-scenarios">
  <div class="fox-popup" style="max-width:680px;">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">ğŸ“š ScÃ©narios FOX (600)</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-scenarios')">âœ•</button>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
      <input id="scenario-search" type="text" placeholder="Rechercherâ€¦"
        style="flex:1;min-width:160px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);color:#fff;border-radius:8px;padding:8px 12px;font-size:0.85rem;"
        oninput="filterScenarios()">
      <select id="scenario-risk" onchange="filterScenarios()"
        style="background:rgba(20,20,40,0.95);border:1px solid rgba(255,255,255,0.15);color:#fff;border-radius:8px;padding:8px 10px;font-size:0.85rem;">
        <option value="">Tous risques</option>
        <option value="aucun">âœ… Aucun</option>
        <option value="faible">ğŸ’› Faible</option>
        <option value="moyen">ğŸ§¡ Moyen</option>
        <option value="Ã©levÃ©">ğŸ”´ Ã‰levÃ©</option>
        <option value="critique">ğŸš¨ Critique</option>
      </select>
    </div>
    <div id="scenarios-list" style="max-height:420px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;"></div>
    <div id="scenarios-count" style="text-align:center;color:#555;font-size:0.75rem;margin-top:8px;"></div>
  </div>
</div>

<!-- POP-UP EXPORT -->

<div class="fox-popup-backdrop" id="popup-export">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">ğŸ“„ Exporter</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-export')">âœ•</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <button onclick="exportRTFFull()"    class="export-btn">ğŸ“ RTF complet</button>
      <button onclick="exportJSONFull()"   class="export-btn">ğŸ“¦ JSON tout</button>
      <button onclick="exportModule1()"    class="export-btn">ğŸ“Š JSON M1</button>
      <button onclick="exportModule2()"    class="export-btn">ğŸ“Š JSON M2</button>
      <button onclick="exportHistorique()" class="export-btn" style="grid-column:span 2;background:rgba(255,140,66,0.1);color:#FF8C42;">ğŸ•°ï¸ Historique multi-annÃ©es</button>
    </div>
  </div>
</div>

<!-- POP-UP BADGES -->

<div class="fox-popup-backdrop" id="popup-badges">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">ğŸ… Collection Badges</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-badges')">âœ•</button>
    </div>
    <div id="badges-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(76px,1fr));gap:8px;max-height:420px;overflow-y:auto;"></div>
  </div>
</div>

<!-- POP-UP SETTINGS -->

<div class="fox-popup-backdrop" id="popup-settings">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">âš™ï¸ Options</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-settings')">âœ•</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:16px;color:#ccc;font-size:0.9rem;">
      <div>
        <div style="color:#888;font-size:0.72rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Animations d'alerte</div>
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" id="toggle-burnout-anim" checked onchange="toggleBurnoutAnimations(this.checked)">
          Effets visuels burn-out actifs
        </label>
      </div>
      <div>
        <div style="color:#888;font-size:0.72rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">AnnÃ©es dans localStorage</div>
        <div id="detected-years" style="color:#FF8C42;font-size:0.88rem;">â€”</div>
      </div>
      <div>
        <div style="color:#888;font-size:0.72rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Reset RPG</div>
        <button onclick="resetRPGConfirm()" style="background:rgba(229,57,53,0.1);border:1px solid rgba(229,57,53,0.25);color:#E53935;border-radius:8px;padding:8px 16px;cursor:pointer;font-size:0.85rem;">ğŸ—‘ï¸ RÃ©initialiser progression RPG</button>
      </div>
    </div>
  </div>
</div>

<style>
.day-input{width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#fff;border-radius:6px;padding:7px 2px;text-align:center;font-size:0.9rem;-moz-appearance:textfield;}
.day-input::-webkit-outer-spin-button,.day-input::-webkit-inner-spin-button{-webkit-appearance:none;}
.day-input:focus{outline:none;border-color:#FF8C42;}
.export-btn{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);color:#ddd;border-radius:10px;padding:12px 8px;cursor:pointer;font-size:0.85rem;transition:all 0.2s;}
.export-btn:hover{background:rgba(255,140,66,0.1);border-color:rgba(255,140,66,0.3);color:#FF8C42;}
.violation-tag{display:inline-flex;align-items:center;gap:5px;background:rgba(229,57,53,0.12);border:1px solid rgba(229,57,53,0.25);border-radius:8px;padding:5px 10px;font-size:0.78rem;color:#ff8a80;}
.scenario-card-mini{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:9px;padding:11px 13px;cursor:pointer;transition:all 0.2s;}
.scenario-card-mini:hover{background:rgba(255,140,66,0.05);border-color:rgba(255,140,66,0.2);}
.scenario-card-mini .sc-name{font-weight:700;color:#eee;font-size:0.87rem;}
.scenario-card-mini .sc-legal{font-size:0.76rem;color:#777;margin-top:3px;}
</style>

<!-- Scripts (ordre inchangÃ©) -->

<script src="js/safety.js"></script>

<script src="js/storage.js"></script>

<script src="js/config.js"></script>

<script src="js/assets-config.js"></script>

<script src="js/modes.js"></script>

<script src="js/xp-system.js"></script>

<script src="js/leagues.js"></script>

<script src="js/badges.js"></script>

<script src="js/milestones.js"></script>

<script src="js/rpg-system.js"></script>

<script src="js/module3.js"></script>

<script src="js/quests.js"></script>

<script src="js/combat.js"></script>

<script src="js/skills.js"></script>

<script src="js/inventory.js"></script>

<script src="js/module-loader.js"></script>

<script src="js/scenarios-fox-data.js"></script>

<script src="js/scenarios-fox.js"></script>

<script src="js/scenarios-ai.js"></script>

<script src="js/legal-engine.js"></script>

<script src="js/data-bridge.js"></script>

<script src="js/module-reader.js"></script>

<script src="js/snapshot-system.js"></script>

<script src="js/export-rtf.js"></script>

<script src="js/ai-integration.js"></script>

<script src="js/main-rpg.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ORCHESTRATEUR GAMING UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ Pop-ups â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPopup(id) {
  const bd = document.getElementById(id); if (!bd) return;
  bd.classList.add('open');
  requestAnimationFrame(() => {
    const p = bd.querySelector('.fox-popup'); if (p) p.classList.add('popin');
  });
  if (id==='popup-modules')  refreshModulesPopup();
  if (id==='popup-burnout')  refreshBurnoutPopup();
  if (id==='popup-quetes')   refreshQuestesPopup();
  if (id==='popup-scenarios') initScenariosPopup();
  if (id==='popup-badges')   refreshBadgesPopup();
  if (id==='popup-settings') refreshSettings();
}
function closePopup(id) {
  const bd = document.getElementById(id); if (!bd) return;
  const p = bd.querySelector('.fox-popup'); if (p) p.classList.remove('popin');
  setTimeout(() => bd.classList.remove('open'), 350);
}
document.querySelectorAll('.fox-popup-backdrop').forEach(bd => {
  bd.addEventListener('click', e => { if (e.target===bd) closePopup(bd.id); });
});
document.addEventListener('keydown', e => {
  if (e.key==='Escape') {
    document.querySelectorAll('.fox-popup-backdrop.open').forEach(bd => closePopup(bd.id));
    document.getElementById('burnout-popup').classList.remove('visible');
  }
});

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(refreshHUD, 800);
  setTimeout(checkBurnoutAlert, 1500);
  // Bonus XP multi-annÃ©es : attribuÃ© une seule fois par session
  setTimeout(() => {
    try {
      const cum = moduleReader.getCumulatedSummary ? moduleReader.getCumulatedSummary() : null;
      if (cum && cum.xpBonus > 0 && typeof gainXP === 'function') {
        const key = 'fox_multiyear_xp_applied';
        const already = sessionStorage.getItem(key);
        if (!already) {
          gainXP(cum.xpBonus, `${cum.years.length} annÃ©es de donnÃ©es dÃ©tectÃ©es`);
          sessionStorage.setItem(key, '1');
          console.log(`ğŸ† Bonus XP multi-annÃ©es : +${cum.xpBonus} XP pour ${cum.years.length} an(s)`);
        }
      }
    } catch(e) {}
  }, 2000);
});

// â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setFoxSource(source) {
  if (!moduleReader.setSourceOverride) return;
  moduleReader.setSourceOverride(source);
  setTimeout(() => { refreshModulesPopup(); refreshHUD(); }, 100);
}

function refreshHUD() {
  try {
    if (typeof gameState !== 'undefined') {
      const lvl = gameState.level||1;
      const xp  = gameState.xp||0;
      const nxt = (typeof xpSystem!=='undefined'&&xpSystem.getNextLevelXP)?xpSystem.getNextLevelXP(lvl):1000;
      document.getElementById('hud-level').textContent = lvl;
      document.getElementById('hud-xp').textContent    = xp;
      document.getElementById('hud-xp-max').textContent = nxt;
      document.getElementById('hud-xp-fill').style.width = Math.min(100,(xp/nxt)*100)+'%';
      const lg = (typeof leagueSystem!=='undefined'&&leagueSystem.getCurrentLeague)?leagueSystem.getCurrentLeague(lvl)?.name:'Bronze';
      document.getElementById('hud-league').textContent = lg||'Bronze';
      document.getElementById('hud-badges').textContent = gameState.badges?.length||0;
    }
    const bo      = moduleReader.getBurnoutScore ? moduleReader.getBurnoutScore() : {score:0,level:'sain'};
    const rolling = moduleReader.getRollingAnalysis ? moduleReader.getRollingAnalysis(12) : {avgTotal:35,violations:{over48:0,over35:0},trend:'stable',weeksAnalyzed:0};
    const boEl = document.getElementById('hud-burnout');
    boEl.textContent = bo.score;
    if (bo.score>=60) boEl.classList.add('danger-val');
    const enEl = document.getElementById('hud-energy');
    const enVal = Math.max(0,100-bo.score);
    enEl.textContent = enVal;
    if (enVal<30) enEl.classList.add('danger-val');
    document.getElementById('hud-violations').textContent = (rolling.violations?.over48||0)+(rolling.violations?.over35||0);
    // Sous-titre avec cumul toutes annÃ©es
    const cum = moduleReader.getCumulatedSummary ? moduleReader.getCumulatedSummary() : null;
    // Bulle Kitsune dynamique
    const bubbleEl = document.getElementById('kitsune-bubble-text');
    if (bubbleEl) {
      const net = cum ? (cum.totalNetOvertime||0).toFixed(0) : '?';
      const msgs = {
        sain:      `âœ… Tout va bien ! ${net}h sup cumulÃ©es. Tape-moi pour en savoir plus.`,
        vigilance: `ğŸ’› Vigilance : ${net}h sup. Semaines chargÃ©es dÃ©tectÃ©es.`,
        risque:    `ğŸŸ  Risque dÃ©tectÃ© : ${net}h sup. Consulte l'analyse.`,
        danger:    `ğŸ”´ Danger : ${net}h sup. Ta charge est critique !`,
        critique:  `ğŸš¨ CRITIQUE : ${net}h sup. Agis maintenant !`,
      };
      bubbleEl.textContent = msgs[bo.level] || msgs.sain;
    }
    const rColor = bo.score<20?'#4CAF50':bo.score<40?'#FF8C42':bo.score<60?'#FF6B35':bo.score<80?'#E53935':'#B71C1C';
    const rLabel = bo.score<20?'ğŸ’š Sain':bo.score<40?'ğŸ’› Vigilance':bo.score<60?'ğŸ§¡ Risque':bo.score<80?'ğŸ”´ Danger':'ğŸš¨ Critique';
    document.getElementById('risk-label-main').textContent = rLabel;
    document.getElementById('risk-bar-main').style.cssText =
      `width:${bo.score}%;background:${rColor};box-shadow:0 0 8px ${rColor}88;`;
  } catch(e) { console.warn('HUD:', e); }
}

// â”€â”€ Burn-out â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkBurnoutAlert() {
  try {
    const bo = moduleReader.getBurnoutScore ? moduleReader.getBurnoutScore() : {score:0};
    if (!document.getElementById('toggle-burnout-anim')?.checked) return;
    const vig = document.getElementById('vignette-overlay');
    const ov  = document.getElementById('burnout-overlay');
    if (bo.score>=80) {
      ov.classList.add('active'); vig.className='critique';
      document.getElementById('card-burnout').style.cssText='border-color:#E53935;box-shadow:0 0 30px rgba(229,57,53,0.3);';
      document.getElementById('burnout-card-desc').textContent=`ğŸš¨ Score ${bo.score}/100 â€” Situation critique`;
      document.getElementById('burnout-card-desc').classList.add('burnout-text-bleed');
      document.body.classList.remove('burnout-shake');
      void document.body.offsetWidth;
      document.body.classList.add('burnout-shake');
      setTimeout(()=>document.body.classList.remove('burnout-shake'),700);
      spawnFatigueParticles(10);
      document.getElementById('burnout-score-val').textContent = bo.score+'/100';
      document.getElementById('burnout-popup-msg').textContent =
        `Niveau ${bo.level?.toUpperCase()}. ${bo.details?.violations?.over48||0} semaine(s) Ã  +48h. `+
        `Consultez votre mÃ©decin du travail et exercez votre droit Ã  la dÃ©connexion (art. L2242-17).`;
      document.getElementById('burnout-popup').classList.add('visible');
    } else if (bo.score>=60) {
      vig.className='danger';
      document.getElementById('burnout-card-desc').textContent=`âš ï¸ Score ${bo.score}/100 â€” Vigilance`;
    } else if (bo.score>=40) {
      document.getElementById('burnout-card-desc').textContent=`ğŸ’› Score ${bo.score}/100 â€” Surveillez`;
    }
  } catch(e){}
}

function closeBurnoutPopup() {
  document.getElementById('burnout-popup').classList.remove('visible');
  openPopup('popup-burnout');
}
function toggleBurnoutAnimations(on) {
  if (!on) { document.getElementById('vignette-overlay').className=''; document.getElementById('burnout-overlay').classList.remove('active'); }
  else checkBurnoutAlert();
}
function spawnFatigueParticles(n) {
  for (let i=0;i<n;i++) {
    const p=document.createElement('div'); p.className='fatigue-particle';
    p.style.left=Math.random()*100+'vw'; p.style.top='-10px';
    const sz=(6+Math.random()*8)+'px'; p.style.width=sz; p.style.height=sz;
    p.style.animationDuration=(3+Math.random()*4)+'s';
    p.style.animationDelay=(Math.random()*2)+'s';
    document.body.appendChild(p); setTimeout(()=>p.remove(),7000);
  }
}

// â”€â”€ Analyse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function runAnalyse() {
  const dh = [0,1,2,3,4,5,6].map(i=>Number(document.getElementById('day'+i).value)||0);
  const gs = {
    weeklyHours:dh.reduce((s,h)=>s+h,0), dailyHours:dh,
    hasNightWork:document.getElementById('chk-night').checked,
    hasSundayWork:document.getElementById('chk-sunday').checked||dh[6]>0,
    hasSaturdayWork:document.getElementById('chk-saturday').checked||dh[5]>0,
    hasHolidayWork:document.getElementById('chk-holiday').checked,
  };
  const result = (typeof foxScenarioEngineExpert!=='undefined')
    ? foxScenarioEngineExpert(gs) : foxScenarioEngine(gs);
  const box = document.getElementById('analyse-results');
  box.style.display='block';
  document.getElementById('analyse-summary').innerHTML =
    `<strong>${result.riskLevel?.emoji||''} ${result.riskLevel?.label||''}</strong> â€” Score ${result.riskScore||0}/100<br><span style="font-size:0.85rem;">${result.summary||''}</span>`;
  document.getElementById('analyse-violations').innerHTML =
    !(result.violations?.length)
      ? '<span style="color:#4CAF50;font-size:0.82rem;">âœ… Aucune violation</span>'
      : result.violations.map(v=>`<span class="violation-tag">âš ï¸ ${v.label} <small style="opacity:0.5">art.${v.article}</small></span>`).join('');
  const sc = result.matchedScenarios||result.triggered||[];
  document.getElementById('analyse-scenarios').innerHTML = sc.slice(0,5).filter(Boolean).map(s=>
    `<div class="scenario-card-mini">
       <div class="sc-name">${s.name}</div>
       <div class="sc-legal">${s.legal||''} Â· ${s.risk||'â€”'}</div>
       <div style="font-size:0.78rem;color:#777;margin-top:4px;">${s.conseil?.message||''}</div>
     </div>`).join('');
  if (result.violations?.length>0 && typeof gainXP==='function') gainXP(50,'Violation dÃ©tectÃ©e');
  document.getElementById('hud-violations').textContent = result.violations?.length||0;
  refreshHUD();
}

// â”€â”€ Modules popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshModulesPopup() {
  const cum   = moduleReader.getCumulatedSummary ? moduleReader.getCumulatedSummary() : null;
  const years = moduleReader.detectAllYears ? moduleReader.detectAllYears() : [moduleReader.year];
  const src   = cum?.source || 'fusion';
  const manual = localStorage.getItem('FOX_SOURCE_OVERRIDE');

  const srcLabel = src === 'fusion' ? 'ğŸ”€ Fusion auto' : src === 'M1' ? 'ğŸ“… M1 forcÃ©' : 'ğŸ’° M2 forcÃ©';
  const srcColor = src === 'M1' ? '#64C8FF' : src === 'M2' ? '#FFD700' : '#4CAF50';

  let html = `
    <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:14px;margin-bottom:14px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <strong style="color:#FF8C42;">ğŸ“Š Cumul toutes annÃ©es</strong>
        <span style="background:rgba(255,255,255,0.08);color:${srcColor};border-radius:20px;padding:3px 10px;font-size:0.72rem;font-weight:700;">
          ${srcLabel}
        </span>
      </div>
      <div style="font-size:0.72rem;color:#666;margin-bottom:10px;">
        ${src === 'fusion'
          ? 'Fusion intelligente â€” M1 et M2 combinÃ©s mois par mois, zÃ©ro doublon. Le cumul est prÃ©servÃ© mÃªme si vous changez de module.'
          : `Source forcÃ©e manuellement sur ${src}. Les mois sans donnÃ©es dans ${src} sont complÃ©tÃ©s par l'autre module.`
        }
      </div>
      <div style="margin-bottom:12px;">
        <div style="font-size:0.72rem;color:#888;margin-bottom:6px;">ğŸ›ï¸ Mode de lecture :</div>
        <div style="display:flex;gap:6px;">
          <button onclick="setFoxSource('auto')"
            style="flex:1;padding:7px;border-radius:8px;border:1px solid ${!manual?'#4CAF50':'rgba(255,255,255,0.1)'};
                   background:${!manual?'rgba(76,175,80,0.15)':'rgba(255,255,255,0.04)'};
                   color:${!manual?'#4CAF50':'#888'};font-size:0.73rem;cursor:pointer;font-weight:${!manual?'900':'400'}">
            ğŸ”€ Fusion auto
          </button>
          <button onclick="setFoxSource('M1')"
            style="flex:1;padding:7px;border-radius:8px;border:1px solid ${manual==='M1'?'#64C8FF':'rgba(255,255,255,0.1)'};
                   background:${manual==='M1'?'rgba(100,200,255,0.15)':'rgba(255,255,255,0.04)'};
                   color:${manual==='M1'?'#64C8FF':'#888'};font-size:0.73rem;cursor:pointer;font-weight:${manual==='M1'?'900':'400'}">
            ğŸ“… Forcer M1
          </button>
          <button onclick="setFoxSource('M2')"
            style="flex:1;padding:7px;border-radius:8px;border:1px solid ${manual==='M2'?'#FFD700':'rgba(255,255,255,0.1)'};
                   background:${manual==='M2'?'rgba(255,215,0,0.15)':'rgba(255,255,255,0.04)'};
                   color:${manual==='M2'?'#FFD700':'#888'};font-size:0.73rem;cursor:pointer;font-weight:${manual==='M2'?'900':'400'}">
            ğŸ’° Forcer M2
          </button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-size:0.83rem;">
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">HS nettes totales</div>
          <div style="font-weight:900;font-size:1.3rem;color:#FF8C42;">${(cum?.totalNetOvertime||0).toFixed(0)}h</div>
        </div>
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">AnnÃ©es suivies</div>
          <div style="font-weight:900;font-size:1.3rem;color:#FF8C42;">${years.length}</div>
        </div>
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">Mois analysÃ©s</div>
          <div style="font-weight:900;font-size:1.3rem;color:#FF8C42;">${cum?.monthCount||0}</div>
        </div>
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">HS +25%</div>
          <div style="font-weight:700;color:#eee;">${(cum?.totalPlus25||0).toFixed(1)}h</div>
        </div>
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">HS +50%</div>
          <div style="font-weight:700;color:#eee;">${(cum?.totalPlus50||0).toFixed(1)}h</div>
        </div>
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">XP bonus</div>
          <div style="font-weight:700;color:#FFD700;">+${cum?.xpBonus||0} XP</div>
        </div>
      </div>
    </div>
    <div style="font-size:0.72rem;color:#555;letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">DÃ©tail par annÃ©e</div>`;

  years.forEach(y => {
    const py = cum?.perYear?.[y];
    const net = py?.net || 0;
    const netColor = net > 100 ? '#E53935' : net > 50 ? '#FF8C42' : '#4CAF50';
    const m1cov = py?.m1Coverage || 0;
    const m2cov = py?.m2Coverage || 0;

    html += `
      <div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:12px;margin-bottom:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div style="font-weight:700;color:#FF8C42;">ğŸ“… ${y}</div>
          <div style="display:flex;gap:4px;font-size:0.68rem;">
            ${m1cov ? `<span style="color:#64C8FF;background:rgba(100,200,255,0.1);border-radius:8px;padding:2px 7px;">M1: ${m1cov} mois</span>` : ''}
            ${m2cov ? `<span style="color:#FFD700;background:rgba(255,215,0,0.1);border-radius:8px;padding:2px 7px;">M2: ${m2cov} mois</span>` : ''}
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;font-size:0.82rem;">
          <div><div style="color:#555;font-size:0.7rem;">HS nettes</div><strong style="color:${netColor};">${net.toFixed(1)}h</strong></div>
          <div><div style="color:#555;font-size:0.7rem;">HS +25%</div><strong>${(py?.hs25||0).toFixed(1)}h</strong></div>
          <div><div style="color:#555;font-size:0.7rem;">HS +50%</div><strong>${(py?.hs50||0).toFixed(1)}h</strong></div>
        </div>
      </div>`;
  });

  if (!years.length) html += '<p style="color:#555;text-align:center;">Aucune donnÃ©e â€” ouvrez le Module 1 ou 2.</p>';
  document.getElementById('modules-content').innerHTML = html;
}


// â”€â”€ Burn-out popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshBurnoutPopup() {
  const bo=moduleReader.getBurnoutScore?moduleReader.getBurnoutScore():{score:0,level:'sain',details:{}};
  const r=moduleReader.getRollingAnalysis?moduleReader.getRollingAnalysis(12):{avgTotal:35,trend:'stable',violations:{over48:0},weeksAnalyzed:0};
  const c=bo.score<20?'#4CAF50':bo.score<40?'#FF8C42':bo.score<60?'#FF6B35':bo.score<80?'#E53935':'#B71C1C';
  document.getElementById('burnout-popup-content').innerHTML=`
    <div style="text-align:center;margin-bottom:18px;">
      <div style="font-size:3rem;font-weight:900;color:${c};text-shadow:0 0 20px ${c}55;">${bo.score}<span style="font-size:1.4rem;">/100</span></div>
      <div style="font-weight:700;color:${c};text-transform:uppercase;letter-spacing:2px;font-size:0.95rem;">${bo.level}</div>
    </div>
    <div class="risk-bar-track" style="margin-bottom:16px;"><div class="risk-bar-fill" style="width:${bo.score}%;background:${c};"></div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;font-size:0.83rem;">
      <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;"><div style="color:#555;">Moy. hebdo</div><strong>${r.avgTotal?.toFixed(1)||'â€”'}h</strong></div>
      <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;"><div style="color:#555;">Tendance</div><strong>${r.trend==='hausse'?'ğŸ“ˆ Hausse':r.trend==='baisse'?'ğŸ“‰ Baisse':'â¡ï¸ Stable'}</strong></div>
      <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;"><div style="color:#555;">Sem. +48h</div><strong style="color:${(r.violations?.over48||0)>0?'#E53935':'#4CAF50'}">${r.violations?.over48||0}</strong></div>
      <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;"><div style="color:#555;">Sem. analysÃ©es</div><strong>${r.weeksAnalyzed||0}</strong></div>
    </div>
    ${bo.score>=40?`<div style="background:rgba(229,57,53,0.08);border:1px solid rgba(229,57,53,0.18);border-radius:10px;padding:13px;font-size:0.82rem;color:#ffcdd2;line-height:1.6;">
      âš•ï¸ Consultez votre mÃ©decin du travail. Droit Ã  la dÃ©connexion (art. L2242-17). Visite Ã  la demande (art. L4624-1).
    </div>`:'<div style="color:#4CAF50;text-align:center;padding:10px;">âœ… Situation saine !</div>'}`;
}

// â”€â”€ QuÃªtes popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshQuestesPopup() {
  const list=document.getElementById('quests-list'); if (!list) return;
  const q=typeof quests!=='undefined'&&Array.isArray(quests)?quests:[];
  list.innerHTML=q.slice(0,6).map(qt=>
    `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:12px;">
      <div style="font-weight:700;color:#eee;font-size:0.87rem;">${qt.icon||'âš”ï¸'} ${qt.name||qt.title||'QuÃªte'}</div>
      <div style="color:#666;font-size:0.77rem;margin-top:3px;">${qt.description||qt.desc||''}</div>
      <div style="background:rgba(255,255,255,0.06);border-radius:4px;height:4px;margin-top:7px;">
        <div style="height:100%;background:#FF8C42;border-radius:4px;width:${((qt.progress||0)/(qt.goal||1))*100}%;"></div>
      </div></div>`).join('')||'<p style="color:#555;text-align:center;font-size:0.85rem;">Aucune quÃªte active.</p>';
}

// â”€â”€ ScÃ©narios popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initScenariosPopup() {
  const all=typeof FOX_SCENARIOS!=='undefined'?FOX_SCENARIOS:[];
  renderScenarios(all.slice(0,30));
  document.getElementById('scenarios-count').textContent=`${all.length} scÃ©narios disponibles`;
}
function filterScenarios() {
  const q=document.getElementById('scenario-search').value.toLowerCase();
  const risk=document.getElementById('scenario-risk').value;
  let f=typeof FOX_SCENARIOS!=='undefined'?FOX_SCENARIOS:[];
  if (q)    f=f.filter(s=>s.name.toLowerCase().includes(q)||(s.desc||'').toLowerCase().includes(q));
  if (risk) f=f.filter(s=>s.risk===risk);
  renderScenarios(f.slice(0,50));
  document.getElementById('scenarios-count').textContent=`${f.length} scÃ©nario(s) trouvÃ©(s)`;
}
function renderScenarios(list) {
  document.getElementById('scenarios-list').innerHTML=list.map(s=>
    `<div class="scenario-card-mini" onclick="var d=this.nextElementSibling;d.style.display=d.style.display==='none'?'block':'none'">
      <div class="sc-name">#${s.id} ${s.name}</div>
      <div class="sc-legal">${s.legal||''} Â· ${s.risk||'â€”'}</div>
    </div>
    <div style="display:none;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:11px;font-size:0.8rem;color:#aaa;line-height:1.5;margin-bottom:2px;">
      ${s.conseil?.message||s.desc||''}
      ${s.conseil?.actions?'<ul style="margin:7px 0 0;padding-left:14px;">'+s.conseil.actions.map(a=>`<li style="margin:3px 0;">${a}</li>`).join('')+'</ul>':''}
    </div>`).join('')||'<p style="color:#555;text-align:center;">Aucun rÃ©sultat</p>';
}

// â”€â”€ Badges popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshBadgesPopup() {
  const grid=document.getElementById('badges-grid'); if (!grid) return;
  const all=typeof BADGES!=='undefined'?BADGES:[];
  const done=(typeof gameState!=='undefined'&&gameState.badges)?gameState.badges:[];
  grid.innerHTML=all.map(b=>{
    const ok=done.includes(b.id);
    return `<div title="${b.name}: ${b.desc||''}" style="background:rgba(255,255,255,${ok?'0.08':'0.02'});border:1px solid rgba(255,255,255,${ok?'0.15':'0.05'});border-radius:9px;padding:9px;text-align:center;opacity:${ok?1:0.32};">
      <div style="font-size:1.5rem;">${b.icon||'ğŸ…'}</div>
      <div style="font-size:0.58rem;color:#777;margin-top:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${b.name||''}</div>
    </div>`;}).join('')||'<p style="color:#555;">Aucun badge dÃ©fini.</p>';
}

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshSettings() {
  const y=moduleReader.detectAllYears?moduleReader.detectAllYears():[];
  document.getElementById('detected-years').textContent=y.length?y.join(' Â· '):'Aucune donnÃ©e';
}
function resetRPGConfirm() {
  if (confirm('RÃ©initialiser XP, badges et quÃªtes ? Les donnÃ©es M1/M2 restent intactes.')) {
    if (typeof gameState!=='undefined') {
      gameState.xp=0;gameState.level=1;gameState.badges=[];
      if (typeof saveGameState==='function') saveGameState();
      refreshHUD(); closePopup('popup-settings');
    }
  }
}
function exportHistorique() {
  if (typeof moduleReader.exportFullHistory==='function') moduleReader.exportFullHistory();
}

// â”€â”€ Kitsune â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function kitsuneFormat(text) {
  // Gras **texte** â†’ <strong>
  text = text.replace(/\*\*(.+?)\*\*/g, '<strong style="color:#fff;">$1</strong>');
  // Sauts de ligne
  text = text.replace(/\n/g, '<br>');
  // Puces â€¢
  text = text.replace(/â€¢\s/g, '<span style="color:#FF8C42;">â€¢</span> ');
  return text;
}

async function sendToKitsune() {
  const inp  = document.getElementById('ai-input');
  const msg  = inp.value.trim();
  if (!msg) return;
  inp.value  = '';
  const conv = document.getElementById('ai-conversation');

  // Message joueur
  conv.innerHTML += `
    <div style="text-align:right;margin:6px 0;">
      <span style="background:rgba(255,140,66,0.18);color:#FF8C42;border-radius:12px 12px 2px 12px;
                   padding:8px 14px;display:inline-block;font-size:0.83rem;max-width:85%;text-align:left;">
        ${msg}
      </span>
    </div>`;

  document.getElementById('ai-loading').style.display = 'block';
  conv.scrollTop = conv.scrollHeight;

  try {
    const reply = typeof askKitsune === 'function' ? await askKitsune(msg) : 'ğŸ¦Š Module non chargÃ©.';
    conv.innerHTML += `
      <div style="text-align:left;margin:6px 0;">
        <span style="background:rgba(255,255,255,0.05);color:#ccc;border-radius:2px 12px 12px 12px;
                     padding:8px 14px;display:inline-block;font-size:0.83rem;max-width:92%;text-align:left;line-height:1.5;">
          ${kitsuneFormat(reply)}
        </span>
      </div>`;
  } catch(e) {
    conv.innerHTML += `<div style="color:#E53935;font-size:0.8rem;margin:4px 0;">Erreur : ${e.message}</div>`;
  }

  document.getElementById('ai-loading').style.display = 'none';
  conv.scrollTop = conv.scrollHeight;
}
</script>

</body>
</html>
