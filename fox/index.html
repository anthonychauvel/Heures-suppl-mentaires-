<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¦Š FOX Engine â€” Heures Sup' Ultimate</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="gaming-mode">

<img id="bg-decor" src="../images/fox-bg.PNG" style="position:fixed;top:0;left:0;width:100vw;height:100vh;object-fit:cover;object-position:center center;z-index:-999;pointer-events:none;">

<div id="burnout-overlay"></div>
<div id="vignette-overlay"></div>

<div id="burnout-popup">
  <span class="burnout-icon">ğŸ”¥</span>
  <div class="score-display" id="burnout-score-val">--</div>
  <h2>Signal Burn-Out DÃ©tectÃ©</h2>
  <p id="burnout-popup-msg">Votre situation prÃ©sente des signaux de risque Ã©levÃ©s.</p>
  <button class="btn-close-burnout" onclick="closeBurnoutPopup()">Voir mes droits â†’</button>
</div>

<!-- HUD -->
<div id="gaming-hud">
  <div class="hud-logo" id="hud-logo-btn" onclick="demoLogoClick()" style="cursor:pointer;user-select:none;">ğŸ¦Š FOX</div>
  <div class="hud-xp-section" onclick="openPopup('popup-leagues')" style="cursor:pointer;" title="Voir ma ligue">
    <div class="hud-xp-label">
      <span style="display:flex;align-items:center;gap:5px;">
        <span style="background:linear-gradient(135deg,rgba(255,140,66,0.4),rgba(255,107,53,0.3));border:1px solid rgba(255,140,66,0.7);border-radius:6px;padding:2px 8px;font-weight:900;font-size:0.85rem;text-shadow:0 0 8px rgba(255,140,66,0.6);">â­ <span id="hud-level">1</span></span>
        <span id="hud-league" style="font-weight:900;font-size:0.82rem;"></span>
      </span>
      <span style="color:#FF8C42;font-weight:900;font-size:0.82rem;"><span id="hud-xp">0</span><span style="color:#444;font-size:0.65em;"> / <span id="hud-xp-max">1000</span></span> <span style="color:#888;font-size:0.65em;">XP</span></span>
    </div>
    <div class="hud-xp-bar" style="height:8px;"><div class="hud-xp-fill" id="hud-xp-fill" style="width:0%;background:linear-gradient(90deg,#FF8C42,#FFD700);"></div></div>
    <div style="display:flex;justify-content:space-between;font-size:0.58rem;color:#444;margin-top:2px;"><span id="hud-xp-percent">0%</span><span id="hud-next-league" style="color:#666;"></span></div>
  </div>
  <div class="hud-stats">
    <div class="hud-stat" onclick="openPopup('popup-modules')" title="Voir les donnÃ©es heures sup" style="cursor:pointer;"><div class="hud-stat-icon">â±ï¸</div><div class="hud-stat-val" id="hud-hours">0</div><div class="hud-stat-lbl">H.SUP</div></div>
    <div class="hud-stat" onclick="openPopup('popup-burnout')" title="Voir l'Ã©nergie et burn-out" style="cursor:pointer;"><div class="hud-stat-icon">â¤ï¸</div><div class="hud-stat-val" id="hud-energy">100</div><div class="hud-stat-lbl">Ã‰NERGIE</div></div>
    <div class="hud-stat" onclick="openPopup('popup-burnout')" title="Voir le risque burn-out" style="cursor:pointer;"><div class="hud-stat-icon">ğŸ”¥</div><div class="hud-stat-val" id="hud-burnout">0</div><div class="hud-stat-lbl">RISQUE</div></div>
    <div class="hud-stat" onclick="openPopup('popup-badges')" title="Voir mes badges" style="cursor:pointer;"><div class="hud-stat-icon">ğŸ…</div><div class="hud-stat-val" id="hud-badges">0</div><div class="hud-stat-lbl">BADGES</div></div>
  </div>
  <div id="hud-buttons">
    <button class="hud-menu-btn" onclick="openPopup('popup-settings')">âš™ï¸</button>
    <a href="../menu.html" class="hud-menu-btn" style="text-decoration:none;">â† Menu</a>
  </div>
</div>

<!-- ZONE PRINCIPALE -->
<div id="gaming-main">

  <!-- Bulle de dialogue Kitsune -->
  <div id="kitsune-bubble" onclick="openPopup('popup-fox')">
    <div id="kitsune-bubble-text">ğŸ¦Š Je surveille tes heures et te guide !</div>
    <div class="bubble-tail"></div>
  </div>

  <!-- Renard central -->
  <div id="kitsune-center" onclick="openPopup('popup-fox')">
    <img id="kitsune-svg" src="../images/foxplayer.PNG" alt="Kitsune">
    <div id="kitsune-tap-hint">Appuie sur moi !</div>
  </div>

  <!-- Barre de risque centrale -->
  <div id="risk-bar-center">
    <div style="display:flex;justify-content:space-between;font-size:0.65rem;color:#fff;margin-bottom:4px;letter-spacing:1px;text-shadow:0 1px 6px rgba(0,0,0,0.9),0 0 12px rgba(0,0,0,0.8);font-weight:700;">
      <span>RISQUE GLOBAL</span><span id="risk-label-main">--</span>
    </div>
    <div class="risk-bar-track"><div class="risk-bar-fill" id="risk-bar-main" style="width:0%"></div></div>
  </div>

  <!-- Dock de boutons en bas -->
  <div id="action-dock">
    <button class="dock-btn" onclick="openPopup('popup-import')">
      <span class="dock-icon">ğŸ“¥</span>
      <span class="dock-label">Importer</span>
    </button>
    <button class="dock-btn" onclick="openPopup('popup-modules')">
      <span class="dock-icon">ğŸ“Š</span>
      <span class="dock-label">DonnÃ©es</span>
    </button>
    <button class="dock-btn" onclick="openPopup('popup-burnout')">
      <span class="dock-icon">ğŸ”¥</span>
      <span class="dock-label">Burn-Out</span>
    </button>
    <button class="dock-btn" onclick="openPopup('popup-quetes')">
      <span class="dock-icon">âš”ï¸</span>
      <span class="dock-label">QuÃªtes</span>
    </button>

    <button class="dock-btn" onclick="openPopup('popup-export')">
      <span class="dock-icon">ğŸ“„</span>
      <span class="dock-label">Export</span>
    </button>
  </div>

</div>

<!-- POP-UP KITSUNE -->
<div class="fox-popup-backdrop" id="popup-fox">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">ğŸ¦Š Kitsune â€” ton alliÃ©</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-fox')">âœ•</button>
    </div>
    <div style="text-align:center;margin-bottom:12px;">
      <img src="../images/foxplayer.PNG" alt="Kitsune" style="width:90px;height:90px;object-fit:contain;">
    </div>
    <div style="font-size:0.65rem;color:#555;text-align:center;margin-bottom:6px;letter-spacing:0.5px;">
      ğŸ¦Š Je te parle comme un ami â€” pas comme un avocat. En cas de doute, consulte un pro !
    </div>
    <div id="fox-text" style="background:rgba(255,140,66,0.08);border:1px solid rgba(255,140,66,0.2);border-radius:12px;padding:14px;color:#ccc;line-height:1.6;font-size:0.9rem;margin-bottom:14px;">
      ğŸ¦Š Salut ! Je surveille tes heures en ami. Clique sur moi depuis l'Ã©cran principal pour mes conseils !
    </div>
    <div id="kitsune-scenario-box" style="display:none;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:14px;margin-top:10px;color:#bbb;font-size:0.85rem;line-height:1.6;">
      <div id="kitsune-scenario-title" style="color:#FF8C42;font-weight:700;margin-bottom:8px;"></div>
      <div id="kitsune-scenario-text"></div>
      <div id="kitsune-scenario-actions" style="margin-top:10px;display:flex;flex-wrap:wrap;gap:6px;"></div>
    </div>
    <!-- Historique rÃ©compenses -->
    <div id="kitsune-rewards-section" style="margin-top:14px;border-top:1px solid rgba(255,255,255,0.07);padding-top:12px;">
      <div style="color:#666;font-size:0.68rem;letter-spacing:1px;margin-bottom:8px;">ğŸ“œ HISTORIQUE RÃ‰COMPENSES</div>
      <div id="kitsune-rewards-log" style="max-height:160px;overflow-y:auto;display:flex;flex-direction:column;gap:5px;">
        <div style="color:#444;font-size:0.78rem;text-align:center;padding:8px;">Aucune rÃ©compense dÃ©bloquÃ©e pour l'instant</div>
      </div>
    </div>
  </div>
</div>

<!-- POP-UP ANALYSE -->
<div class="fox-popup-backdrop" id="popup-analyse">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">âš–ï¸ Analyse Juridique</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-analyse')">âœ•</button>
    </div>
    <div style="font-size:0.75rem;color:#666;letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">Saisie semaine courante (heures/jour)</div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:10px;">
      <div style="text-align:center;font-size:0.65rem;color:#555;">Lun</div><div style="text-align:center;font-size:0.65rem;color:#555;">Mar</div><div style="text-align:center;font-size:0.65rem;color:#555;">Mer</div><div style="text-align:center;font-size:0.65rem;color:#555;">Jeu</div><div style="text-align:center;font-size:0.65rem;color:#555;">Ven</div><div style="text-align:center;font-size:0.65rem;color:#555;">Sam</div><div style="text-align:center;font-size:0.65rem;color:#555;">Dim</div>
      <input class="day-input" type="number" min="0" max="24" value="7" id="day0">
      <input class="day-input" type="number" min="0" max="24" value="7" id="day1">
      <input class="day-input" type="number" min="0" max="24" value="7" id="day2">
      <input class="day-input" type="number" min="0" max="24" value="7" id="day3">
      <input class="day-input" type="number" min="0" max="24" value="7" id="day4">
      <input class="day-input" type="number" min="0" max="24" value="0" id="day5">
      <input class="day-input" type="number" min="0" max="24" value="0" id="day6">
    </div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px;">
      <label style="display:flex;align-items:center;gap:5px;font-size:0.82rem;color:#aaa;cursor:pointer;"><input type="checkbox" id="chk-night"> Nuit</label>
      <label style="display:flex;align-items:center;gap:5px;font-size:0.82rem;color:#aaa;cursor:pointer;"><input type="checkbox" id="chk-sunday"> Dimanche</label>
      <label style="display:flex;align-items:center;gap:5px;font-size:0.82rem;color:#aaa;cursor:pointer;"><input type="checkbox" id="chk-saturday"> Samedi</label>
      <label style="display:flex;align-items:center;gap:5px;font-size:0.82rem;color:#aaa;cursor:pointer;"><input type="checkbox" id="chk-holiday"> FÃ©riÃ©</label>
    </div>
    <button onclick="runAnalyse()" style="width:100%;background:linear-gradient(135deg,#FF8C42,#FF6B35);border:none;color:#fff;border-radius:12px;padding:13px;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 4px 20px rgba(255,140,66,0.3);">âš¡ Analyser maintenant</button>
    <div id="analyse-results" style="display:none;margin-top:16px;">
      <div id="analyse-summary" style="background:rgba(255,140,66,0.08);border:1px solid rgba(255,140,66,0.2);border-radius:12px;padding:14px;color:#ccc;font-size:0.88rem;line-height:1.6;margin-bottom:10px;"></div>
      <div id="analyse-violations" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;"></div>
      <div id="analyse-scenarios" style="display:flex;flex-direction:column;gap:8px;"></div>
    </div>
  </div>
</div>

<!-- POP-UP MODULES -->
<div class="fox-popup-backdrop" id="popup-modules">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">ğŸ“Š DonnÃ©es M1 &amp; M2</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-modules')">âœ•</button>
    </div>
    <div id="modules-content" style="color:#ccc;font-size:0.9rem;"></div>
  </div>
</div>

<!-- POP-UP BURN-OUT -->
<div class="fox-popup-backdrop" id="popup-burnout">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">ğŸ”¥ Score Burn-Out</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-burnout')">âœ•</button>
    </div>
    <div id="burnout-popup-content" style="color:#ccc;"></div>
  </div>
</div>

<!-- POP-UP QUETES -->
<div class="fox-popup-backdrop" id="popup-quetes">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">âš”ï¸ QuÃªtes &amp; Combats</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-quetes')">âœ•</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
      <button onclick="openPopup('popup-badges')" style="background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.2);color:#FFD700;border-radius:12px;padding:14px;cursor:pointer;font-size:0.88rem;font-weight:700;">ğŸ… Mes Badges</button>
      <button onclick="openPopup('popup-skills')" style="background:rgba(100,200,255,0.08);border:1px solid rgba(100,200,255,0.2);color:#64C8FF;border-radius:12px;padding:14px;cursor:pointer;font-size:0.88rem;font-weight:700;">ğŸŒŸ CompÃ©tences</button>
    </div>
    <div id="quests-list" style="display:flex;flex-direction:column;gap:8px;"></div>
  </div>
</div>

<!-- POP-UP SCENARIOS -->
<div class="fox-popup-backdrop" id="popup-scenarios">
  <div class="fox-popup" style="max-width:680px;">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">ğŸ“š ScÃ©narios FOX (600)</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-scenarios')">âœ•</button>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
      <input id="scenario-search" type="text" placeholder="Rechercherâ€¦"
        style="flex:1;min-width:160px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);color:#fff;border-radius:8px;padding:8px 12px;font-size:0.85rem;"
        oninput="filterScenarios()">
      <select id="scenario-risk" onchange="filterScenarios()"
        style="background:rgba(20,20,40,0.95);border:1px solid rgba(255,255,255,0.15);color:#fff;border-radius:8px;padding:8px 10px;font-size:0.85rem;">
        <option value="">Tous risques</option>
        <option value="aucun">âœ… Aucun</option>
        <option value="faible">ğŸ’› Faible</option>
        <option value="moyen">ğŸ§¡ Moyen</option>
        <option value="Ã©levÃ©">ğŸ”´ Ã‰levÃ©</option>
        <option value="critique">ğŸš¨ Critique</option>
      </select>
    </div>
    <div id="scenarios-list" style="max-height:420px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;"></div>
    <div id="scenarios-count" style="text-align:center;color:#555;font-size:0.75rem;margin-top:8px;"></div>
  </div>
</div>

<!-- POP-UP EXPORT -->
<div class="fox-popup-backdrop" id="popup-export">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">ğŸ“„ Exporter</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-export')">âœ•</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <button onclick="exportRTFFull()"    class="export-btn">ğŸ“ RTF complet</button>
      <button onclick="exportJSONFull()"   class="export-btn">ğŸ“¦ JSON tout</button>
      <button onclick="exportModule1()"    class="export-btn">ğŸ“Š JSON M1</button>
      <button onclick="exportModule2()"    class="export-btn">ğŸ“Š JSON M2</button>
      <button onclick="exportHistorique()" class="export-btn" style="grid-column:span 2;background:rgba(255,140,66,0.1);color:#FF8C42;">ğŸ•°ï¸ Historique multi-annÃ©es</button>
    </div>
  </div>
</div>



<!-- POP-UP LEAGUES -->
<div class="fox-popup-backdrop" id="popup-leagues">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">\u{1F3C6} Ligues de progression</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-leagues')">\u2715</button>
    </div>
    <div id="leagues-grid" style="display:flex;flex-direction:column;gap:8px;max-height:480px;overflow-y:auto;"></div>
  </div>
</div>

<!-- POP-UP IMPORT -->
<div class="fox-popup-backdrop" id="popup-import">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">ğŸ“¥ Importer des donnÃ©es</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-import')">âœ•</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:12px;color:#ccc;font-size:0.88rem;">
      <div style="background:rgba(255,140,66,0.06);border:1px solid rgba(255,140,66,0.15);border-radius:10px;padding:12px;line-height:1.6;">
        ğŸ“‚ Pour importer tes donnÃ©es M1 ou M2, ouvre directement le <strong style="color:#FF8C42;">Module 1</strong> ou <strong style="color:#FF8C42;">Module 2</strong> depuis le menu principal et saisis tes heures. FOX dÃ©tecte automatiquement les nouvelles donnÃ©es.
      </div>
      <div style="color:#666;font-size:0.72rem;letter-spacing:1px;margin-top:4px;">IMPORT FICHIER JSON</div>
      <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:12px;">
        <input type="file" id="import-json-file" accept=".json" style="color:#aaa;font-size:0.82rem;width:100%;" onchange="importJSONFile(this)">
        <div style="color:#555;font-size:0.72rem;margin-top:6px;">Format : export JSON FOX Engine (M1, M2 ou complet)</div>
      </div>
      <button onclick="importFromClipboard()" style="background:rgba(100,200,255,0.08);border:1px solid rgba(100,200,255,0.2);color:#64C8FF;border-radius:10px;padding:11px;font-weight:700;cursor:pointer;">ğŸ“‹ Coller depuis le presse-papier</button>
      <div id="import-status" style="display:none;border-radius:10px;padding:10px;font-size:0.82rem;text-align:center;"></div>
    </div>
  </div>
</div>
<!-- POP-UP BADGES -->
<div class="fox-popup-backdrop" id="popup-badges">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">ğŸ… Collection Badges</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-badges')">âœ•</button>
    </div>
    <div id="badges-filter" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;">
      <button onclick="filterBadgesByRarity('all')" class="badge-filter-btn active" data-rarity="all">Tous</button>
      <button onclick="filterBadgesByRarity('common')" class="badge-filter-btn" data-rarity="common" style="color:#b0b0b0;">Communs</button>
      <button onclick="filterBadgesByRarity('rare')" class="badge-filter-btn" data-rarity="rare" style="color:#5094ff;">Rares</button>
      <button onclick="filterBadgesByRarity('epic')" class="badge-filter-btn" data-rarity="epic" style="color:#a050ff;">Ã‰piques</button>
      <button onclick="filterBadgesByRarity('legendary')" class="badge-filter-btn" data-rarity="legendary" style="color:#FFD700;">LÃ©gendaires</button>
    </div>
    <div id="badges-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(76px,1fr));gap:8px;max-height:420px;overflow-y:auto;"></div>
  </div>
</div>

<!-- POP-UP COMPÃ‰TENCES (IDs 51-65) -->
<div class="fox-popup-backdrop" id="popup-skills">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">ğŸŒŸ CompÃ©tences</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-skills')">âœ•</button>
    </div>
    <div style="color:#555;font-size:0.75rem;margin-bottom:10px;">RÃ©compenses liÃ©es Ã  ton utilisation de FOX Engine</div>
    <div id="skills-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(76px,1fr));gap:8px;max-height:420px;overflow-y:auto;"></div>
  </div>
</div>

<!-- Image agrandie (badges/compÃ©tences) -->
<div id="badge-zoom-overlay" onclick="this.style.display='none'" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.88);align-items:center;justify-content:center;flex-direction:column;cursor:pointer;">
  <img id="badge-zoom-img" src="" style="max-width:260px;max-height:260px;object-fit:contain;border-radius:16px;box-shadow:0 0 60px rgba(255,140,66,0.4);">
  <div id="badge-zoom-name" style="color:#FF8C42;font-weight:900;font-size:1.1rem;margin-top:16px;"></div>
  <div id="badge-zoom-desc" style="color:#888;font-size:0.85rem;margin-top:6px;max-width:280px;text-align:center;"></div>
</div>

<!-- POP-UP SETTINGS -->
<div class="fox-popup-backdrop" id="popup-settings">
  <div class="fox-popup">
    <div class="fox-popup-header">
      <h2 class="fox-popup-title">âš™ï¸ Options</h2>
      <button class="fox-popup-close" onclick="closePopup('popup-settings')">âœ•</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:16px;color:#ccc;font-size:0.9rem;">
      <div>
        <div style="color:#888;font-size:0.72rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Animations d'alerte</div>
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" id="toggle-burnout-anim" checked onchange="toggleBurnoutAnimations(this.checked)">
          Effets visuels burn-out actifs
        </label>
      </div>
      <div>
        <div style="color:#888;font-size:0.72rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">AnnÃ©es dans localStorage</div>
        <div id="detected-years" style="color:#FF8C42;font-size:0.88rem;">â€”</div>
      </div>
      <div>
        <div style="color:#888;font-size:0.72rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Reset RPG</div>
        <button onclick="resetRPGConfirm()" style="background:rgba(229,57,53,0.1);border:1px solid rgba(229,57,53,0.25);color:#E53935;border-radius:8px;padding:8px 16px;cursor:pointer;font-size:0.85rem;">ğŸ—‘ï¸ RÃ©initialiser progression RPG</button>
      </div>
      <div>
        <div style="color:#888;font-size:0.72rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Diagnostic</div>
        <button onclick="debugM1Data()" style="background:rgba(255,140,66,0.08);border:1px solid rgba(255,140,66,0.2);color:#FF8C42;border-radius:8px;padding:8px 16px;cursor:pointer;font-size:0.85rem;">ğŸ” Debug lecture M1</button>
      </div>
    </div>
  </div>
</div>


<style>
/* Animations rÃ©compenses */
@keyframes badgeUnlock {
  0%  { transform: scale(0.3) rotate(-15deg); opacity: 0; }
  60% { transform: scale(1.2) rotate(5deg);  opacity: 1; }
  80% { transform: scale(0.95); }
  100%{ transform: scale(1); }
}
@keyframes levelUpPulse {
  0%   { box-shadow: 0 0 0 0 rgba(255,215,0,0.7); transform: scale(1); }
  50%  { box-shadow: 0 0 0 20px rgba(255,215,0,0); transform: scale(1.05); }
  100% { box-shadow: 0 0 0 0 rgba(255,215,0,0); transform: scale(1); }
}
@keyframes rewardPop {
  0%   { transform: translateY(30px); opacity: 0; }
  100% { transform: translateY(0);    opacity: 1; }
}
.badge-unlock-anim { animation: badgeUnlock 0.6s ease forwards; }
.level-up-anim    { animation: levelUpPulse 1s ease 3; }

/* HUD stat cliquable */
.hud-stat { transition: transform 0.15s, background 0.15s; border-radius: 8px; padding: 4px 6px; }
.hud-stat:hover { transform: scale(1.08); background: rgba(255,140,66,0.12); }

/* Badge filter buttons */
.badge-filter-btn {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.12);
  color: #888;
  border-radius: 8px;
  padding: 4px 10px;
  font-size: 0.75rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}
.badge-filter-btn.active, .badge-filter-btn:hover {
  background: rgba(255,140,66,0.15);
  border-color: rgba(255,140,66,0.4);
  color: #FF8C42;
}

/* Badge zoom overlay flex */
#badge-zoom-overlay { display: none; }
#badge-zoom-overlay.show { display: flex !important; }

/* RÃ©compense verrouillÃ©e */
.badge-locked {
  filter: grayscale(100%) brightness(0.3);
  cursor: default;
}
.badge-locked-icon {
  position: absolute; top: 2px; right: 2px;
  font-size: 0.65rem; color: #444;
}

/* Mode dÃ©mo â€” sidebar droite, pas plein Ã©cran */
#popup-demo-panel {
  max-width: 340px !important;
  left: auto !important;
  right: 0 !important;
  top: 0 !important;
  bottom: 0 !important;
  inset: auto !important;
  width: 340px !important;
  border-left: 2px solid rgba(255,140,66,0.3) !important;
  box-shadow: -10px 0 40px rgba(0,0,0,0.8) !important;
  transition: width 0.25s ease !important;
  overflow: hidden !important;
}
#popup-demo-panel[data-minimized="1"] {
  width: 42px !important;
  overflow: hidden !important;
}
#popup-demo-panel[data-minimized="1"] > div {
  display: none !important;
}
/* Sur mobile : sidebar 80% max-width */
@media (max-width: 480px) {
  #popup-demo-panel { max-width: 80vw !important; }
}

/* Notification rÃ©compense */
.reward-notification {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, rgba(20,20,40,0.97), rgba(30,20,50,0.97));
  border: 2px solid #FFD700;
  border-radius: 16px;
  padding: 14px 20px;
  z-index: 9990;
  text-align: center;
  animation: rewardPop 0.4s ease forwards;
  box-shadow: 0 0 40px rgba(255,215,0,0.3);
  max-width: 300px;
}

/* Ligue dans HUD â€” plus visible */
#hud-league { font-size: 0.82rem; color: #FFD700; }
#hud-league img { filter: drop-shadow(0 0 4px rgba(255,215,0,0.5)); }
</style>
<style>
.day-input{width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#fff;border-radius:6px;padding:7px 2px;text-align:center;font-size:0.9rem;-moz-appearance:textfield;}
.day-input::-webkit-outer-spin-button,.day-input::-webkit-inner-spin-button{-webkit-appearance:none;}
.day-input:focus{outline:none;border-color:#FF8C42;}
.export-btn{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);color:#ddd;border-radius:10px;padding:12px 8px;cursor:pointer;font-size:0.85rem;transition:all 0.2s;}
.export-btn:hover{background:rgba(255,140,66,0.1);border-color:rgba(255,140,66,0.3);color:#FF8C42;}
.violation-tag{display:inline-flex;align-items:center;gap:5px;background:rgba(229,57,53,0.12);border:1px solid rgba(229,57,53,0.25);border-radius:8px;padding:5px 10px;font-size:0.78rem;color:#ff8a80;}
.scenario-card-mini{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:9px;padding:11px 13px;cursor:pointer;transition:all 0.2s;}
.scenario-card-mini:hover{background:rgba(255,140,66,0.05);border-color:rgba(255,140,66,0.2);}
.scenario-card-mini .sc-name{font-weight:700;color:#eee;font-size:0.87rem;}
.scenario-card-mini .sc-legal{font-size:0.76rem;color:#777;margin-top:3px;}
</style>

<!-- Scripts (ordre inchangÃ©) -->
<script src="js/safety.js"></script>
<script src="js/storage.js"></script>
<script src="js/config.js"></script>
<script src="js/assets-config.js"></script>
<script src="js/modes.js"></script>
<script src="js/xp-system.js"></script>
<script src="js/leagues.js"></script>
<script src="js/badges.js"></script>
<script src="js/milestones.js"></script>
<script src="js/rpg-system.js"></script>
<script src="js/module3.js"></script>
<script src="js/quests.js"></script>
<script src="js/combat.js"></script>
<script src="js/skills.js"></script>
<script src="js/inventory.js"></script>
<script src="js/module-loader.js"></script>
<script src="js/scenarios-fox-data.js"></script>
<script src="js/scenarios-fox.js"></script>
<script src="js/scenarios-ai.js"></script>
<script src="js/legal-engine.js"></script>
<script src="js/data-bridge.js"></script>
<script src="js/module-reader.js?v=3"></script>
<script src="js/snapshot-system.js"></script>
<script src="js/export-rtf.js"></script>
<script src="js/ai-integration.js"></script>
<script src="js/main-rpg.js"></script>

<script>
/* \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
   ORCHESTRATEUR GAMING UI
\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550 */


// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
//  KITSUNE : narration automatique lors de nouvelles HS
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550

const _kitsuneMessages = [
  { min: 0.5, max: 2,  msg: "\uD83E\uDD8A +{h}h sup d\u00E9tect\u00E9es. Une petite heure de plus... rappelle-toi : apr\u00E8s 35h, chaque heure doit \u00EAtre compens\u00E9e ou major\u00E9e (art. L3121-28 CT)." },
  { min: 2,   max: 5,  msg: "\uD83E\uDD8A {h}h sup suppl\u00E9mentaires. Tu cumules. Pense \u00E0 v\u00E9rifier si ces heures figurent bien sur ton bulletin de paie." },
  { min: 5,   max: 10, msg: "\uD83E\uDD8A {h}h sup cette semaine ! Au-del\u00E0 de 43h, le taux de majoration passe \u00E0 50% (selon ta convention collective)." },
  { min: 10,  max: 20, msg: "\uD83E\uDD8A {h}h sup d\u00E9tect\u00E9es ! C'est significatif. V\u00E9rifie ton contingent annuel \u2014 il est g\u00E9n\u00E9ralement fix\u00E9 \u00E0 220h (art. D3121-24 CT)." },
  { min: 20,  max: 999, msg: "\uD83E\uDD8A {h}h sup d'un coup ! C'est beaucoup. Pense \u00E0 demander une r\u00E9cup\u00E9ration ou un repos compensateur obligatoire (art. L3121-33 CT)." },
];

const _kitsuneScenarioTips = [
  { condition: h => h >= 8,   title: "Limite journali\u00E8re", text: "La dur\u00E9e maximale journali\u00E8re est 10h (12h exceptionnellement). Au-del\u00E0, c'est une infraction (art. L3121-18 CT).", actions: ["Demander le registre des heures", "Contacter l'inspection du travail"] },
  { condition: h => h >= 48,  title: "Limite hebdomadaire", text: "48h est le maximum absolu sur une semaine (60h en d\u00E9rogation exceptionnelle). Au-del\u00E0, ton employeur risque une amende.", actions: ["R\u00E9clamation \u00E9crite \u00E0 l'employeur", "Saisir les Prud'hommes"] },
  { condition: () => true,    title: "Bon \u00E0 savoir", text: "Les heures suppl\u00E9mentaires doivent \u00EAtre pay\u00E9es dans le mois suivant leur r\u00E9alisation, sauf accord de r\u00E9cup\u00E9ration \u00E9crit sign\u00E9.", actions: ["V\u00E9rifier ton bulletin de paie", "Consulter ta convention collective"] },
];

function kitsuneNarrateOvertime(deltaH, source) {
  try {
    const h = Math.round(deltaH * 10) / 10;

    // \u2500\u2500 Bulle principale (message court) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
    const msg = _kitsuneMessages.find(m => h >= m.min && h < m.max);
    const bubbleText = msg ? msg.msg.replace('{h}', h) : '\uD83E\uDD8A ' + h + 'h sup d\u00E9tect\u00E9es.';
    const bubbleEl = document.getElementById('kitsune-bubble-text');
    if (bubbleEl) bubbleEl.textContent = bubbleText;

    // \u2500\u2500 S\u00E9lection sc\u00E9nario FOX adapt\u00E9 \u00E0 la situation \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
    let scenario = null;
    if (typeof FOX_SCENARIOS !== 'undefined' && FOX_SCENARIOS.length > 0) {
      const bo  = moduleReader.getBurnoutScore ? moduleReader.getBurnoutScore() : { score: 0 };
      const cum = moduleReader.getCumulatedSummary ? moduleReader.getCumulatedSummary() : {};
      let pool  = FOX_SCENARIOS;

      // Priorit\u00E9 1 : burn-out critique \u2192 sc\u00E9narios bien-\u00EAtre (401-600)
      if (bo.score >= 60) {
        const wellbeing = FOX_SCENARIOS.filter(s => s.id >= 401);
        if (wellbeing.length > 0) pool = wellbeing;
      }
      // Priorit\u00E9 2 : burn-out mod\u00E9r\u00E9 \u2192 mix bien-\u00EAtre + repos
      else if (bo.score >= 40) {
        const mixed = FOX_SCENARIOS.filter(s => s.id >= 401 || s.category === 'repos');
        if (mixed.length > 0) pool = mixed;
      }
      // Priorit\u00E9 3 : HS d\u00E9passant 48h semaine \u2192 sc\u00E9narios limite/violation
      else if (h >= 13) {
        pool = FOX_SCENARIOS.filter(s =>
          ['limite','extreme','repos'].includes(s.category) ||
          (s.conseil && s.conseil.alerte && s.conseil.alerte.niveau === 'danger')
        );
        if (!pool.length) pool = FOX_SCENARIOS;
      }
      // Priorit\u00E9 4 : HS+50% \u2192 sc\u00E9narios haute intensit\u00E9
      else if (cum.totalPlus50 > 0) {
        pool = FOX_SCENARIOS.filter(s =>
          s.category === 'intense' && s.risk && (s.risk === '\u00E9lev\u00E9' || s.risk === 'critique')
        );
        if (!pool.length) pool = FOX_SCENARIOS.filter(s => s.category === 'intense');
        if (!pool.length) pool = FOX_SCENARIOS;
      }
      // Priorit\u00E9 5 : heures normales \u2192 sc\u00E9narios standard/intense adapt\u00E9s
      else if (h > 0) {
        pool = FOX_SCENARIOS.filter(s =>
          ['standard','intense','partiel'].includes(s.category)
        );
        if (!pool.length) pool = FOX_SCENARIOS;
      }

      // \u00C9viter les 10 derniers sc\u00E9narios narr\u00E9s (vari\u00E9t\u00E9)
      const narrated = JSON.parse(localStorage.getItem('FOX_SCENARIOS_NARRATED') || '[]');
      const recentIds = narrated.slice(-10);
      const fresh = pool.filter(s => !recentIds.includes(s.id));
      const finalPool = fresh.length > 0 ? fresh : pool;

      // S\u00E9lection al\u00E9atoire dans le pool filtr\u00E9
      scenario = finalPool[Math.floor(Math.random() * finalPool.length)];
    }

    // \u2500\u2500 Tracker le sc\u00E9nario narr\u00E9 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
    if (scenario) {
      const narrated = JSON.parse(localStorage.getItem('FOX_SCENARIOS_NARRATED') || '[]');
      if (!narrated.includes(scenario.id)) {
        narrated.push(scenario.id);
        localStorage.setItem('FOX_SCENARIOS_NARRATED', JSON.stringify(narrated));
      }
    }

    // \u2500\u2500 Afficher le sc\u00E9nario dans le popup Kitsune \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
    const conseil = scenario && scenario.conseil ? scenario.conseil : null;
    const title_txt = conseil ? conseil.titre : (scenario ? scenario.name : '\uD83D\uDCCB Conseil');
    const body_txt  = conseil ? conseil.message : (scenario ? (scenario.desc || '') : bubbleText);
    const actions   = conseil && conseil.actions ? conseil.actions : [];
    const alerte    = conseil && conseil.alerte  ? conseil.alerte  : null;

    // Couleur selon niveau d'alerte
    const alerteColor = !alerte ? '#FF8C42'
      : alerte.niveau === 'danger'  ? '#E53935'
      : alerte.niveau === 'warning' ? '#FF8C42'
      : '#4CAF50';

    const box   = document.getElementById('kitsune-scenario-box');
    const title = document.getElementById('kitsune-scenario-title');
    const body  = document.getElementById('kitsune-scenario-text');
    const acts  = document.getElementById('kitsune-scenario-actions');

    if (box && title && body) {
      title.textContent = '\uD83D\uDCCB ' + title_txt;
      title.style.color = alerteColor;
      body.textContent  = body_txt;
      if (acts) {
        acts.innerHTML = actions.map(a =>
          '<span style="background:rgba(255,140,66,0.12);border:1px solid rgba(255,140,66,0.25);border-radius:8px;padding:4px 10px;font-size:0.75rem;color:#FF8C42;margin:2px;display:inline-block;">' + a + '</span>'
        ).join('');
      }
      if (alerte) {
        acts.innerHTML += '<br><span style="color:' + alerteColor + ';font-size:0.78rem;font-weight:700;">' + alerte.texte + '</span>';
      }
      box.style.display = 'block';

      const foxText = document.getElementById('fox-text');
      if (foxText) foxText.innerHTML =
        '<strong style="color:' + alerteColor + ';">\uD83E\uDD8A ' + h + 'h sup viennent d\'\u00EAtre d\u00E9tect\u00E9es !</strong><br><br>' + body_txt;
    }
  } catch(e) { console.warn('kitsuneNarrateOvertime:', e); }
}

// \u2500\u2500 Pop-ups \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function openPopup(id) {
  const bd = document.getElementById(id); if (!bd) return;
  bd.classList.add('open');
  requestAnimationFrame(() => {
    const p = bd.querySelector('.fox-popup'); if (p) p.classList.add('popin');
  });
  if (id==='popup-modules')  { syncModulesAndAwardXP('popup'); setTimeout(refreshModulesPopup, 150); }
  else if (id==='popup-analyse') { syncModulesAndAwardXP('popup'); }
  if (id==='popup-burnout')  refreshBurnoutPopup();
  if (id==='popup-quetes')   refreshQuestesPopup();
  if (id==='popup-scenarios') initScenariosPopup();
  if (id==='popup-badges')   refreshBadgesPopup();
  if (id==='popup-skills')   refreshSkillsPopup();
  if (id==='popup-settings') refreshSettings();
  if (id==='popup-fox')      refreshKitsunePopup();
  if (id==='popup-leagues')  refreshLeaguesPopup();
}
function closePopup(id) {
  const bd = document.getElementById(id); if (!bd) return;
  const p = bd.querySelector('.fox-popup'); if (p) p.classList.remove('popin');
  setTimeout(() => bd.classList.remove('open'), 350);
}
document.querySelectorAll('.fox-popup-backdrop').forEach(bd => {
  bd.addEventListener('click', e => { if (e.target===bd) closePopup(bd.id); });
});
document.addEventListener('keydown', e => {
  if (e.key==='Escape') {
    document.querySelectorAll('.fox-popup-backdrop.open').forEach(bd => closePopup(bd.id));
    document.getElementById('burnout-popup').classList.remove('visible');
  }
});

// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
//  SYNC M1/M2 \u2192 M3 avec attribution XP automatique
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550

// M\u00E9moriser les derniers totaux connus pour calculer le delta XP
// Cumuls persist\u00E9s en localStorage pour \u00E9viter re-attribution XP au rechargement
function _loadLastCumul() {
  try {
    const s = localStorage.getItem('FOX_LAST_CUMUL');
    return s ? JSON.parse(s) : { m1: -1, m2: -1 };
  } catch(e) { return { m1: -1, m2: -1 }; }
}
function _saveLastCumul(m1, m2) {
  try { localStorage.setItem('FOX_LAST_CUMUL', JSON.stringify({ m1, m2 })); } catch(e) {}
}
const _initCumul = _loadLastCumul();
let _lastM1Net = _initCumul.m1;  // M1 : netOvertime cumul\u00E9 toutes ann\u00E9es
let _lastM2Tot = _initCumul.m2;  // M2 : annualHours cumul\u00E9 toutes ann\u00E9es
let _lastYear   = '';  // Ann\u00E9e active pour d\u00E9tecter changement

function syncModulesAndAwardXP(source) {
  try {
    // D\u00E9tecter changement d'ann\u00E9e
    const currentYear = localStorage.getItem('ACTIVE_YEAR_SUFFIX') || String(new Date().getFullYear());
    if (currentYear !== _lastYear && _lastYear !== '') {
      console.log('\uD83E\uDD8A M3 : changement d\'ann\u00E9e d\u00E9tect\u00E9 \u2192 ' + currentYear);
      showNotification('\uD83D\uDCC5 Ann\u00E9e ' + currentYear + ' charg\u00E9e dans FOX', 'info');
    }
    _lastYear = currentYear;

    // Recharger les donn\u00E9es M1/M2
    moduleReader.syncWithGameState();

    // Calculer les cumuls toutes ann\u00E9es
    const history  = moduleReader.getFullHistory();
    const years    = history.years || [];

    let cumM1Net = 0;  // M1 : heures sup nettes cumul\u00E9es
    let cumM2Tot = 0;  // M2 : heures sup directes cumul\u00E9es

    years.forEach(y => {
      const d = history.history[y];
      if (d.m1 && d.m1.hasData) {
        // M1 : utilise netOvertime calcule semaine par semaine (absences deduites)
        cumM1Net += Math.max(0, d.m1.netOvertime || 0);
      }
      if (d.m2 && d.m2.hasData) {
        // M2 : 1h sup = 1h directement
        cumM2Tot += Math.max(0, d.m2.totalAnnual || d.m2.annualHours || 0);
      }
    });

    // Source primaire s\u00E9lectionn\u00E9e automatiquement
    const primary = moduleReader.selectPrimaryModule ? moduleReader.selectPrimaryModule() : 'M1';
    const newTotal = primary === 'M2' ? cumM2Tot : (cumM1Net + cumM2Tot > 0 ? Math.max(cumM1Net, cumM2Tot) : 0);

    // === Attribution XP si nouvelles heures d\u00E9tect\u00E9es ===
    const oldM1 = _lastM1Net;
    const oldM2 = _lastM2Tot;

    // Calcul delta : premier sync (-1) = on accorde XP sur tout le cumul existant
    const isFirstSync = (_lastM1Net < 0 && _lastM2Tot < 0);
    const deltaM1 = isFirstSync
      ? cumM1Net
      : Math.max(0, cumM1Net - Math.max(0, _lastM1Net));
    const deltaM2 = isFirstSync
      ? cumM2Tot
      : Math.max(0, cumM2Tot - Math.max(0, _lastM2Tot));

    const totalDelta = primary === 'M2'
      ? deltaM2
      : (deltaM1 > 0 ? deltaM1 : deltaM2);

    if (totalDelta > 0.09 && typeof xpSystem !== 'undefined') {
      // addXP prend des HEURES (xpPerHour=100), pas des points XP
      const result = xpSystem.addXP(totalDelta); // totalDelta en heures
      const xpGain = result ? result.xpGained : Math.round(totalDelta * 100);

      // Sync gameState
      if (typeof gameState !== 'undefined') {
        if (gameState.player) {
          gameState.player.xp    = xpSystem.currentXP;
          gameState.player.level = xpSystem.level;
        }
        if (gameState.hours) gameState.hours.total = (gameState.hours.total || 0) + totalDelta;
        if (typeof saveGameState === 'function') saveGameState();
      }

      if (!isFirstSync) {
        showNotification('\u26A1 +' + xpGain + ' XP \u2014 ' + totalDelta.toFixed(1) + 'h sup d\u00E9tect\u00E9es (' + primary + ')', 'success');
        kitsuneNarrateOvertime(totalDelta, primary);
      } else {
        console.log('FOX init : ' + totalDelta.toFixed(1) + 'h cumul\u00E9es \u2192 +' + xpGain + ' XP (source: ' + primary + ')');
      }
    }

    _lastM1Net = cumM1Net;
    _lastM2Tot = cumM2Tot;
    _saveLastCumul(cumM1Net, cumM2Tot);

    // Rafra\u00EEchir tout l'affichage
    refreshHUD();
    if (typeof updateAllDisplays === 'function') {
      try { updateAllDisplays(); } catch(e) {}
    }

    // V\u00E9rifier les badges d\u00E9bloqu\u00E9s
    if (typeof checkAndAwardBadges === 'function') {
      setTimeout(checkAndAwardBadges, 500);
    }

  } catch(e) {
    console.warn('syncModulesAndAwardXP:', e);
    try { refreshHUD(); } catch(ex) {}
  }
}

// \u2500\u2500 Polling auto toutes les 20 secondes \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
let _syncInterval = null;
function startSyncPolling() {
  if (_syncInterval) clearInterval(_syncInterval);
  _syncInterval = setInterval(() => syncModulesAndAwardXP('poll'), 20000);
}

// \u2500\u2500 \u00C9couter les changements localStorage (depuis M1/M2) \u2500\u2500\u2500\u2500\u2500\u2500\u2500
window.addEventListener('storage', (e) => {
  // R\u00E9agir si M1, M2 ou l'ann\u00E9e active changent
  if (e.key && (
    e.key.startsWith('DATA_REPORT_') ||
    e.key.startsWith('CA_HS_TRACKER_V1_DATA_') ||
    e.key === 'ACTIVE_YEAR_SUFFIX'
  )) {
    setTimeout(() => syncModulesAndAwardXP('storage-event'), 300);
  }
});

// \u2500\u2500 Init \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
document.addEventListener('DOMContentLoaded', () => {
  // Exposer BADGES et LEAGUES globalement d\u00E8s le chargement
  setTimeout(() => {
    if (typeof badgeSystem !== 'undefined' && badgeSystem.badges && badgeSystem.badges.length > 0) {
      window.BADGES = badgeSystem.badges;
    } else if (typeof rpgSystem !== 'undefined' && rpgSystem.badges && rpgSystem.badges.length > 0) {
      window.BADGES = rpgSystem.badges;
    }
    console.log('[INIT] window.BADGES peupl\u00E9:', (window.BADGES||[]).length, 'badges');
  }, 300);
  setTimeout(() => syncModulesAndAwardXP('init'), 800);
  startSyncPolling();
  setTimeout(checkBurnoutAlert, 1500);
  // Bonus XP multi-ann\u00E9es : attribu\u00E9 une seule fois par session
  setTimeout(() => {
    try {
      const cum = moduleReader.getCumulatedSummary ? moduleReader.getCumulatedSummary() : null;
      if (cum && cum.xpBonus > 0 && typeof gainXP === 'function') {
        const key = 'fox_multiyear_xp_applied';
        const already = sessionStorage.getItem(key);
        if (!already) {
          gainXP(cum.xpBonus, `${cum.years.length} ann\u00E9es de donn\u00E9es d\u00E9tect\u00E9es`);
          sessionStorage.setItem(key, '1');
          console.log(`\uD83C\uDFC6 Bonus XP multi-ann\u00E9es : +${cum.xpBonus} XP pour ${cum.years.length} an(s)`);
        }
      }
    } catch(e) {}
  }, 2000);
});

// \u2500\u2500 HUD \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function setFoxSource(source) {
  if (!moduleReader.setSourceOverride) return;
  moduleReader.setSourceOverride(source);
  setTimeout(() => { refreshModulesPopup(); refreshHUD(); }, 100);
  // Exposer BADGES globalement depuis badgeSystem
  if (typeof badgeSystem !== 'undefined' && badgeSystem.badges) {
    window.BADGES = badgeSystem.badges;
  } else if (typeof rpgSystem !== 'undefined' && rpgSystem.badges) {
    window.BADGES = rpgSystem.badges;
  }
}

function refreshHUD() {
  try {
    if (typeof xpSystem !== 'undefined') {
      const lvl = xpSystem.level || 1;
      const xp  = xpSystem.currentXP || 0;
      const progress = xpSystem.getCurrentLevelProgress ? xpSystem.getCurrentLevelProgress() : {current:xp,needed:1000,percentage:0};
      document.getElementById('hud-level').textContent  = lvl;
      document.getElementById('hud-xp').textContent     = progress.current || xp;
      document.getElementById('hud-xp-max').textContent = progress.needed  || 1000;
      document.getElementById('hud-xp-fill').style.width = Math.min(100, progress.percentage || 0)+'%';
      const pct = document.getElementById('hud-xp-percent');
      if (pct) pct.textContent = Math.min(100, Math.round(progress.percentage || 0)) + '% niveau suivant';
      if (typeof leagueSystem !== 'undefined' && leagueSystem.getCurrentLeague) {
        const _xpForLeague = xpSystem ? xpSystem.currentXP : 0;
        const leagueData = leagueSystem.leagues ? leagueSystem.leagues.find(l => l.name === leagueSystem.getCurrentLeague(_xpForLeague)?.name) : null;
        const lgEl = document.getElementById('hud-league');
        if (lgEl) {
          if (leagueData && leagueData.img) {
            lgEl.innerHTML = '<img src="' + leagueData.img + '" alt="' + (leagueData.name||'') + '" style="height:18px;vertical-align:middle;margin-right:3px;filter:drop-shadow(0 0 4px rgba(255,215,0,0.5));" onerror="this.style.display=\'none\'"> ' + (leagueData.name||'Bronze');
          } else {
            lgEl.textContent = leagueSystem.getCurrentLeague(lvl)?.name || 'Bronze';
          }
        }
        // Prochaine ligue
        const nextLgEl = document.getElementById('hud-next-league');
        if (nextLgEl && typeof leagueSystem.leagues !== 'undefined') {
          const leagues = leagueSystem.leagues || [];
          const curIdx = leagues.findIndex(l => l.name === (leagueData && leagueData.name));
          if (curIdx >= 0 && curIdx < leagues.length - 1) {
            const nextL = leagues[curIdx + 1];
            if (nextL && nextL.xpMin) {
              const remaining = Math.max(0, nextL.xpMin - (xpSystem.currentXP || 0));
              nextLgEl.textContent = remaining > 0 ? remaining + ' XP \u2192 ' + nextL.name : '\uD83C\uDFC6 ' + nextL.name;
            }
          } else { nextLgEl.textContent = ''; }
        }
      }
      // Lire les deux sources de badges
      const _allBadgesCount = _getUnlockedIds ? _getUnlockedIds().length : (gameState.badges?.length||0);
      document.getElementById('hud-badges').textContent = _allBadgesCount;
    }
    const bo      = moduleReader.getBurnoutScore ? moduleReader.getBurnoutScore() : {score:0,level:'sain'};
    const rolling = moduleReader.getRollingAnalysis ? moduleReader.getRollingAnalysis(12) : {avgTotal:35,violations:{over48:0,over35:0},trend:'stable',weeksAnalyzed:0};
    const boEl = document.getElementById('hud-burnout');
    boEl.textContent = bo.score;
    if (bo.score>=60) { boEl.classList.add('danger-val'); }
    else { boEl.classList.remove('danger-val'); }
    // \u00C9nergie = 100 - burnout + bonus r\u00E9cup\u00E9ration semaines r\u00E9centes
    const enEl = document.getElementById('hud-energy');
    let recoveryBonus = 0;
    try {
      const rolling2w = moduleReader.getRollingAnalysis ? moduleReader.getRollingAnalysis(2) : null;
      if (rolling2w && rolling2w.weeksAnalyzed >= 1) {
        const recentAvg = rolling2w.avgTotal || 0;
        if (recentAvg <= 35) recoveryBonus = 15; // semaine l\u00E9gale = r\u00E9cup rapide
        else if (recentAvg <= 38) recoveryBonus = 8;
        else if (recentAvg <= 40) recoveryBonus = 3;
      }
    } catch(e) {}
    const enBase = Math.max(0, 100 - bo.score);
    const enVal  = Math.min(100, enBase + recoveryBonus);
    enEl.textContent = enVal;
    if (recoveryBonus > 0) enEl.style.color = '#4CAF50';
    else enEl.style.color = '';
    if (enVal<30) enEl.classList.add('danger-val'); else enEl.classList.remove('danger-val');
    // violations supprimees du HUD
    // Cumul heures sup toutes annees (M1 + M2 fusionnes)
    let cum = null;
    try {
      const cumData = moduleReader.getCumulatedHours ? moduleReader.getCumulatedHours() : null;
      if (cumData) {
        const hoursEl = document.getElementById('hud-hours');
        if (hoursEl) hoursEl.textContent = Math.round(cumData.netOvertime || 0);
        cum = { totalNetOvertime: cumData.netOvertime || 0 };
      }
    } catch(e) {}
    if (!cum) cum = moduleReader.getCumulatedSummary ? moduleReader.getCumulatedSummary() : null;
    // Bulle Kitsune dynamique
    const bubbleEl = document.getElementById('kitsune-bubble-text');
    if (bubbleEl) {
      const net = cum ? (cum.totalNetOvertime||0).toFixed(0) : '?';
      // D\u00E9tail du score burnout pour expliquer d'o\u00F9 vient la valeur
      const rolling2 = moduleReader.getRollingAnalysis ? moduleReader.getRollingAnalysis(12) : null;
      const avgH = rolling2 ? rolling2.avgTotal.toFixed(1) : '35';
      const ov48 = rolling2 ? (rolling2.violations?.over48 || 0) : 0;
      const trend2 = rolling2 ? rolling2.trend : 'stable';
      const expl = bo.score > 0
        ? `Moy ${avgH}h/sem${ov48>0?' \u00B7 '+ov48+'\u00D7 +48h':''}${trend2==='hausse'?' \u00B7 tendance \u2197':''}. `
        : '';
      const msgs = {
        sain:      `\u2705 Tout va bien ! ${net}h sup cumul\u00E9es. ${expl}Tape-moi pour en savoir plus.`,
        vigilance: `\uD83D\uDC9B Vigilance (score ${bo.score}/100) : ${net}h sup. ${expl}Semaines charg\u00E9es d\u00E9tect\u00E9es.`,
        risque:    `\uD83D\uDFE0 Risque (score ${bo.score}/100) : ${net}h sup. ${expl}Consulte l'analyse.`,
        danger:    `\uD83D\uDD34 Danger (score ${bo.score}/100) : ${net}h sup. ${expl}Ta charge est critique !`,
        critique:  `\uD83D\uDEA8 CRITIQUE (score ${bo.score}/100) : ${net}h sup. ${expl}Agis maintenant !`,
      };
      bubbleEl.textContent = msgs[bo.level] || msgs.sain;
    }
    const rColor = bo.score<20?'#4CAF50':bo.score<40?'#FF8C42':bo.score<60?'#FF6B35':bo.score<80?'#E53935':'#B71C1C';
    const rLabel = bo.score<20?'\uD83D\uDC9A Sain':bo.score<40?'\uD83D\uDC9B Vigilance':bo.score<60?'\uD83E\uDDE1 Risque':bo.score<80?'\uD83D\uDD34 Danger':'\uD83D\uDEA8 Critique';
    document.getElementById('risk-label-main').textContent = rLabel;
    document.getElementById('risk-bar-main').style.cssText =
      `width:${bo.score}%;background:${rColor};box-shadow:0 0 8px ${rColor}88;`;
  } catch(e) { console.warn('HUD:', e); }
}

// \u2500\u2500 Burn-out \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function checkBurnoutAlert() {
  try {
    const bo = moduleReader.getBurnoutScore ? moduleReader.getBurnoutScore() : {score:0};
    // Tracker le pic burn-out historique
    const peak = parseInt(localStorage.getItem('FOX_BURNOUT_PEAK') || '0');
    if ((bo.score || 0) > peak) localStorage.setItem('FOX_BURNOUT_PEAK', String(bo.score));
    if (!document.getElementById('toggle-burnout-anim')?.checked) return;
    const vig = document.getElementById('vignette-overlay');
    const ov  = document.getElementById('burnout-overlay');
    if (bo.score>=80) {
      ov.classList.add('active'); vig.className='critique';
      document.getElementById('card-burnout').style.cssText='border-color:#E53935;box-shadow:0 0 30px rgba(229,57,53,0.3);';
      document.getElementById('burnout-card-desc').textContent=`\uD83D\uDEA8 Score ${bo.score}/100 \u2014 Situation critique`;
      document.getElementById('burnout-card-desc').classList.add('burnout-text-bleed');
      document.body.classList.remove('burnout-shake');
      void document.body.offsetWidth;
      document.body.classList.add('burnout-shake');
      setTimeout(()=>document.body.classList.remove('burnout-shake'),700);
      spawnFatigueParticles(10);
      document.getElementById('burnout-score-val').textContent = bo.score+'/100';
      document.getElementById('burnout-popup-msg').textContent =
        `Niveau ${bo.level?.toUpperCase()}. ${bo.details?.violations?.over48||0} semaine(s) \u00E0 +48h. `+
        `Consultez votre m\u00E9decin du travail et exercez votre droit \u00E0 la d\u00E9connexion (art. L2242-17).`;
      document.getElementById('burnout-popup').classList.add('visible');
    } else if (bo.score>=60) {
      vig.className='danger';
      document.getElementById('burnout-card-desc').textContent=`\u26A0\uFE0F Score ${bo.score}/100 \u2014 Vigilance`;
    } else if (bo.score>=40) {
      document.getElementById('burnout-card-desc').textContent=`\uD83D\uDC9B Score ${bo.score}/100 \u2014 Surveillez`;
    }
  } catch(e){}
}

function closeBurnoutPopup() {
  document.getElementById('burnout-popup').classList.remove('visible');
  openPopup('popup-burnout');
}
function toggleBurnoutAnimations(on) {
  if (!on) { document.getElementById('vignette-overlay').className=''; document.getElementById('burnout-overlay').classList.remove('active'); }
  else checkBurnoutAlert();
}
function spawnFatigueParticles(n) {
  for (let i=0;i<n;i++) {
    const p=document.createElement('div'); p.className='fatigue-particle';
    p.style.left=Math.random()*100+'vw'; p.style.top='-10px';
    const sz=(6+Math.random()*8)+'px'; p.style.width=sz; p.style.height=sz;
    p.style.animationDuration=(3+Math.random()*4)+'s';
    p.style.animationDelay=(Math.random()*2)+'s';
    document.body.appendChild(p); setTimeout(()=>p.remove(),7000);
  }
}

// \u2500\u2500 Analyse \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function runAnalyse() {
  const dh = [0,1,2,3,4,5,6].map(i=>Number(document.getElementById('day'+i).value)||0);
  const gs = {
    weeklyHours:dh.reduce((s,h)=>s+h,0), dailyHours:dh,
    hasNightWork:document.getElementById('chk-night').checked,
    hasSundayWork:document.getElementById('chk-sunday').checked||dh[6]>0,
    hasSaturdayWork:document.getElementById('chk-saturday').checked||dh[5]>0,
    hasHolidayWork:document.getElementById('chk-holiday').checked,
  };
  const result = (typeof foxScenarioEngineExpert!=='undefined')
    ? foxScenarioEngineExpert(gs) : foxScenarioEngine(gs);
  const box = document.getElementById('analyse-results');
  box.style.display='block';
  document.getElementById('analyse-summary').innerHTML =
    `<strong>${result.riskLevel?.emoji||''} ${result.riskLevel?.label||''}</strong> \u2014 Score ${result.riskScore||0}/100<br><span style="font-size:0.85rem;">${result.summary||''}</span>`;
  document.getElementById('analyse-violations').innerHTML =
    !(result.violations?.length)
      ? '<span style="color:#4CAF50;font-size:0.82rem;">\u2705 Aucune violation</span>'
      : result.violations.map(v=>`<span class="violation-tag">\u26A0\uFE0F ${v.label} <small style="opacity:0.5">art.${v.article}</small></span>`).join('');
  const sc = result.matchedScenarios||result.triggered||[];
  document.getElementById('analyse-scenarios').innerHTML = sc.slice(0,5).filter(Boolean).map(s=>
    `<div class="scenario-card-mini">
       <div class="sc-name">${s.name}</div>
       <div class="sc-legal">${s.legal||''} \u00B7 ${s.risk||'\u2014'}</div>
       <div style="font-size:0.78rem;color:#777;margin-top:4px;">${s.conseil?.message||''}</div>
     </div>`).join('');
  if (result.violations?.length>0 && typeof gainXP==='function') gainXP(50,'Violation d\u00E9tect\u00E9e');
  document.getElementById('hud-violations').textContent = result.violations?.length||0;
  refreshHUD();
}

// \u2500\u2500 Modules popup \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function refreshModulesPopup() {
  const cum   = moduleReader.getCumulatedSummary ? moduleReader.getCumulatedSummary() : null;
  const years = moduleReader.detectAllYears ? moduleReader.detectAllYears() : [moduleReader.year];
  const src   = cum?.source || 'fusion';
  const manual = localStorage.getItem('FOX_SOURCE_OVERRIDE');

  const srcLabel = src === 'fusion' ? '\uD83D\uDD00 Fusion auto' : src === 'M1' ? '\uD83D\uDCC5 M1 forc\u00E9' : '\uD83D\uDCB0 M2 forc\u00E9';
  const srcColor = src === 'M1' ? '#64C8FF' : src === 'M2' ? '#FFD700' : '#4CAF50';

  let html = `
    <div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:14px;margin-bottom:14px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <strong style="color:#FF8C42;">\uD83D\uDCCA Cumul toutes ann\u00E9es</strong>
        <span style="background:rgba(255,255,255,0.08);color:${srcColor};border-radius:20px;padding:3px 10px;font-size:0.72rem;font-weight:700;">
          ${srcLabel}
        </span>
      </div>
      <div style="font-size:0.72rem;color:#666;margin-bottom:10px;">
        ${src === 'fusion'
          ? 'Fusion intelligente \u2014 M1 et M2 combin\u00E9s mois par mois, z\u00E9ro doublon. Le cumul est pr\u00E9serv\u00E9 m\u00EAme si vous changez de module.'
          : `Source forc\u00E9e manuellement sur ${src}. Les mois sans donn\u00E9es dans ${src} sont compl\u00E9t\u00E9s par l'autre module.`
        }
      </div>
      <div style="margin-bottom:12px;">
        <div style="font-size:0.72rem;color:#888;margin-bottom:6px;">\uD83C\uDF9B\uFE0F Mode de lecture :</div>
        <div style="display:flex;gap:6px;">
          <button onclick="setFoxSource('auto')"
            style="flex:1;padding:7px;border-radius:8px;border:1px solid ${!manual?'#4CAF50':'rgba(255,255,255,0.1)'};
                   background:${!manual?'rgba(76,175,80,0.15)':'rgba(255,255,255,0.04)'};
                   color:${!manual?'#4CAF50':'#888'};font-size:0.73rem;cursor:pointer;font-weight:${!manual?'900':'400'}">
            \uD83D\uDD00 Fusion auto
          </button>
          <button onclick="setFoxSource('M1')"
            style="flex:1;padding:7px;border-radius:8px;border:1px solid ${manual==='M1'?'#64C8FF':'rgba(255,255,255,0.1)'};
                   background:${manual==='M1'?'rgba(100,200,255,0.15)':'rgba(255,255,255,0.04)'};
                   color:${manual==='M1'?'#64C8FF':'#888'};font-size:0.73rem;cursor:pointer;font-weight:${manual==='M1'?'900':'400'}">
            \uD83D\uDCC5 Forcer M1
          </button>
          <button onclick="setFoxSource('M2')"
            style="flex:1;padding:7px;border-radius:8px;border:1px solid ${manual==='M2'?'#FFD700':'rgba(255,255,255,0.1)'};
                   background:${manual==='M2'?'rgba(255,215,0,0.15)':'rgba(255,255,255,0.04)'};
                   color:${manual==='M2'?'#FFD700':'#888'};font-size:0.73rem;cursor:pointer;font-weight:${manual==='M2'?'900':'400'}">
            \uD83D\uDCB0 Forcer M2
          </button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-size:0.83rem;">
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">HS nettes totales</div>
          <div style="font-weight:900;font-size:1.3rem;color:#FF8C42;">${(cum?.totalNetOvertime||0).toFixed(0)}h</div>
        </div>
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">Ann\u00E9es suivies</div>
          <div style="font-weight:900;font-size:1.3rem;color:#FF8C42;">${years.length}</div>
        </div>
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">Mois analys\u00E9s</div>
          <div style="font-weight:900;font-size:1.3rem;color:#FF8C42;">${cum?.monthCount||0}</div>
        </div>
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">HS +25%</div>
          <div style="font-weight:700;color:#eee;">${(cum?.totalPlus25||0).toFixed(1)}h</div>
        </div>
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">HS +50%</div>
          <div style="font-weight:700;color:#eee;">${(cum?.totalPlus50||0).toFixed(1)}h</div>
        </div>
        <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
          <div style="color:#555;font-size:0.7rem;">XP bonus</div>
          <div style="font-weight:700;color:#FFD700;">+${cum?.xpBonus||0} XP</div>
        </div>
      </div>
    </div>
    <div style="font-size:0.72rem;color:#555;letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;">D\u00E9tail par ann\u00E9e</div>`;

  years.forEach(y => {
    const py = cum?.perYear?.[y];
    const net = py?.net || 0;
    const netColor = net > 100 ? '#E53935' : net > 50 ? '#FF8C42' : '#4CAF50';
    const m1cov = py?.m1Coverage || 0;
    const m2cov = py?.m2Coverage || 0;

    html += `
      <div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:12px;margin-bottom:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div style="font-weight:700;color:#FF8C42;">\uD83D\uDCC5 ${y}</div>
          <div style="display:flex;gap:4px;font-size:0.68rem;">
            ${m1cov ? `<span style="color:#64C8FF;background:rgba(100,200,255,0.1);border-radius:8px;padding:2px 7px;">M1: ${m1cov} mois</span>` : ''}
            ${m2cov ? `<span style="color:#FFD700;background:rgba(255,215,0,0.1);border-radius:8px;padding:2px 7px;">M2: ${m2cov} mois</span>` : ''}
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;font-size:0.82rem;">
          <div><div style="color:#555;font-size:0.7rem;">HS nettes</div><strong style="color:${netColor};">${net.toFixed(1)}h</strong></div>
          <div><div style="color:#555;font-size:0.7rem;">HS +25%</div><strong>${(py?.hs25||0).toFixed(1)}h</strong></div>
          <div><div style="color:#555;font-size:0.7rem;">HS +50%</div><strong>${(py?.hs50||0).toFixed(1)}h</strong></div>
        </div>
      </div>`;
  });

  if (!years.length) html += '<p style="color:#555;text-align:center;">Aucune donn\u00E9e \u2014 ouvrez le Module 1 ou 2.</p>';
  // \u2500\u2500 Diagnostic M1 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
  try {
    const y = (moduleReader.detectAllYears ? moduleReader.detectAllYears() : []).join(', ') || '\u2014';
    const m1Test = {};
    (moduleReader.detectAllYears ? moduleReader.detectAllYears() : []).forEach(yr => {
      const raw = JSON.parse(localStorage.getItem('DATA_REPORT_' + yr) || '{}');
      const days = Object.keys(raw).filter(k => /^\d{4}-\d{2}-\d{2}$/.test(k));
      const nonZero = days.filter(d => (raw[d].extra||0) > 0);
      m1Test[yr] = { totalDays: days.length, withHS: nonZero.length, sample: nonZero[0] ? raw[nonZero[0]] : null };
    });
    const diagLines = Object.entries(m1Test).map(([yr, v]) =>
      `${yr}: ${v.totalDays} jours M1, ${v.withHS} avec HS${v.sample?' (ex: extra='+v.sample.extra+'h)':''}`
    );
    html += `<details style="margin-top:14px;"><summary style="color:#444;font-size:0.7rem;cursor:pointer;letter-spacing:1px;">\uD83D\uDD0D DIAGNOSTIC M1 (d\u00E9veloppeur)</summary>
      <div style="font-size:0.72rem;color:#556;margin-top:8px;line-height:1.6;font-family:monospace;">
        ${diagLines.join('<br>') || 'Aucune donn\u00E9e M1 trouv\u00E9e'}
      </div></details>`;
  } catch(e) {}
  document.getElementById('modules-content').innerHTML = html;
}


// \u2500\u2500 Burn-out popup \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function refreshBurnoutPopup() {
  const bo=moduleReader.getBurnoutScore?moduleReader.getBurnoutScore():{score:0,level:'sain',details:{}};
  const r=moduleReader.getRollingAnalysis?moduleReader.getRollingAnalysis(12):{avgTotal:35,trend:'stable',violations:{over48:0},weeksAnalyzed:0};
  const c=bo.score<20?'#4CAF50':bo.score<40?'#FF8C42':bo.score<60?'#FF6B35':bo.score<80?'#E53935':'#B71C1C';
  document.getElementById('burnout-popup-content').innerHTML=`
    <div style="text-align:center;margin-bottom:18px;">
      <div style="font-size:3rem;font-weight:900;color:${c};text-shadow:0 0 20px ${c}55;">${bo.score}<span style="font-size:1.4rem;">/100</span></div>
      <div style="font-weight:700;color:${c};text-transform:uppercase;letter-spacing:2px;font-size:0.95rem;">${bo.level}</div>
    </div>
    <div class="risk-bar-track" style="margin-bottom:16px;"><div class="risk-bar-fill" style="width:${bo.score}%;background:${c};"></div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;font-size:0.83rem;">
      <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;"><div style="color:#555;">Moy. hebdo</div><strong>${r.avgTotal?.toFixed(1)||'\u2014'}h</strong></div>
      <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;"><div style="color:#555;">Tendance</div><strong>${r.trend==='hausse'?'\uD83D\uDCC8 Hausse':r.trend==='baisse'?'\uD83D\uDCC9 Baisse':'\u27A1\uFE0F Stable'}</strong></div>
      <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;"><div style="color:#555;">Sem. +48h</div><strong style="color:${(r.violations?.over48||0)>0?'#E53935':'#4CAF50'}">${r.violations?.over48||0}</strong></div>
      <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;"><div style="color:#555;">Sem. analys\u00E9es</div><strong>${r.weeksAnalyzed||0}</strong></div>
    </div>
    ${bo.score>=40?`<div style="background:rgba(229,57,53,0.08);border:1px solid rgba(229,57,53,0.18);border-radius:10px;padding:13px;font-size:0.82rem;color:#ffcdd2;line-height:1.6;">
      \u2695\uFE0F Consultez votre m\u00E9decin du travail. Droit \u00E0 la d\u00E9connexion (art. L2242-17). Visite \u00E0 la demande (art. L4624-1).
    </div>`:'<div style="color:#4CAF50;text-align:center;padding:10px;">\u2705 Situation saine !</div>'}`;
}

// \u2500\u2500 Qu\u00EAtes popup \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function refreshQuestesPopup() {
  const list=document.getElementById('quests-list'); if (!list) return;
  const q=typeof quests!=='undefined'&&Array.isArray(quests)?quests:[];
  list.innerHTML=q.slice(0,6).map(qt=>
    `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:12px;">
      <div style="font-weight:700;color:#eee;font-size:0.87rem;">${qt.icon||'\u2694\uFE0F'} ${qt.name||qt.title||'Qu\u00EAte'}</div>
      <div style="color:#666;font-size:0.77rem;margin-top:3px;">${qt.description||qt.desc||''}</div>
      <div style="background:rgba(255,255,255,0.06);border-radius:4px;height:4px;margin-top:7px;">
        <div style="height:100%;background:#FF8C42;border-radius:4px;width:${((qt.progress||0)/(qt.goal||1))*100}%;"></div>
      </div></div>`).join('')||'<p style="color:#555;text-align:center;font-size:0.85rem;">Aucune qu\u00EAte active.</p>';
}

// \u2500\u2500 Sc\u00E9narios popup \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function initScenariosPopup() {
  const all=typeof FOX_SCENARIOS!=='undefined'?FOX_SCENARIOS:[];
  renderScenarios(all.slice(0,30));
  document.getElementById('scenarios-count').textContent=`${all.length} sc\u00E9narios disponibles`;
}
function filterScenarios() {
  const q=document.getElementById('scenario-search').value.toLowerCase();
  const risk=document.getElementById('scenario-risk').value;
  let f=typeof FOX_SCENARIOS!=='undefined'?FOX_SCENARIOS:[];
  if (q)    f=f.filter(s=>s.name.toLowerCase().includes(q)||(s.desc||'').toLowerCase().includes(q));
  if (risk) f=f.filter(s=>s.risk===risk);
  renderScenarios(f.slice(0,50));
  document.getElementById('scenarios-count').textContent=`${f.length} sc\u00E9nario(s) trouv\u00E9(s)`;
}
function renderScenarios(list) {
  document.getElementById('scenarios-list').innerHTML=list.map(s=>
    `<div class="scenario-card-mini" onclick="var d=this.nextElementSibling;d.style.display=d.style.display==='none'?'block':'none'">
      <div class="sc-name">#${s.id} ${s.name}</div>
      <div class="sc-legal">${s.legal||''} \u00B7 ${s.risk||'\u2014'}</div>
    </div>
    <div style="display:none;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:11px;font-size:0.8rem;color:#aaa;line-height:1.5;margin-bottom:2px;">
      ${s.conseil?.message||s.desc||''}
      ${s.conseil?.actions?'<ul style="margin:7px 0 0;padding-left:14px;">'+s.conseil.actions.map(a=>`<li style="margin:3px 0;">${a}</li>`).join('')+'</ul>':''}
    </div>`).join('')||'<p style="color:#555;text-align:center;">Aucun r\u00E9sultat</p>';
}

// \u2500\u2500 Badges popup \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
// \u2500\u2500 Helpers badges communs \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function _getAllBadges() {
  let all = [];
  if (typeof badgeSystem !== 'undefined' && badgeSystem.badges && badgeSystem.badges.length > 0)
    all = badgeSystem.badges;
  else if (typeof BADGES !== 'undefined' && BADGES.length > 0)
    all = BADGES;
  if (all.length > 0 && (!window.BADGES || window.BADGES.length === 0)) window.BADGES = all;
  return all;
}
function _getUnlockedIds() {
  // Fusionner gameState.badges ET badgeSystem.unlockedBadges pour que les deux sources soient visibles
  const gs = (typeof gameState !== 'undefined' && gameState.badges) ? gameState.badges : [];
  const bs = (typeof badgeSystem !== 'undefined' && badgeSystem.unlockedBadges) ? badgeSystem.unlockedBadges : [];
  return [...new Set([...gs, ...bs])];
}
function _makeBadgeCard(b, ok, filterRarity) {
  if (filterRarity && filterRarity !== 'all' && b.rarity !== filterRarity) return '';
  const rC = {common:'rgba(180,180,180,0.14)',rare:'rgba(80,140,255,0.14)',epic:'rgba(160,80,255,0.16)',legendary:'rgba(255,180,30,0.18)'};
  const rB = {common:'rgba(180,180,180,0.25)',rare:'rgba(80,140,255,0.35)',epic:'rgba(160,80,255,0.4)',legendary:'rgba(255,180,30,0.5)'};
  const bg = ok ? (rC[b.rarity]||'rgba(255,255,255,0.06)') : 'rgba(255,255,255,0.015)';
  const bd = ok ? (rB[b.rarity]||'rgba(255,255,255,0.1)') : 'rgba(255,255,255,0.04)';
  const imgHtml = b.img
    ? `<img src="${b.img}" alt="${b.name}" style="width:44px;height:44px;object-fit:contain;" onerror="this.style.display='none';this.nextSibling.style.display='block'"><span style="display:none;font-size:1.5rem;">${b.icon||'\u{1F3C5}'}</span>`
    : `<span style="font-size:1.5rem;">${b.icon||'\u{1F3C5}'}</span>`;
  const cursor = ok ? 'cursor:pointer;' : 'cursor:default;';
  const onclick = ok ? `onclick="showBadgeZoom('${(b.img||'').replace(/'/g,"\'")}','${(b.name||'').replace(/'/g,"\'")}','${((b.description||b.desc||'').replace(/'/g,"\'"))}')"` : '';
  return `<div title="${ok ? b.name+' : '+(b.description||b.desc||'') : '\u{1F512} '+b.name+' \u2014 non d\u00E9bloqu\u00E9'}"
    ${onclick}
    style="background:${bg};border:1px solid ${bd};border-radius:10px;padding:8px;text-align:center;opacity:${ok?1:0.28};transition:all 0.2s;${cursor}position:relative;">
    <div style="height:48px;display:flex;align-items:center;justify-content:center;">${ok?imgHtml:'<span style="font-size:1.5rem;filter:grayscale(1);">'+(b.icon||'\u{1F3C5}')+'</span>'}</div>
    <div style="font-size:0.56rem;color:${ok?'#bbb':'#444'};margin-top:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:58px;">${ok?b.name:'???'}</div>
    ${ok?'':`<div style="position:absolute;top:3px;right:4px;font-size:0.6rem;color:#333;">\u{1F512}</div>`}
  </div>`;
}

// Filtre raret\u00E9 actif
let _badgeFilterRarity = 'all';
function filterBadgesByRarity(r) {
  _badgeFilterRarity = r;
  document.querySelectorAll('.badge-filter-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.rarity === r);
  });
  refreshBadgesPopup();
}

function refreshBadgesPopup() {
  const grid = document.getElementById('badges-grid'); if (!grid) return;
  // Auto-unlock badges avec stats actuelles
  if (typeof badgeSystem !== 'undefined' && typeof buildBadgeStats === 'function') {
    try { badgeSystem.checkAndUnlockBadges(buildBadgeStats()); } catch(e){}
  }
  const all  = _getAllBadges().filter(b => !b.id || b.id <= 50);
  const done = _getUnlockedIds();
  grid.innerHTML = all.map(b => _makeBadgeCard(b, done.includes(b.id), _badgeFilterRarity)).join('') || '<p style="color:#555;">Aucun badge.</p>';
}

function refreshSkillsPopup() {
  const grid = document.getElementById('skills-grid'); if (!grid) return;
  if (typeof badgeSystem !== 'undefined' && typeof buildBadgeStats === 'function') {
    try { badgeSystem.checkAndUnlockBadges(buildBadgeStats()); } catch(e){}
  }
  const all  = _getAllBadges().filter(b => b.id && b.id >= 51);
  const done = _getUnlockedIds();
  grid.innerHTML = all.map(b => _makeBadgeCard(b, done.includes(b.id), 'all')).join('') || '<p style="color:#555;">Aucune comp\u00E9tence d\u00E9finie.</p>';
}

function refreshLeaguesPopup() {
  const grid = document.getElementById('leagues-grid'); if (!grid) return;
  if (typeof leagueSystem === 'undefined') { grid.innerHTML = '<p style="color:#555;">Ligues non charg\u00E9es.</p>'; return; }
  const xp  = typeof xpSystem !== 'undefined' ? (xpSystem.currentXP || 0) : 0;
  const cur = leagueSystem.getCurrentLeague(xp);
  const nxt = leagueSystem.getNextLeague ? leagueSystem.getNextLeague(xp) : null;
  const prog = leagueSystem.getLeagueProgress ? leagueSystem.getLeagueProgress(xp) : null;
  function hexRgb(hex) {
    if (!hex||!hex.startsWith('#')) return '255,140,66';
    return `${parseInt(hex.slice(1,3),16)},${parseInt(hex.slice(3,5),16)},${parseInt(hex.slice(5,7),16)}`;
  }
  grid.innerHTML = leagueSystem.leagues.map(lg => {
    const active   = lg.id === cur.id;
    const unlocked = xp >= lg.minXP;
    let bar = '';
    if (active && prog) {
      const pct = Math.min(100, Math.round(prog.percentage || 0));
      bar = `<div style="height:4px;background:rgba(255,255,255,0.07);border-radius:2px;margin-top:6px;overflow:hidden;"><div style="height:100%;width:${pct}%;background:${lg.color};border-radius:2px;transition:width 0.4s;"></div></div>
             <div style="font-size:0.65rem;color:${lg.color};margin-top:3px;">${pct}% \u2014 ${prog.xpRemainingForNext||'?'} XP restants</div>`;
    }
    const onclk = unlocked ? `onclick="showLeagueZoom('${lg.img||''}','${lg.name}','${lg.minXP.toLocaleString()} XP minimum')"` : '';
    return `<div ${onclk}
      style="background:${active?`rgba(${hexRgb(lg.color)},0.1)`:'rgba(255,255,255,0.02)'};border:${active?`2px solid ${lg.color}`:'1px solid rgba(255,255,255,0.06)'};border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:12px;opacity:${unlocked?1:0.3};${unlocked?'cursor:pointer;':''}transition:all 0.2s;">
      <div style="width:52px;height:52px;flex-shrink:0;display:flex;align-items:center;justify-content:center;">
        ${lg.img?`<img src="${lg.img}" alt="${lg.name}" style="width:48px;height:48px;object-fit:contain;${active?`filter:drop-shadow(0 0 8px ${lg.color});`:''}" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><span style="display:none;font-size:2rem;">${lg.icon||'\u{1F3C6}'}</span>`:`<span style="font-size:2rem;">${lg.icon||'\u{1F3C6}'}</span>`}
      </div>
      <div style="flex:1;min-width:0;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
          <span style="font-weight:700;color:${active?lg.color:'#aaa'};font-size:0.9rem;">${lg.name}${active?' \u25C4':''}</span>
          <span style="font-size:0.7rem;color:#555;white-space:nowrap;">${lg.minXP.toLocaleString()} XP</span>
        </div>
        ${bar}
      </div>
    </div>`;
  }).join('');
}

function showLeagueZoom(imgSrc, name, desc) {
  const ov = document.getElementById('badge-zoom-overlay');
  if (!ov) return;
  document.getElementById('badge-zoom-img').src = imgSrc;
  document.getElementById('badge-zoom-name').textContent = name;
  document.getElementById('badge-zoom-desc').textContent = desc;
  ov.style.display = 'flex';
}


function showBadgeZoom(imgSrc, name, desc) {
  const ov = document.getElementById('badge-zoom-overlay');
  if (!ov) return;
  document.getElementById('badge-zoom-img').src  = imgSrc;
  document.getElementById('badge-zoom-name').textContent = name;
  document.getElementById('badge-zoom-desc').textContent = desc;
  ov.style.display = 'flex';
}

// \u2500\u2500 Settings \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function refreshSettings() {
  const y=moduleReader.detectAllYears?moduleReader.detectAllYears():[];
  document.getElementById('detected-years').textContent=y.length?y.join(' \u00B7 '):'Aucune donn\u00E9e';
}
function _fullRPGReset() {
  if (typeof xpSystem !== 'undefined') {
    if (typeof xpSystem.reset === 'function') xpSystem.reset();
    else { xpSystem.currentXP=0; xpSystem.level=1; localStorage.setItem('rpg_xp','0'); localStorage.setItem('rpg_level','1'); }
  }
  if (typeof badgeSystem !== 'undefined') { badgeSystem.unlockedBadges=[]; localStorage.setItem('rpg_unlocked_badges','[]'); }
  if (typeof gameState !== 'undefined') {
    gameState.xp=0; gameState.level=1; gameState.badges=[];
    if (gameState.player) { gameState.player.xp=0; gameState.player.level=1; }
    if (typeof saveGameState==='function') saveGameState();
  }
  window._lastM1Net=0; window._lastM2Tot=0;
  localStorage.removeItem('FOX_REWARDS_HISTORY');
  localStorage.removeItem('FOX_SCENARIOS_NARRATED');
  localStorage.removeItem('FOX_BURNOUT_PEAK');
  localStorage.removeItem('FOX_RTF_EXPORTED');
}
function resetRPGConfirm() {
  if (confirm('R\u00E9initialiser XP, badges et qu\u00EAtes ? Les donn\u00E9es M1/M2 restent intactes.')) {
    _fullRPGReset(); refreshHUD(); closePopup('popup-settings');
    showNotification('\u{1F504} Progression r\u00E9initialis\u00E9e', 'info');
  }
}
function exportHistorique() {
  if (typeof moduleReader.exportFullHistory==='function') moduleReader.exportFullHistory();
}

// \u2500\u2500 Kitsune \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function kitsuneFormat(text) {
  // Gras **texte** \u2192 <strong>
  text = text.replace(/\*\*(.+?)\*\*/g, '<strong style="color:#fff;">$1</strong>');
  // Sauts de ligne
  text = text.replace(/\n/g, '<br>');
  // Puces \u2022
  text = text.replace(/\u2022\s/g, '<span style="color:#FF8C42;">\u2022</span> ');
  return text;
}

async function sendToKitsune() {
  const inp  = document.getElementById('ai-input');
  const msg  = inp.value.trim();
  if (!msg) return;
  inp.value  = '';
  const conv = document.getElementById('ai-conversation');

  // Message joueur
  conv.innerHTML += `
    <div style="text-align:right;margin:6px 0;">
      <span style="background:rgba(255,140,66,0.18);color:#FF8C42;border-radius:12px 12px 2px 12px;
                   padding:8px 14px;display:inline-block;font-size:0.83rem;max-width:85%;text-align:left;">
        ${msg}
      </span>
    </div>`;

  document.getElementById('ai-loading').style.display = 'block';
  conv.scrollTop = conv.scrollHeight;

  try {
    const reply = typeof askKitsune === 'function' ? await askKitsune(msg) : '\uD83E\uDD8A Module non charg\u00E9.';
    conv.innerHTML += `
      <div style="text-align:left;margin:6px 0;">
        <span style="background:rgba(255,255,255,0.05);color:#ccc;border-radius:2px 12px 12px 12px;
                     padding:8px 14px;display:inline-block;font-size:0.83rem;max-width:92%;text-align:left;line-height:1.5;">
          ${kitsuneFormat(reply)}
        </span>
      </div>`;
  } catch(e) {
    conv.innerHTML += `<div style="color:#E53935;font-size:0.8rem;margin:4px 0;">Erreur : ${e.message}</div>`;
  }

  document.getElementById('ai-loading').style.display = 'none';
  conv.scrollTop = conv.scrollHeight;
}
</script>

<!-- â•â• POP-UP DÃ‰MO CACHÃ‰ (5 clics + code) â•â• -->
<div id="popup-demo-code" style="display:none;position:fixed;bottom:0;left:0;right:0;z-index:9999;background:rgba(8,8,20,0.97);border-top:2px solid rgba(255,140,66,0.4);border-radius:20px 20px 0 0;padding-bottom:env(safe-area-inset-bottom);max-height:70vh;overflow-y:auto;align-items:center;justify-content:center;">
  <div style="background:#0d0d1a;border:2px solid #FF8C42;border-radius:20px;padding:28px;max-width:320px;width:90%;text-align:center;">
    <div style="font-size:2rem;margin-bottom:8px;">ğŸ”</div>
    <div style="color:#FF8C42;font-weight:900;font-size:1.1rem;letter-spacing:2px;margin-bottom:6px;">MODE DÃ‰MO</div>
    <div style="color:#555;font-size:0.75rem;margin-bottom:18px;">AccÃ¨s restreint â€” code requis</div>
    <input id="demo-code-input" type="password" maxlength="8" placeholder="Code secret"
      style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,140,66,0.3);color:#fff;border-radius:10px;padding:12px;text-align:center;font-size:1.2rem;letter-spacing:6px;margin-bottom:12px;box-sizing:border-box;"
      onkeypress="if(event.key==='Enter')checkDemoCode()">
    <button onclick="checkDemoCode()" style="width:100%;background:linear-gradient(135deg,#FF8C42,#FF6B35);border:none;color:#fff;border-radius:10px;padding:12px;font-weight:900;font-size:1rem;cursor:pointer;margin-bottom:8px;">Valider</button>
    <button onclick="document.getElementById('popup-demo-code').style.display='none'" style="background:none;border:none;color:#444;font-size:0.8rem;cursor:pointer;">Annuler</button>
    <div id="demo-code-error" style="color:#E53935;font-size:0.78rem;margin-top:8px;display:none;">âŒ Code incorrect</div>
  </div>
</div>

<!-- â•â• POP-UP DÃ‰MO ACTIF â•â• -->
<div id="popup-demo-panel" style="display:none;position:fixed;top:0;right:0;bottom:0;width:340px;z-index:9998;background:rgba(8,8,20,0.98);overflow-y:auto;padding-bottom:40px;">
  <div style="padding:16px 16px 0 16px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <div style="color:#FF8C42;font-weight:900;font-size:1.2rem;">ğŸ¬ MODE DÃ‰MO</div>
      <div style="display:flex;gap:6px;">
        <button id="demo-toggle-btn" onclick="toggleDemoPanel()" style="background:rgba(255,140,66,0.1);border:1px solid rgba(255,140,66,0.3);color:#FF8C42;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:0.85rem;" title="Masquer le panneau">â¬…</button>
        <button onclick="exitDemoMode()" style="background:rgba(229,57,53,0.15);border:1px solid #E53935;color:#E53935;border-radius:8px;padding:6px 14px;cursor:pointer;font-weight:700;">âœ• Quitter</button>
      </div>
    </div>

    <div style="color:#666;font-size:0.72rem;letter-spacing:1px;margin-bottom:12px;">Ã‰TAPE ACTIVE</div>
    <div id="demo-step-label" style="background:rgba(255,140,66,0.1);border:1px solid rgba(255,140,66,0.3);border-radius:12px;padding:12px 16px;color:#FF8C42;font-weight:700;font-size:0.95rem;margin-bottom:20px;">â€”</div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;">
      <button class="demo-btn" onclick="demoStep('reset')">ğŸ”„ Reset tout</button>
      <button class="demo-btn" onclick="demoStep('start')">ğŸŒ± DÃ©part (0h)</button>
      <button class="demo-btn" onclick="demoStep('light')">ğŸ’› LÃ©gÃ¨res HS (15h)</button>
      <button class="demo-btn" onclick="demoStep('medium')">ğŸ§¡ HS modÃ©rÃ©es (60h)</button>
      <button class="demo-btn" onclick="demoStep('heavy')">ğŸ”´ HS Ã©levÃ©es (150h)</button>
      <button class="demo-btn" onclick="demoStep('critical')">ğŸš¨ Situation critique (220h+)</button>
      <button class="demo-btn" onclick="demoStep('multiyear')">ğŸ•°ï¸ Multi-annÃ©es (3 ans)</button>
      <button class="demo-btn" onclick="demoStep('burnout')">ğŸ”¥ Score max burnout</button>
    </div>

    <div style="color:#666;font-size:0.72rem;letter-spacing:1px;margin-bottom:10px;">SCÃ‰NARIOS KITSUNE</div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px;" id="demo-scenario-list"></div>

    <div style="color:#666;font-size:0.72rem;letter-spacing:1px;margin-bottom:10px;">BADGES</div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:20px;" id="demo-badges-preview"></div>

    <div style="color:#666;font-size:0.72rem;letter-spacing:1px;margin-bottom:10px;">XP & NIVEAU</div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:20px;">
      <button class="demo-btn" onclick="demoXP(100)">+100 XP</button>
      <button class="demo-btn" onclick="demoXP(500)">+500 XP</button>
      <button class="demo-btn" onclick="demoXP(1000)">+1000 XP</button>
      <button class="demo-btn" onclick="demoXP(5000)">+5000 XP</button>
    </div>

    <div style="color:#666;font-size:0.72rem;letter-spacing:1px;margin-bottom:10px;">KITSUNE NARRATION</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
      <button class="demo-btn" onclick="demoNarrate(1)">ğŸ¦Š +1h sup</button>
      <button class="demo-btn" onclick="demoNarrate(5)">ğŸ¦Š +5h sup</button>
      <button class="demo-btn" onclick="demoNarrate(10)">ğŸ¦Š +10h sup</button>
      <button class="demo-btn" onclick="demoNarrate(48)">ğŸ¦Š +48h semaine</button>
    </div>
  </div>
</div>

<style>
.demo-btn {
  background: rgba(255,140,66,0.08);
  border: 1px solid rgba(255,140,66,0.2);
  color: #FF8C42;
  border-radius: 10px;
  padding: 10px 8px;
  font-size: 0.78rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}
.demo-btn:hover {
  background: rgba(255,140,66,0.18);
  border-color: #FF8C42;
}
</style>
<script>
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
//  MODE DEMO CACHE \u2014 5 clics sur FOX + code 19871502
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550

let _demoClickCount = 0;
let _demoClickTimer = null;
let _demoActive = false;

function demoLogoClick() {
  _demoClickCount++;
  clearTimeout(_demoClickTimer);
  const logo = document.getElementById('hud-logo-btn');
  if (logo) { logo.style.transform = 'scale(1.3)'; setTimeout(() => logo.style.transform = '', 200); }
  if (_demoClickCount >= 5) {
    _demoClickCount = 0;
    const p = document.getElementById('popup-demo-code');
    if (p) { p.style.display = 'flex'; }
    const inp = document.getElementById('demo-code-input');
    if (inp) { inp.value = ''; inp.focus(); }
    document.getElementById('demo-code-error').style.display = 'none';
  } else {
    _demoClickTimer = setTimeout(() => { _demoClickCount = 0; }, 3000);
    if (logo) {
      const r = 5 - _demoClickCount;
      logo.textContent = r > 0 ? ('\u{1F98A} ' + r) : '\u{1F98A} FOX';
      setTimeout(() => { logo.textContent = '\u{1F98A} FOX'; }, 800);
    }
  }
}

function checkDemoCode() {
  const inp = document.getElementById('demo-code-input');
  const err = document.getElementById('demo-code-error');
  const code = inp ? inp.value.trim() : '';
  if (code === '19871502') {
    document.getElementById('popup-demo-code').style.display = 'none';
    openDemoPanel();
  } else {
    err.style.display = 'block';
    if (inp) { inp.value = ''; inp.focus(); }
  }
}

function openDemoPanel() {
  _demoActive = true;
  document.getElementById('popup-demo-panel').style.display = 'block';
  _demoFillScenarios();
  _demoFillBadges();
  _demoBanner(true);
}


function toggleDemoPanel() {
  const panel = document.getElementById('popup-demo-panel');
  const btn   = document.getElementById('demo-toggle-btn');
  const body  = panel.querySelector(':scope > div');
  if (!panel || !body) return;
  const isMin = panel.getAttribute('data-minimized') === '1';
  if (isMin) {
    body.style.display = '';
    panel.style.width = '340px';
    panel.setAttribute('data-minimized', '0');
    if (btn) btn.textContent = '\u2B05';
  } else {
    body.style.display = 'none';
    panel.style.width = '42px';
    panel.setAttribute('data-minimized', '1');
    if (btn) btn.textContent = '\u27A1';
  }
}
function exitDemoMode() {
  _demoActive = false;
  document.getElementById('popup-demo-panel').style.display = 'none';
  _demoBanner(false);
  demoStep('reset');
}

function _demoBanner(on) {
  let b = document.getElementById('demo-active-banner');
  if (on && !b) {
    b = document.createElement('div');
    b.id = 'demo-active-banner';
    b.style.cssText = 'position:fixed;top:0;left:50%;transform:translateX(-50%);z-index:9990;background:linear-gradient(90deg,#FF8C42,#FF6B35);color:#fff;font-size:0.68rem;font-weight:900;padding:2px 16px;border-radius:0 0 8px 8px;letter-spacing:2px;pointer-events:none;';
    b.textContent = 'MODE DEMO';
    document.body.appendChild(b);
  } else if (!on && b) { b.remove(); }
}

function _demoInjectM1(year, weeks) {
  const data = {};
  weeks.forEach(w => { data[w.date] = { extra: w.extra||0, recup: w.recup||0, absent: w.absent||0 }; });
  localStorage.setItem('DATA_REPORT_' + year, JSON.stringify(data));
  localStorage.setItem('BASE_HEBDO_' + year, '35');
  localStorage.setItem('ANNUAL_RATE_' + year, '10');
}

function _demoInjectM2(year, months) {
  localStorage.setItem('CA_HS_TRACKER_V1_DATA_' + year, JSON.stringify(months));
}

function _demoSetXP(xp, level) {
  if (typeof xpSystem !== 'undefined') {
    xpSystem.currentXP = xp;
    xpSystem.level     = level;
    if (typeof xpSystem.saveToStorage === 'function') xpSystem.saveToStorage();
  }
  if (typeof gameState !== 'undefined') {
    gameState.xp = xp; gameState.level = level;
    if (gameState.player) { gameState.player.xp = xp; gameState.player.level = level; }
    if (typeof saveGameState === 'function') saveGameState();
  }
}

function _demoSetBadges(ids) {
  // Garder les string IDs dans gameState (compat ancien syst\u00e8me)
  // ET convertir les num\u00e9riques dans badgeSystem
  const strIds = (ids || []).filter(id => typeof id === 'string');
  const numIds = (ids || []).filter(id => typeof id === 'number');
  // Mapper les string IDs : les 10 premiers badges num\u00e9riques pour les light/medium
  const autoMap = {first_overtime:1,vigilant:2,overtime_100:8,overtime_150:9,weekend_worker:10,night_owl:11,iron_worker:12};
  const mappedIds = strIds.map(s => autoMap[s] || null).filter(Boolean);
  const allNumIds = [...new Set([...numIds, ...mappedIds])];
  if (typeof badgeSystem !== 'undefined') {
    badgeSystem.unlockedBadges = allNumIds;
    localStorage.setItem('rpg_unlocked_badges', JSON.stringify(allNumIds));
  }
  if (typeof gameState !== 'undefined') {
    gameState.badges = allNumIds;
    if (typeof saveGameState === 'function') saveGameState();
  }
}

function _demoLabel(txt) {
  const el = document.getElementById('demo-step-label');
  if (el) el.textContent = txt;
}

function demoStep(step) {
  const y  = new Date().getFullYear().toString();
  const yp = (parseInt(y) - 1).toString();
  const y2 = (parseInt(y) - 2).toString();

  if (step === 'reset') {
    _demoLabel('Reset - donnees effacees');
    ['DATA_REPORT_','CA_HS_TRACKER_V1_DATA_','BASE_HEBDO_','ANNUAL_RATE_'].forEach(k => {
      [y, yp, y2].forEach(yr => localStorage.removeItem(k + yr));
    });
    _fullRPGReset(); // reset XP + badges + cumuls proprement
    syncModulesAndAwardXP('demo'); refreshHUD();

  } else if (step === 'start') {
    _demoLabel('Depart - 0h sup, niveau 1');
    _demoInjectM1(y, []);
    _demoSetXP(50, 1); _demoSetBadges([]);
    syncModulesAndAwardXP('demo'); refreshHUD();

  } else if (step === 'light') {
    _demoLabel('Legeres HS - ~15h sur annee');
    _demoInjectM1(y, [
      {date:y+'-01-15',extra:3},{date:y+'-02-10',extra:2},
      {date:y+'-03-05',extra:4,recup:1},{date:y+'-04-12',extra:3},
      {date:y+'-05-08',extra:2},{date:y+'-06-15',extra:3,recup:1},
    ]);
    _demoSetXP(350, 2); _demoSetBadges(['first_overtime','vigilant']);
    syncModulesAndAwardXP('demo'); setTimeout(refreshHUD, 300);

  } else if (step === 'medium') {
    _demoLabel('HS moderees - 60h / an');
    const wks = [];
    for (let m=1;m<=10;m++) {
      const mm=String(m).padStart(2,'0');
      wks.push({date:y+'-'+mm+'-07',extra:4});
      wks.push({date:y+'-'+mm+'-21',extra:3,recup:1});
    }
    _demoInjectM1(y, wks);
    _demoSetXP(1200, 4); _demoSetBadges(['first_overtime','vigilant','overtime_100','weekend_worker']);
    syncModulesAndAwardXP('demo'); setTimeout(refreshHUD, 300);

  } else if (step === 'heavy') {
    _demoLabel('HS elevees - 150h, risque serieux');
    const wks = [];
    for (let m=1;m<=12;m++) {
      const mm=String(m).padStart(2,'0');
      wks.push({date:y+'-'+mm+'-07',extra:8});
      wks.push({date:y+'-'+mm+'-14',extra:7,recup:1});
      wks.push({date:y+'-'+mm+'-21',extra:9});
    }
    _demoInjectM1(y, wks);
    _demoSetXP(4500, 7); _demoSetBadges(['first_overtime','vigilant','overtime_100','overtime_150','weekend_worker','night_owl','iron_worker']);
    syncModulesAndAwardXP('demo'); setTimeout(refreshHUD, 300);

  } else if (step === 'critical') {
    _demoLabel('CRITIQUE - 220h+, contingent depasse');
    const wks = [];
    for (let m=1;m<=12;m++) {
      const mm=String(m).padStart(2,'0');
      wks.push({date:y+'-'+mm+'-06',extra:12});
      wks.push({date:y+'-'+mm+'-13',extra:11});
      wks.push({date:y+'-'+mm+'-20',extra:10,recup:1});
    }
    _demoInjectM1(y, wks);
    _demoInjectM2(y, {
      [y+'-01']:{hsPlus25:8,hsPlus50:6},[y+'-02']:{hsPlus25:10,hsPlus50:8},
      [y+'-03']:{hsPlus25:12,hsPlus50:5},[y+'-04']:{hsPlus25:9,hsPlus50:7},
      [y+'-05']:{hsPlus25:15,hsPlus50:10},[y+'-06']:{hsPlus25:11,hsPlus50:9},
    });
    _demoSetXP(9800, 10);
    const all = typeof BADGES !== 'undefined' ? BADGES.map(b=>b.id).slice(0,20) : [];
    _demoSetBadges(all);
    syncModulesAndAwardXP('demo'); setTimeout(refreshHUD, 300);

  } else if (step === 'multiyear') {
    _demoLabel('Multi-annees - 3 ans cumules');
    [y, yp, y2].forEach((yr, i) => {
      const mult = [1, 1.5, 2][i];
      const wks = [];
      for (let m=1;m<=12;m++) {
        const mm=String(m).padStart(2,'0');
        wks.push({date:yr+'-'+mm+'-10',extra:Math.round(5*mult)});
        wks.push({date:yr+'-'+mm+'-20',extra:Math.round(4*mult),recup:1});
      }
      _demoInjectM1(yr, wks);
    });
    _demoSetXP(7500, 9); _demoSetBadges(['first_overtime','overtime_100','overtime_150','multiyear','veteran']);
    syncModulesAndAwardXP('demo'); setTimeout(refreshHUD, 300);

  } else if (step === 'burnout') {
    _demoLabel('BURNOUT MAX - score critique');
    const wks = [];
    for (let m=1;m<=12;m++) {
      const mm=String(m).padStart(2,'0');
      wks.push({date:y+'-'+mm+'-06',extra:14});
      wks.push({date:y+'-'+mm+'-13',extra:13});
      wks.push({date:y+'-'+mm+'-20',extra:12});
    }
    _demoInjectM1(y, wks);
    [yp, y2].forEach(yr => {
      const wks2 = [];
      for (let m=1;m<=12;m++) {
        wks2.push({date:yr+'-'+String(m).padStart(2,'0')+'-10',extra:10});
      }
      _demoInjectM1(yr, wks2);
    });
    _demoSetXP(15000, 12);
    const allB = typeof BADGES !== 'undefined' ? BADGES.map(b=>b.id) : [];
    _demoSetBadges(allB);
    syncModulesAndAwardXP('demo');
    setTimeout(() => { refreshHUD(); checkBurnoutAlert(); }, 300);
  }
}

function demoXP(amount) {
  if (typeof gameState !== 'undefined') {
    const nx = (gameState.xp||0) + amount;
    const nl = Math.max(1, Math.floor(nx/1000)+1);
    _demoSetXP(nx, nl); refreshHUD();
    showNotification('+' + amount + ' XP (demo)', 'success');
  }
}

function demoNarrate(hours) {
  kitsuneNarrateOvertime(hours, 'DEMO');
  showNotification('Kitsune +' + hours + 'h (demo)', 'info');
}

function _demoFillScenarios() {
  const list = document.getElementById('demo-scenario-list');
  if (!list) return;
  const all = typeof FOX_SCENARIOS !== 'undefined' ? FOX_SCENARIOS : [];
  const risks = ['aucun','faible','moyen','\u00E9lev\u00E9','critique'];
  const picks = risks.map(r => all.find(s => s.risk === r)).filter(Boolean);
  list.innerHTML = picks.map(s =>
    '<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:8px;padding:9px 11px;cursor:pointer;" onclick="demoShowScenario(' + s.id + ')">' +
    '<div style="font-size:0.77rem;font-weight:700;color:#eee;">#' + s.id + ' ' + s.name + '</div>' +
    '<div style="font-size:0.68rem;color:#666;margin-top:2px;">' + s.risk + '</div>' +
    '</div>'
  ).join('') || '<div style="color:#555;font-size:0.8rem;">Aucun scenario</div>';
}

function demoShowScenario(id) {
  const all = typeof FOX_SCENARIOS !== 'undefined' ? FOX_SCENARIOS : [];
  const s = all.find(sc => sc.id === id);
  if (!s) return;
  document.getElementById('popup-demo-panel').style.display = 'none';
  const ft = document.getElementById('fox-text');
  if (ft) ft.innerHTML = '<strong style="color:#FF8C42;">Scenario #' + s.id + ' - ' + s.name + '</strong><br><br>' + (s.conseil && s.conseil.message ? s.conseil.message : (s.desc || ''));
  const box = document.getElementById('kitsune-scenario-box');
  if (box) {
    document.getElementById('kitsune-scenario-title').textContent = s.name;
    document.getElementById('kitsune-scenario-text').textContent = s.conseil && s.conseil.message ? s.conseil.message : '';
    const acts = document.getElementById('kitsune-scenario-actions');
    if (acts && s.conseil && s.conseil.actions) {
      acts.innerHTML = s.conseil.actions.map(a =>
        '<span style="background:rgba(255,140,66,0.12);border:1px solid rgba(255,140,66,0.25);border-radius:8px;padding:4px 10px;font-size:0.75rem;color:#FF8C42;">' + a + '</span>'
      ).join('');
    }
    box.style.display = 'block';
  }
  openPopup('popup-fox');
  setTimeout(() => { document.getElementById('popup-demo-panel').style.display = 'block'; }, 150);
}

function _demoFillBadges() {
  const el = document.getElementById('demo-badges-preview');
  if (!el) return;
  // R\u00E9cup\u00E9rer BADGES : window.BADGES si peupl\u00E9, sinon badgeSystem direct
  const all = (typeof BADGES !== 'undefined' && BADGES.length > 0) ? BADGES
            : (typeof badgeSystem !== 'undefined' && badgeSystem.badges && badgeSystem.badges.length > 0) ? badgeSystem.badges
            : (typeof rpgSystem !== 'undefined' && rpgSystem.badges) ? rpgSystem.badges
            : [];
  if (all.length > 0 && (!window.BADGES || window.BADGES.length === 0)) window.BADGES = all;

  const rows = all.slice(0, 15).map(function(b) {
    // Utiliser l'image si disponible, sinon emoji fallback
    const imgHtml = b.img
      ? '<img src="' + b.img + '" alt="' + (b.name||'') + '" style="width:36px;height:36px;object-fit:contain;"'
        + ' onerror="console.warn(\'[DEBUG badges] Image manquante:\',this.src);this.style.display=\'none\';this.nextSibling.style.display=\'block\'">'
        + '<span style="display:none;font-size:1.3rem;">' + (b.icon || '&#127941;') + '</span>'
      : '<span style="font-size:1.3rem;">' + (b.icon || '&#127941;') + '</span>';

    return '<div data-bid="' + b.id + '" title="' + (b.name||'') + '" style="background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.2);border-radius:8px;padding:7px;text-align:center;cursor:pointer;">'
      + '<div style="height:40px;display:flex;align-items:center;justify-content:center;">' + imgHtml + '</div>'
      + '</div>';
  });
  el.innerHTML = rows.length ? rows.join('') : '<div style="color:#555;font-size:0.8rem;">Aucun badge</div>';
  setTimeout(function() {
    el.querySelectorAll('[data-bid]').forEach(function(d) {
      d.addEventListener('click', function() { demoUnlockBadge(d.getAttribute('data-bid')); });
    });
  }, 50);
}

function demoUnlockBadge(id) {
  if (typeof gameState !== 'undefined') {
    if (!gameState.badges) gameState.badges = [];
    if (!gameState.badges.includes(id)) {
      gameState.badges.push(id);
      if (typeof saveGameState === 'function') saveGameState();
      refreshHUD(); _demoFillBadges();
      showNotification('Badge: ' + id, 'success');
    }
  }
}
</script>
<script>
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550
//  NOUVELLES FONCTIONS FOX ENGINE \u2014 patch complet
// \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550

// \u2500\u2500 D\u00E9cor saisonnier (4 backgrounds par trimestre) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
const _SEASONAL_BG = [
  '../images/fox-bg.PNG',     // Q1 : hiver (jan-mar)
  '../images/fox-bg-2.PNG',   // Q2 : printemps (avr-jun)
  '../images/fox-bg-3.PNG',   // Q3 : \u00E9t\u00E9 (jul-sep)
  '../images/fox-bg-4.PNG',   // Q4 : automne (oct-d\u00E9c)
];
function updateSeasonalBg() {
  const m     = new Date().getMonth(); // 0-11
  const q     = Math.floor(m / 3);    // 0-3
  const bg    = _SEASONAL_BG[q] || _SEASONAL_BG[0];
  const bgEl  = document.getElementById('bg-decor');
  if (!bgEl) return;
  const current = bgEl.src.split('/').pop();
  const target  = bg.split('/').pop();
  if (current !== target) {
    bgEl.style.opacity = '0';
    bgEl.style.transition = 'opacity 1.5s ease';
    setTimeout(() => {
      bgEl.src = bg;
      bgEl.onload = () => { bgEl.style.opacity = '1'; };
      bgEl.onerror = () => { bgEl.style.opacity = '1'; }; // fallback si image absente
    }, 800);
  }
}

// \u2500\u2500 PNJ \u2014 \u00E9volution tous les 5 niveaux jusqu'au niveau 50 \u2500
// Images attendues : foxplayer.PNG (niv 1-5), foxplayer-2.PNG (6-10) ... foxplayer-10.PNG (46-50)
function updatePNJLevel(level) {
  const lvl   = Math.max(1, Math.min(50, level || 1));
  const tier  = Math.min(10, Math.ceil(lvl / 5));   // 1 \u00E0 10
  const img   = tier === 1 ? '../images/foxplayer.PNG' : `../images/foxplayer-${tier}.PNG`;
  const pnj   = document.getElementById('kitsune-svg');
  const foxImgPopup = document.querySelector('#popup-fox img[src*="foxplayer"]');
  if (pnj && pnj.getAttribute('data-tier') !== String(tier)) {
    pnj.setAttribute('data-tier', tier);
    pnj.src = img;
    if (foxImgPopup) foxImgPopup.src = img;
  }
}

// \u2500\u2500 Animation Level-Up \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function showLevelUpAnim(level) {
  // Flash or d'or sur le HUD level
  const lvlEl = document.getElementById('hud-level');
  if (lvlEl) {
    lvlEl.classList.add('level-up-anim');
    setTimeout(() => lvlEl.classList.remove('level-up-anim'), 3500);
  }
  // Notification centr\u00E9e
  const notif = document.createElement('div');
  notif.className = 'reward-notification';
  notif.innerHTML = `
    <div style="font-size:2rem;margin-bottom:6px;">\u2B06\uFE0F</div>
    <div style="color:#FFD700;font-weight:900;font-size:1.1rem;letter-spacing:1px;">NIVEAU ${level} !</div>
    <div style="color:#bbb;font-size:0.8rem;margin-top:4px;">Ta ma\u00EEtrise du droit du travail grandit \uD83E\uDD8A</div>`;
  document.body.appendChild(notif);
  setTimeout(() => { notif.style.opacity='0'; notif.style.transition='opacity 0.6s'; }, 3000);
  setTimeout(() => notif.remove(), 3600);
  addRewardToHistory(`\u2B06\uFE0F Niveau ${level} atteint !`, 'level');
}

// \u2500\u2500 Animation Badge/Comp\u00E9tence d\u00E9bloqu\u00E9 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function showBadgeUnlockAnim(badge) {
  const rC = {common:'#b0b0b0', rare:'#5094ff', epic:'#a050ff', legendary:'#FFD700'};
  const color = rC[badge.rarity] || '#FF8C42';
  const notif = document.createElement('div');
  notif.className = 'reward-notification';
  notif.style.border = `2px solid ${color}`;
  notif.style.boxShadow = `0 0 40px ${color}44`;
  const isSkill = badge.id >= 51;
  notif.innerHTML = `
    <div style="font-size:1.8rem;margin-bottom:4px;" class="badge-unlock-anim">${badge.icon || (isSkill ? '\uD83C\uDF1F' : '\uD83C\uDFC5')}</div>
    <div style="color:${color};font-weight:900;font-size:0.95rem;">${isSkill ? 'COMP\u00C9TENCE' : 'BADGE'} D\u00C9BLOQU\u00C9</div>
    <div style="color:#eee;font-size:0.85rem;margin-top:3px;font-weight:700;">${badge.name}</div>
    <div style="color:#888;font-size:0.72rem;margin-top:2px;">${badge.description || ''}</div>`;
  document.body.appendChild(notif);
  setTimeout(() => { notif.style.opacity='0'; notif.style.transition='opacity 0.6s'; }, 4000);
  setTimeout(() => notif.remove(), 4600);
  addRewardToHistory(`${badge.icon || (isSkill ? '\uD83C\uDF1F' : '\uD83C\uDFC5')} ${badge.name} \u2014 ${badge.description || ''}`, badge.rarity || 'common');
}

// \u2500\u2500 Historique r\u00E9compenses dans popup Kitsune \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function addRewardToHistory(text, type) {
  // Persister dans localStorage
  const key = 'FOX_REWARDS_HISTORY';
  const hist = JSON.parse(localStorage.getItem(key) || '[]');
  hist.unshift({ text, type, ts: Date.now() });
  if (hist.length > 50) hist.splice(50);
  localStorage.setItem(key, JSON.stringify(hist));
  // Mettre \u00E0 jour le panneau si ouvert
  _renderRewardsLog(hist);
}

function _renderRewardsLog(hist) {
  const log = document.getElementById('kitsune-rewards-log');
  if (!log) return;
  if (!hist || hist.length === 0) {
    log.innerHTML = '<div style="color:#444;font-size:0.78rem;text-align:center;padding:8px;">Aucune r\u00E9compense d\u00E9bloqu\u00E9e pour l\'instant</div>';
    return;
  }
  const typeColors = { level:'#FFD700', common:'#b0b0b0', rare:'#5094ff', epic:'#a050ff', legendary:'#FFD700', info:'#FF8C42' };
  log.innerHTML = hist.map(r => {
    const c = typeColors[r.type] || '#888';
    const d = new Date(r.ts);
    const ts = `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
    return `<div style="background:rgba(255,255,255,0.03);border-left:3px solid ${c};border-radius:6px;padding:6px 10px;font-size:0.78rem;">
      <span style="color:${c};">${r.text}</span>
      <span style="color:#333;font-size:0.65rem;float:right;">${ts}</span>
    </div>`;
  }).join('');
}

// \u2500\u2500 Kitsune popup refresh (historique) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function refreshKitsunePopup() {
  const hist = JSON.parse(localStorage.getItem('FOX_REWARDS_HISTORY') || '[]');
  _renderRewardsLog(hist);
}

// \u2500\u2500 Import JSON fichier \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function importJSONFile(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      _applyImportedData(data);
    } catch(err) {
      _setImportStatus('JSON invalide : ' + err.message, false);
    }
  };
  reader.readAsText(file);
}

async function importFromClipboard() {
  try {
    const text = await navigator.clipboard.readText();
    const data = JSON.parse(text);
    _applyImportedData(data);
  } catch(e) {
    _setImportStatus('Aucun JSON valide dans le presse-papier', false);
  }
}

function _applyImportedData(data) {
  let count = 0;
  // D\u00E9tecter le type de donn\u00E9es
  if (data.gameState || data.xp || data.badges) {
    // Export RPG complet
    if (data.gameState && typeof gameState !== 'undefined') {
      Object.assign(gameState, data.gameState);
      if (typeof saveGameState === 'function') saveGameState();
      count++;
    }
  }
  // Import localStorage direct (cl\u00E9s DATA_REPORT_, CA_HS_TRACKER_V1_DATA_)
  if (data.localStorage) {
    Object.entries(data.localStorage).forEach(([k, v]) => {
      localStorage.setItem(k, typeof v === 'string' ? v : JSON.stringify(v));
      count++;
    });
  }
  // Import M1 direct
  if (data.module1 || data.m1) {
    const m1 = data.module1 || data.m1;
    const year = m1.year || new Date().getFullYear();
    if (m1.rawData) localStorage.setItem('DATA_REPORT_' + year, JSON.stringify(m1.rawData));
    count++;
  }
  // Import M2 direct
  if (data.module2 || data.m2) {
    const m2 = data.module2 || data.m2;
    const year = m2.year || new Date().getFullYear();
    if (m2.data) localStorage.setItem('CA_HS_TRACKER_V1_DATA_' + year, JSON.stringify(m2.data));
    count++;
  }
  if (count > 0) {
    _setImportStatus(`Import r\u00E9ussi (${count} section(s)). Rechargement\u2026`, true);
    setTimeout(() => { syncModulesAndAwardXP('import'); closePopup('popup-import'); }, 1200);
  } else {
    _setImportStatus('Donn\u00E9es non reconnues \u2014 v\u00E9rifie le format', false);
  }
}

function _setImportStatus(msg, ok) {
  const el = document.getElementById('import-status');
  if (!el) return;
  el.style.display = 'block';
  el.style.background = ok ? 'rgba(76,175,80,0.12)' : 'rgba(229,57,53,0.12)';
  el.style.border = ok ? '1px solid rgba(76,175,80,0.3)' : '1px solid rgba(229,57,53,0.3)';
  el.style.color = ok ? '#4CAF50' : '#E53935';
  el.textContent = msg;
}

// \u2500\u2500 Debug M1 (ajout\u00E9 dans Settings) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function debugM1Data() {
  const year = localStorage.getItem('ACTIVE_YEAR_SUFFIX') || new Date().getFullYear();
  const raw  = localStorage.getItem('DATA_REPORT_' + year);
  const keys = Object.keys(localStorage).filter(k => k.startsWith('DATA_REPORT_'));
  const msg  = `Ann\u00E9e active: ${year}\nCl\u00E9s M1 trouv\u00E9es: ${keys.join(', ') || 'aucune'}\nDonn\u00E9es: ${raw ? Object.keys(JSON.parse(raw)).length + ' entr\u00E9es' : 'vide'}`;
  alert(msg);
}

// \u2500\u2500 Kitsune narration \u2014 ton "conseil d'ami" \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
function _friendlyScenario(s) {
  if (!s || !s.conseil) return null;
  const c = s.conseil;
  // R\u00E9\u00E9crire en mode "ami qui sait"
  const titre = c.titre;
  let msg = c.message || '';
  // Remplacer tournures juridiques froides par ton chaleureux
  msg = msg
    .replace(/Vous devez/gi, 'Tu dois')
    .replace(/Il est obligatoire/gi, 'C\'est obligatoire')
    .replace(/L\'employeur/gi, 'Ton employeur')
    .replace(/Le salari\u00E9/gi, 'Tu')
    .replace(/selon la convention/gi, 'selon ta convention (\u00E0 v\u00E9rifier !)')
    .replace(/V\u00E9rifiez/gi, 'V\u00E9rifie')
    .replace(/Contactez/gi, 'Contacte')
    .replace(/Signaler/gi, 'Signale');
  // Ajouter disclaimer l\u00E9ger si sc\u00E9nario l\u00E9gal
  const legal = s.id <= 400;
  const disclaimer = legal ? '\n\n\uD83D\uDCAC (\u00C0 titre indicatif \u2014 je suis ton renard, pas ton avocat !)' : '';
  return { titre, msg: msg + disclaimer, actions: c.actions, alerte: c.alerte };
}

// Override de kitsuneNarrateOvertime pour apply le ton ami
const _origKitsune = typeof kitsuneNarrateOvertime === 'function' ? kitsuneNarrateOvertime : null;
function kitsuneNarrateOvertime(deltaH, source) {
  try {
    const h = Math.round(deltaH * 10) / 10;
    const msgObj = typeof _kitsuneMessages !== 'undefined' && _kitsuneMessages.find ? _kitsuneMessages.find(m => h >= m.min && h < m.max) : null;
    const bubbleText = msgObj ? msgObj.msg.replace('{h}', h) : `\u{1F98A} ${h}h sup de plus \u2014 je t'explique ci-dessous !`;
    const bubbleEl = document.getElementById('kitsune-bubble-text');
    if (bubbleEl) bubbleEl.textContent = bubbleText;

    // S\u00E9lection sc\u00E9nario FOX
    let scenario = null;
    if (typeof FOX_SCENARIOS !== 'undefined' && FOX_SCENARIOS.length > 0) {
      const bo  = moduleReader.getBurnoutScore ? moduleReader.getBurnoutScore() : { score: 0 };
      const cum = moduleReader.getCumulatedSummary ? moduleReader.getCumulatedSummary() : {};
      let pool  = FOX_SCENARIOS;
      if (bo.score >= 60) pool = FOX_SCENARIOS.filter(s => s.id >= 401);
      else if (bo.score >= 40) pool = FOX_SCENARIOS.filter(s => s.id >= 401 || s.category === 'repos');
      else if (h >= 13) pool = FOX_SCENARIOS.filter(s => ['limite','extreme','repos'].includes(s.category));
      else if ((cum.totalPlus50 || 0) > 0) pool = FOX_SCENARIOS.filter(s => s.category === 'intense' && (s.risk === '\u00E9lev\u00E9' || s.risk === 'critique'));
      else pool = FOX_SCENARIOS.filter(s => ['standard','intense','partiel'].includes(s.category));
      if (!pool.length) pool = FOX_SCENARIOS;
      const narrated = JSON.parse(localStorage.getItem('FOX_SCENARIOS_NARRATED') || '[]');
      const fresh = pool.filter(s => !narrated.slice(-10).includes(s.id));
      const finalPool = fresh.length > 0 ? fresh : pool;
      scenario = finalPool[Math.floor(Math.random() * finalPool.length)];
    }

    if (scenario) {
      const narrated = JSON.parse(localStorage.getItem('FOX_SCENARIOS_NARRATED') || '[]');
      if (!narrated.includes(scenario.id)) { narrated.push(scenario.id); localStorage.setItem('FOX_SCENARIOS_NARRATED', JSON.stringify(narrated)); }
    }

    // Rendu "ton ami"
    const conseil = scenario ? _friendlyScenario(scenario) : null;
    const alerteColor = !conseil?.alerte ? '#FF8C42'
      : conseil.alerte.niveau === 'danger' ? '#E53935'
      : conseil.alerte.niveau === 'warning' ? '#FF8C42' : '#4CAF50';

    const box   = document.getElementById('kitsune-scenario-box');
    const title = document.getElementById('kitsune-scenario-title');
    const body  = document.getElementById('kitsune-scenario-text');
    const acts  = document.getElementById('kitsune-scenario-actions');
    const foxText = document.getElementById('fox-text');

    if (conseil && box && title && body) {
      title.textContent = '\u{1F4CB} ' + conseil.titre;
      title.style.color = alerteColor;
      body.textContent  = conseil.msg;
      if (acts) {
        acts.innerHTML = (conseil.actions || []).map(a =>
          `<span style="background:rgba(255,140,66,0.12);border:1px solid rgba(255,140,66,0.25);border-radius:8px;padding:4px 10px;font-size:0.75rem;color:#FF8C42;margin:2px;display:inline-block;">${a}</span>`
        ).join('');
        if (conseil.alerte) {
          acts.innerHTML += `<br><span style="color:${alerteColor};font-size:0.78rem;font-weight:700;">${conseil.alerte.texte}</span>`;
        }
      }
      box.style.display = 'block';
    }
    if (foxText) {
      const friendly = `\u{1F98A} ${h}h de plus sur tes \u00E9paules \u2014 voil\u00E0 ce que j'observe pour toi :`;
      foxText.innerHTML = `<strong style="color:${alerteColor};">${friendly}</strong><br><br>${conseil ? conseil.msg.replace(/\n/g,'<br>') : bubbleText}`;
    }
    // Historique
    addRewardToHistory(`\u{1F98A} Narration : ${scenario ? scenario.name : 'conseil g\u00E9n\u00E9ral'} (${h}h)`, 'info');
  } catch(e) { console.warn('kitsuneNarrateOvertime:', e); }
}

// \u2500\u2500 Override showLevelUpAnim dans xpSystem \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
// Hook sur le r\u00E9sultat de addXP pour d\u00E9tecter level-up
const _origAddXP = typeof xpSystem !== 'undefined' && xpSystem.addXP ? xpSystem.addXP.bind(xpSystem) : null;
if (_origAddXP && typeof xpSystem !== 'undefined') {
  xpSystem.addXP = function(hours) {
    const prevLevel = this.level;
    const result    = _origAddXP(hours);
    const newLevel  = this.level;
    if (newLevel > prevLevel) {
      showLevelUpAnim(newLevel);
      updatePNJLevel(newLevel);
    }
    return result;
  };
}

// \u2500\u2500 Override checkAndAwardBadges pour animations \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
const _origCheckBadges = typeof checkAndAwardBadges === 'function' ? checkAndAwardBadges : null;
function checkAndAwardBadges() {
  try {
    if (typeof badgeSystem === 'undefined') return [];
    const stats     = typeof buildBadgeStats === 'function' ? buildBadgeStats() : {};
    const newBadges = badgeSystem.checkAndUnlockBadges(stats);
    for (const badge of newBadges) {
      // Synchroniser dans gameState.badges pour l'affichage
      if (typeof gameState !== 'undefined') {
        if (!gameState.badges) gameState.badges = [];
        if (!gameState.badges.includes(badge.id)) {
          gameState.badges.push(badge.id);
          if (typeof saveGameState === 'function') saveGameState();
        }
      }
      showBadgeUnlockAnim(badge);
    }
    // Sync compl\u00E8te de toutes les badges badgeSystem \u2192 gameState (au cas o\u00F9)
    if (typeof gameState !== 'undefined' && badgeSystem.unlockedBadges) {
      const allUnlocked = badgeSystem.unlockedBadges;
      if (!gameState.badges) gameState.badges = [];
      let changed = false;
      allUnlocked.forEach(id => {
        if (!gameState.badges.includes(id)) { gameState.badges.push(id); changed = true; }
      });
      if (changed && typeof saveGameState === 'function') saveGameState();
    }
    // Mettre \u00E0 jour le compteur HUD
    const hudBadges = document.getElementById('hud-badges');
    if (hudBadges) hudBadges.textContent = _getUnlockedIds().length;
    return newBadges;
  } catch(e) { console.warn('checkAndAwardBadges:', e); return []; }
}

// \u2500\u2500 Helpers settings M1 debug \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500

// \u2500\u2500 Init : d\u00E9cor saisonnier + PNJ niveau au load \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(updateSeasonalBg, 500);
  setTimeout(() => {
    const lvl = typeof xpSystem !== 'undefined' ? (xpSystem.level || 1) : 1;
    updatePNJLevel(lvl);
  }, 600);
  // Charger historique Kitsune
  setTimeout(refreshKitsunePopup, 1000);
});

</script>
</body>
</html>
